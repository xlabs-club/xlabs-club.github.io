[{"content":"","date":"2023-09-07","id":0,"permalink":"/docs/guides/","summary":"","tags":[],"title":"Guides"},{"content":"云原生技术探索。\n","date":"2023-09-07","id":1,"permalink":"/docs/cloud/introduction/","summary":"\u003cp\u003e云原生技术探索。\u003c/p\u003e","tags":[],"title":"Introduction"},{"content":"卫星实验室，一个专注于技术创新的开源组织。\n此项目为卫星实验室主页 xlabs.club 的源码，在这里将分享我们的平台工程实践经验，介绍如何以技术驱动业务长期发展和高速增长。\n欢迎提交 PR 进行开源共建。\n主页内容 平台工程：我们的平台工程建设之路，关于 DevOps, DataOps, FinOps 以及 AIOps 的工程实践。 云原生：云原生技术探索，如何以云原生技术支撑起不断变化的复杂业务。 技术博客：研发踩坑记录，翻一翻总有惊喜。 awesome-x-ops：一些关于 AIOps、DataOps、DevOps、GitOps、FinOps 的优秀软件、博客、配套工具。 xlabs-ops：一些 IaC 运维脚本和通用模板，如 Argo Workflows 模板仓库，是对官方 Examples 的组合、扩展。 xlabs-developer-platform：一个基于 Backstage 自建的开发者平台。 backstage-plugins：卫星实验室的开源 backstage plugins，欢迎提交 PR。 License 本文档采用 CC BY-NC 4.0 许可协议。\n","date":"2023-09-07","id":2,"permalink":"/docs/guides/introduction/","summary":"\u003cp\u003e卫星实验室，一个专注于技术创新的开源组织。\u003c/p\u003e\n\u003cp\u003e此项目为卫星实验室主页 \u003ca href=\"https://www.xlabs.club\" target=\"_blank\" rel=\"noopener\"\u003exlabs.club\u003c/a\u003e\n 的源码，在这里将分享我们的平台工程实践经验，介绍如何以技术驱动业务长期发展和高速增长。\u003c/p\u003e\n\u003cp\u003e欢迎提交 PR 进行开源共建。\u003c/p\u003e\n\u003ch2 id=\"主页内容\"\u003e主页内容\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e平台工程：我们的平台工程建设之路，关于 DevOps, DataOps, FinOps 以及 AIOps 的工程实践。\u003c/li\u003e\n\u003cli\u003e云原生：云原生技术探索，如何以云原生技术支撑起不断变化的复杂业务。\u003c/li\u003e\n\u003cli\u003e技术博客：研发踩坑记录，翻一翻总有惊喜。\u003c/li\u003e\n\u003cli\u003eawesome-x-ops：一些关于 AIOps、DataOps、DevOps、GitOps、FinOps 的优秀软件、博客、配套工具。\u003c/li\u003e\n\u003cli\u003exlabs-ops：一些 IaC 运维脚本和通用模板，如 Argo Workflows 模板仓库，是对官方 Examples 的组合、扩展。\u003c/li\u003e\n\u003cli\u003exlabs-developer-platform：一个基于 Backstage 自建的开发者平台。\u003c/li\u003e\n\u003cli\u003ebackstage-plugins：卫星实验室的开源 backstage plugins，欢迎提交 PR。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"license\"\u003eLicense\u003c/h2\u003e\n\u003cp\u003e本文档采用 \u003ca href=\"https://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\" rel=\"noopener\"\u003eCC BY-NC 4.0\u003c/a\u003e\n 许可协议。\u003c/p\u003e","tags":[],"title":"Introduction"},{"content":"常用 Kubernetes 命令，复制，粘贴，这就是生活。\n复制 secret 到另一个 namespace。 kubectl get secret mys --namespace=na -oyaml | grep -v \u0026#39;^\\s*namespace:\\s\u0026#39; | kubectl apply --namespace=nb -f -\r批量删除 pod。 kubectl get pods --all-namespaces | grep Evicted | awk \u0026#39;{print $2 \u0026#34; --namespace=\u0026#34; $1}\u0026#39; | xargs kubectl delete pod # Delete by label kubectl delete pod -n idaas-book -l app.kubernetes.io/name=idaas-book\r原地重启 Pod。 kubectl rollout restart deploy/xxx -n your-namespace\r命令行快速扩缩容。 # kubectl scale -h kubectl scale --replicas=1 deploy/xxx -n your-namespace\r密钥解密。 kubectl get secret my-creds -n mysql -o jsonpath=\u0026#34;{.data.ADMIN_PASSWORD}\u0026#34; | base64 --decode\r合并多个 kube config 文件。 export KUBECONFIG=~/.kube/config:~/.kube/anotherconfig kubectl config view --flatten \u0026gt; ~/.kube/config-all cp ~/.kube/config-all ~/.kube/config # 顺手把权限改了，避免 helm 或 kubectl 客户端 warning chmod 600 ~/.kube/config\r获取某个 namespace 下的全部资源，找出你看不见的资源，常用于 webhook/CR/CRD 等资源清理，解决强制删除失败。 ns=your-namespace for resource in `kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get -o name -n $ns`; do kubectl get $resource -n $ns; # kubectl patch $resource -p \u0026#39;{\u0026#34;metadata\u0026#34;: {\u0026#34;finalizers\u0026#34;: []}}\u0026#39; --type=\u0026#39;merge\u0026#39; -n $ns; done\r根据特定字段排序 Pod 列表。 # 根据重启次数排序 kubectl get pods --sort-by=\u0026#39;.status.containerStatuses[0].restartCount\u0026#39; -A\r","date":"2023-09-07","id":3,"permalink":"/docs/tldr/kubernetes/","summary":"\u003cp\u003e常用 Kubernetes 命令，复制，粘贴，这就是生活。\u003c/p\u003e\n\u003chr\u003e\n\u003cul\u003e\n\u003cli\u003e复制 secret 到另一个 namespace。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get secret mys --namespace\u003cspan class=\"o\"\u003e=\u003c/span\u003ena -oyaml \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -v \u003cspan class=\"s1\"\u003e\u0026#39;^\\s*namespace:\\s\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e kubectl apply --namespace\u003cspan class=\"o\"\u003e=\u003c/span\u003enb -f -\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e批量删除 pod。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get pods --all-namespaces \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep Evicted \u003cspan class=\"p\"\u003e|\u003c/span\u003e awk \u003cspan class=\"s1\"\u003e\u0026#39;{print $2 \u0026#34; --namespace=\u0026#34; $1}\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e xargs kubectl delete pod\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Delete by label\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl delete pod -n idaas-book -l app.kubernetes.io/name\u003cspan class=\"o\"\u003e=\u003c/span\u003eidaas-book\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e原地重启 Pod。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl rollout restart deploy/xxx -n your-namespace\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e命令行快速扩缩容。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# kubectl scale -h\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl scale --replicas\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e deploy/xxx -n your-namespace\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e密钥解密。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e kubectl get secret my-creds -n mysql -o \u003cspan class=\"nv\"\u003ejsonpath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;{.data.ADMIN_PASSWORD}\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e base64 --decode\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e合并多个 kube config 文件。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eKUBECONFIG\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e~/.kube/config:~/.kube/anotherconfig\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl config view --flatten \u0026gt; ~/.kube/config-all\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp ~/.kube/config-all ~/.kube/config\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 顺手把权限改了，避免 helm 或 kubectl 客户端 warning\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e600\u003c/span\u003e ~/.kube/config\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e获取某个 namespace 下的全部资源，找出你看不见的资源，常用于 webhook/CR/CRD 等资源清理，解决强制删除失败。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ens\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyour-namespace\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e resource in \u003cspan class=\"sb\"\u003e`\u003c/span\u003ekubectl api-resources --verbs\u003cspan class=\"o\"\u003e=\u003c/span\u003elist --namespaced -o name \u003cspan class=\"p\"\u003e|\u003c/span\u003e xargs -n \u003cspan class=\"m\"\u003e1\u003c/span\u003e kubectl get -o name -n \u003cspan class=\"nv\"\u003e$ns\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    kubectl get \u003cspan class=\"nv\"\u003e$resource\u003c/span\u003e  -n \u003cspan class=\"nv\"\u003e$ns\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# kubectl patch $resource -p \u0026#39;{\u0026#34;metadata\u0026#34;: {\u0026#34;finalizers\u0026#34;: []}}\u0026#39; --type=\u0026#39;merge\u0026#39; -n $ns;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e根据特定字段排序 Pod 列表。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 根据重启次数排序\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get pods --sort-by\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.status.containerStatuses[0].restartCount\u0026#39;\u003c/span\u003e -A\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e","tags":[],"title":"Kubernetes"},{"content":"我们的平台工程建设之路，介绍前期方案设计、中间踩坑历程。\n原则 分享我们平台工程建设的一些基本原则。\n以开发者为中心：赋能开发者，了解困难，解决问题，让开发者生活更轻松。 自动化：自动化手动和重复性任务，减少人为错误，提高效率。 标准化：标准化保持一致性，减少复杂性，减少团队认知负载，提供最佳实践和统一的编码结构。 模块化：松耦合且独立的模块，可独立开发、测试和部署。 弹性：可扩展水平扩缩容的能力，以及容错抗脆弱的能力。 安全：相比于微服务、云原生领域的安全，在平台工程里，更强调代码、基础设施、数据和其他资源的安全。 协作：平台工程师、开发人员、运维运营人员以及其他参与者之间的协作，提高生产力、促进创新并创造积极包容的工作环境。 持续改进：持续性反馈、评估、改进。 架构概述 为便于理解，我们仍然按照惯用架构模型，将架构分为 IaaS、CaaS、PaaS、Applications 这几个层级。\n专业的运维人员作为 platform engineer 着重于 IaaS、CaaS、PaaS 建设，开发人员作为 application engineer 更专注于 PaaS、Applications 建设，为开发和运维提供工具、协作平台、基础应用。\nC4Context title 平台工程总体架构 Boundary(users, \"Users\", \"用户接入\") { Person(superAdmin, \"超级管理员\") Person(admin, \"平台管理员\") Person(developer, \"开发人员\") Person(maintenance, \"运维人员\") } Boundary(console, \"Console\", \"开发者平台\") { Container(backstage, \"Backstage\",\"react\",\"开发者门户\") Container(apps, \"应用管理平台\",\"Application\",\"容器管理、应用管理、配置管理、自动化测试\") Container(ops, \"统一运维平台\",\"x-ops\",\"数据库、中间件、日志、监控告警平台\") Container(iam, \"IAM\", \"Keycloak\", \"统一用户、组织、角色权限管理\") } Boundary(paas, \"PaaS\", \"PaaS\") { ContainerDb(rds, \"RDS\", \"PostgreSQL/MySQL\", \"PostgreSQL、MySQL 等关系型数据库\") ContainerDb(clickhouse, \"ClickHouse\", \"ClickHouse\", \"BI、Logging、Metrics 等列式数据库\") ContainerDb(nosql, \"NoSQL\", \"NoSQL\", \"ES、Redis、Mongo 等缓存数据库、文档数据库\") ContainerDb(mq, \"消息队列\", \"Kafka\", \"Kafka、RocketMQ 等消息队列\") } Boundary(caas, \"CaaS\", \"CaaS\") { Container(k8s, \"Kubernetes\",\"k8s\",\"K8S 容器平台\") Container(workflow, \"编排引擎\",\"Argo\",\"流水线，流程、应用编排引擎\") Container(kms, \"KMS\",\"HashiCorp Vault\",\"秘钥管理系统\") Container(harbor, \"Harbor\",\"harbor\",\"容器镜像仓库\") Container(git, \"IaC\",\"GitLab\",\"IaC、GitOps 源码仓库\") } Boundary(iaas, \"IaaS\", \"IaaS\") { Container(vm, \"云主机\",\"vm\",\"云主机自带本地存储\") Container(cbh, \"堡垒机\",\"cbh\",\"安全运维审计堡垒机\") Container(s3, \"S3\",\"S3/Minio\",\"分布式对象存储\") Container(nfs, \"NFS\",\"nfs\",\"共享文件存储\") } UpdateLayoutConfig($c4ShapeInRow=\"4\", $c4BoundaryInRow=\"1\")\r基础设施标准化 基础设施标准化是平台工程建设的第一步，通过对基础设施服务进行标准化，减少开发人员和运维团队之间的摩擦，减少运维难度，大大降低出错的概率。\n云平台已经成熟，在云平台的基础上，我们更近一步，提出 All In K8S 策略，这里的 All In 主要包括两点：\nRun On K8S：数据库、缓存、消息队列、业务应用，一切都运行在 K8S 上，K8S 是事实上的基础设施。 面向 K8S 设计：遵循 K8S 设计原则，拥抱 K8S 生态，充分利用开源功能特性。 作为一个由传统运维转变而来的团队，分享几个可能有用的关注点：\n操作习惯变化，由命令式到声明式：过去在虚拟机内直接修改文件、执行某个命令、安装某个插件，变为修改 yaml 配置、修改基础镜像、修改镜像 init 进程。 资源隔离：从集群、node、namespace 不同维度进行物理或逻辑隔离，对数据库、业务应用按 Label 、污点进行逻辑分区。 权限和策略管理：有容器云平台用平台即可。如果没有，K8S 4 种鉴权模式 Node、ABAC、RBAC 和 Webhook 能否满足要求，考虑是否引入 OPA Gatekeeper 或 Kyverno 完善和简化工作。 网络安全：截止目前 K8S 安装时仍然推荐禁用虚拟机内部防火墙，云平台提供虚拟机安全组一般用于防止外部网络入侵， K8S 内部考虑使用 NetworkPolicy 防止内部人员搞坏。比如不同组织的多个数据库，结合上面的资源隔离和权限控制，从一开始就要规划好是按集群还是 namespace 划分。 严格版本化管理：操作系统、容器镜像、Helm Charts、命令行工具，精确到小版本。 显式声明参数：以 Helm 应用为例，理解 values.yaml 文件中的每个变量并避免使用默认值，每次更新版本比对变量差异并再次执行显式声明参数原则。 应用交付自动化：自动化、规范化应用交付全流程，并严格践行面向失败设计的原则。减少人的动作流程才能减少生产事故。 日志采集：应用日志可能打印到文件或 Pod console，统一采集展示。 故障演练：对不同应用进行故障演练，尤其是模拟备份和恢复，传统的停进程、恢复文件、重启服务的操作模式在容器内可能行不通。 开发者体验 如何提升开发者体验。如何实现开发者自助。内部开发者平台解决不了的问题有哪些，如何解决的。\n可观测性 可观测助力提升开发者体验和质量提升。AIOps 是不是未来。\n组织架构变革 平台工程如何推动和影响组织架构变革。\n","date":"2023-09-07","id":4,"permalink":"/docs/platform/introduction/","summary":"\u003cp\u003e我们的平台工程建设之路，介绍前期方案设计、中间踩坑历程。\u003c/p\u003e\n\u003ch2 id=\"原则\"\u003e原则\u003c/h2\u003e\n\u003cp\u003e分享我们平台工程建设的一些基本原则。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e以开发者为中心：赋能开发者，了解困难，解决问题，让开发者生活更轻松。\u003c/li\u003e\n\u003cli\u003e自动化：自动化手动和重复性任务，减少人为错误，提高效率。\u003c/li\u003e\n\u003cli\u003e标准化：标准化保持一致性，减少复杂性，减少团队认知负载，提供最佳实践和统一的编码结构。\u003c/li\u003e\n\u003cli\u003e模块化：松耦合且独立的模块，可独立开发、测试和部署。\u003c/li\u003e\n\u003cli\u003e弹性：可扩展水平扩缩容的能力，以及容错抗脆弱的能力。\u003c/li\u003e\n\u003cli\u003e安全：相比于微服务、云原生领域的安全，在平台工程里，更强调代码、基础设施、数据和其他资源的安全。\u003c/li\u003e\n\u003cli\u003e协作：平台工程师、开发人员、运维运营人员以及其他参与者之间的协作，提高生产力、促进创新并创造积极包容的工作环境。\u003c/li\u003e\n\u003cli\u003e持续改进：持续性反馈、评估、改进。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"架构概述\"\u003e架构概述\u003c/h2\u003e\n\u003cp\u003e为便于理解，我们仍然按照惯用架构模型，将架构分为 IaaS、CaaS、PaaS、Applications 这几个层级。\u003c/p\u003e\n\u003cp\u003e专业的运维人员作为 platform engineer 着重于 IaaS、CaaS、PaaS 建设，开发人员作为 application engineer 更专注于 PaaS、Applications 建设，为开发和运维提供工具、协作平台、基础应用。\u003c/p\u003e\n\u003cdiv class=\"mermaid text-center\"\u003e\nC4Context\n    title 平台工程总体架构\n\n    Boundary(users, \"Users\", \"用户接入\") {\n        Person(superAdmin, \"超级管理员\")\n        Person(admin, \"平台管理员\")\n        Person(developer, \"开发人员\")\n        Person(maintenance, \"运维人员\")\n    }\n\n    Boundary(console, \"Console\", \"开发者平台\") {\n        Container(backstage, \"Backstage\",\"react\",\"开发者门户\")\n        Container(apps, \"应用管理平台\",\"Application\",\"容器管理、应用管理、配置管理、自动化测试\")\n        Container(ops, \"统一运维平台\",\"x-ops\",\"数据库、中间件、日志、监控告警平台\")\n        Container(iam, \"IAM\", \"Keycloak\", \"统一用户、组织、角色权限管理\")\n    }\n\n    Boundary(paas, \"PaaS\", \"PaaS\") {\n        ContainerDb(rds, \"RDS\", \"PostgreSQL/MySQL\", \"PostgreSQL、MySQL 等关系型数据库\")\n        ContainerDb(clickhouse, \"ClickHouse\", \"ClickHouse\", \"BI、Logging、Metrics 等列式数据库\")\n        ContainerDb(nosql, \"NoSQL\", \"NoSQL\", \"ES、Redis、Mongo 等缓存数据库、文档数据库\")\n        ContainerDb(mq, \"消息队列\", \"Kafka\", \"Kafka、RocketMQ 等消息队列\")\n    }\n\n    Boundary(caas, \"CaaS\", \"CaaS\") {\n        Container(k8s, \"Kubernetes\",\"k8s\",\"K8S 容器平台\")\n        Container(workflow, \"编排引擎\",\"Argo\",\"流水线，流程、应用编排引擎\")\n        Container(kms, \"KMS\",\"HashiCorp Vault\",\"秘钥管理系统\")\n        Container(harbor, \"Harbor\",\"harbor\",\"容器镜像仓库\")\n        Container(git, \"IaC\",\"GitLab\",\"IaC、GitOps 源码仓库\")\n    }\n\n    Boundary(iaas, \"IaaS\", \"IaaS\") {\n        Container(vm, \"云主机\",\"vm\",\"云主机自带本地存储\")\n        Container(cbh, \"堡垒机\",\"cbh\",\"安全运维审计堡垒机\")\n        Container(s3, \"S3\",\"S3/Minio\",\"分布式对象存储\")\n        Container(nfs, \"NFS\",\"nfs\",\"共享文件存储\")\n    }\n\n    UpdateLayoutConfig($c4ShapeInRow=\"4\", $c4BoundaryInRow=\"1\")\r\n\u003c/div\u003e\r\n\r\n\u003ch2 id=\"基础设施标准化\"\u003e基础设施标准化\u003c/h2\u003e\n\u003cp\u003e基础设施标准化是平台工程建设的第一步，通过对基础设施服务进行标准化，减少开发人员和运维团队之间的摩擦，减少运维难度，大大降低出错的概率。\u003c/p\u003e","tags":[],"title":"总体架构"},{"content":"统一身份认证（Identity and Access Management，身份认证和访问控制，简称 IAM）的技术选型和实践。\n核心需求 集中管理：从一个地方管理账户和身份。 单点登录：允许用户使用一组凭据访问所有集成的系统和应用，避免记忆多个用户名和密码。 动态访问控制：基于角色和策略动态授予或撤销访问权限。 审计与合规：记录和监控访问活动，以支持合规性审计。 无缝快速集成：作为平台工程的一部分更强调“自助”，各个应用能够无缝快速接入，甚至有些应用只需要简单的权限能够不需要开发自动接入。 强化认证机制：采用多因素认证（MFA：OTP 口令、指纹、短信验证码等）方法，为重要操作增加额外防护。 技术选项 为满足以上需求，在初期技术选项时主要关注以下几个开源组件。\nkeycloak : 全面的 IAM 解决方案 ，实现用户、权限管理，单点登录、MFA 等。 Dex : 身份代理，连接多个身份源，仅作为 OpenID Connect。 Ory : 包含多个独立的组件，组成一个全家桶的解决方案。 oauth2-proxy : 反向代理工具，专为提供 OAuth 2.0 身份验证和授权服务而设计，附带基于用户、分组、角色的权限管理。 Pomerium : Pomerium 不仅仅是一个 OAuth 2.0 代理，它还提供了细粒度的访问控制，能够根据用户、组、和其他上下文属性来决定访问权限。 以下为 keycloak 和 Dex 的简单对比。为什么不把 Ory 加进来，因为没有实际用过，不便于发表意见，如果你是一个 Ory 用户欢迎补充。\n特性/工具 Keycloak Dex 类型 全面的 IAM 解决方案 身份代理 用户管理 支持内置用户管理 不直接管理用户，依赖外部身份提供者 协议支持 OpenID Connect、OAuth 2.0、SAML 2.0 OpenID Connect SSO 支持 依赖外部身份提供者实现 社交登录 支持多种社交登录选项 不直接支持，可通过连接外部身份提供者实现 角色管理 支持复杂的角色和权限管理 不直接支持 扩展性 高，适合各种规模和复杂性的需求 适合将多个身份源统一到一个认证流程的环境 使用场景 需要全面、集中式身份管理的组织 需要统一多个身份源认证，如在云原生环境中 用户界面 提供丰富的用户和管理员界面 主要是 API，没有详细的用户界面 适用性 适用于需要完整 IAM 解决方案的组织 适用于作为多个身份源代理，尤其在 Kubernetes 环境中 以下为 OAuth2 Proxy 和 Pomerium 的简单对比。\n特性/工具 OAuth2 Proxy Pomerium 主要用途 身份验证代理 边缘身份验证和访问控制 身份认证方法 支持多种 OAuth 2.0 提供商 支持 OAuth 2.0、OpenID Connect 和 SAML 安全性 基本的身份验证和授权 高级访问控制，包括路由规则和策略 单点登录（SSO） 支持 支持 部署复杂性 相对简单，易于部署 较为复杂，但提供更多的配置选项和灵活性 用户界面 主要通过配置文件和命令行界面操作 提供 Web 界面用于配置和管理 适用场景 适合于小型应用和简单的身份验证需求 适合于大型企业和复杂的访问控制需求 集成能力 适合单一应用或小型系统 适合复杂的系统架构和多应用环境 扩展性和灵活性 基本扩展性，适用于标准用例 高度可扩展和灵活，适用于复杂多变的环境 社区和支持 拥有活跃的社区 社区支持强大，提供企业级支持和服务 方案落地 为满足核心诉求，根据不同场景我们做了以下选择。\n以 keycloak + ldap 管理用户、角色、权限，用户原始数据存于 ldap 中。 以 oatuh2-proxy + keycloak oidc 作为认证代理中间件，为那些不具备认证授权机制的应用提供统一的认证授权访问控制。 一个简单的应用统一身份认证总架构示例如下。\nC4Context Person(admin, \"超级管理员\") Person_Ext(extUser, \"自助注册\") Person_Ext(socialUser, \"社交登录\") Person(developer, \"内部人员\") Boundary(iam, \"IAM\", \"iam\") { Container(keycloak, \"keycloak\", \"Quarkus\", \"Admin 控制台\n用户、组织、角色、权限管理\") Container(ldap, \"LDAP/AD\",\"ldap\", \"LDAP 或 Windows AD 作为用户源\") ContainerDb(spiUser, \"自定义用户源\", \"Java SPI\", \"通过实现 SPI 自定义用户源\") System_Ext(providers, \"身份联合\", \"Github、Gitlab、Wechart、SAML v2.0、OIDC 等\n用户身份联合\") } Boundary(sso, \"Plugins Applications\", \"sso\") { Container(backstage, \"Backstage\",\"react\",\"开发者门户\") Container(grafana, \"Grafana\",\"grafana\",\"监控告警平台\") Container(k8s, \"Kubernetes\",\"kubernetes\",\"Kubernetes Service Account\") } Boundary(apps, \"OAuth Proxy Applications\", \"sso\") { Container(proxy, \"oauth2-proxy\",\"golang\",\"认证代理\n认证和 RBAC 权限管理\n通过后透传用户、角色等信息\") Container(login, \"自研应用\",\"any\", \"需要登录才可访\n自身无用户权限管理功能\") } Rel(admin, keycloak, \"用户管理\", \"http\") Rel(developer, keycloak, \"用户自助\", \"http\") Rel(extUser, keycloak, \"用户自助注册\", \"http\") Rel(socialUser, keycloak, \"社交账户登录\", \"http\") Rel(developer, backstage, \"开发者门户\", \"http\") Rel(developer, proxy, \"SSO\", \"http\") Rel(developer, grafana, \"SSO\", \"http\") Rel(developer, k8s, \"统一身份\", \"http\") Rel(proxy, login, \"RBAC\",\"x-user-id/group/role\") Rel(keycloak, ldap, \"user storage\") Rel(keycloak, spiUser, \"user storage\") Rel(keycloak, providers, \"identity provider\") Rel(backstage, keycloak, \"plugin auth backend\") Rel(proxy, keycloak, \"oidc provider\") Rel(grafana, keycloak, \"oidc provider\") Rel(k8s, keycloak, \"oidc provider\") UpdateRelStyle(proxy, keycloak,$lineColor=\"blue\" $offsetX=\"260\") UpdateLayoutConfig($c4ShapeInRow=\"4\", $c4BoundaryInRow=\"4\")\r","date":"2023-12-19","id":5,"permalink":"/docs/platform/iam/","summary":"\u003cp\u003e统一身份认证（Identity and Access Management，身份认证和访问控制，简称 IAM）的技术选型和实践。\u003c/p\u003e\n\u003ch2 id=\"核心需求\"\u003e核心需求\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e集中管理：从一个地方管理账户和身份。\u003c/li\u003e\n\u003cli\u003e单点登录：允许用户使用一组凭据访问所有集成的系统和应用，避免记忆多个用户名和密码。\u003c/li\u003e\n\u003cli\u003e动态访问控制：基于角色和策略动态授予或撤销访问权限。\u003c/li\u003e\n\u003cli\u003e审计与合规：记录和监控访问活动，以支持合规性审计。\u003c/li\u003e\n\u003cli\u003e无缝快速集成：作为平台工程的一部分更强调“自助”，各个应用能够无缝快速接入，甚至有些应用只需要简单的权限能够不需要开发自动接入。\u003c/li\u003e\n\u003cli\u003e强化认证机制：采用多因素认证（MFA：OTP 口令、指纹、短信验证码等）方法，为重要操作增加额外防护。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"技术选项\"\u003e技术选项\u003c/h2\u003e\n\u003cp\u003e为满足以上需求，在初期技术选项时主要关注以下几个开源组件。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/keycloak/\" target=\"_blank\" rel=\"noopener\"\u003ekeycloak\u003c/a\u003e\n: 全面的 IAM 解决方案 ，实现用户、权限管理，单点登录、MFA 等。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/dexidp\" target=\"_blank\" rel=\"noopener\"\u003eDex\u003c/a\u003e\n: 身份代理，连接多个身份源，仅作为 OpenID Connect。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/ory/\" target=\"_blank\" rel=\"noopener\"\u003eOry\u003c/a\u003e\n: 包含多个独立的组件，组成一个全家桶的解决方案。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/oauth2-proxy\" target=\"_blank\" rel=\"noopener\"\u003eoauth2-proxy\u003c/a\u003e\n: 反向代理工具，专为提供 OAuth 2.0 身份验证和授权服务而设计，附带基于用户、分组、角色的权限管理。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/pomerium/\" target=\"_blank\" rel=\"noopener\"\u003ePomerium\u003c/a\u003e\n: Pomerium 不仅仅是一个 OAuth 2.0 代理，它还提供了细粒度的访问控制，能够根据用户、组、和其他上下文属性来决定访问权限。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e以下为 keycloak 和 Dex 的简单对比。为什么不把 Ory 加进来，因为没有实际用过，不便于发表意见，如果你是一个 Ory 用户欢迎补充。\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e特性/工具\u003c/th\u003e\n          \u003cth\u003eKeycloak\u003c/th\u003e\n          \u003cth\u003eDex\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e类型\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e全面的 IAM 解决方案\u003c/td\u003e\n          \u003ctd\u003e身份代理\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e用户管理\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e支持内置用户管理\u003c/td\u003e\n          \u003ctd\u003e不直接管理用户，依赖外部身份提供者\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e协议支持\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003eOpenID Connect、OAuth 2.0、SAML 2.0\u003c/td\u003e\n          \u003ctd\u003eOpenID Connect\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003eSSO\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e支持\u003c/td\u003e\n          \u003ctd\u003e依赖外部身份提供者实现\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e社交登录\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e支持多种社交登录选项\u003c/td\u003e\n          \u003ctd\u003e不直接支持，可通过连接外部身份提供者实现\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e角色管理\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e支持复杂的角色和权限管理\u003c/td\u003e\n          \u003ctd\u003e不直接支持\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e扩展性\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e高，适合各种规模和复杂性的需求\u003c/td\u003e\n          \u003ctd\u003e适合将多个身份源统一到一个认证流程的环境\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e使用场景\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e需要全面、集中式身份管理的组织\u003c/td\u003e\n          \u003ctd\u003e需要统一多个身份源认证，如在云原生环境中\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e用户界面\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e提供丰富的用户和管理员界面\u003c/td\u003e\n          \u003ctd\u003e主要是 API，没有详细的用户界面\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003cstrong\u003e适用性\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd\u003e适用于需要完整 IAM 解决方案的组织\u003c/td\u003e\n          \u003ctd\u003e适用于作为多个身份源代理，尤其在 Kubernetes 环境中\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e以下为 OAuth2 Proxy 和 Pomerium 的简单对比。\u003c/p\u003e","tags":[],"title":"统一身份认证"},{"content":"我们的平台工程建设之路。\n","date":"2023-09-07","id":6,"permalink":"/docs/platform/","summary":"\u003cp\u003e我们的平台工程建设之路。\u003c/p\u003e","tags":[],"title":"平台工程"},{"content":"云原生技术探索。\n","date":"2023-09-07","id":7,"permalink":"/docs/cloud/","summary":"\u003cp\u003e云原生技术探索。\u003c/p\u003e","tags":[],"title":"云原生"},{"content":"什么是 Jakarta EE，为什么要切换 Jakarta EE 就是 Java EE 的新名词。这里的 EE 全称是 Enterprise Edition，它是专门为企业级 Java 应用定义的一套规范，与 Java SE (Java Platform, Standard Edition) 相对应。\nJava EE 是从 Java 1.2 版本开始推出的 Java 企业级开发平台，最初的名称是 J2EE (Java 2 Platform, Enterprise Edition)。随着 Java 的发展，它的名称于 Java 1.5 版本时更改为 Java EE (Java Platform, Enterprise Edition)。2009 年 Oracle 收购了 Sun，Java EE 开始由 Oracle 通过 JCP (Java Community Process) 开发和维护。\n直到 2017 年，Oracle 将 Java EE 提交给了 Eclipse 基金会，并命名为 Eclipse Enterprise for Java。然而，由于\u0026quot;Java\u0026quot;这个名字的商标归 Oracle 所有，Eclipse 基金会无法继续使用 javax.* 和 java.*，因此，项目名称改为 Jakarta EE。\nJakarta EE 包含了许多技术规范和 API，涵盖了 Web 应用、数据库访问、消息传递、事务处理、安全性等方面的功能，其中包括但不限于下列规范：\nJakarta Servlet：前身是 J2EE Servlet，定义了如何管理 HTTP 请求的规范。这应该是大部分 Java Web 开发者最熟悉的，同时也是许多其它规范的基础。\nJakarta Server Page (JSP)：服务端动态生成网页的技术，可以看作 Java 版本的 PHP 和 ASP。\nJakarta Websocket：定义了一套 WebSocket 连接相关的 API，用于实现全双工通信。\nJakarta RESTful Web Services：开发符合 REST 原则的 Web 服务的一套规范。\nJakarta JSON Binding：Java 类和 JSON 字符串互相转换的规范。\nJakarta XML Binding：Java 类和 XML 的映射规范。\nJakarta Enterprise Beans (EJB)：这个规范比较复杂，包括 EJB 容器，RMI（远程过程调用），并发控制，依赖注入等。\nJakarta Persistent (JPA)：ORM 规范，定义了 Java 类和数据库表直接的映射规范。\nJakarta Transactions (JTA)：包含了事务相关的接口和注解类，也用于管理分布式事务。\nJakarta Messaging (JMS)：消息系统的规范，用于实现异步消息传递，比如 Apache 的 ActiveMQ 就实现了这套规范。\n对研发的影响 依赖包坐标和版本号变更 比如常见的 servlet-api：\n\u0026lt;!-- 老版本 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javax.servlet\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javax.servlet-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.1.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- 新版本 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;jakarta.servlet\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jakarta.servlet-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;6.1.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt;\rpackage namespace 变更 比如：\n// 老版本 import javax.servlet.Filter; // 新版本 import jakarta.servlet.Filter;\r兼容性问题 如果不兼容会发生什么，比如：\nServlet 运行期错误 javax.servlet.ServletRequest can not cast to jakarta.servlet.ServletRequest\r数据库扫描失败映射错误 比如下面定义是 javax.persistence.Table，开源或者自定义的数据库中间件件一般习惯按注解 jakarta.persistence.Table 进行扫描：\nimport javax.persistence.Id; import javax.persistence.Table; @Table(name = \u0026#34;mt_field_extra\u0026#34;) public class FieldExtra { @Id String id; }\rprivate static void scanTableName(Class\u0026lt;?\u0026gt; clazz, PersistMeta meta, boolean mapCamelCaseToUnderscore) { jakarta.persistence.Table table = clazz.getAnnotation(jakarta.persistence.Table.class); String tableName; if (null != table) { tableName = table.name(); } else { tableName = nameConvert(clazz.getSimpleName(), mapCamelCaseToUnderscore); } }\r如果项目能直接升级到最新版本当然更好，但是作为中间件团队提供的组件，往往需要在过渡期间提供一种兼容两种模式的方案，既能让原有老服务正常使用，又兼容 Spring Boot 3+ Jakarta EE 9+新服务。\nJakarta EE 兼容是一个复杂的课题，当前只记录 package namespace 差异解决方法。\nMaven 本身特性说明 父子 POM 依赖继承 假设父 POM 使用 dependencyManagement 定义如下：\n\u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jakarta\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jakarta-java21\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jakarta-java23\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt;\rMaven 官方文档说明：\nNOTE: In two of these dependency references, we had to specify the \u0026lt;type/\u0026gt; element. This is because the minimal set of information for matching a dependency reference against a dependencyManagement section is actually {groupId, artifactId, type, classifier}. In many cases, these dependencies will refer to jar artifacts with no classifier. This allows us to shorthand the identity set to {groupId, artifactId}, since the default for the type field is jar, and the default classifier is null.\n基于以上说明，假设子模块，依次按以下方式填写 dependency，实际生效的是哪个：\n\u0026lt;dependencies\u0026gt; \u0026lt;!-- 方式 1 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- 方式 2 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- 方式 3 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;classifier\u0026gt;jakarta\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- 方式 4，同时引入 2 个 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.tester\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rocketmq-support\u0026lt;/artifactId\u0026gt; \u0026lt;classifier\u0026gt;jakarta-java23\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt;\rProfile 继承和传递 假设有个第三方组件，比如 rocketmq-support，他定义了一个 profile 叫 jakarta，独立加了 dependencies，deploy 到中央仓库。\n\u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;jakarta\u0026lt;/id\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;jakarta.servlet\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jakarta.servlet-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/profile\u0026gt;\r有另外一个组件 B 依赖了 rocketmq-support，并且也定义了一个 jakarta profile 激活。那么这个组件 B 会自动依赖 jakarta.servlet-api 吗？\n不会。profile 为自身编译期服务，deploy 后失效。\n如果 deploy 后还能依赖传递的话，那某些人定义写一些恶意代码和插件然后定义一堆通用的 profile，比如大家喜欢叫 dev，然后 deploy 就能变相投毒了。\n如果父 pom 定义了 profile，子模块直接引用，是会继承生效的。\n主流的辅助工具 Tomcat Migration Tool Tomcat Migration Tool 是 Apache Tomcat 提供的迁移工具。\njava -jar jakartaee-migration-*-shaded.jar \u0026lt;source\u0026gt; \u0026lt;destination\u0026gt;\rThe source should be a path to a compressed archive, a folder or an individual file. The destination will be created at the specified path as a resource of the same type as the source.\n用途：\n字节码转换 已有项目，甚至无源码项目，直接转换。只负责转换制品，要想给别人用需自己手动 deploy 一个 javax war 转换后放到 Tomcat 10，理论上可运行 缺陷：\n解决不了本地开发 Debug 期间编译、运行的问题，如果不兼容本地启动、Test 失败 另外 Tomcat 10 提供了一种自动转换的方法，参考文档：https://tomcat.apache.org/migration-10.html 将 war 放到 webapps-javaee 目录下，就会自动转换后放到 webapp 下运行。然而这种方案最大的问题在于：\n必须是基于外置 Tomcat，不支持 Spring Boot Jar 形式运行。 转换需要时间，这是时间基本上都是 1~10 分钟之间，对应用重启、快速扩缩容都有很大的副作用。 maven-shade-plugin 用途：\n字节码转换 需要配置详细的转换规则 缺陷：\n解决不了本地开发 Debug 期间编译、运行的问题，本地启动、Test 失败 maven-assembly-plugin 上面我们都是假设只有 javax 和 jakarta namespace 差异，只需要转换字节码。但是，\n如果有某个 Java 方法不兼容需要重写一个版本怎么办 配置文件比如 xml 有差异怎么办 assembly-plugin 就可以帮助我们通过 include、exclude 不同的源码、resource、依赖项，重组编译发布不同的包。\n这是适合复杂不兼容的代码，但是对于多模块项目，需要某个模块开发指定 assembly xml，会非常痛苦。\n目前其他几种工具只处理 javax 和 jakarta package 差异，后续肯定会遇到除了 package 不同，接口或使用方式也不兼容的情况，等遇到了再单独处理。\nOpenRewrite OpenRewrite 迁移菜谱 Migrate to Jakarta EE 9 。\n# 命令行运行 mvn -U org.openrewrite.maven:rewrite-maven-plugin:run \\ -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:RELEASE \\ -Drewrite.activeRecipes=org.openrewrite.java.migrate.jakarta.JavaxMigrationToJakarta \\ -Drewrite.exportDatatables=false\r用途：\n源码级别转换，直接自动改代码 除了代码，还能自动改写 pom 依赖 缺陷：\n多模块目前适配还不完善，对于多模块，需要每个模块处理一次 复杂代码可能转换失败，失败后可能导致编译失败，无法一键编译，需要人工介入 改 pom 时，他会自己强制指定版本号，实际上我们希望用父 pom 管理版本号 速度稍慢，遍历并修改文件源码，然后编译 transformer-maven-plugin transformer-maven-plugin 是 eclipse 出的字节码和配置文件转换工具，默认内置了一些 jakarta 的替换规则。\n它能帮我们实现：\n同时打包（或发布）出 javax 和 jakarta 两个包，通过 classifier 区分，比如设置 javax 默认 classifier 为 null，转换后的版本设置 classifier 为 jakarta。 只打包（或发布）javax 和 jakarta 任意一个版本。 web.xml 或 web-fragment.xml 等相关 xml 定义转换。 \u0026lt;plugin\u0026gt; \u0026lt;!-- 这个插件自动把 javax 转为 jakarta，打包出 javax 和 jakarta 两个包，通过 classifier 区分 --\u0026gt; \u0026lt;groupId\u0026gt;org.eclipse.transformer\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;transformer-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; \u0026lt;extensions\u0026gt;true\u0026lt;/extensions\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;!-- javax 替换成 jakarta --\u0026gt; \u0026lt;id\u0026gt;jakarta-jar\u0026lt;/id\u0026gt; \u0026lt;phase\u0026gt;package\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;jar\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;rules\u0026gt; \u0026lt;jakartaDefaults\u0026gt;true\u0026lt;/jakartaDefaults\u0026gt; \u0026lt;/rules\u0026gt; \u0026lt;artifact\u0026gt; \u0026lt;groupId\u0026gt;${project.groupId}\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;${project.artifactId}\u0026lt;/artifactId\u0026gt; \u0026lt;/artifact\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt;\r用途：\n字节码转换 支持 web 相关 xml 定义自动替换，比如 web-fragment.xml xmlns=\u0026quot;http://xmlns.jcp.org/xml/ns/javaee\u0026quot; 转换和 deploy 可以一步到位，速度快很方便 如果是多模块，可以在根父模块声明一次，一键全部编译 缺陷：\n不处理 pom 依赖关系，发布出的 Jakarta 版本依赖项都遵循原 pom 声明 此插件运行需要 Java 21 版本，发布业务包的时候，必须使用 Java 21 编译，编译目标 release 版本可以是 Java 8，在 pom 中增加以下设置：\n\u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;21\u0026lt;/java.version\u0026gt; \u0026lt;maven.compiler.release\u0026gt;8\u0026lt;/maven.compiler.release\u0026gt; \u0026lt;/properties\u0026gt;\rweb-fragment.xml 适配 一般咱们典型的 web-fragment 定义有如下两个版本，3.0 和 3.1：\n3.0 版本：\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-fragment xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns=\u0026#34;http://java.sun.com/xml/ns/javaee\u0026#34; xsi:schemaLocation=\u0026#34;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-fragment_3_0.xsd\u0026#34; version=\u0026#34;3.0\u0026#34; metadata-complete=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;/web-fragment\u0026gt;\r3.1 版本：\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-fragment xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-fragment_3_1.xsd\u0026#34; version=\u0026#34;3.1\u0026#34; metadata-complete=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;/web-fragment\u0026gt;\r其中涉及 jakarta 修改的替换的是其中的 xmlns、xsi、version 字段。\nTomcat 8 以后支持 3.1 版本并兼容 3.0 版本，Tomcat 7 对应 3.0 版本。\ntransformer-maven-plugin 已经不支持 3.0 版本的替换，所以如果还在用 3.0 的需要咱们手动改成以上 3.1 版本的定义，transformer-maven-plugin 在转换的过程中才能自动升级到 jakarta，自动升级后，升级到 5.0 后的结果如下：\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-fragment xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns=\u0026#34;https://jakarta.ee/xml/ns/jakartaee\u0026#34; xsi:schemaLocation=\u0026#34;https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/web-fragment_5_0.xsd\u0026#34; version=\u0026#34;5.0\u0026#34; metadata-complete=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;/web-fragment\u0026gt;\r跳过转换 我们的 maven 项目大部分都是多模块，对于打包成 war 自运行不需要发布给别人用的项目，一般都不需要转换，可以设置 properties transform.skip=true 跳过。\n\u0026lt;properties\u0026gt; \u0026lt;!-- 不发布 --\u0026gt; \u0026lt;maven.deploy.skip\u0026gt;true\u0026lt;/maven.deploy.skip\u0026gt; \u0026lt;!-- 不转换 --\u0026gt; \u0026lt;transform.skip\u0026gt;true\u0026lt;/transform.skip\u0026gt; \u0026lt;/properties\u0026gt;\r实施方案 Classifier vs Version 业界主流方案就是用版本号区分或者用 classifier 区分这两种方案。\nclassifier 最主要的问题是无法通过父 pom 继承，这样将导致各个业务方需要大量改 pom.xml 文件。\n假设一个项目依赖了 app-a，而 app-a 又依赖 b、c、d.\n首先因为父 pom 定义 classifier 并不会继承。那么，我是不是指定 app-a 的 classifier 就行了。\n不是，除非 app-a 的特定 classifier 自身 pom 里已经为给个模块指定了 classifier，否则 app-a 依赖的各个都要重新指定一遍，这就使用 pom 文件长得又长又臭。如果哪天 app-a 又新增依赖 e, 但是使用者漏掉了 e classifier 声明的，就可能带来问题，这是很危险的动作。\n所以我们最终选择用版本号来区分。\n使用特定版本 版本号规则，在原版本基础上增加固定前缀：9999.${project.version}，如原 9.6.0 对应的 jakarta 版本号是 9999.9.6.0。\n父 pom 区分版本号，Spring Boot 3.x 版本依赖，重申版本号。\n这样各个使用者，只需要选择不同的父 pom，遵循父 pom 版本定义，dependency 可以原样不变。\n如何打包发布 目前暂定选择 transformer-maven-plugin，他不完美，但是足够快，相对稳定。\n发布目标：两次发布，第一次发布常规版本，第二次发布自动转换后的版本，版本号增加前缀。\n发布步骤：\n在公司级父 pom 增加如下 profile：\n\u0026lt;profiles\u0026gt; \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;jakarta-transformer\u0026lt;/id\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.eclipse.transformer\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;transformer-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; \u0026lt;extensions\u0026gt;true\u0026lt;/extensions\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;!-- 此处配置 javax 替换成 jakarta，artifactId 不变，无 classifier --\u0026gt; \u0026lt;id\u0026gt;jakarta-jar\u0026lt;/id\u0026gt; \u0026lt;phase\u0026gt;package\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;jar\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;rules\u0026gt; \u0026lt;jakartaDefaults\u0026gt;true\u0026lt;/jakartaDefaults\u0026gt; \u0026lt;/rules\u0026gt; \u0026lt;artifact\u0026gt; \u0026lt;groupId\u0026gt;${project.groupId}\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;${project.artifactId}\u0026lt;/artifactId\u0026gt; \u0026lt;/artifact\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/profile\u0026gt; \u0026lt;/profiles\u0026gt;\r发布 jakarta 版本时，先改版本号增加前缀，再指定 profile 发布：\n# 获取当前版本号 mvn help:evaluate -Dexpression=project.version -q -DforceStdout # 如果项目都是自己写版本号的，使用 version 插件设置新版本号，增加前缀 mvn versions:set -DnewVersion=9999.9.6.0 -DgenerateBackupPoms=false # 重新发布，指定 -Pjakarta profile，父 pom 里的插件自动转换 javax mvn deploy -Pjakarta-transformer # 如果使用 flatten-maven-plugin 插件管理版本号的，设置 revision mvn deploy -Drevision=9999.9.6.0 -Pjakarta-transformer\r","date":"2025-09-14","id":8,"permalink":"/blog/javax-jakarta-compatibility/","summary":"\u003ch2 id=\"什么是-jakarta-ee为什么要切换\"\u003e什么是 Jakarta EE，为什么要切换\u003c/h2\u003e\n\u003cp\u003eJakarta EE 就是 Java EE 的新名词。这里的 EE 全称是 Enterprise Edition，它是专门为企业级 Java 应用定义的一套规范，与 Java SE (Java Platform, Standard Edition) 相对应。\u003c/p\u003e\n\u003cp\u003eJava EE 是从 Java 1.2 版本开始推出的 Java 企业级开发平台，最初的名称是 J2EE (Java 2 Platform, Enterprise Edition)。随着 Java 的发展，它的名称于 Java 1.5 版本时更改为 Java EE (Java Platform, Enterprise Edition)。2009 年 Oracle 收购了 Sun，Java EE 开始由 Oracle 通过 JCP (Java Community Process) 开发和维护。\u003c/p\u003e\n\u003cp\u003e直到 2017 年，Oracle 将 Java EE 提交给了 Eclipse 基金会，并命名为 Eclipse Enterprise for Java。然而，\u003cstrong\u003e由于\u0026quot;Java\u0026quot;这个名字的商标归 Oracle 所有，Eclipse 基金会无法继续使用 \u003ccode\u003ejavax.*\u003c/code\u003e 和 \u003ccode\u003ejava.*\u003c/code\u003e，因此，项目名称改为 Jakarta EE\u003c/strong\u003e。\u003c/p\u003e","tags":["Java","Spring Boot"],"title":"Javax 和 Jakarta 过渡期兼容方案"},{"content":"在日常开发中，我们经常遇到类似如下需求：\n项目组提供了 SDK，某个 API 已经被标记为废弃，但是大家迟迟不升级，项目组还需要花费时间维护已经废弃的 API。 有些项目在使用 JDK 已经废弃的 API，这些废弃 API 在更高版本 JDK 中已经删除，导致推动升级 JDK 比较困难。 有些项目会跨版本混合编译，比如用 Java 8 编译运行在 Java 21 上，常见的错误比如 javafx.util 在 Java 21 默认已经去掉了，就会出现编译成功却运行时失败。 所以我们想提供一种方案，能不能在编译期就强制禁用某些 API，主动阻止让编译不通过，提前报错及早发现及早处理。\n实现方案 当前我们使用 maven forbiddenapis 插件，结合 CI 流程来实现。\n执行效果，如果有使用禁用的 API，能看到类似如下错误提示，编译失败并给出原因。\n12:40:30.647 [INFO] 12:40:30.648 [INFO] --- forbiddenapis:3.9:check (check-forbidden-apis) @ app-biz --- 12:40:30.657 [INFO] Scanning for classes to check... 12:40:30.661 [INFO] Reading bundled API signatures: jdk-deprecated-1.8 12:40:30.694 [INFO] Reading API signatures: /usr/share/maven/conf/forbidden-apis.txt 12:40:30.694 [INFO] Loading classes to check... 12:40:30.695 [INFO] Scanning classes for violations... 12:40:30.849 [ERROR] Forbidden class/interface use: javafx.util.Pair [禁止使用 JavaFX 相关类] 12:40:30.850 [ERROR] in com.tester.HomeController (HomeController.java:11) 12:40:30.865 [ERROR] Scanned 13 class file(s) for forbidden API invocations (in 0.21s), 1 error(s). 12:40:30.872 [INFO] ------------------------------------------------------------------------ 24784 [INFO] --- forbiddenapis:3.9:check (check-forbidden-apis) @ app-api --- 24812 [INFO] Scanning for classes to check... 24884 [INFO] Reading bundled API signatures: jdk-deprecated-1.8 25016 [INFO] Reading API signatures: /usr/share/maven/conf/forbidden-apis.txt 25017 [INFO] Loading classes to check... 25106 [INFO] Scanning classes for violations... 25984 [ERROR] Forbidden method invocation: java.net.URLEncoder#encode(java.lang.String) [Deprecated in Java 1.8] 25984 [ERROR] in com.tester.FormBody$FormBodyBuilder (FormBody.java:60) 26110 [ERROR] Scanned 660 class file(s) for forbidden API invocations (in 1.31s), 2 error(s). 26113 [INFO] Maven 核心配置 首先，在父 pom 里增加了以下片段，此内容主要含义：\n在存在 ${env.MAVEN_HOME}/conf/forbidden-apis.txt 文件时激活此 profile，以便确保缺少 txt 文件时不会报错。 默认激活了 forbiddenapis 插件的 jdk-deprecated 规则。 增加了我们定制的 forbidden-apis.txt 规则，此文件放在 maven 的基础镜像里。 \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;forbidden\u0026lt;/id\u0026gt; \u0026lt;activation\u0026gt; \u0026lt;file\u0026gt; \u0026lt;exists\u0026gt;${env.MAVEN_HOME}/conf/forbidden-apis.txt\u0026lt;/exists\u0026gt; \u0026lt;/file\u0026gt; \u0026lt;/activation\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;de.thetaphi\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;forbiddenapis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.9\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;detail\u0026gt;true\u0026lt;/detail\u0026gt; \u0026lt;failOnUnsupportedJava\u0026gt;false\u0026lt;/failOnUnsupportedJava\u0026gt; \u0026lt;ignoreSignaturesOfMissingClasses\u0026gt;true\u0026lt;/ignoreSignaturesOfMissingClasses\u0026gt; \u0026lt;bundledSignatures\u0026gt; \u0026lt;bundledSignature\u0026gt;jdk-deprecated\u0026lt;/bundledSignature\u0026gt; \u0026lt;/bundledSignatures\u0026gt; \u0026lt;signaturesFiles\u0026gt; \u0026lt;signaturesFile\u0026gt;${env.MAVEN_HOME}/conf/forbidden-apis.txt\u0026lt;/signaturesFile\u0026gt; \u0026lt;/signaturesFiles\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;id\u0026gt;check-forbidden-apis\u0026lt;/id\u0026gt; \u0026lt;phase\u0026gt;process-classes\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;check\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;id\u0026gt;test-check-forbidden-apis\u0026lt;/id\u0026gt; \u0026lt;phase\u0026gt;process-test-classes\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;testCheck\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/profile\u0026gt;\r我的项目需要紧急发版，来不及改代码，如何禁用以上插件，在 pom.xml 中增加以下属性，或通过 mvn 命令行 -Dforbiddenapis.skip=true 传递此参数：\n\u0026lt;properties\u0026gt; \u0026lt;forbiddenapis.skip\u0026gt;true\u0026lt;/forbiddenapis.skip\u0026gt; \u0026lt;/properties\u0026gt;\rforbiddenapis 规则详解 forbiddenapis 插件有内置规则和自定义规则，规则名字叫 signatures。\nforbiddenapis 插件默认已经内置了一些规则 signatures，参考：bundled-signatures 。\n主要默认规则：\njdk-unsafe-*: Signatures of \u0026ldquo;unsafe\u0026rdquo; methods that use default charset, default locale, or default timezone. For server applications it is very stupid to call those methods, as the results will definitely not what the user wants (for Java* = 1.7, 1.8, 9,\u0026hellip;, 24; Ant / Maven / Gradle automatically add the compile Java version). jdk-deprecated-*: This disallows all deprecated methods from the JDK (for Java*= 1.7, 1.8, 9,\u0026hellip;, 24; Ant / Maven / Gradle automatically add the compile Java version). jdk-internal-*: Lists all internal packages of the JDK as of Security.getProperty(\u0026ldquo;package.access\u0026rdquo;). Calling those methods will always trigger security manager and is completely forbidden from Java 9 on (for Java*= 1.7, 1.8, 9,\u0026hellip;, 24; Ant / Maven / Gradle automatically add the compile Java version, since forbiddenapis v2.1). jdk-non-portable: Signatures of all non-portable (like com.sun.management.HotSpotDiagnosticMXBean) or internal runtime APIs (like sun.misc.Unsafe). This is a superset of jdk-internal. Internally this is implemented using heuristics: Any reference to an API that is part of the Java runtime (rt.jar, extensions, Java 9+ java./ jdk. core modules) and is not part of the Java SE specification packages (mainly java, javax, but also org.ietf.jgss, org.omg, org.w3c.dom, and org.xml.sax) is forbidden (any java version, no specific JDK version, since forbiddenapis v2.1). jdk-system-out: On server-side applications or libraries used by other programs, printing to System.out or System.err is discouraged and should be avoided (any java version, no specific JDK version). jdk-reflection: Reflection usage to work around access flags fails with SecurityManagers and likely will not work anymore on runtime classes in Java 9 or later (any java version, no specific JDK version, since forbiddenapis v2.1). commons-io-unsafe-*: If your application uses the famous Apache Common-IO library, this adds signatures of all methods that depend on default charset (for versions* = 1.0, 1.1, 1.2, 1.3, 1.4, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8.0, 2.9.0, 2.10.0, 2.11.0, 2.12.0, 2.13.0, 2.14.0, 2.15.0, 2.15.1, 2.16.0, 2.16.1, 2.17.0, 2.18.0). 通过 txt 文件自定义规则，规则语法：signatures-syntax 。\nClass reference: A binary/fully-qualified class name (including package). You may use the output of Class.getName(). Be sure to use correct name for inner classes! Example: java.lang.String A package/class glob pattern: To forbid all classes from a package, you may use glob patterns, like sun.misc.**(** matches against package boundaries). A field of a class: package.Class#fieldName A method signature: It consists of a binary class name, followed by # and a method name including method parameters: java.lang.String#concat(java.lang.String) – All method parameters need to use fully qualified class names! Instead of method parameters, the special wildcard string ** may be used to add all variants of a method, regardless of their parameter types. To refer to instance constructors, use the method name \u0026lt;init\u0026gt;, e.g. java.lang.Integer#\u0026lt;init\u0026gt;(int). The error message displayed when the signature matches can be given at the end of each signature line using \u0026ldquo;@\u0026rdquo; as separator:\njava.lang.String @ You are crazy that you disallow strings To not repeat the same message after each signature, you can prepend signatures with a default message. Use a line starting with \u0026ldquo;@defaultMessage\u0026rdquo;.\n@defaultMessage You are crazy that you disallow substrings java.lang.String#substring(int) java.lang.String#substring(int,int) 这里着重需要注意：\n按方法名定义时，一定要定义好参数类型，否则不生效。 按包名定义时，一定要区分好一个 * 和两个 **，一个*只能匹配一级，两个**能匹配 N 级。 ","date":"2025-09-09","id":9,"permalink":"/blog/ci-maven-forbidden-api/","summary":"\u003cp\u003e在日常开发中，我们经常遇到类似如下需求：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e项目组提供了 SDK，某个 API 已经被标记为废弃，但是大家迟迟不升级，项目组还需要花费时间维护已经废弃的 API。\u003c/li\u003e\n\u003cli\u003e有些项目在使用 JDK 已经废弃的 API，这些废弃 API 在更高版本 JDK 中已经删除，导致推动升级 JDK 比较困难。\u003c/li\u003e\n\u003cli\u003e有些项目会跨版本混合编译，比如用 Java 8 编译运行在 Java 21 上，常见的错误比如 \u003ccode\u003ejavafx.util\u003c/code\u003e 在 Java 21 默认已经去掉了，就会出现编译成功却运行时失败。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e所以我们想提供一种方案，能不能在编译期就强制禁用某些 API，主动阻止让编译不通过，提前报错及早发现及早处理。\u003c/p\u003e\n\u003ch2 id=\"实现方案\"\u003e实现方案\u003c/h2\u003e\n\u003cp\u003e当前我们使用 maven \u003ca href=\"https://github.com/policeman-tools/forbidden-apis\" target=\"_blank\" rel=\"noopener\"\u003eforbiddenapis\u003c/a\u003e\n 插件，结合 CI 流程来实现。\u003c/p\u003e\n\u003cp\u003e执行效果，如果有使用禁用的 API，能看到类似如下错误提示，编译失败并给出原因。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.647 [INFO]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.648 [INFO] --- forbiddenapis:3.9:check (check-forbidden-apis) @ app-biz ---\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.657 [INFO] Scanning for classes to check...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.661 [INFO] Reading bundled API signatures: jdk-deprecated-1.8\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.694 [INFO] Reading API signatures: /usr/share/maven/conf/forbidden-apis.txt\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.694 [INFO] Loading classes to check...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.695 [INFO] Scanning classes for violations...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.849 [ERROR] Forbidden class/interface use: javafx.util.Pair [禁止使用 JavaFX 相关类]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.850 [ERROR]   in com.tester.HomeController (HomeController.java:11)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.865 [ERROR] Scanned 13 class file(s) for forbidden API invocations (in 0.21s), 1 error(s).\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e12:40:30.872 [INFO] ------------------------------------------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e24784 [INFO] --- forbiddenapis:3.9:check (check-forbidden-apis) @ app-api ---\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e24812 [INFO] Scanning for classes to check...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e24884 [INFO] Reading bundled API signatures: jdk-deprecated-1.8\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e25016 [INFO] Reading API signatures: /usr/share/maven/conf/forbidden-apis.txt\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e25017 [INFO] Loading classes to check...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e25106 [INFO] Scanning classes for violations...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e25984 [ERROR] Forbidden method invocation: java.net.URLEncoder#encode(java.lang.String) [Deprecated in Java 1.8]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e25984 [ERROR]   in com.tester.FormBody$FormBodyBuilder (FormBody.java:60)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e26110 [ERROR] Scanned 660 class file(s) for forbidden API invocations (in 1.31s), 2 error(s).\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e26113 [INFO]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003ch3 id=\"maven-核心配置\"\u003eMaven 核心配置\u003c/h3\u003e\n\u003cp\u003e首先，在父 pom 里增加了以下片段，此内容主要含义：\u003c/p\u003e","tags":["CICD","Java"],"title":"CI: Maven 如何在编译时禁止调用某些特定 API"},{"content":"使用 Spring Security Resource Server 和 Keycloak，实现用户 RBAC、ABAC 授权，主要介绍：\nSpring Security Resource Server 如何与标准 OAuth2 协议集成。 Spring Security Resource Server 如何与 Keycloak Authorization Server 集成。 如何校验和解析 JWT Token，获取用户详细信息。 如何使用 keycloak admin client 获取更多信息，执行更高级动作。 Spring Security JWT Token 模式下如何方便本地 Debug，如何通过 keycloak admin client 模拟用户登录。 在开始之前我们先解释几点：\nKeycloak 官方的 Spring Boot Starter 后续将逐渐停止维护，所以我们只用 keycloak 的 client，自己实现一部分代码，有 client sdk 实现起来很容易。 Spring Security OAuth 2.0 Resource Server 也有多种集成方式，这里我们只实现 JWT 这一种，并且是 sessionless 的，也就是只负责授权不负责 登录认证， 登录由网关通过 oauth2-proxy 实现，详情可参考另一篇博客介绍 traefik-oauth2-proxy-keycloak 。 ","date":"2024-11-24","id":10,"permalink":"/blog/spring-security-with-keycloak-oauth2/","summary":"\u003cp\u003e使用 Spring Security Resource Server 和 Keycloak，实现用户 RBAC、ABAC 授权，主要介绍：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSpring Security Resource Server 如何与标准 OAuth2 协议集成。\u003c/li\u003e\n\u003cli\u003eSpring Security Resource Server 如何与 Keycloak Authorization Server 集成。\u003c/li\u003e\n\u003cli\u003e如何校验和解析 JWT Token，获取用户详细信息。\u003c/li\u003e\n\u003cli\u003e如何使用 keycloak admin client 获取更多信息，执行更高级动作。\u003c/li\u003e\n\u003cli\u003eSpring Security JWT Token 模式下如何方便本地 Debug，如何通过 keycloak admin client 模拟用户登录。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e在开始之前我们先解释几点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eKeycloak 官方的 Spring Boot Starter 后续将逐渐停止维护，所以我们只用 keycloak 的 client，自己实现一部分代码，有 client sdk 实现起来很容易。\u003c/li\u003e\n\u003cli\u003eSpring Security \u003ca href=\"https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html\" target=\"_blank\" rel=\"noopener\"\u003eOAuth 2.0 Resource Server\u003c/a\u003e\n 也有多种集成方式，这里我们只实现 \u003ccode\u003eJWT\u003c/code\u003e 这一种，并且是 sessionless 的，也就是只负责授权不负责 \u003ccode\u003e登录认证\u003c/code\u003e， 登录由网关通过 oauth2-proxy 实现，详情可参考另一篇博客介绍 \u003ca href=\"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/\" target=\"_blank\" rel=\"noopener\"\u003etraefik-oauth2-proxy-keycloak\u003c/a\u003e\n。\u003c/li\u003e\n\u003c/ol\u003e","tags":["spring","idaas","oauth2","keycloak"],"title":"Spring Security 集成 Keycloak 实现用户 RBAC、ABAC 授权"},{"content":"基于 K8S 部署 Backstage，集成 oauth2-proxy 和 Keycloak，实现用户管理、认证和授权，配置详解和原理介绍。\n如果你遇到以下问题或诉求，可以参考此文档。\nBackstage 接入 oauth2-proxy，登录或认证失败。 Backstage 实现 RBAC、ABAC 授权管理，以及如何实现自定义权限。 oauth2-proxy 对接 keycloak，参数不理解或者配置一直错误。 在开始之前，我们先了解一个点，Backstage 官方开源有开箱即用的容器镜像，也有丰富的插件生态，然而区别于其他插件类应用，Backstage 有自己的特点：\nBackstage 插件分为 frontend 和 backend，一个完整的插件可能包含两种，也可能只包含其中一种。\n开源发布的开箱即用的容器镜像，只包含基础插件，一般只用来作为初次学习使用。\n如果想使用其他插件，需要做一些编码工作，一般步骤如下。\n使用 npx @backstage/create-app@latest 创建一个基础项目。 按插件要求安装插件，配置插件菜单、UI 效果、权限、认证信息等，每个插件要求不同。 按需开发自己的插件。 编译成新容器镜像，某些插件可能还需要在容器中额外安装一些依赖包，部署时使用此容器镜像。 基本上每个插件都有自己的配置要求，需根据插件文档配置 app-config.yaml。\n可以把 Backstage 类比于 Spring Boot，提供了 starter、framework、plugins，如果想真实使用，需要自己引入依赖，编译成自己的镜像发布部署，欢迎 star 我们基于 Backstage 定制的开源项目 xlabs-developer-platform 。\n核心组件介绍：\n用户同步使用 Red Hat 贡献的社区开源插件 @backstage-community/plugin-catalog-backend-module-keycloak ，将 keycloak 用户同步到 Backstage 数据库，后面我们会提到为什么需要这一步。 认证使用官方内置的 OAuth 2 Proxy Provider . 授权，权限管理 Permissions，支持 RBAC、ABAC， 使用 Red Hat 贡献的社区开源插件 @backstage-community/plugin-rbac ，虽然插件名字叫 RBAC，但是实际上支持 ABAC。注意 Spotify 也有 RBAC 插件 需要购买 License 才能用，两个插件别弄混了。 以上认证和授权是独立的，如果你只需要认证，不需要授权，那可以不需要 RBAC 插件。\n整体架构流程图：\nsequenceDiagram participant User as User participant proxy as oauth2-proxy participant Backstage as Backstage participant Keycloak as Keycloak Note over Backstage,Keycloak: Backstage Sync Users Backstage-\u003e\u003eKeycloak: Fetch users and groups from Keycloak Keycloak--\u003e\u003eBackstage: Save user and group to backstage User-\u003e\u003eproxy: Access oauth2-proxy (Browser) proxy-\u003e\u003eproxy: Check if user is authenticated by cookie session proxy-\u003e\u003eKeycloak: Redirect to Keycloak for login Keycloak--\u003e\u003eUser: Display Keycloak login page User-\u003e\u003eKeycloak: Submit credentials Keycloak--\u003e\u003eproxy: Return access token proxy-\u003e\u003eBackstage: Forward request with token and user info in Header Backstage-\u003e\u003eBackstage: Validate user existence, check user permissions Backstage--\u003e\u003eproxy: Respond with data proxy--\u003e\u003eUser: Return data from Backstage\r安装部署配置详解和原理分析 在开始之前，我们先特别注意几个比较容易踩坑的点：\nBackstage OAuth 2 Proxy Provider 除了进行用户登录认证外，还会校验用户是否已经存在，如果不存在会返回错误，所以我们需要使用 @backstage-community/plugin-catalog-backend-module-keycloak 插件，先将用户同步到 backstage 里。 Backstage 的 Sign In resolver 依赖 oauth2-proxy 传递的 http header，所以我们把 backstage 作为 oauth2-proxy 的 upstream，网络流量是 User -\u0026gt; oauth2-proxy -\u0026gt; Backstage。下面我们会单独说明依赖哪些 Header。 oauth2-proxy 以 email 作为用户校验和识别，所以尽量为用户设置 email，否则后续会有很多额外配置和开发工作。等报错了就知道怎么解决了，能解决，只是带来额外的工作。 下面的安装部署配置，都在我们的部署脚本 xlabs-ops 源码里，可供参考，方便复制粘贴。\nKeycloak 配置准备 Keycloak 需要准备两对 client id 和 client secret，都是 OpenID Connect , 分别给 Backstage @backstage-community/plugin-catalog-backend-module-keycloak 插件同步用户用， 和 oauth2-proxy 登录认证使用。如果你想省事，也可以把两个 client 合并成一个。\n给 Backstage 同步用户使用，假设 id 叫 backstage，需要在 keycloak 开启 Authorization，并在 Service Account Roles 授权查询 users 和 groups 的权限。他的作用就是通过 keycloak 的 api 将 users 和 groups 同步到 backstage，如果没有权限，在 backstage 的日志里应该能看到一些相应的错误信息。\n给 oauth2-proxy 登录认证用，假设 id 叫 oauth2-proxy, 需要在 keycloak 设置 Valid redirect URIs 为你 backstage 的回调地址，支持通配符，比如 https://backstage.nxest.com/*，并设置 Audience 和 Groups scope， 否则登录失败。具体设置 scope 方式请参考官方文档 oauth2-proxy-keycloak-oidc 和我的另外一遍博客 traefik-oauth2-proxy-keycloak 。\noauth2-proxy 配置 oauth2-proxy 也有很多部署方式，以 K8S 内部署 bitnami/oauth2-proxy helm chart 为例，核心配置参考如下。\nconfiguration: clientID: oauth2-proxy clientSecret: copy-from-keycloak-oauth2-proxy-client-secret # openssl rand -base64 32 | tr -- \u0026#39;+/\u0026#39; \u0026#39;-_\u0026#39; cookieSecret: \u0026#34;Vr0_r5nWZPLAxNgI9ZIU2JnE24brhPbkZ0sUN_phwJo==\u0026#34; # https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview # oauth2_proxy.cfg 是 toml，注意等号后面 String 类型需要引号 content: | provider = \u0026#34;keycloak-oidc\u0026#34; provider_display_name = \u0026#34;Keycloak\u0026#34; email_domains = \u0026#34;*\u0026#34; pass_access_token = true ssl_insecure_skip_verify = true ssl_upstream_insecure_skip_verify = true insecure_oidc_allow_unverified_email = true code_challenge_method = \u0026#34;S256\u0026#34; cookie_expire = \u0026#34;30m\u0026#34; cookie_refresh = \u0026#34;4m\u0026#34; skip_auth_routes = \u0026#39;.*\\.(js|css)$\u0026#39; upstreams = \u0026#34;http://backstage.backstage.svc:7007\u0026#34; silence_ping_logging = true backend_logout_url = \u0026#34;\u0026lt;%= keycloakBaseUrl %\u0026gt;/realms/devops/protocol/openid-connect/logout\u0026#34; oidcIssuerUrl: \u0026lt;%= keycloakBaseUrl %\u0026gt;/realms/devops redirectUrl: \u0026#34;\u0026#34; # 白名单支持通配符： *.xxx.com whiteList: \u0026#34;*.xxx.com\u0026#34;\r注意这里几个特别关键的配置：\n将 \u0026lt;%= keycloakBaseUrl %\u0026gt; 替换为你的 keycloak 真实 URL 地址，设置为对外地址，比如 ingress 的域名。 devops 是我自定义的 realm 名字，请根据你自己实际的情况设置，keycloak 默认的 realm 是 master。 upstreams：设置为 backstage 的服务地址。我这里设置的是 backstage 的 k8s service 地址，因为 oauth2-proxy 和 Backstage 都在 K8S 集群内，能通即可。 cookie_refresh : 设置为 Keycloak Access-Token lifespan - 1m cookie_expire : 设置为 Keycloak Refresh-Token lifespan (Keycloak client_session_idle) skip_auth_routes 对某些 url 不做认证，可写可不写，看你爱好。 关于 keycloak token 过期时间的配置，可以参考 keycloak 官方文档或 IDaaS Book 。\nBackstage 配置 Backstage 需要编码，引入 Keycloak 和 RBAC 插件，修改导航栏菜单，然后才是配置文件。这部分并没有什么难度，参考插件说明即可完成，注意请根据插件的最新版本说明配置，这里提到的一切都可能过时，Backstage 变化实在是太大了。\nBackstage 我们区分认证和授权两部分，两部分可独立配置，但是都依赖用户同步，所以先把用户同步到 Backstage 数据库。\n用户同步 官方英文最新文档请参考 catalog-backend-module-keycloak ，请根据最新文档操作。\n基本步骤：\n安装插件依赖。\nyarn workspace backend add @backstage-community/plugin-catalog-backend-module-keycloak\r在 backstage 注册插件，backstage 工程 packages/backend/src/index.ts 增加以下代码。\nconst backend = createBackend(); # 增加这一行 backend.add( import(\u0026#39;@backstage-community/plugin-catalog-backend-module-keycloak\u0026#39;), ); backend.start();\r配置插件同步需要的 client id 和 client secret，同步周期，在 backstage 的 app-config.yaml 增加以下片段。\ncatalog: providers: keycloakOrg: default: baseUrl: https://\u0026lt;keycloak_host\u0026gt; loginRealm: ${KEYCLOAK_REALM} realm: ${KEYCLOAK_REALM} # 这里的 client 就是我们上面说的 backstage client， 需要授权查询用户和组的权限 clientId: ${KEYCLOAK_CLIENTID} clientSecret: ${KEYCLOAK_CLIENTSECRET} schedule: # Optional (defaults to the configurations below if not provided); same options as in TaskScheduleDefinition # supports cron, ISO duration, \u0026#34;human duration\u0026#34; as used in code frequency: { minutes: 30 } # Customize this to fit your needs # supports ISO duration, \u0026#34;human duration\u0026#34; as used in code timeout: { minutes: 3 } # Customize this to fit your needs\r以上配置完成后，观察下 backstage 的运行日志，成功的话会有同步了多少个 user 和 group 的日志，失败的话会有失败原因，确保同步成功。\n用户认证 官方英文最新文档请参考 OAuth 2 Proxy Provider ，请根据最新文档操作。\n基本步骤：\n安装 backstage 后端插件依赖。\nyarn --cwd packages/backend add @backstage/plugin-auth-backend-module-oauth2-proxy-provider\r配置 backstage 后端代码，启用插件，在 packages/backend/src/index.ts 增加以下代码。\n# 增加这一行 backend.add( import(\u0026#39;@backstage/plugin-auth-backend-module-oauth2-proxy-provider\u0026#39;), );\r配置 oauth2Proxy 认证组件需要的参数，在 backstage 的 app-config.yaml 增加以下片段。\nauth: # environment 必须定义，一般定义为 development 和 production，可根据自己的需要定义，后面代码中会有引用名字的地方 environment: development providers: oauth2Proxy: signIn: resolvers: # See https://backstage.io/docs/auth/oauth2-proxy/provider#resolvers for more resolvers - resolver: forwardedUserMatchingUserEntityName\r改前端代码，修改登录页面，使用 oauth2Proxy 的登录组件，参考 官方文档 . 在 packages/app/src/App.tsx 找到 SignInPage 修改为如下片段，当然，你可以根据自己的环境定制更多自己的登录页面。\n// SignInPage: props =\u0026gt; \u0026lt;SignInPage {...props} auto providers={[\u0026#39;guest\u0026#39;]} /\u0026gt;, SignInPage: props =\u0026gt; { const configApi = useApi(configApiRef); // 开发环境使用 guest 账号，生产环境使用 oauth2Proxy 作为登录认证 if (configApi.getString(\u0026#39;auth.environment\u0026#39;) === \u0026#39;development\u0026#39;) { return ( \u0026lt;SignInPage {...props} providers={[\u0026#39;guest\u0026#39;]} /\u0026gt; ); } return \u0026lt;ProxiedSignInPage {...props} provider=\u0026#34;oauth2Proxy\u0026#34; /\u0026gt;; }\r上面我们使用了 backstage 的 resolvers forwardedUserMatchingUserEntityName, 他就是从 Http Header 中获取 oauth2-proxy 传递过来的 x-forwarded-user 值与数据库比对，找到用户信息。\noauth2-proxy 传递到 upstream 的常用 header 有：\nx-forwarded-user: af188bba-0388-2623-8cdb-39422e8be30a # user database id x-forwarded-preferred-username: lisan123 # user login name x-forwarded-groups: admin,test-group # user groups x-forwarded-access-token: xxx # Access Token authorization: Bearer token xxx # 注意这个是 ID Token，不是 Access Token cookie: xxx\r至此，登录认证已经可以了。\n用户授权 RBAC 授权插件有前端和后端两个插件。\n先安装 backend 后端插件，基本步骤：\n安装 backstage 后端插件依赖。\nyarn workspace backend add @backstage-community/plugin-rbac-backend\r配置 backstage 后端代码，启用插件，在 packages/backend/src/index.ts 补充以下代码。\n// 删除原来的 permission plugin - backend.add(import(\u0026#39;@backstage/plugin-permission-backend/alpha\u0026#39;)); - backend.add( - import(\u0026#39;@backstage/plugin-permission-backend-module-allow-all-policy\u0026#39;), - ); // 增加这一行 + backend.add(import(\u0026#39;@backstage-community/plugin-rbac-backend\u0026#39;)); 配置 RBAC 插件用户权限，在 backstage 的 app-config.yaml 增加以下片段。\npermission: enabled: true # see https://github.com/backstage/community-plugins/tree/main/workspaces/rbac/plugins/rbac-backend rbac: maxDepth: 1 admin: superUsers: # 这里的 “default” 是 backstage 的 namespace 的概念，没改默认是 default - name: user:default/zhangsan - name: user:default/mike users: - name: user:default/lisir - name: group:default/admins\r再安装 frontend 前端插件，把 RBAC 管理界面放出来，基本步骤：\n安装 backstage 前端插件依赖。\nyarn workspace app add @backstage-community/plugin-rbac\r配置 backstage 前端代码，在 packages/app/src/App.tsx 补充以下代码，增加 Route。\nimport { RbacPage } from \u0026#39;@backstage-community/plugin-rbac\u0026#39;; \u0026lt;Route path=\u0026#34;/rbac\u0026#34; element={\u0026lt;RbacPage /\u0026gt;} /\u0026gt;;\r配置导航菜单，修改 packages/app/src/components/Root/Root.tsx。\nimport { Administration } from \u0026#39;@backstage-community/plugin-rbac\u0026#39;; export const Root = ({ children }: PropsWithChildren\u0026lt;{}\u0026gt;) =\u0026gt; ( \u0026lt;SidebarPage\u0026gt; \u0026lt;Sidebar\u0026gt; ... \u0026lt;Administration /\u0026gt; ... \u0026lt;/Sidebar\u0026gt; \u0026lt;/SidebarPage\u0026gt; );\r至此，用以上配置有权限的用户登录，就可以访问 RBAC 管理界面了。根据 权限管理文档 开启自定义权限之旅吧。\n","date":"2024-11-16","id":11,"permalink":"/blog/backstage-keycloak-oauth2-proxy/","summary":"\u003cp\u003e基于 K8S 部署 Backstage，集成 oauth2-proxy 和 Keycloak，实现用户管理、认证和授权，配置详解和原理介绍。\u003c/p\u003e\n\u003cp\u003e如果你遇到以下问题或诉求，可以参考此文档。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://backstage.io/\" target=\"_blank\" rel=\"noopener\"\u003eBackstage\u003c/a\u003e\n 接入 oauth2-proxy，登录或认证失败。\u003c/li\u003e\n\u003cli\u003eBackstage 实现 RBAC、ABAC 授权管理，以及如何实现自定义权限。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://oauth2-proxy.github.io/oauth2-proxy/\" target=\"_blank\" rel=\"noopener\"\u003eoauth2-proxy\u003c/a\u003e\n 对接 keycloak，参数不理解或者配置一直错误。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e在开始之前，我们先了解一个点，Backstage 官方开源有开箱即用的容器镜像，也有丰富的插件生态，然而区别于其他插件类应用，Backstage 有自己的特点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eBackstage 插件分为 frontend 和 backend，一个完整的插件可能包含两种，也可能只包含其中一种。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e开源发布的开箱即用的容器镜像，只包含基础插件，一般只用来作为初次学习使用。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e如果想使用其他插件，需要做一些编码工作，一般步骤如下。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e使用 \u003ccode\u003enpx @backstage/create-app@latest\u003c/code\u003e 创建一个基础项目。\u003c/li\u003e\n\u003cli\u003e按插件要求安装插件，配置插件菜单、UI 效果、权限、认证信息等，每个插件要求不同。\u003c/li\u003e\n\u003cli\u003e按需开发自己的插件。\u003c/li\u003e\n\u003cli\u003e编译成新容器镜像，某些插件可能还需要在容器中额外安装一些依赖包，部署时使用此容器镜像。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e基本上每个插件都有自己的配置要求，需根据插件文档配置 app-config.yaml。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e可以把 Backstage 类比于 Spring Boot，提供了 starter、framework、plugins，如果想真实使用，需要自己引入依赖，编译成自己的镜像发布部署，欢迎 star 我们基于 Backstage 定制的开源项目 \u003ca href=\"https://github.com/xlabs-club/xlabs-developer-platform\" target=\"_blank\" rel=\"noopener\"\u003exlabs-developer-platform\u003c/a\u003e\n。\u003c/p\u003e\n\u003cp\u003e核心组件介绍：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用户同步使用 Red Hat 贡献的社区开源插件 \u003ca href=\"https://github.com/backstage/community-plugins/tree/main/workspaces/keycloak/plugins/catalog-backend-module-keycloak\" target=\"_blank\" rel=\"noopener\"\u003e@backstage-community/plugin-catalog-backend-module-keycloak\u003c/a\u003e\n，将 keycloak 用户同步到 Backstage 数据库，后面我们会提到为什么需要这一步。\u003c/li\u003e\n\u003cli\u003e认证使用官方内置的 \u003ca href=\"https://backstage.io/docs/auth/oauth2-proxy/provider\" target=\"_blank\" rel=\"noopener\"\u003eOAuth 2 Proxy Provider\u003c/a\u003e\n.\u003c/li\u003e\n\u003cli\u003e授权，权限管理 Permissions，支持 RBAC、ABAC， 使用 Red Hat 贡献的社区开源插件 \u003ca href=\"https://github.com/backstage/community-plugins/tree/main/workspaces/rbac/plugins\" target=\"_blank\" rel=\"noopener\"\u003e@backstage-community/plugin-rbac\u003c/a\u003e\n，虽然插件名字叫 RBAC，但是实际上支持 ABAC。注意 Spotify 也有 \u003ca href=\"https://backstage.spotify.com/marketplace/spotify/plugin/rbac/\" target=\"_blank\" rel=\"noopener\"\u003eRBAC 插件\u003c/a\u003e\n 需要购买 License 才能用，两个插件别弄混了。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e以上认证和授权是独立的，如果你只需要认证，不需要授权，那可以不需要 RBAC 插件。\u003c/p\u003e","tags":["k8s","idaas"],"title":"Backstage 集成 oauth2-proxy 和 Keycloak，实现用户管理、登录认证以及 RBAC、ABAC 授权"},{"content":"作为一个程序员，在日常开发中永远避免不了认证鉴权，而我们开发的某些应用，并不需要太复杂的鉴权，比如可能只要求必须是登录用户，或者只需要根据角色进行 RBAC 鉴权。有没有方法简化此流程，让应用开发者只关注业务开发，这就是本文档要解决的问题。\n如果你有类似以下的需求，都可以参考此文档，原理是一样的，组件也可复用。\n为原本没有登录验证的服务提供认证服务，比如某些开源组件不支持认证但是又因携带一些危险数据而不想公开访问。 实现统一的单点登录 SSO、并支持简单的 RBAC、UBAC 鉴权。 为 Kubernetus Traefik Nginx Ingress 提供统一的认证入口，一键实现所有入口必须登录才可访问。 配置 Traefik 使用 Forward Auth，Nginx 使用 auth_request 实现认证，也可以一并参考。 在 K8S 或应用网关，基于用户、角色等不同属性，路由到不同服务。 如果你凑巧也在用 Backstage ，请参考 另一篇博客 。 写在前面：\n本文档里的示例代码是以 k3s 为基础，使用 traefik 作为 ingress controller，整体完善但略显复杂，如果没有 K3S/K8S，以其他方式部署也是完全可以的，基本原理都是一样的。 对于某些场景下可选的配置，会单独说明，请注意分别。 这里提到的每个组件都是可替换的，比如 nginx 代替 traefik，Pomerium 代替 oauth2-proxy，可根据爱好选择，后面也会适当补充几种不同方式的对比和部署差异，更详细内容请参考本站另外一篇文档 统一身份认证 。 示例中的代码都是从真实环境拷贝经过检验的，但为了便于理解可能裁剪无关紧要的内容，完整的安装部署源码请参考我们的部署脚本 xlabs-club/xlabs-ops 。 需要懂一些 K8S、OIDC 基础知识，此处只提供链接不展开说明。 组件介绍 Keycloak\nKeycloak 是一个开源的身份和访问管理解决方案，支持 OAuth 2.0、OpenID Connect、SAML 等协议。它提供用户管理、角色管理、单点登录（SSO）、身份提供服务等功能，在本示例中担任 Auth Provider 角色。关于 Keycloak 的中文介绍，可参考本站单独的博客 IDaaS Book 。\noauth2-proxy 顾名思义它是一个关于 oauth 反向代理，主要用来为后端服务增加身份验证层。它支持多种 OAuth 2.0 提供者（如 Google、OIDC、Keycloak 等），可以保护未提供身份验证的应用。oauth2-proxy 在请求进入后端服务之前，会先进行 OAuth 2.0 登录认证，确保请求者具有访问权限。它承担了登录的合法性校验、重定向、登录成功后的 cookie、response 设置等功能。\nApplication\n应用代号，可以是任何应用，UI 也好，API 也好，都可以，只要想拦截都行。\n在开始之前，建议先了解下 oauth2-proxy 的基本功能，并需要特别关注一下他的这几个容易令人疑惑的设置。\noauth2-proxy 的 set header 和 pass header 的区别， set header 设置的是 response header，这在下面提到的 nginx auth_request 模块和 traefik forwardAuth Middleware 会用到。 pass header 是认证通过后，将一些基本信息，比如 Access Token、User ID、User Group 通过 Http Request Header 传递到 upstream（代理的目标应用），upstream 可以拿到 Header 信息后做更多的事情。 目标应用 --upstream 一般就是一个或多个具体的后端服务地址，也可以是静态文件。还有一种特殊的文件 file:///dev/null, 相当于舍弃 upstream，下面我们会用他结合 traefik forwardAuth 使用。 关注下 oauth2-proxy 的 Endpoints ，主要使用 start、auth、sign_in、sign_out 等几个，另外 auth endpoint 后面可以追加 query parameters allowed_groups/allowed_emails，这样不就组成了一个简单的基于 Group 的权限认证。 注意看文档中关于 proxy 的设置，比如 --reverse-proxy，很多错误都是因为认证和配置没问题，但是到了后端 OAuth 本身校验失败，Token 的校验对 scheme、host 都有要求，如果经过了 proxy，要透传 header 中的 scheme、host。 基本原理和流程 目前 oauth2-proxy 有几种主流的使用方式。\n第一种，直接使用 oauth2-proxy 对外提供服务，承担认证流程并提供简单的权限校验，认证通过后通过 Header 传递一些用户信息到 upstream application，流量由 oauth2-proxy 分发。\n这种方式网络流量大概类似如下方式。\nsequenceDiagram participant User participant oauth2-proxy participant Application User-\u003e\u003eoauth2-proxy: Access Service oauth2-proxy-\u003e\u003eoauth2-proxy: Authenticate User to Auth Provider (eg. keycloak) oauth2-proxy-\u003e\u003eApplication: Forward request to Backend proxy paas headers(user id/name/groups/roles) Application-\u003e\u003eApplication: Do more things by header info Application--\u003e\u003eoauth2-proxy: Response oauth2-proxy--\u003e\u003eUser: Return Response\r第二种，借助 traefik forwardAuth 认证插件 或 nginx auth_request 认证模块，结合 oauth2-proxy 提供的认证相关 Endpoints，承担认证流程，认证通过后流量的分发仍然由 traefik/nginx 执行。此方案的优点很明显，就是 traefik/nginx 的流量分发能力远超过 oauth2-proxy，不破坏 traefik/nginx 本身的功能。\n他的网络流量和流程大概类似如下方式。\nsequenceDiagram participant User participant Traefik participant oauth2-proxy participant Keycloak participant Application User-\u003e\u003eTraefik: Access Application URL Traefik-\u003e\u003eoauth2-proxy: Forward request (auth check) oauth2-proxy-\u003e\u003eoauth2-proxy: Check if user is authenticated oauth2-proxy--\u003e\u003eUser: Redirect to Keycloak login User-\u003e\u003eKeycloak: Enter credentials Keycloak-\u003e\u003eKeycloak: Authenticate User Keycloak--\u003e\u003eUser: Return Authorization Code User-\u003e\u003eoauth2-proxy: Send Authorization Code oauth2-proxy-\u003e\u003eKeycloak: Exchange Code for Access Token Keycloak--\u003e\u003eoauth2-proxy: Return Access Token oauth2-proxy--\u003e\u003eUser: Set authentication cookie oauth2-proxy-\u003e\u003eTraefik: Forward original request, add Response Header Traefik-\u003e\u003eApplication: Response Header to Request Header, Forward request to Application Application--\u003e\u003eTraefik: Return response Traefik--\u003e\u003eUser: Return response\r流程描述：\n用户访问 Application URL，请求被 Traefik 捕获。 Traefik 将请求转发给 oauth2-proxy，检查用户是否已认证。 如果用户未认证，oauth2-proxy 会将用户重定向到 Keycloak 登录页面。 用户在 Keycloak 上输入凭证并进行认证。 认证成功后，Keycloak 返回鉴权码给用户。 用户将鉴权码发送给 oauth2-proxy，oauth2-proxy 使用鉴权码向 Keycloak 请求访问令牌。 Keycloak 返回访问令牌给 oauth2-proxy，oauth2-proxy 设置身份验证 cookie。 oauth2-proxy 认证通过后，设置 Response Header 给 Traefik，Traefik 将 Response Header 转成 Request Header 传递给 Application。 Application 返回响应，最终由 Traefik 返回给用户。 本文档部署示例使用的是第二种方式。\n部署配置详解 此处的 Traefik 使用的 K3S Traefik ingress controller，相关的功能通过 ingress annotations 实现，如果你使用其他方式部署，请参考 Traefik 文档 转换为对应的 yaml 配置。\nKeycloak 配置 首先，我们需要在 Keycloak 中创建一个 client，用于允许 oauth2-proxy 使用 Keycloak 验证用户身份验证。\nOIDC 客户端必须配置 audience mapper，以将客户端的名称包含在 JWT 令牌的 aud 声明中。 aud 声明指定令牌的预期接收者，oauth2-proxy 期望与 \u0026ndash;client-id 或 \u0026ndash;oidc-extra-audience 的值匹配。 在 Keycloak 中，通过使用 client scopes 或 dedicated 将声明添加到 JWT Token 中。\n登录 Keycloak admin 控制台，切换到你自己的 realm。\n通过 Clients -\u0026gt; Create client （注： -\u0026gt; 连接代表 Keycloak 的菜单和按钮导航）来创建新客户端，核心参数如下，注：app.example.com 为我的应用地址。\nClient type： OpenID Connect Client ID：oauth2-proxy Client authentication 勾选，打开 Authentication flow 勾选 Standard flow Valid redirect URIs: 设置为你的应用 callback 地址，https://app.example.com/oauth2/callback，可以设置多个，也可以设置正则匹配，如 https://app.example.com/* Valid post logout redirect URIs：https://app.example.com/oauth2/sign_out 以上点保存后，从 Clients -\u0026gt; oauth2-proxy -\u0026gt; Credentials 页面，复制客户端密钥，下面会用到。\n配置一个 audience mapper, 在 Clients -\u0026gt; oauth2-proxy -\u0026gt; Client scopes页签，此时在列表应该看到一个名字叫 oauth2-proxy-dedicated的，点击进去，通过 Configure a new mapper 按钮创建一个新的 mapper。\n类型选择 Audience 名字叫 aud-mapper-oauth2-proxy Included Client Audience：选择 oauth2-proxy 勾选 Add to ID token、Add to access token、Add to token introspection 如果想使用 oauth2-proxy 的 --allowed-group 验证，需要在 Client scopes -\u0026gt; Create client scope 创建一个名字叫 groups 的 scope，下面参数是保持 groups 后才能使用，在 groups 的 detail -\u0026gt; mapper 里创建 Group Membership 类型的 mapper。\nname：groups-mapper Token Claim Name: groups 勾选 Add to xxx，全勾上。 再回到 Clients -\u0026gt; oauth2-proxy -\u0026gt; Client scopes页签， Add client scope选择我们上一步创建的 groups, Add 类型选择 Optional。这样就能把用户的 group 加到 JWT token 里了。\noauth2-proxy 配置 在开始之前我们先做出两个选择：\noauth2-proxy 对接 keycloak，可以选择 Keycloak OIDC provider，也可以选择 OpenID Connect provider，这里我们选择 Keycloak OIDC，他比 OpenID Connect 多了按照 role 和 group 授权。 oauth2-proxy 对接 Traefik，可以使用 errors middlewares 实现，也可以使用 Redirect 实现，这两种方式在 oauth2-proxy 的文档里都有详细的说明，两种方式都能实现根据情况选择一个，配置上稍有差别，返回值对 401 和 403 的处理也不同。 这里我们使用 bitnami/oauth2-proxy helm chart 部署，values.yaml 主要配置如下。\n# service 默认 port 4180 service: port: 4180 ## Configuration section ## configuration: clientID: oauth2-proxy clientSecret: \u0026lt;%= 替换成上面创建的 clientSecret %\u0026gt; # cookieSecret 创建命令： openssl rand -base64 32 | tr -- \u0026#39;+/\u0026#39; \u0026#39;-_\u0026#39; cookieSecret: \u0026#34;iSGfyi0EbDrkg6eNJpAXGLmwN1jZDZossmElq5GgXeI=\u0026#34; ## content 会映射到 oauth2-proxy.cfg 配置文件里 ## 各个参数含义请参考 https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview content: | reverse_proxy = true provider = \u0026#34;keycloak-oidc\u0026#34; provider_display_name = \u0026#34;Keycloak\u0026#34; email_domains = \u0026#34;*\u0026#34; set_xauthrequest = true set_authorization_header = true ssl_insecure_skip_verify = true insecure_oidc_allow_unverified_email = true code_challenge_method = \u0026#34;S256\u0026#34; upstreams = \u0026#34;file:///dev/null\u0026#34; # 填你自己的 keycloak 服务地址 oidcIssuerUrl: https://keycloak.example.com/realms/master # 不需要填 redirectUrl，由 Traefik 帮我们处理 redirectUrl: \u0026#34;\u0026#34;\r再次强调，因为我们是使用 Traefik 做流量分发，oauth2-proxy 仅提供认证功能，所以这几个参数很重要。\nredirectUrl: \u0026#34;\u0026#34; content: | reverse_proxy = true upstreams = \u0026#34;file:///dev/null\u0026#34;\r为了配合下面的 Traefik forwardAuth 实现 authResponseHeaders，还需要开启这两个参数。\ncontent: | set_xauthrequest = true set_authorization_header = true\r开启后，在 backend 服务里就能通过 Header 获取到当前用户的登录信息，以 keycloak-oidc provider 为例，获取到的 Header 如下。\nx-auth-request-user: af188bba-0388-2623-8cdb-39422e8be30a # user database id x-auth-request-preferred-username: lisan123 # user login name x-auth-request-groups: admin,test-group # user groups x-auth-request-access-token: xxx # Access Token authorization: Bearer token xxx # 注意这个是 ID Token，不是 Access Token cookie: xxx\rTraefik 配置 Traefik 我们需要两个 Middleware：\nerrors: 将 http 返回状态码是 401-403 的请求，重定向到 oauth2-proxy /oauth2/sign_in 端点。 forwardAuth：检查登录状态并设置 cookie 和 Header。 先创建这两个 Middleware。\napiVersion: traefik.io/v1alpha1 kind: Middleware metadata: name: errors-sign-in namespace: oauth2-proxy spec: errors: status: - \u0026#34;401-403\u0026#34; service: name: oauth2-proxy namespace: oauth2-proxy port: 4180 query: \u0026#34;/oauth2/sign_in\u0026#34; --- apiVersion: traefik.io/v1alpha1 kind: Middleware metadata: name: forward-auth namespace: oauth2-proxy spec: forwardAuth: # oauth2-proxy k8s service 地址 address: http://oauth2-proxy.oauth2-proxy.svc:4180/oauth2/auth trustForwardHeader: true # 增加 header，可用 header 参考 oauth2-proxy 文档 authResponseHeaders: - X-Auth-Request-User - X-Auth-Request-Preferred-Username - X-Auth-Request-Access-Token - X-Auth-Request-Groups - Authorization - Set-Cookie\r创建完了，在 k8s 里可使用 traefik IngressRoute 对外暴露服务，也可使用标准 traefik ingress，看个人爱好。\n因为 IngressRoute 看起来比较直观，好理解，我们先看下 IngressRoute 配置。\napiVersion: traefik.io/v1alpha1 kind: IngressRoute metadata: name: app-ingress-route namespace: oauth2-proxy # annotations: # cert-manager.io/issuer: selfsigned-issuer spec: entryPoints: - web - websecure routes: - match: \u0026#34;Host(`app.example.com`) \u0026amp;\u0026amp; PathPrefix(`/oauth2`)\u0026#34; kind: Rule services: - name: oauth2-proxy namespace: oauth2-proxy port: http middlewares: - name: errors-sign-in # 需要代理的应用对外暴露服务 - match: Host(`app.example.com`) kind: Rule middlewares: - name: errors-sign-in - name: forward-auth services: # 后端应用 - name: backend namespace: oauth2-proxy port: http-backend\r使用 k8s ingress 实现，annotations 请参考 traefik.ingress.kubernetes.io 。\n注意这里有两个关键点：\n因为 ingress 没办法像 IngressRoute 那样，为不同 path 设置不同的 middlewares，所以我们拆分成两个 ingress 定义。 traefik annotations 的 middlewares 名字定义格式为：namespace-middleware@@kubernetescrd，一定要加 namespace 前缀，如果是 default namespace 的话，也要加 default-前缀，否则查看 traefik 日志会看到一些 middlewares 找不到的错误，从而导致服务不生效。 # 第一个 ingress，对应 match: \u0026#34;Host(`app.example.com`) \u0026amp;\u0026amp; PathPrefix(`/oauth2`)\u0026#34;，使用 errors-sign-in middleware apiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: traefik.ingress.kubernetes.io/router.middlewares: oauth2-proxy-errors-sign-in@kubernetescrd name: errors-sign-in # namespace: oauth2-proxy spec: ingressClassName: traefik rules: # traefik 支持泛域名拦截，如果你想给所有的 ingress 都设置 oauth2，此处可以设置为 \u0026#34;*.example.com\u0026#34; - host: \u0026#34;app.example.com\u0026#34; http: paths: - backend: service: name: oauth2-proxy port: name: http path: /oauth2 pathType: Prefix # 根据你自己的情况设置 TLS # tls: # - hosts: # - \u0026#34;app.example.com\u0026#34; # secretName: \u0026#34;app.example.com-tls\u0026#34; --- # 第二个 ingress，对应 match: \u0026#34;Host(`app.example.com`)，使用 errors-sign-in,oauth2-proxy 两个 middleware apiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: # 这里设置 errors-sign-in,oauth2-proxy 两个 middleware traefik.ingress.kubernetes.io/router.middlewares: oauth2-proxy-errors-sign-in@kubernetescrd,oauth2-proxy-forward-auth@kubernetescrd name: errors-sign-in-ingress namespace: oauth2-proxy spec: ingressClassName: traefik rules: # traefik 支持泛域名拦截，如果你想给所有的 ingress 都设置 oauth2，此处可以设置为 \u0026#34;*.example.com\u0026#34; - host: \u0026#34;app.example.com\u0026#34; http: paths: - backend: service: name: backend port: name: http-backend path: / pathType: Prefix\rK3S Traefik 对接 oauth2-proxy 特别说明 如果以上你的所有应用都部署在 K8S 同一个 namespace 里，就不用关注这个了。\nK3S Traefik 默认未开启 allowCrossNamespace, 不允许跨 namespace 访问，所以如果你给其他 namespace 的应用也加上 auth Middleware，在应用上访问看不到错误就是一直没有 Auth 功能，以为是配置不生效，其实查看 K3S Traefik log 可以看到有关于 Middleware 找不到或 Service 无法访问的错误日志。\n以下解决办法任选其一：\n在应用所在的 namespace 都创建 Middleware，创建 K8S ExternalName Service 指定 oauth2-proxy Service，这样 Middleware 和 Service 都在同 namespace 了。\n为 Traefik 开启 allowCrossNamespace 配置，关于 K3S 如何使用 HelmChartConfig 定制 Traefik 配置，可参考官方文档 Customizing Packaged Components with HelmChartConfig 。\n# 手动临时改配置，不推荐，可能后续更新丢失 $ kubectl -n kube-system edit deployment traefik # 在 args 中增加 --providers.kubernetescrd.allowCrossNamespace=true # 永久生效配置 # vi /var/lib/rancher/k3s/server/manifests/traefik-config.yaml apiVersion: helm.cattle.io/v1 kind: HelmChartConfig metadata: name: traefik namespace: kube-system spec: valuesContent: |- providers: kubernetesCRD: enabled: true allowCrossNamespace: true\rKeycloak 对接 oauth2-proxy 特别说明 Keycloak 需要创建 audience mapper 和 groups scope mapper，这在 oauth2-proxy 官方文档 中有详细的说明和创建步骤。\noauth2-proxy 自动重定向到 keycloak 登录 以上使用 traefik errors middlewares 实现的方案，有两个弊端：\n登录成功后的回调，无法回到原始请求页面，会丢失 oauth2-proxy 的 rd，只能回到根目录。 每次需要登录的时候，先停在 oauth2-proxy 的 sign-in 登录页，等着你点 Sign in with，需要点击一下才会跳转到 keycloak 的登录页。 为了解决这个问题，我们可以定制 oauth2-proxy 的登录页 sign_in.html，在登录页面直接重定向，sign_in.html 内容如下。\n{{define \u0026#34;sign_in.html\u0026#34;}} \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34; charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Redirecting\u0026lt;/title\u0026gt; \u0026lt;script\u0026gt; window.location = \u0026#34;{{.ProxyPrefix}}/start?rd=\u0026#34; + encodeURI(window.location); \u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt;\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; {{end}}\r然后给 oauth2-proxy 增加环境变量 OAUTH2_PROXY_CUSTOM_TEMPLATES_DIR 放置以上登录页面。\n如果在 k8s 里，可以通过重编 oauth2-proxy 镜像，或者通过 initContainers 挂载目录复制以上文件，我已做好了一个这样的镜像，在此 GitHub 。\n使用方式类似如下。\ninitContainers: # copy 自定义模板，不需要点击 `Sign in` 按钮，自动重定向到登录页 - name: auto-sign-in # 源码： https://github.com/l10178/x-container image: docker.io/nxest/oauth2-proxy-auto-sign-in:v7.7.1 imagePullPolicy: IfNotPresent env: - name: OAUTH2_PROXY_CUSTOM_TEMPLATES_DIR value: /bitnami/oauth2-proxy/templates volumeMounts: - mountPath: /bitnami/oauth2-proxy/templates name: templates\rnginx 使用 auth_request 对接 oauth2-proxy 原理同 Traefik，将 /oauth2 相关请求交给 oauth2-proxy 服务，认证通过后 proxy_pass 到后端服务，注意设置 Header 和 Cookie。\n另外注意下这一行 auth_request /oauth2/auth;，前面我们提到 auth endpoint 后面可以追加 query parameters allowed_groups/allowed_emails，在 nginx 里我们可以根据不同 server 或 location 设置不同的 group，类似 auth_request /oauth2/auth?allowed_groups=cms-admin;, 这样不就组成了一个简单的基于 Group 的权限认证。\n如果想根据用户属性代理到不同的服务实例或路径，把 proxy_pass http://backend/; 用 lua if else 包装一下，不就实现了一个简单的路由功能。\nserver { location /oauth2/ { proxy_pass http://oauth2-proxy.svc:4180; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Scheme $scheme; proxy_set_header X-Auth-Request-Redirect $request_uri; # or, if you are handling multiple domains: # proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri; } location = /oauth2/auth { proxy_pass http://oauth2-proxy.svc:4180; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Scheme $scheme; # nginx auth_request includes headers but not body proxy_set_header Content-Length \u0026#34;\u0026#34;; proxy_pass_request_body off; } location / { auth_request /oauth2/auth; error_page 401 = /oauth2/sign_in; # pass information via X-User and X-Email headers to backend, # requires running with --set-xauthrequest flag auth_request_set $user $upstream_http_x_auth_request_user; auth_request_set $email $upstream_http_x_auth_request_email; proxy_set_header X-User $user; proxy_set_header X-Email $email; # if you enabled --pass-access-token, this will pass the token to the backend auth_request_set $token $upstream_http_x_auth_request_access_token; proxy_set_header X-Access-Token $token; # if you enabled --cookie-refresh, this is needed for it to work with auth_request auth_request_set $auth_cookie $upstream_http_set_cookie; add_header Set-Cookie $auth_cookie; # When using the --set-authorization-header flag, some provider\u0026#39;s cookies can exceed the 4kb # limit and so the OAuth2 Proxy splits these into multiple parts. # Nginx normally only copies the first `Set-Cookie` header from the auth_request to the response, # so if your cookies are larger than 4kb, you will need to extract additional cookies manually. auth_request_set $auth_cookie_name_upstream_1 $upstream_cookie_auth_cookie_name_1; # Extract the Cookie attributes from the first Set-Cookie header and append them # to the second part ($upstream_cookie_* variables only contain the raw cookie content) if ($auth_cookie ~* \u0026#34;(; .*)\u0026#34;) { set $auth_cookie_name_0 $auth_cookie; set $auth_cookie_name_1 \u0026#34;auth_cookie_name_1=$auth_cookie_name_upstream_1$1\u0026#34;; } # Send both Set-Cookie headers now if there was a second part if ($auth_cookie_name_upstream_1) { add_header Set-Cookie $auth_cookie_name_0; add_header Set-Cookie $auth_cookie_name_1; } proxy_pass http://backend/; # or \u0026#34;root /path/to/site;\u0026#34; or \u0026#34;fastcgi_pass ...\u0026#34; etc } }\r如果是在 K8S 内使用 nginx ingress controller 实现，请参考官方文档将以上配置转换为注解和 lua 片段，类似如下设置。\nnginx.ingress.kubernetes.io/auth-signin: https://$host/oauth2/start?rd=$escaped_request_uri nginx.ingress.kubernetes.io/auth-url: https://$host/oauth2/auth\r遇见问题和解决办法 我们使用过程中遇见的问题和解决办法，记录下来仅供参考。\ntraefik middleware 配置未生效。\n检查 traefik 日志，看看有没有错误，如果有语法错误或者权限问题，traefik 也能正常启动，只是配置不生效。\ntraefik log 中 middleware 找不到，请参考本文上面说明，将 middlewares 名字改为：namespace-middleware@@kubernetescrd，一定要加 namespace 前缀，如果是 default namespace 的话，也要加 default- 前缀。\nlevel=error msg=\u0026#34;middleware \\\u0026#34;errors-sign-in@kubernetes\\\u0026#34; does not exist\u0026#34; entryPointName=web routerName=oauth2-proxy-errors-sign-in-sign-in-example-com-oauth2@kubernetes oauth2-proxy 能重定向到登录页面，输入密码登录成功，回调到 callback 时出现下面这个错误，原因是缺少 audience mapper，参考本文上面介绍增加 mapper。\n500 Internal Server Error Oops! Something went wrong. For more information contact your server administrator. [oauthproxy.go:902] Error creating session during OAuth2 callback: audience from claim aud with value [account] does not match with any of allowed audiences map[oauth2-proxy:{}] ","date":"2024-10-10","id":12,"permalink":"/blog/traefik-oauth2-proxy-keycloak/","summary":"\u003cp\u003e作为一个程序员，在日常开发中永远避免不了认证鉴权，而我们开发的某些应用，并不需要太复杂的鉴权，比如可能只要求必须是登录用户，或者只需要根据角色进行 RBAC 鉴权。有没有方法简化此流程，让应用开发者只关注业务开发，这就是本文档要解决的问题。\u003c/p\u003e\n\u003cp\u003e如果你有类似以下的需求，都可以参考此文档，原理是一样的，组件也可复用。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e为原本没有登录验证的服务提供认证服务，比如某些开源组件不支持认证但是又因携带一些危险数据而不想公开访问。\u003c/li\u003e\n\u003cli\u003e实现统一的单点登录 SSO、并支持简单的 RBAC、UBAC 鉴权。\u003c/li\u003e\n\u003cli\u003e为 Kubernetus Traefik Nginx Ingress 提供统一的认证入口，一键实现所有入口必须登录才可访问。\u003c/li\u003e\n\u003cli\u003e配置 Traefik 使用 Forward Auth，Nginx 使用 auth_request 实现认证，也可以一并参考。\u003c/li\u003e\n\u003cli\u003e在 K8S 或应用网关，基于用户、角色等不同属性，路由到不同服务。\u003c/li\u003e\n\u003cli\u003e如果你凑巧也在用 \u003ca href=\"https://backstage.io/\" target=\"_blank\" rel=\"noopener\"\u003eBackstage\u003c/a\u003e\n，请参考 \u003ca href=\"https://www.xlabs.club/blog/backstage-oauth2-proxy-keycloak/\" target=\"_blank\" rel=\"noopener\"\u003e另一篇博客\u003c/a\u003e\n。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e写在前面：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e本文档里的示例代码是以 k3s 为基础，使用 traefik 作为 ingress controller，整体完善但略显复杂，如果没有 K3S/K8S，以其他方式部署也是完全可以的，基本原理都是一样的。\u003c/li\u003e\n\u003cli\u003e对于某些场景下可选的配置，会单独说明，请注意分别。\u003c/li\u003e\n\u003cli\u003e这里提到的每个组件都是可替换的，比如 nginx 代替 traefik，Pomerium 代替 oauth2-proxy，可根据爱好选择，后面也会适当补充几种不同方式的对比和部署差异，更详细内容请参考本站另外一篇文档 \u003ca href=\"https://www.xlabs.club/docs/platform/iam/\" target=\"_blank\" rel=\"noopener\"\u003e统一身份认证\u003c/a\u003e\n。\u003c/li\u003e\n\u003cli\u003e示例中的代码都是从真实环境拷贝经过检验的，但为了便于理解可能裁剪无关紧要的内容，完整的安装部署源码请参考我们的部署脚本 \u003ca href=\"https://github.com/xlabs-club/xlabs-ops\" target=\"_blank\" rel=\"noopener\"\u003exlabs-club/xlabs-ops\u003c/a\u003e\n。\u003c/li\u003e\n\u003cli\u003e需要懂一些 K8S、OIDC 基础知识，此处只提供链接不展开说明。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"组件介绍\"\u003e组件介绍\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eKeycloak\u003c/p\u003e\n\u003cp\u003eKeycloak 是一个开源的身份和访问管理解决方案，支持 OAuth 2.0、OpenID Connect、SAML 等协议。它提供用户管理、角色管理、单点登录（SSO）、身份提供服务等功能，在本示例中担任 Auth Provider 角色。关于 Keycloak 的中文介绍，可参考本站单独的博客 \u003ca href=\"https://idaas.xlabs.club/\" target=\"_blank\" rel=\"noopener\"\u003eIDaaS Book\u003c/a\u003e\n。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://oauth2-proxy.github.io/oauth2-proxy/\" target=\"_blank\" rel=\"noopener\"\u003eoauth2-proxy\u003c/a\u003e\n\u003c/p\u003e\n\u003cp\u003e顾名思义它是一个关于 oauth 反向代理，主要用来为后端服务增加身份验证层。它支持多种 OAuth 2.0 提供者（如 Google、OIDC、Keycloak 等），可以保护未提供身份验证的应用。oauth2-proxy 在请求进入后端服务之前，会先进行 OAuth 2.0 登录认证，确保请求者具有访问权限。它承担了登录的合法性校验、重定向、登录成功后的 cookie、response 设置等功能。\u003c/p\u003e","tags":["k8s","idaas"],"title":"使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解"},{"content":"在建设本博客的过程中，发现了一些优秀的开发工具、有趣原创的独立博客，以及独立发布的良心开源产品，我觉得有必要把他们展示出来。\n如有侵权，请提 issue，如有推荐，请到我们的 GitHub 仓库提交 pull requests。\n在线工具 IT Tools，研发人员常用 JSON/时间戳/数学/加密 等等各种在线生成和转换工具：https://it-tools.tech 。 Web Tools，JWT/JSON/URL/Base64 等编解码工具，简洁：https://www.jstoolset.com 。 独立博客 地瓜哥，分享技术带来的喜悦：https://www.diguage.com 。 独立产品 Coming Soon\u0026hellip;\n","date":"2024-09-26","id":13,"permalink":"/blog/xlabs-link-exchange/","summary":"\u003cp\u003e在建设本博客的过程中，发现了一些优秀的开发工具、有趣原创的独立博客，以及独立发布的良心开源产品，我觉得有必要把他们展示出来。\u003c/p\u003e\n\u003cp\u003e如有侵权，请提 issue，如有推荐，请到我们的 \u003ca href=\"https://github.com/xlabs-club/xlabs-club.github.io\" target=\"_blank\" rel=\"noopener\"\u003eGitHub\u003c/a\u003e\n 仓库提交 pull requests。\u003c/p\u003e\n\u003ch2 id=\"在线工具\"\u003e在线工具\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eIT Tools，研发人员常用 JSON/时间戳/数学/加密 等等各种在线生成和转换工具：\u003ca href=\"https://it-tools.tech\" target=\"_blank\" rel=\"noopener\"\u003ehttps://it-tools.tech\u003c/a\u003e\n。\u003c/li\u003e\n\u003cli\u003eWeb Tools，JWT/JSON/URL/Base64 等编解码工具，简洁：\u003ca href=\"https://www.jstoolset.com\" target=\"_blank\" rel=\"noopener\"\u003ehttps://www.jstoolset.com\u003c/a\u003e\n。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"独立博客\"\u003e独立博客\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e地瓜哥，分享技术带来的喜悦：\u003ca href=\"https://www.diguage.com\" target=\"_blank\" rel=\"noopener\"\u003ehttps://www.diguage.com\u003c/a\u003e\n。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"独立产品\"\u003e独立产品\u003c/h2\u003e\n\u003cp\u003eComing Soon\u0026hellip;\u003c/p\u003e","tags":[],"title":"卫星实验室友情链接"},{"content":"我们公司的主要应用都是以 Java 作为开发语言，这几年随着业务的高速增长，应用数目越来越多，CPU 内存资源占用越来越多，项目组之间开发合作效率也越来越低。\n顺应这个时代降本增效的目的，我们希望寻找一个能解决当前几个核心问题的框架：\n模块化开发、部署、资源共享的能力，减少 Cache、Class 等资源占用，有效降低内存占用。 更快更轻的依赖，应用能够更快的启动。 能够让各个项目组不改代码或少改代码即可接入，控制开发迁移的成本，毕竟很多历史老应用不是那么容易迁移。 基于以上背景，我们在 2022 年基于 SOFAArk 运行了一个版本，效果不太理想暂时搁置。今年 Koupleless 重新开源后做了一些增强和变更，开源社区活跃度有所提升，看宣传效果很好，我们决定重新评估是否可在公司内推广。\n什么是 Koupleless Koupleless 是一种模块化 Serverless 技术解决方案，它能让普通应用低成本演进为 Serverless 研发模式，让代码与资源解耦，轻松独立维护， 与此同时支持秒级构建部署、合并部署、动态伸缩等能力为用户提供极致的研发运维体验，最终帮助企业实现降本增效。\nKoupleless 是蚂蚁集团内部经过 5 年打磨成熟的研发框架和运维调度平台能力，相较于传统镜像化的应用模式研发、运维、运行阶段都有 10 倍左右的提升，总结起来 5 大特点：快、省、灵活部署、平滑演进、生产规模化验证。\n以上都是官网的宣传，更多介绍请链接到官网查看。\n在整个 Koupleless 平台里，需要四个组件：\n研发工具 Arkctl, 提供模块创建、快速联调测试等能力。 运行组件 SOFAArk, Arklet，提供模块运维、模块生命周期管理，多模块运行环境。（这算两个组件？） 控制面组件 ModuleController，本质上是一个 K8S Operator，提供模块发布与运维能力。 我们公司有自己的发布系统、应用管理平台，很少允许运行额外的控制面组件，那么除去 ModuleController，我个人认为，Koupleless 约等于 SOFAArk。\nKoupleless 增强了 SOFAArk 运维部署相关的功能，解决了 SOFAArk 在企业内无法开箱即用的问题。\n应用接入遇见问题 基于官方文档我们改造接入了几个应用，分享几个我们遇见的问题。\n对 Java 17 或 21 的支持不好。 虽然官方已经声称支持 Java 17，但是若用了 Java 17 的语法或新特性，无法编译通过。最后只好自编译 SOFAArk plugin 修改相关依赖解决。\n不支持 Arm 架构。 本地使用最新 MacBook 启动失败，健康检测组件不支持 Arm，奇怪的是官方有相关的 issue 且已经关闭，却并未升级相关依赖。\n以下错误导致启动失败，根据原因是 classloader 依赖失败，没排除干净，Spring 必须全部由基座加载。\nCaused by: java.lang.IllegalArgumentException: class org.springframework.cloud.bootstrap.RefreshBootstrapRegistryInitializer is not assignable to interface org.springframework.boot.BootstrapRegistryInitializer at org.springframework.util.Assert.assignableCheckFailed(Assert.java:720) at org.springframework.util.Assert.isAssignable(Assert.java:651) at org.springframework.util.Assert.isAssignable(Assert.java:682) at org.springframework.boot.SpringApplication.createSpringFactoriesInstances(SpringApplication.java:444) ... 22 more Dubbo service 实例化失败，根据原因是 classloader 依赖失败，dubbo 由基座加载，相应的 api interface、model 也必须由基座加载。Bean 的实例化和调用可以是 biz 模块。\nCaused by: java.lang.IllegalArgumentException: interface com.api.service.EditionService is not visible from class loader at com.alibaba.dubbo.common.bytecode.Proxy.getProxy(Proxy.java:98) at com.alibaba.dubbo.common.bytecode.Proxy.getProxy(Proxy.java:67) at com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory.getProxy(JavassistProxyFactory.java:35) at com.alibaba.dubbo.rpc.proxy.AbstractProxyFactory.getProxy(AbstractProxyFactory.java:49) at com.alibaba.dubbo.rpc.proxy.wrapper.StubProxyFactoryWrapper.getProxy(StubProxyFactoryWrapper.java:60) at com.alibaba.dubbo.rpc.ProxyFactory$Adpative.getProxy(ProxyFactory$Adpative.java) Biz 模块某些 ClassNotFoundException，排除的太多了，excludeGroupIds=org.apache 把 apache 全部交给基座了，但是基座并没有 http-client。依赖包管理是一个严格的事情，多了也不行，少了也不行，有些是启动报错，有些是运行期报错。\nCaused by: java.lang.IllegalStateException: Failed to introspect Class [org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientConfigurations$RestClientBuilderConfiguration] Caused by: java.lang.ClassNotFoundException: org.apache.http.impl.nio.client.HttpAsyncClientBuilder at java.base/java.net.URLClassLoader.findClass(URLClassLoader.java:445) at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:593) at org.springframework.boot.loader.LaunchedURLClassLoader.loadClass(LaunchedURLClassLoader.java:151) at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:526) ... 52 more Spring Boot AutoConfiguration 问题，可能有以下几种场景，但是排除 AutoConfiguration 后，本地 IDEA 启动联调必须依赖基座。\n基座只是加载 jar class，模块负责实例化 Bean，基座需要排除 AutoConfiguration。 基座即加载 jar 又实例化 Bean，模块复用 Bean，模块需要排除 AutoConfiguration。 基座加载 jar，模块不需要实例化 Bean，误触发实例化，常见于@ConditionalOnClass。 不支持 spring-boot-devtools，他有独立的 RestartClassLoader，同理如果其他开源组件有独立 ClassLoader 也可能有问题，需要仔细评估。\n不支持 spring-boot-actuator 使用独立端口。\n总结 收益：\n内存占用有明显降低，如果再结合 static、service 共享，把 i18n、xxxCache、xxxUtils、xxxService 沉淀到底座，能大幅降低资源占用。 通用 Bean，甚至 redis、kafka 等连接，也可由基座实例化，只实例化一次，降低资源，同时启动速度加倍。 通用功能基座开发，基座能力越强，上层 biz 开发效率越高，可提高研发效率。 挑战：\n文档不友好，功能还处于 Beta 版本，不管是 Koupleless 还是 SOFAArk。如果想真正跑起来，需要仔细去看源码和源码解析的博客，而博客很多已经过时了会把你带进坑去。当然如何能获得官方团队支持，就另说了。 关于基座和 Biz 模块 static 变量的问题，你想共享的时候，是好东西，你不想共享的时候，就需要搞明白这个变量共享了吗，谁加载的，影响范围是哪些，如何做到不共享。目前没想到如何评估 static 的影响范围，只能 case by case 翻源码。 基座和 Biz 模块磨合，哪些 jar 交给基座，哪些 Bean 交给基座，都需要有严格的限制，既不能多也不能少，否则可能启动失败，可能运行期失败。花费大量的时候维护 pom.xml，需要有人很熟悉 pom 依赖。 classloader 模型变更，任何有自定义 classloader 的地方都需要重新评估，可能需要变更代码。 关于 2、3、4，理解了 Koupleless 原理就能理解这几个问题了，每一个都可能让你的应用迁移产生意想不到的效果，需要仔细评估。\n如果你是新项目且迫切需要 Koupleless 的功能，不妨一试。最后祝 Koupleless 发展越来越好，如有兴趣可以去开源社区建设。\n","date":"2024-05-27","id":14,"permalink":"/blog/koupleless-first-boot/","summary":"\u003cp\u003e我们公司的主要应用都是以 Java 作为开发语言，这几年随着业务的高速增长，应用数目越来越多，CPU 内存资源占用越来越多，项目组之间开发合作效率也越来越低。\u003c/p\u003e\n\u003cp\u003e顺应这个时代降本增效的目的，我们希望寻找一个能解决当前几个核心问题的框架：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e模块化开发、部署、资源共享的能力，减少 Cache、Class 等资源占用，有效降低内存占用。\u003c/li\u003e\n\u003cli\u003e更快更轻的依赖，应用能够更快的启动。\u003c/li\u003e\n\u003cli\u003e能够让各个项目组不改代码或少改代码即可接入，控制开发迁移的成本，毕竟很多历史老应用不是那么容易迁移。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e基于以上背景，我们在 2022 年基于 SOFAArk 运行了一个版本，效果不太理想暂时搁置。今年 Koupleless 重新开源后做了一些增强和变更，开源社区活跃度有所提升，看宣传效果很好，我们决定重新评估是否可在公司内推广。\u003c/p\u003e\n\u003ch2 id=\"什么是-koupleless\"\u003e什么是 Koupleless\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://koupleless.io/home/\" target=\"_blank\" rel=\"noopener\"\u003eKoupleless\u003c/a\u003e\n 是一种模块化 Serverless 技术解决方案，它能让普通应用低成本演进为 Serverless 研发模式，让代码与资源解耦，轻松独立维护， 与此同时支持秒级构建部署、合并部署、动态伸缩等能力为用户提供极致的研发运维体验，最终帮助企业实现降本增效。\u003c/p\u003e\n\u003cp\u003eKoupleless 是蚂蚁集团内部经过 5 年打磨成熟的研发框架和运维调度平台能力，相较于传统镜像化的应用模式研发、运维、运行阶段都有 10 倍左右的提升，总结起来 5 大特点：快、省、灵活部署、平滑演进、生产规模化验证。\u003c/p\u003e\n\u003cp\u003e以上都是官网的宣传，更多介绍请链接到官网查看。\u003c/p\u003e\n\u003cp\u003e在整个 Koupleless 平台里，需要四个组件：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e研发工具 Arkctl, 提供模块创建、快速联调测试等能力。\u003c/li\u003e\n\u003cli\u003e运行组件 SOFAArk, Arklet，提供模块运维、模块生命周期管理，多模块运行环境。（这算两个组件？）\u003c/li\u003e\n\u003cli\u003e控制面组件 ModuleController，本质上是一个 K8S Operator，提供模块发布与运维能力。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们公司有自己的发布系统、应用管理平台，很少允许运行额外的控制面组件，那么除去 ModuleController，我个人认为，Koupleless 约等于 SOFAArk。\u003c/p\u003e\n\u003cp\u003eKoupleless 增强了 SOFAArk 运维部署相关的功能，解决了 SOFAArk 在企业内无法开箱即用的问题。\u003c/p\u003e\n\u003ch2 id=\"应用接入遇见问题\"\u003e应用接入遇见问题\u003c/h2\u003e\n\u003cp\u003e基于官方文档我们改造接入了几个应用，分享几个我们遇见的问题。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e对 Java 17 或 21 的支持不好。\n虽然官方已经声称支持 Java 17，但是若用了 Java 17 的语法或新特性，无法编译通过。最后只好自编译 SOFAArk plugin 修改相关依赖解决。\u003c/p\u003e","tags":["Java"],"title":"Koupleless 试用报告总结，踩坑记录分享"},{"content":"汇总整理了容器镜像制作最佳实践、多架构编译、Dockerfile 编写小技巧等常用技术问题，同时介绍下我日常使用的 ORAS、skopeo 等辅助工具。\n最佳实践 整理了由 Docker 官方和社区推荐的用于构建高效镜像的最佳实践和方法，当然有些可能并不适用于你，请注意分辨。\n使用官方镜像作为基础镜像。官方镜像经过了充分验证并集成了最佳实践。\n# 正例： FROM node # 反例： FROM ubuntu RUN apt-get install -y node\r保持尽可能小的镜像大小，绝不安装无关依赖。\n严格的版本化管理，使用确定性的标签，基础镜像禁用 latest。\n使用 .dockerignore 文件排除文件干扰。\n最经常变化的命令越往后执行，充分利用分层缓存机制。\nDockerfile 中每行命令产生一层，请合并命令执行，最大限度减少层数。\n使用多阶段构建，减少所构建镜像的大小。\n禁用 root 用户，使用独立的 use 和 group。\n启用镜像安全扫描，并及时更新。\n一个容器只专注做一件事情。\nJava 应用程序不要使用 PID 为 1 的进程，使用 tini 或 dump-init 管理进程，避免僵尸进程。\n以上都是一些基本的原则，但是实际工作的过程中，大家可能会像我一样纠结几个问题。\n关于第 1 点，一定要使用官方镜像吗。未必，看情况。比如我们作为平台，涉及很多种开发语言，很多种组合场景，每个官方基础镜像可能都不同，就会自建基础镜像，以便统一操作系统、统一脚本和安全维护。为什么要统一操作系统，操作系统投的毒，就像出骨鱼片里未净的刺，给人一种不期待的伤痛。 为了镜像大小和安全，一定要使用 Alpine 或 distroless 镜像吗。我的建议是不要使用 Alpine 镜像，如有能力才使用 distroless 镜像。毕竟 libc 的坑，谁痛谁知道。 Dockerfile 编写小技巧 使用 Heredocs 语法代替又长又臭的字符串拼接，当然 Heredocs 支持更多功能比如 run python、多文件内容拷贝，具体请参考官方文档。\n# 以前 RUN apt-get update \u0026amp;\u0026amp; \\ apt-get upgrade -y \u0026amp;\u0026amp; \\ apt-get install -y ... # 使用 Heredocs RUN \u0026lt;\u0026lt;EOF apt-get update apt-get upgrade -y apt-get install -y ... EOF # 单文件内容拷贝，直接生成文件内容到目标文件 COPY \u0026lt;\u0026lt;EOF /usr/share/nginx/html/index.html (your index page goes here) EOF # 多文件内容拷贝，每个文件指定不同的文件内容 COPY \u0026lt;\u0026lt;robots.txt \u0026lt;\u0026lt;humans.txt /usr/share/nginx/html/ (robots content) robots.txt (humans content) humans.txt\r使用 ARG 变量动态构建，注意 ARG 作用域。\n# ARG 可写默认值，也可不写 ARG TOMCAT_TAG=9.0.93-jre21 # 把 ARG 放到 FROM 的前面，FROM 指令即可使用变量 FROM docker.io/tomcat:${TOMCAT_TAG} # 想在 FROM 后面继续使用 ARG，需在 FROM 后再声明一次 ARG TOMCAT_TAG=9.0.93-jre21 RUN echo \u0026#34;Tomcat tag is ${TOMCAT_TAG}\u0026#34; # ARG 作用域： # 1. 在第一个 FROM 之前的所有 ARG , 在所有 FROM 中生效，仅在 FROM 中生效。 # 2. 在 FROM 后的 ARG, 仅在当前 FROM 作用域生效。 即尽在当前 stage 生效。\r使用 COPY --from 代替 curl 或 wget 静态文件下载，适用于一些 COPY 即可用的文件。\n# 去 github.com releases 下载文件可能很慢，有些组件本身有 docker 版本，COPY 来用 ARG JMX_VER=1.0.1 FROM docker.io/nxest/tomcat-jmx-agent:${JMX_VER} AS tomcat-jmx-agent COPY --from=tomcat-jmx-agent /plugins /opt/tomcat/plugins\r校验 curl 结果，如果失败退出。\n# 关于 -jkfSL 请参考 man 说明 curl -jkfSL -o vmtouch.zip \u0026#39;https://github.com/hoytech/vmtouch/archive/refs/tags/v1.3.1.zip\u0026#39;\r变量扩展，简化 Shell 书写。\n${variable:-word}：如果变量未设置，则将值设置为 word ${variable:+word}：如果变量已设置，则将值设置为 word ${var1:-$var2}: 如果 var1 未设置则取 var1\r通过 \u0026ndash;build-arg 指定 Http 代理，注意不要在 Dockerfile 里通过 ENV 指定，ENV 指定不安全且对后续部署出来的 Pod 也生效。\ndocker buildx build --build-arg http_proxy=http://your-proxy --build-arg https_proxy=http://your-proxy --build-arg no_proxy=localhost,127.0.0.1,10.*,172.*,*.cn\r多架构编译 多架构编译目前比较流行的几种方案：\ndocker 配合 qemu 实现交叉混合编译，一台机器即可。优点：简单。缺点：异构编译速度很慢。 docker 使用远端 builder，多个 builder 机器，各自编译各自原生架构，docker 会帮我们自动合并 manifest。相对简单，速度快。 使用 buildkit 或 GoogleContainerTools/kaniko 在 k8s 集群内编译。速度最快，水平扩缩容，适用于大型编译场景，需要准备更多资源。 如果你本身具备多架构的机器资源，使用 docker 远端 builder 或 kaniko 同架构编译，速度和性能是最理想的。\n高度依赖指令集的应用，比如某些老 python 包无 arm 版本触发编译，跨架构编译可能需要 3 小时，而同架构只需要 10 分钟。\nkaniko 支持“多架构编译”，但是不支持跨架构编译，不能在 amd64 机器上编译 arm64 容器，如果需要多架构只能在不同机器上多次编译，然后使用 manifest-tool 合并。\n方式 1：为一台 docker 机器启用多架构编译：\n# 创建新的 build，支持多架构，直接 use 生效，关于 --driver 类型请参考官方文档 docker buildx create --name=multi-platform --platform=linux/amd64,linux/arm64 --driver=docker-container --use --bootstrap # 查看是否生效，星号的代表当前生效的 docker buildx ls # 指定 platform，build and push docker buildx build --platform linux/amd64,linux/arm64 --push --tag tester:1.0 # 切换其他构建器 docker buildx use multi-platform # 使用 buildx 提供的 imagetools inspect 工具可以查看远程仓库中的清单列表信息 docker buildx imagetools inspect tester:1.0\r方式 2：组合一台 AMD64、一台 ARM64 机器，多节点各自编译。\n放开 docker 的 tcp 端口，注意，在生产环境一定要启用 TLS 认证，放开端口是一件很危险的事情。\n$ cat /etc/docker/daemon.json { \u0026#34;hosts\u0026#34;: [\u0026#34;unix:///var/run/docker.sock\u0026#34;, \u0026#34;tcp://0.0.0.0:2375\u0026#34;] } # 创建一个新的 builder，指定支持的架构类型 docker buildx create --name multi-remote --node node-amd64 --platform linux/amd64 # 使用 --append，追加节点，指定支持的架构类型。除了使用 tcp 方式，也可使用 ssh 方式，ssh 需要配置免密登录 docker buildx create --name multi-remote --append \\ --node node-arm64 --platform linux/arm64,linux/arm64/v8,linux/arm/v7 \\ tcp://your-arm64-node-ip:2375 # 切换，启用 docker buildx use multi-remote docker buildx inspect --bootstrap\r查看 buildx，确认是否生效。\n$ docker buildx ls NAME/NODE DRIVER/ENDPOINT STATUS BUILDKIT PLATFORMS builder docker-container \\_ builder0 \\_ unix:///var/run/docker.sock inactive multi-container* docker-container \\_ multi-container0 \\_ unix:///var/run/docker.sock running v0.16.0 linux/amd64*, linux/arm64*, linux/amd64/v2, linux/amd64/v3, linux/386, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6 multi-remote docker-container \\_ node-amd64 \\_ unix:///var/run/docker.sock inactive linux/amd64* \\_ node-arm64 \\_ tcp://192.168.100.200:2375 inactive linux/arm64*, linux/arm/v7* default docker \\_ default \\_ default running v0.13.2 linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/386 在 Dockerfile 中判断架构，支持如下架构相关的变量。\nTARGETPLATFORM: 构建镜像的目标平台，例如 linux/amd64, linux/arm/v7, windows/amd64。 TARGETOS: TARGETPLATFORM 的 OS 类型，例如 linux, windows。 TARGETARCH: TARGETPLATFORM 的架构类型，例如 amd64, arm64。 TARGETVARIANT: TARGETPLATFORM 的变种，该变量可能为空，例如 v7。 BUILDPLATFORM: 构建镜像主机平台，例如 linux/amd64。 BUILDOS: BUILDPLATFORM 的 OS 类型，例如 linux。 BUILDARCH: BUILDPLATFORM 的架构类型，例如 amd64。 BUILDVARIANT: BUILDPLATFORM 的变种，该变量可能为空，例如 v7。 代码中判断架构举例。\nFROM alpine:3.20 # 需要先声明 ARG 才可使用， 但不需要主动赋值，docker 会自动赋值 ARG TARGETARCH RUN \u0026lt;\u0026lt;EOF set -e if [ \u0026#34;${TARGETARCH}\u0026#34; = \u0026#34;amd64\u0026#34; ]; then echo \u0026#34;this is amd64\u0026#34; elif [ \u0026#34;${TARGETARCH}\u0026#34; = \u0026#34;arm64\u0026#34; ]; then echo \u0026#34;this is arm64\u0026#34; fi EOF\r在 FROM 中强制切换架构，使用特定平台的基础镜像。\n# 使用特定平台的基础镜像 FROM --platform=linux/amd64 ubuntu:20.04 FROM --platform=$TARGETPLATFORM ubuntu:20.04 # 在这里添加你的指令 RUN apt-get update \u0026amp;\u0026amp; apt-get install -y curl\r辅助工具 hadolint hadolint 是一个 Dockerfile 语法检测工具，根据最近实践检测语法给出修改方式。\n可以用命令行执行，可以 Docker 镜像执行，也可以使用 Online 在线分析 。\nskopeo skopeo 是一个镜像搬运工具。\n不需要运行守护进程，用于对容器镜像与容器仓库执行管理操作的命令行工具，支持 OCI 镜像与 Docker V2 镜像。\n可以执行的典型操作场景：\n通过各种存储机制复制镜像，例如，可以在不需要特权的情况下将镜像从一个 Registry 复制到另一个 Registry。 检测远程镜像并查看其属性，包括其图层，无需将镜像拉到本地。 从镜像库中删除镜像。 当存储库需要时，skopeo 可以传递适当的凭据和证书进行身份验证。 看一下他的 help 就知道什么意思了。\n$ skopeo --help Various operations with container images and container image registries Usage: skopeo [flags] skopeo [command] Available Commands: copy Copy an IMAGE-NAME from one location to another delete Delete image IMAGE-NAME inspect 查看一个镜像的 manifest 或者 image config 详细信息 list-tags List tags in the transport/repository specified by the SOURCE-IMAGE login Login to a container registry manifest-digest 计算文件的清单摘要是一个 sha256sum 值 standalone-sign 使用本地文件创建签名 standalone-verify 验证本地文件的签名 sync 将一个或多个图像从一个位置同步到另一个位置，非常实用 # 查询支持支持的传输格式，举例 $ skopeo copy --help Supported transports: containers-storage, dir, docker, docker-archive, docker-daemon, oci, oci-archive, ostree, sif, tarball Usage: skopeo copy [command options] SOURCE-IMAGE DESTINATION-IMAGE Examples: skopeo copy docker://quay.io/skopeo/stable:latest docker://registry.example.com/skopeo:latest 日常使用可留作 shell 脚本，快速复制镜像，包括 OCI 格式的 helm charts。\n# 指定自建的 harbor 地址 expport PRIVATE_HARBOR=custom.harbor.local skopeo login ${PRIVATE_HARBOR} # 指定 --multi-arch=all，复制多架构镜像 skopeo copy --multi-arch=all docker://ghcr.io/graalvm/jdk-community:23.0.1 docker://${PRIVATE_HARBOR}/ghcr.io/graalvm/jdk-community:23.0.1\r遇见问题和解决办法 在 docker 多节点构建时，偶尔出现编译完了，一直卡在 exporting to client directory 不动，任务无法结束。\n参考官方 buildkit/issues/2950 ，按照大家的描述，build 镜像大于 500M 时就容易触发此问题。\n我的解决办法是，在 build 时指定 compression=zstd 启用压缩，基本上能解决这个问题。我这里使用了 zstd 压缩，需要在 docker 编译机器上安装 zstd 并且需要 K8S 运行集群支持，否则拉取镜像时可能出现不支持的类型 zstd，简单起见改为 gzip 压缩即可。\n# compression=zstd 解决 buildkit/issues/2950 exporting 偶尔卡死问题 # type=image,oci-mediatypes=false 编译出 docker v2 格式镜像，为了兼容有些老版本集群还不支持 oci 格式 # --provenance=false 是为了不生成烦人的无 tag metadata docker buildx build --output type=image,oci-mediatypes=false,compression=zstd --provenance=false --push\r","date":"2024-05-24","id":15,"permalink":"/blog/docker-best-practices/","summary":"\u003cp\u003e汇总整理了容器镜像制作最佳实践、多架构编译、Dockerfile 编写小技巧等常用技术问题，同时介绍下我日常使用的 ORAS、skopeo 等辅助工具。\u003c/p\u003e\n\u003ch2 id=\"最佳实践\"\u003e最佳实践\u003c/h2\u003e\n\u003cp\u003e整理了由 Docker 官方和社区推荐的用于构建高效镜像的最佳实践和方法，当然有些可能并不适用于你，请注意分辨。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e使用官方镜像作为基础镜像。官方镜像经过了充分验证并集成了最佳实践。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# 正例：\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e    FROM node\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"c\"\u003e# 反例：\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e    FROM ubuntu\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e    RUN apt-get install -y node\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e保持尽可能小的镜像大小，绝不安装无关依赖。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e严格的版本化管理，使用确定性的标签，基础镜像禁用 latest。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e使用 .dockerignore 文件排除文件干扰。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e最经常变化的命令越往后执行，充分利用分层缓存机制。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDockerfile 中每行命令产生一层，请合并命令执行，最大限度减少层数。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e使用多阶段构建，减少所构建镜像的大小。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e禁用 root 用户，使用独立的 use 和 group。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e启用镜像安全扫描，并及时更新。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e一个容器只专注做一件事情。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJava 应用程序不要使用 PID 为 1 的进程，使用 tini 或 dump-init 管理进程，避免僵尸进程。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e以上都是一些基本的原则，但是实际工作的过程中，大家可能会像我一样纠结几个问题。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e关于第 1 点，一定要使用官方镜像吗。未必，看情况。比如我们作为平台，涉及很多种开发语言，很多种组合场景，每个官方基础镜像可能都不同，就会自建基础镜像，以便统一操作系统、统一脚本和安全维护。为什么要统一操作系统，操作系统投的毒，就像出骨鱼片里未净的刺，给人一种不期待的伤痛。\u003c/li\u003e\n\u003cli\u003e为了镜像大小和安全，一定要使用 Alpine 或 distroless 镜像吗。我的建议是不要使用 Alpine 镜像，如有能力才使用 distroless 镜像。毕竟 libc 的坑，谁痛谁知道。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"dockerfile-编写小技巧\"\u003eDockerfile 编写小技巧\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e使用 Heredocs 语法代替又长又臭的字符串拼接，当然 Heredocs 支持更多功能比如 run python、多文件内容拷贝，具体请参考官方文档。\u003c/p\u003e","tags":["k8s"],"title":"容器镜像制作最佳实践，多架构编译，Dockerfile 编写小技巧和踩坑记录，镜像维护辅助工具 ORAS、skopeo 等介绍"},{"content":"\r虽然 Java 界流行 你发任你发，我用 Java 8。但根据 Azul 组织发布关于 Java 使用的最新数据显示，Java 17 悄悄登上了使用率最高的宝座，Java 21 也紧随其后。相信在未来的几年，Java 25 将占据主流。\n升级收益 破坏性变更评估工具 在升级之前，可通过 jdeps 和 jdeprscan 先评估下是否有使用内部类和废弃 API，有一个总的概览。\njdeps jdeps 是 Java 自带的命令行工具，可以用来分析依赖关系和生成模块信息文件，这里我们只借用他的其中一项功能。\n通过 jdeps --jdk-internals 检查是否有使用内部 API，以下例子显示使用了 sun.net.util.IPAddressUtil 这个 Java 内部工具类，会显示详细的源码类和 jar 包位置。\n可以继续使用 Java 中的内部 API，另外 OpenJDK Wiki 页面 Java Dependency Analysis Tool 推荐了某些常用 JDK 内部 API 的替换项，可参考这些建议替换掉。\n$ jdeps -dotoutput \u0026lt;dot-file-dir\u0026gt; -jdkinternals \u0026lt;one-or-more-jar-files....\u0026gt; $ jdeps --jdk-internals --multi-release 21 --class-path . target/xxx.jar . -\u0026gt; java.base com.my.SecurityChecker -\u0026gt; sun.net.util.IPAddressUtil JDK internal API (java.base) Warning: JDK internal APIs are unsupported and private to JDK implementation that are subject to be removed or changed incompatibly and could break your application. Please modify your code to eliminate dependence on any JDK internal APIs. For the most recent update on JDK internal API replacements, please check: https://wiki.openjdk.org/display/JDK8/Java+Dependency+Analysis+Tool jdeprscan jdeprscan 也是 Java 自带分析工具，可查看是否使用了已弃用或已删除的 API。使用已弃用的 API 不是阻塞性问题，还能接着跑，但是建议替换掉。使用已删除的 API，那就彻底跑不起来了。\n# 了解自 Java 8 后弃用的具体 API $ jdeprscan --release 21 --list # 加上 --for-removal ，列出已删除的 API $ jdeprscan --release 21 --list --for-removal @Deprecated(since=\u0026#34;9\u0026#34;, forRemoval=true) class javax.security.cert.Certificate @Deprecated(since=\u0026#34;9\u0026#34;, forRemoval=true) class javax.security.cert.CertificateEncodingException …… @Deprecated(since=\u0026#34;18\u0026#34;, forRemoval=true) void java.lang.Enum.finalize() @Deprecated(since=\u0026#34;17\u0026#34;, forRemoval=true) void java.lang.System.setSecurityManager(java.lang.SecurityManager) @Deprecated(since=\u0026#34;17\u0026#34;, forRemoval=true) java.lang.SecurityManager java.lang.System.getSecurityManager() @Deprecated(since=\u0026#34;21\u0026#34;, forRemoval=true) javax.management.MBeanServerConnection javax.management.remote.JMXConnector.getMBeanServerConnection(javax.security.auth.Subject) 扫描自己的代码中是否有使用废弃 API：\n# 注意通过 --class-path 增加依赖的 jar 包 $ jdeprscan --release 21 --class-path log4j-api-2.13.0.jar my-application.jar error: cannot find class sun/misc/BASE64Encoder class com/company/Util uses deprecated method java/lang/Double::\u0026lt;init\u0026gt;(D)V 以上例子，com.company.Util 类在调用 java.lang.Double 类的已弃用构造函数。 javadoc 会建议用来代替已弃用 API 的 API。 但是无法解决“error: cannot find class sun/misc/BASE64Encoder”问题，因为它是已删除的 API， 自 Java 8 发布以来，应使用 java.util.Base64。\n注意使用 jdeprscan 需要通过 \u0026ndash;class-path 指定依赖项，可先执行 mvn dependency:copy-dependencies 命令，此时会 copy 依赖项到 target/dependency 目录。\n如果你加了 \u0026ndash;class-path 依赖，大概率还是报错误 error: cannot find class，目测寻找依赖项是根据 target/dependency 中的名字顺序找的，不是常规的 java 进程一次性加载完，不知道这算不算 jdeprscan 的设计 Bug，具体解决办法可参考 jdeprscan-throws-cannot-find-class-error 。\n我采用的解决方式是把所有依赖 jar 文件都接到某个文件夹，解压成 classes，然后 class-path 使用此文件。这样还有个好处，扫描报告里只有我真正要扫描的当前项目的报告，不包含第三方 jar 的。\n以上过程命令行参考：\nmvn dependency:copy-dependencies -Dsilent=true mkdir -p target/dependency-classes for jar in target/dependency/*.jar; do unzip -o \u0026#34;$jar\u0026#34; -d target/dependency-classes done jdeprscan --class-path target/dependency-classes target/really-project.jar\r除了使用 jdeprscan 命令行以外，也可在你项目的 maven pom 文件中引入 maven-jdeps-plugin，如下示例，引入后如果有使用废弃 API，将在 mvn package 的时候直接失败报错，避免有人无意引入废弃 API。\n\u0026lt;project\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-jdeps-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.1.2\u0026lt;/version\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;!-- verify main classes --\u0026gt; \u0026lt;goal\u0026gt;jdkinternals\u0026lt;/goal\u0026gt; \u0026lt;!-- verify test classes --\u0026gt; \u0026lt;goal\u0026gt;test-jdkinternals\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;multiRelease\u0026gt;21\u0026lt;/multiRelease\u0026gt; \u0026lt;!-- 其他参数按需配置 --\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt;\remt4j emt4j 是 Eclipse 推出的一个静态分析工具，下面会详细介绍用法，展示效果。\n升级兼容方法 利用 Maven 的 profile 机制，根据 JDK 版本号，自动激活不同的配置。\n\u0026lt;profiles\u0026gt; \u0026lt;!-- 以下配置抄自地瓜哥博客，感谢地瓜哥 --\u0026gt; \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;Java1.8\u0026lt;/id\u0026gt; \u0026lt;activation\u0026gt; \u0026lt;!-- 在 JDK 1.8 时自动激活--\u0026gt; \u0026lt;jdk\u0026gt;1.8\u0026lt;/jdk\u0026gt; \u0026lt;/activation\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;spring.version\u0026gt;5.3.33\u0026lt;/spring.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;!-- 在父 POM 中使用 dependencyManagement 生命 --\u0026gt; \u0026lt;!-- 在需要的子模块中可以直接使用 --\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javax.servlet\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javax.servlet-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.0.1\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-surefire-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.5\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;includes\u0026gt; \u0026lt;include\u0026gt;**/*Test.java\u0026lt;/include\u0026gt; \u0026lt;/includes\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-compiler-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.13.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;showWarnings\u0026gt;true\u0026lt;/showWarnings\u0026gt; \u0026lt;fork\u0026gt;true\u0026lt;/fork\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/profile\u0026gt; \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;Java21\u0026lt;/id\u0026gt; \u0026lt;activation\u0026gt; \u0026lt;!-- 在 Java 21 以上激活 --\u0026gt; \u0026lt;jdk\u0026gt;[21,)\u0026lt;/jdk\u0026gt; \u0026lt;/activation\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;spring.version\u0026gt;6.0.19\u0026lt;/spring.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;!-- 在父 POM 中使用 dependencyManagement 生命 --\u0026gt; \u0026lt;!-- 在需要的子模块中可以直接使用 --\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;jakarta.servlet\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jakarta.servlet-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;6.0.0\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openjdk.nashorn\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;nashorn-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;15.4\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.glassfish.jaxb\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jaxb-runtime\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.3.9\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javax.annotation\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javax.annotation-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.3.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-surefire-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.5\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;includes\u0026gt; \u0026lt;include\u0026gt;**/*Test.java\u0026lt;/include\u0026gt; \u0026lt;/includes\u0026gt; \u0026lt;argLine\u0026gt; --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.util=ALL-UNNAMED --add-opens java.base/java.math=ALL-UNNAMED --add-opens java.base/java.time=ALL-UNNAMED \u0026lt;/argLine\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-compiler-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;showWarnings\u0026gt;true\u0026lt;/showWarnings\u0026gt; \u0026lt;fork\u0026gt;true\u0026lt;/fork\u0026gt; \u0026lt;compilerArgs\u0026gt; \u0026lt;arg\u0026gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED\u0026lt;/arg\u0026gt; \u0026lt;/compilerArgs\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/profile\u0026gt; \u0026lt;/profiles\u0026gt;\rJava 模块化兼容。\n你一定见过这种错误。\nCaused by: java.lang.reflect.InaccessibleObjectException: Unable to make field protected int[] java.util.Calendar.fields accessible: module java.base does not \u0026#34;opens java.util\u0026#34; to unnamed module @21282ed8 也一定知道怎么解决了，将没开放的模块强制对外开放，有两个参数选项： \u0026ndash;add-exports 导出包，意味着其中的所有公共类型和成员都可以在编译和运行时访问。 \u0026ndash;add-opens 打开包，意味着其中的所有类型和成员（不仅是公共类型）都可以在运行时访问。\n两者的区别在于 \u0026ndash;add-opens 开放的更加彻底，不仅 public 类型、变量及方法可以访问，就连非 public 元素，也可以通过调用 setAccessible(true) 后也可以访问。简单起见，直接使用 \u0026ndash;add-opens 即可。\n使用 Maven 命令时，配置 maven-surefire-plugin 插件，参考如下：\n\u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-surefire-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;argLine\u0026gt; --add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.math=ALL-UNNAMED \u0026lt;/argLine\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt;\r在 IntelliJ IDEA 运行程序如果报错，可以通过在 “VM Option” 配置项中，增加 Java 模块化 --add-opens 相关启动参数即可正常启动。\n完整 add-opens 列表。\n--add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED --add-opens=java.base/java.math=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/java.security=ALL-UNNAMED --add-opens=java.base/java.text=ALL-UNNAMED --add-opens=java.base/java.time=ALL-UNNAMED --add-opens=java.base/jdk.internal.access=ALL-UNNAMED --add-opens=java.base/jdk.internal.misc=ALL-UNNAMED\r辅助迁移工具 一些辅助迁移到新版本的工具，仅供参考。\nMaven 依赖包更新 使用 maven 检查是否有最新的依赖包和插件，对整体项目有一个全局的了解。注意，这里给的建议仅供参考，不要一下子应用上，需要综合考虑当前的项目依赖关系。\nmvn versions:display-dependency-updates mvn versions:display-plugin-updates\rEclipse Migration Toolkit for Java (EMT4J) EMT4J 也是一个静态分析工具，可输出分析报告，也可直接 apply 到 git，支持通过 maven 插件、cli 命令行、Java Agent 3 种方式分析。\n目前发布比较慢，只有 master 分支支持 Java 21，可以基于 master 分支自己编译构建，也可以使用已 Realease 版本只分析到 Java 17。\n# 以下示例自己编译构建，master 分支还不太稳定，可能出错 $ git clone git@github.com:adoptium/emt4j.git $ cd emt4j $ mvn clean package -Prelease # 以上步骤生成 emt4j-${version}.zip 在 emt4j-assembly/target 目录下。 # 解压以上 zip 后，得到 emt4j tree -L 2 . ├── bin │ ├── analysis.bat │ └── analysis.sh └── lib ├── agent ├── analysis └── maven-plugin # 注意 emt4j 需要使用 Java 8 运行，所以先把自己的 Java 环境切换到 Java 8 $ sh bin/analysis.sh -f 8 -t 17 -o report.html my-java-project-dir # 在 report.html 能看到分析内容和建议，如 Issues Context Location: refclass:file:my-java-project-dir/target/classes/com/mypackage/spring/BaseAbstractDataSource.class!/com.mypackage.spring.BaseAbstractDataSource!/, Target: java.lang.Class.newInstance()Ljava/lang/Object; 可通过 emt4j-maven-plugin 进行检查。增加以下 plugin，执行 mvn emt4j:check 成功后查看报告。\n注意 emt4j-maven-plugin 目前版本 0.8.0 比较老，请使用 Java 8 或 Java 17 跑 mvn 命令，版本太高会失败。\n\u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.eclipse.emt4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;emt4j-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.8.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;!-- 当前版本 --\u0026gt; \u0026lt;fromVersion\u0026gt;8\u0026lt;/fromVersion\u0026gt; \u0026lt;!-- 期望升级版本，0.8.0 还不支持 Java 21 --\u0026gt; \u0026lt;toVersion\u0026gt;17\u0026lt;/toVersion\u0026gt; \u0026lt;outputFile\u0026gt;target/report.html\u0026lt;/outputFile\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt;\r不想使用 xml 配置的，可参考以下命令行直接 run plugin。\n# 官方当前发布的版本 mvn process-test-classes org.eclipse.emt4j:emt4j-maven-plugin:0.8.0:check -DfromVersion=8 -DtoVersion=17 -DoutputFile=emt4j-report.html # 这个是我自己基于 master 分支编译的 0.91 版本，支持 Java21 mvn process-test-classes org.eclipse.emt4j:emt4j-maven-plugin:0.91:process -DfromVersion=8 -DtoVersion=21 -DoutputFile=emt4j-report.html\r检查结果错误可能很多，根据优先级修改，比如以下我的检查结果，检查结果支持中英文展示。\nNon-heap memory footprint increasing Description Priority: p1 Issue Count: 1 Netty uses the direct byte buffer internally. There 2 ways to manage the direct buffer lifecycle, the first it\u0026#39;s managed by Netty self, and the second is managed by JVM. In JDK 8, netty uses the first way, but in JDK 11, netty uses the second. The first cannot be monitored through MXBean, but the second can be monitored. How to fix If you want keep the first way,add the option to JVM:\u0026#34;-Dio.netty.tryReflectionSetAccessible=true --add-opens=java.base/jdk.internal.misc=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED\u0026#34; when running on JDK 11.But if use the second way,the netty should upgrade to a version at least 4.1.33. Because the older netty use a remove API tht release byte buffer. Issues Context Target: file:/Users/l10178/.m2/repository/io/netty/netty/3.10.0.Final/netty-3.10.0.Final.jar 优先级：p1 有一些 class 已经被删除了需要修改代码替换成为新的 API 位置：file:xxx/Base64Util.class, 目标：sun.misc.BASE64Decoder 优先级：p3 通过测试已知的一些不兼容的 jar 如何修复： file:/root/.m2/repository/dom4j/dom4j/1.6.1/dom4j-1.6.1.jar 不匹配规则 \u0026#34;Version should \u0026gt;= \u0026#39;2.0\u0026#39; \u0026#34; OpenRewrite 一键升级依赖包，重构源码，入门指导可参考我的另一篇博客：智能代码重构 。 OpenRewrite 更成熟易用。\nJaCoLine 检查 Java 命令行选项参数有没有问题，识别出已经过时不支持的参数。\nJava 参数查询工具 Java 参数太多，到 VM Options Explorer - Corretto JDK21 中参照，里面根据 JDK 的版本以及发行商，列出来所有的相关参数，选择好对应发行商的正确版本，就可以搜索或者查看 java 命令支持的所有参数了。\n推荐配置 升级到 Java 21 以后以下是根据我们公司常规经验推荐的配置，非普世可用，请根据自己的应用情况臻选。\n如果在使用 ZGC，推荐启用分代 -XX:+ZGenerational ，对稳定性、吞吐量、内存占用都有很大优化。Java 23 默认已启用分代 ZGC。 在很多场景下 G1 仍然是最稳的选择，内存占用比 ZGC 低，CPU 更稳定。大部分场景下小内存应用，并不需要 ZGC。 亲测大部分应用 Java 23 比 Java 21 内存占用约少 5%-10%，GC 更稳定。 遇见问题和解决办法 一定要升级依赖包吗，不升级能编译通过，直接用 Java 21 能不能跑起来，会不会有问题。\n以我们实际经验来看，确实有很多应该不升级可直接运行，也没有问题。但是遇到了一些应用，跑着跑着 OOM 了，切换回 Java 8 就没有问题，还不知道是哪个包不兼容。\nTLS 不兼容问题，类似如下错误。JDK 17 是支持 TLS1.0 ~ TLS1.3 的，但是默认使用的 TLS 版本是 TLS 1.3, 老版本被禁用了，需要主动放开。\n# 错误日志 The server selected protocol version TLS10 is not accepted by client preferences [TLS13, TLS12]。 # 配置文件 $JAVA_HOME/conf/security/java.security # 找到里面的一行配置： jdk.tls.disabledAlgorithms=SSLv3, TLSv1, TLSv1.1, RC4, DES, MD5withRSA, \\ DH keySize \u0026lt; 1024, EC keySize \u0026lt; 224, 3DES_EDE_CBC, anon, NULL # 说明：JDK 中的 jdk.tls.disabledAlgorithms 参数用于禁用不安全或不需要的 TLS 密码算法， 以提高系统的安全性。通过配置这个参数，可以指定 JDK 不支持的密码算法或协议，以降低它们的优先级， 减少被攻击的风险。 # 我们把 TLSv1，TLSv1.1 这两个删除掉，变成如下： jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, \\ DH keySize \u0026lt; 1024, EC keySize \u0026lt; 224, 3DES_EDE_CBC, anon, NULL # 不建议直接去改原 java.security 文件，可自定义一个新文件 custom.java.security，内容只包含 disabledAlgorithms 配置 jdk.tls.disabledAlgorithms=RC4, DES, MD5withRSA, \\ DH keySize \u0026lt; 1024, EC keySize \u0026lt; 224, 3DES_EDE_CBC, anon, NULL, \\ include jdk.disabled.namedCurves # 然后启动的命令行增加以下参数配置，指定自定义的 java.security 文件覆盖文件里有的值 -Djava.security.properties=$JAVA_HOME/conf/security/custom.java.security # 注意注意，用两个等号 == 指定自定义的 java.security 文件，是覆盖整个 Java 默认的 java.security 文件，原文件全部失效，只用自定义文件里的配置 -Djava.security.properties==$JAVA_HOME/conf/security/custom.java.security module jdk.proxy3 does not \u0026ldquo;opens jdk.proxy3\u0026rdquo; to unnamed module.\n网上包括人工智能推荐的答案都是 add-opens，这也是我想到的第一个方式，毕竟以前遇见 unnamed module 都是这么干的。\n-–add-opens=jdk.proxy3=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED 实际上都不生效。Java 里并没有一个真的叫 jdk.proxy3 的模块，这是由 Dynamic Proxy 动态生成的一个虚拟方法。最根本的解决办法还是升级代码，不要调用 Java 过时的方法。我这里是因为 Groovy 调用产生，升级了一下 Groovy，完美解决。\n参考资料 从 Java 15 到 23 关于 G1 GC 的优化\nhttps://tschatzl.github.io/ Oracle 出的 Java 21 迁移指南，包含新特性介绍、Removed APIs、Removed Tools and Components 等\nhttps://docs.oracle.com/en/java/javase/21/migrate/getting-started.html Microsoft transition from java 8 to java 11\nhttps://learn.microsoft.com/en-us/java/openjdk/transition-from-java-8-to-java-11 Java Dependency Analysis Tool\nhttps://wiki.openjdk.org/display/JDK8/Java+Dependency+Analysis+Tool 什么是多版本 Jar（Multi Release Jar）\nhttps://docs.oracle.com/en/java/javase/11/docs/specs/jar/jar.html#multi-release-jar-files Java G1 重要参数设置参考\nhttps://gceasy.io/gc-recommendations/important-g1-gc-arguments.jsp 地瓜哥 JVM GC 性能测试（三）：真实流量\nhttps://www.diguage.com/post/gc-performance-real-qps/ 地瓜哥 OpenJDK 21 升级指南\nhttps://www.diguage.com/post/upgrade-to-openjdk21/ jdeprscan can not find class 解决办法\nhttps://stackoverflow.com/questions/49525496/jdeprscan-throws-cannot-find-class-error/ 从 Java 8 升级到 Java 17 踩坑全过程\nhttps://cloud.tencent.com/developer/article/2257886 阿里云开发者社区 Java 升级总结\nhttps://www.zhihu.com/tardis/zm/art/585377119?source_id=1003 ","date":"2024-05-23","id":16,"permalink":"/blog/migrating-java8-to-java25/","summary":"\u003cp\u003e\r\n\r\n\u003cimg\r\n  src=\"/blog/migrating-java8-to-java25/java25_hu_42c3cb3c5a24a2c.webp\"\r\n  width=\"770\"\r\n  height=\"403\"\r\n  decoding=\"async\"\r\n  fetchpriority=\"auto\"\r\n  loading=\"lazy\"\r\n  alt=\"java25-release\"title=\"java25-release\"\r\n  id=\"h-rh-i-0\"\r\n\u003e\u003c/p\u003e\n\u003cp\u003e虽然 Java 界流行 \u003cstrong\u003e你发任你发，我用 Java 8\u003c/strong\u003e。但根据 Azul 组织发布关于 Java 使用的最新数据显示，Java 17 悄悄登上了使用率最高的宝座，Java 21 也紧随其后。相信在未来的几年，Java 25 将占据主流。\u003c/p\u003e\n\u003cp\u003e\r\n\r\n\u003cimg\r\n  src=\"/blog/migrating-java8-to-java25/java-report_hu_cf024fc5f59d1d32.webp\"\r\n  width=\"1080\"\r\n  height=\"609\"\r\n  decoding=\"async\"\r\n  fetchpriority=\"auto\"\r\n  loading=\"lazy\"\r\n  alt=\"java-report\"title=\"java-report\"\r\n  id=\"h-rh-i-1\"\r\n\u003e\u003c/p\u003e\n\u003ch2 id=\"升级收益\"\u003e升级收益\u003c/h2\u003e\n\u003ch2 id=\"破坏性变更评估工具\"\u003e破坏性变更评估工具\u003c/h2\u003e\n\u003cp\u003e在升级之前，可通过 jdeps 和 jdeprscan 先评估下是否有使用内部类和废弃 API，有一个总的概览。\u003c/p\u003e\n\u003ch3 id=\"jdeps\"\u003ejdeps\u003c/h3\u003e\n\u003cp\u003ejdeps 是 Java 自带的命令行工具，可以用来分析依赖关系和生成模块信息文件，这里我们只借用他的其中一项功能。\u003c/p\u003e\n\u003cp\u003e通过 \u003ccode\u003ejdeps --jdk-internals\u003c/code\u003e 检查是否有使用内部 API，以下例子显示使用了 \u003ccode\u003esun.net.util.IPAddressUtil\u003c/code\u003e 这个 Java 内部工具类，会显示详细的源码类和 jar 包位置。\u003c/p\u003e\n\u003cp\u003e可以继续使用 Java 中的内部 API，另外 OpenJDK Wiki 页面 \u003ca href=\"https://wiki.openjdk.org/display/JDK8/Java\u0026#43;Dependency\u0026#43;Analysis\u0026#43;Tool\" target=\"_blank\" rel=\"noopener\"\u003eJava Dependency Analysis Tool\u003c/a\u003e\n 推荐了某些常用 JDK 内部 API 的替换项，可参考这些建议替换掉。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"gp\"\u003e$\u003c/span\u003e jdeps -dotoutput \u0026lt;dot-file-dir\u0026gt; -jdkinternals \u0026lt;one-or-more-jar-files....\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"gp\"\u003e$\u003c/span\u003e jdeps --jdk-internals --multi-release \u003cspan class=\"m\"\u003e21\u003c/span\u003e --class-path . target/xxx.jar\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e. -\u0026gt; java.base\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e   com.my.SecurityChecker -\u0026gt; sun.net.util.IPAddressUtil  JDK internal API (java.base)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003eWarning: JDK internal APIs are unsupported and private to JDK implementation that are\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003esubject to be removed or changed incompatibly and could break your application.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003ePlease modify your code to eliminate dependence on any JDK internal APIs.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003eFor the most recent update on JDK internal API replacements, please check:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003ehttps://wiki.openjdk.org/display/JDK8/Java+Dependency+Analysis+Tool\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003ch3 id=\"jdeprscan\"\u003ejdeprscan\u003c/h3\u003e\n\u003cp\u003ejdeprscan 也是 Java 自带分析工具，可查看是否使用了已弃用或已删除的 API。使用已弃用的 API 不是阻塞性问题，还能接着跑，但是建议替换掉。使用已删除的 API，那就彻底跑不起来了。\u003c/p\u003e","tags":[],"title":"从 Java 8 升级到 Java 25，踩坑记录、变更评估方法、辅助工具介绍"},{"content":"在搭建本地 Kubernetus 集群后，由于环境在内网，做不了域名验证，无法使用 Let\u0026rsquo;s Encrypt 颁发和自动更新证书，然而很多应用要求必须启用 HTTPS，只能用自签名 CA 证书，并由此 CA 继续颁发其他证书。\n所以我们准备了以下工具，开始搭建。\nPulumi : 当前非常流行的 IaC 工具，值得一试。 cert-manager : 云原生证书管理，用于自动管理和颁发各种发行来源的 TLS 证书。它将确保证书有效并定期更新，并尝试在到期前的适当时间更新证书。 核心步骤和相关代码如下，更多源码请参考我们的 GitHub 项目 xlabs-ops 。\n使用 Pulumi 安装 cert-manager，生成自签名 CA 证书，根据自签名 CA 证书生成 cert-manager ClusterIssuer，都在如下代码了。\nimport * as pulumi from \u0026#34;@pulumi/pulumi\u0026#34;; import * as kubernetes from \u0026#34;@pulumi/kubernetes\u0026#34;; import * as tls from \u0026#34;@pulumi/tls\u0026#34;; // 部署 cert-manager Helm chart const certManagerRelease = new kubernetes.helm.v3.Release(\u0026#34;cert-manager\u0026#34;, { name: \u0026#34;cert-manager\u0026#34;, chart: \u0026#34;cert-manager\u0026#34;, version: \u0026#34;1.14.5\u0026#34;, namespace: \u0026#34;cert-manager\u0026#34;, createNamespace: true, timeout: 600, repositoryOpts: { repo: \u0026#34;https://charts.jetstack.io\u0026#34; }, values: { installCRDs: true } }); // 生成一个 CA private key const caPrivateKey = new tls.PrivateKey(\u0026#34;caPrivateKey\u0026#34;, { algorithm: \u0026#34;RSA\u0026#34; }); // 生成一个 自签名 CA 证书 const caCert = new tls.SelfSignedCert(\u0026#34;caCert\u0026#34;, { // keyAlgorithm: \u0026#34;RSA\u0026#34;, privateKeyPem: caPrivateKey.privateKeyPem, isCaCertificate: true, validityPeriodHours: 87600, // 10 year allowedUses: [\u0026#34;cert_signing\u0026#34;, \u0026#34;crl_signing\u0026#34;], subject: { commonName: \u0026#34;your.domain.com\u0026#34;, organization: \u0026#34;Xlabs Club\u0026#34; } }); // 生成一个带有 CA crt 和 key 的 Kubernetes Secret const caSecret = new kubernetes.core.v1.Secret(\u0026#34;caSecret\u0026#34;, { metadata: { name: \u0026#34;selfsigned-cert-manager-ca\u0026#34;, namespace: \u0026#34;cert-manager\u0026#34; }, type: \u0026#34;Opaque\u0026#34;, stringData: { \u0026#34;tls.crt\u0026#34;: caCert.certPem, \u0026#34;tls.key\u0026#34;: caPrivateKey.privateKeyPem } }); // 创建一个自签名的 ClusterIssuer 给 ingress 用 const clusterIssuer = new kubernetes.apiextensions.CustomResource( \u0026#34;selfsigned-issuer\u0026#34;, { apiVersion: \u0026#34;cert-manager.io/v1\u0026#34;, kind: \u0026#34;ClusterIssuer\u0026#34;, metadata: { name: \u0026#34;selfsigned-issuer\u0026#34;, // 注意 ClusterIssuer 和 caSecret 放在同一个 namespace，不写 namespace 时 ClusterIssuer 找不到 caSecret namespace: \u0026#34;cert-manager\u0026#34; }, spec: { ca: { secretName: caSecret.metadata.name } } }, { dependsOn: certManagerRelease } ); export const certManagerVersion = certManagerRelease.version; export const clusterIssuerName = clusterIssuer.metadata.name; // Export CA 证书，便于客户端导入信任证书 export const caCertificatePem = caCert.certPem;\r以上执行 pulumi up 后，我们就得到了一个自签名的 CA 证书、一个可用于为 ingress 自动签发 TLS 的 ClusterIssuer。\n在 K8S ingress 上，增加以下 annotations 即可自动生成 TLS 证书，注意名字 selfsigned-issuer 与上面创建的名字保持一致。\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: cert-manager.io/cluster-issuer: selfsigned-issuer\r另外提供一个小插曲，实际上 cert-manager 的 ClusterIssuer 不需要指定 namespace，但是在创建的时候发现不写 namespace，caSecret 创建在 default namespace 后，ClusterIssuer 找不到 caSecret，所以为他们两个都特别指定了 namespace。\n让 Edge/Chrome 信任自签名证书 以上生成的自签名证书在浏览器访问时，会有红色提示不安全，被禁止访问，所以需要将我们的 CA 证书导入本机并选择信任。\n# 导出上面步骤生产的 CA 证书 pulumi stack output caCertificatePem --show-secrets \u0026gt; ca.crt.pem\rMac 用户，通过以下命令行，或打开 Keychain Access 应用程序手动导入并在 info trust 中选择 always trust。\nsudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ca.crt.pem\r对于 Ubuntu 用户，可通过以下命令导入。某些 Ubuntu Desktop 增加信任证书后，Edge 仍然提示证书无效，在 Edge 地址栏输入 edge://settings/privacy/manageCertificates 重新导入了一次就解决了。\nmv ca.crt.pem ca.crt sudo apt-get install -y ca-certificates sudo cp ca.crt /usr/local/share/ca-certificates/my-local-ca.crt sudo update-ca-certificates\rWindows 用户，双击 ca.crt 安装证书到“受信任的根证书颁发机构”。\n","date":"2024-04-29","id":17,"permalink":"/blog/trust-cert-manager-selfsigned-tls/","summary":"\u003cp\u003e在搭建本地 Kubernetus 集群后，由于环境在内网，做不了域名验证，无法使用 Let\u0026rsquo;s Encrypt 颁发和自动更新证书，然而很多应用要求必须启用 HTTPS，只能用自签名 CA 证书，并由此 CA 继续颁发其他证书。\u003c/p\u003e\n\u003cp\u003e所以我们准备了以下工具，开始搭建。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.pulumi.com/\" target=\"_blank\" rel=\"noopener\"\u003ePulumi\u003c/a\u003e\n: 当前非常流行的 IaC 工具，值得一试。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://cert-manager.io/\" target=\"_blank\" rel=\"noopener\"\u003ecert-manager\u003c/a\u003e\n: 云原生证书管理，用于自动管理和颁发各种发行来源的 TLS 证书。它将确保证书有效并定期更新，并尝试在到期前的适当时间更新证书。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e核心步骤和相关代码如下，更多源码请参考我们的 GitHub 项目 \u003ca href=\"https://github.com/xlabs-club/xlabs-ops\" target=\"_blank\" rel=\"noopener\"\u003exlabs-ops\u003c/a\u003e\n。\u003c/p\u003e\n\u003cp\u003e使用 Pulumi 安装 cert-manager，生成自签名 CA 证书，根据自签名 CA 证书生成 cert-manager ClusterIssuer，都在如下代码了。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ts\" data-lang=\"ts\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003eimport\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"kr\"\u003eas\u003c/span\u003e \u003cspan class=\"nx\"\u003epulumi\u003c/span\u003e \u003cspan class=\"kr\"\u003efrom\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;@pulumi/pulumi\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003eimport\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"kr\"\u003eas\u003c/span\u003e \u003cspan class=\"nx\"\u003ekubernetes\u003c/span\u003e \u003cspan class=\"kr\"\u003efrom\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;@pulumi/kubernetes\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003eimport\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"kr\"\u003eas\u003c/span\u003e \u003cspan class=\"nx\"\u003etls\u003c/span\u003e \u003cspan class=\"kr\"\u003efrom\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;@pulumi/tls\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 部署 cert-manager Helm chart\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ecertManagerRelease\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003ekubernetes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehelm\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ev3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cert-manager\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cert-manager\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003echart\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cert-manager\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003eversion\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;1.14.5\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kr\"\u003enamespace\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cert-manager\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003ecreateNamespace\u003c/span\u003e: \u003cspan class=\"kt\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003etimeout\u003c/span\u003e: \u003cspan class=\"kt\"\u003e600\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003erepositoryOpts\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003erepo\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;https://charts.jetstack.io\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003evalues\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003einstallCRDs\u003c/span\u003e: \u003cspan class=\"kt\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 生成一个 CA private key\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaPrivateKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003etls\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrivateKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;caPrivateKey\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003ealgorithm\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;RSA\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 生成一个 自签名 CA 证书\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaCert\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003etls\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSelfSignedCert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;caCert\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e// keyAlgorithm: \u0026#34;RSA\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003eprivateKeyPem\u003c/span\u003e: \u003cspan class=\"kt\"\u003ecaPrivateKey.privateKeyPem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003eisCaCertificate\u003c/span\u003e: \u003cspan class=\"kt\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003evalidityPeriodHours\u003c/span\u003e: \u003cspan class=\"kt\"\u003e87600\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 10 year\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003eallowedUses\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cert_signing\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;crl_signing\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003esubject\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003ecommonName\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;your.domain.com\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003eorganization\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Xlabs Club\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 生成一个带有 CA crt 和 key 的 Kubernetes Secret\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaSecret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003ekubernetes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ev1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSecret\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;caSecret\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003emetadata\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;selfsigned-cert-manager-ca\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kr\"\u003enamespace\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cert-manager\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kr\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Opaque\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003estringData\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;tls.crt\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaCert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecertPem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;tls.key\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaPrivateKey\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eprivateKeyPem\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 创建一个自签名的 ClusterIssuer 给 ingress 用\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003eclusterIssuer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003ekubernetes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eapiextensions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eCustomResource\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;selfsigned-issuer\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cert-manager.io/v1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003ekind\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ClusterIssuer\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003emetadata\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nx\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;selfsigned-issuer\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e// 注意 ClusterIssuer 和 caSecret 放在同一个 namespace，不写 namespace 时 ClusterIssuer 找不到 caSecret\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"kr\"\u003enamespace\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cert-manager\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nx\"\u003espec\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nx\"\u003eca\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nx\"\u003esecretName\u003c/span\u003e: \u003cspan class=\"kt\"\u003ecaSecret.metadata.name\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nx\"\u003edependsOn\u003c/span\u003e: \u003cspan class=\"kt\"\u003ecertManagerRelease\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003eexport\u003c/span\u003e \u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ecertManagerVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecertManagerRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eversion\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003eexport\u003c/span\u003e \u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003eclusterIssuerName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eclusterIssuer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// Export CA 证书，便于客户端导入信任证书\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kr\"\u003eexport\u003c/span\u003e \u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaCertificatePem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecaCert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecertPem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e以上执行 \u003ccode\u003epulumi up\u003c/code\u003e 后，我们就得到了一个自签名的 CA 证书、一个可用于为 ingress 自动签发 TLS 的 ClusterIssuer。\u003c/p\u003e","tags":["k8s","pulumi"],"title":"使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书并信任证书"},{"content":"因为工作经常需要用到 K8S，而且有时因网络原因不能完全依赖公司网络，或者因为测试新功能不能直接发布到公司 K8S 集群，所以就有了本地搭建 K8S 的需求。\n另外如果你有以下需求，此文档中提到的方案也可能对你有所帮助：\n开发机器模拟 Arm、AMD64 等不同 CPU 架构。 本地搭建完全隔离的开发环境，比如为测试 docker、podman、buildkit、containd 等不同软件设置的独立环境。 CI/CD 流程中即用即消的轻量级虚拟机替代方案，比如单元测试、集成测试中需要虚拟机或 K8S，快速启动，用完删除。 有限的资源模拟大批量的 K8S 节点，测试 K8S API 能力。 以下介绍一下我用过的几种不同方案，纯属个人观点仅供参考。\n使用 Docker Desktop 并启用 Kubernetes 功能。\n优点：使用最简单，开箱即用。\n缺点：只支持单节点 K8S，且 K8S 部分功能不支持，不易定制。\nDocker run K3D, K3D run K3S。\n优点：简单，任何支持 docker 的工具（Rancher Desktop、Podman） 启动一个容器即可。\n缺点：只支持 K3S，稳定性越来越不行了，以前多优秀啊。\nmultipass 启动虚拟机，然后安装 K8S、K3S 或 minikube。\n优点：multipass 可启动空白 ubuntu 虚拟机，或者启动已经安装好 minikube 的虚拟机。\n缺点：只支持 ubuntu，虚拟机与宿主机同架构。\nlima 启动虚拟机，然后安装 K8S、K3S 或 minikube。\n优点：支持虚拟多种 Linux 发行版，支持异构 CPU 虚拟机，同时能代替 Docker Desktop。\n缺点：架构稍复杂，启动略慢，不如 multipass 稳定，不支持运行在 Windows。\n以上方案，在网络畅通的情况下，均能在 10 分钟内启动一个单节点 K8S，所以整体方案都不复杂。\n如何选择：\n如果你需要在公司使用，并且不想买商业 License 的话，可直接排除 Docker Desktop。\n如果你是一个深度 K8S 开发者，需要对 K8S 集群有些把控，有较多定制，可排除 K3D。\n如果你的开发机器是 Windows，可排除 lima，截止写稿还不支持运行在 Windows 上，今天是否支持请参考他的官方文档。\n在过去的很多年，我一直使用 multipass 虚拟出 ubuntu 虚拟机，有了虚拟机就想干啥干啥了，自己按需安装 K8S 或 K3S，相对比较稳定，使用也很方便，这是我最喜欢的方案。\n直到我换了 MacBook Arm 架构，经常需要联调或测试一些 AMD64 的功能，为方便异构编译和测试，不得不寻找一种新的解决方案，就换到了 lima。\nlima 支持 ARM on Intel、Intel on ARM 异构虚拟机，异构机器整体性能上会有所损失，基本能满足日常开发联调使用。\nmultipass 快速安装 K3S multipass 是 Ubuntu 背后的厂商 Canonical 推出的一款虚拟化工具，可运行在 Windows、Mac、Linux 上，在本地快速启动 Ubuntu 虚拟机。\n在启动前使用 multipass find 看下有哪些可用镜像。\n$ multipass find Image Aliases Version Description 20.04 focal 20240408 Ubuntu 20.04 LTS 22.04 jammy,lts 20240319 Ubuntu 22.04 LTS 23.10 mantic 20240410 Ubuntu 23.10 Blueprint Aliases Version Description anbox-cloud-appliance latest Anbox Cloud Appliance docker 0.4 A Docker environment with Portainer and related tools minikube latest minikube is local Kubernetes 使用 multipass 启动一个 ubuntu 虚拟机，然后安装 k3s，安装完成后把 k3s 的 kube config 文件拷贝到本机，以便能执行 helm 和 kubectl 命令。\n# 启动一个新虚拟机，名字叫 k3s，使用 ubuntu 22.04 镜像 multipass launch --name k3s --cpus 8 --memory 16G --disk 256G 22.04 # 查看虚拟机信息，获取 IP，后面连接测试使用 multipass 给我们的内部 IP multipass info k3s # 进入虚拟机 multipass shell k3s # Install or upgrade k3s as master curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_KUBECONFIG_MODE=600 INSTALL_K3S_CHANNEL=latest sh - # 按照成功后拷贝 /etc/rancher/k3s/k3s.yaml 当做 kube/config 文件。\rlima 快速入门 Linux Machines (Lima) 也是一个虚拟化工具，目前是 CNCF sandbox 工程，大厂背书颇有前景。\nlima 版本还在不断迭代，具体使用请参考官方文档，以下是入门常用命令。\n# 查看模板列表 limactl start --list-templates # 使用 Ubuntu 模版启动一个默认虚拟机，此时需要下载镜像模板文件，镜像比较大耐心等待 limactl start --name=default --cpus=2 --memory=4 --disk=32 template://ubuntu # 在 MacBook Arm 上指定使用 --arch=x86_64 架构 limactl create --name=agent --arch=x86_64 --cpus=2 --memory=4 --disk=32 template://ubuntu # 直接启动 k8s 模板 limactl start --name=k8s --cpus=2 --memory=4 --disk=32 template://k8s # 导出可用的 KUBECONFIG export KUBECONFIG=$(limactl list k8s --format \u0026#39;unix://{{.Dir}}/copied-from-guest/kubeconfig.yaml\u0026#39;) # 查看当前虚拟机列表 limactl list # 启停虚拟机，agent 是上面创建出来的虚拟机名字 limactl start agent limactl stop agent # 进入虚拟机 shell 环境 limactl shell agent\r","date":"2024-04-13","id":18,"permalink":"/blog/easiest-k8s-on-macos/","summary":"\u003cp\u003e因为工作经常需要用到 K8S，而且有时因网络原因不能完全依赖公司网络，或者因为测试新功能不能直接发布到公司 K8S 集群，所以就有了本地搭建 K8S 的需求。\u003c/p\u003e\n\u003cp\u003e另外如果你有以下需求，此文档中提到的方案也可能对你有所帮助：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e开发机器模拟 Arm、AMD64 等不同 CPU 架构。\u003c/li\u003e\n\u003cli\u003e本地搭建完全隔离的开发环境，比如为测试 docker、podman、buildkit、containd 等不同软件设置的独立环境。\u003c/li\u003e\n\u003cli\u003eCI/CD 流程中即用即消的轻量级虚拟机替代方案，比如单元测试、集成测试中需要虚拟机或 K8S，快速启动，用完删除。\u003c/li\u003e\n\u003cli\u003e有限的资源模拟大批量的 K8S 节点，测试 K8S API 能力。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e以下介绍一下我用过的几种不同方案，纯属个人观点仅供参考。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e使用 Docker Desktop 并启用 Kubernetes 功能。\u003c/p\u003e\n\u003cp\u003e优点：使用最简单，开箱即用。\u003c/p\u003e\n\u003cp\u003e缺点：只支持单节点 K8S，且 K8S 部分功能不支持，不易定制。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDocker run K3D, K3D run K3S。\u003c/p\u003e\n\u003cp\u003e优点：简单，任何支持 docker 的工具（Rancher Desktop、Podman） 启动一个容器即可。\u003c/p\u003e\n\u003cp\u003e缺点：只支持 K3S，稳定性越来越不行了，以前多优秀啊。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://multipass.run/\" target=\"_blank\" rel=\"noopener\"\u003emultipass\u003c/a\u003e\n 启动虚拟机，然后安装 K8S、K3S 或 minikube。\u003c/p\u003e\n\u003cp\u003e优点：multipass 可启动空白 ubuntu 虚拟机，或者启动已经安装好 minikube 的虚拟机。\u003c/p\u003e\n\u003cp\u003e缺点：只支持 ubuntu，虚拟机与宿主机同架构。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://lima-vm.io/\" target=\"_blank\" rel=\"noopener\"\u003elima\u003c/a\u003e\n 启动虚拟机，然后安装 K8S、K3S 或 minikube。\u003c/p\u003e\n\u003cp\u003e优点：支持虚拟多种 Linux 发行版，支持异构 CPU 虚拟机，同时能代替 Docker Desktop。\u003c/p\u003e","tags":["k8s"],"title":"MacOS 搭建本地 K8S 开发环境方案选型，基于 multipass、lima 等不同方案优缺点介绍对比"},{"content":"问题背景，我们有一个 Http 服务在 K8S 内部署了 3 个 Pod，客户端使用 Service NodePort 进行连接，发现流量几乎都集中到了一个 Pod 上，各 Pod 承载流量很不均衡。\n已知的情况是：\nK8S Service 底层是 ipvs round-robin 负载均衡策略，按道理讲应该是均衡的。 客户端和服务端都启用了 Keep-Alive 长连接。 经过抓包分析，负载较高的 Pod 保持着较多 KeepAlive 长连接。将 kube-proxy 的 ipvs 转发模式设置为 Least-Connection，即倾向转发给连接数少的 Pod，可能会有所缓解，但也不一定，因为 ipvs 的负载均衡状态是分散在各个节点的，并没有收敛到一个地方，也就无法在全局层面感知哪个 Pod 上的连接数少，并不能真正做到 Least-Connection。\n服务端主动要求断开长连接 客户端连接我们可能无法控制，那么如何从服务端主动断开长连接。\n以 Tomcat 为例，它提供了 maxKeepAliveRequests 参数，到达此参数阈值后，Tomcat 会在 Response Header 中主动加一个 Connection: close，正常情况下客户端接收到此响应后会主动断开长连接。\n对于其他不支持此参数的服务器，可以自定义 Filter 或者自定代码，到达某阈值后在 Response Header 中主动追加 Connection: close。\n对于 Spring Boot 可通过 properties 配置。\n# Spring Boot Tomcat server.tomcat.max-keep-alive-requests=100 # Spring Boot WebFlux server.netty.max-keep-alive-requests=100\r对于独立部署 Tomcat，可在 server.xml 文件 Connector 中配置 maxKeepAliveRequests，Tomcat xml 可解析启动参数，启动时增加 -D=server.tomcat.max-keep-alive-requests=200 来调整默认值大小，另外注意，Tomcat xml 不支持解析 ENV 环境变量，只支持解析 -D 启动参数。\n\u0026lt;Connector port=\u0026#34;80\u0026#34; protocol=\u0026#34;org.apache.coyote.http11.Http11Nio2Protocol\u0026#34; maxKeepAliveRequests=\u0026#34;${server.tomcat.max-keep-alive-requests:-100}\u0026#34;/\u0026gt;\r以上，也解释了另外一个问题，在有些场景可能想一直保持长连接，为什么收到一个 Connection: close Header 断开了长连接。 因为 maxKeepAliveRequests 默认值是 100。\n客户端负载均衡和服务端负载均衡 在 Spring Cloud 和 K8S 作为服务注册发现的方案对比上，此时就可以加上一条，负载均衡模式不同。\nSpring Cloud 体系是客户端负载均衡，由客户端选择负载均衡算法，此时不管是否有长连接，流量都相对均衡。\nK8S Service 是服务端负载均衡，由 K8S 决定如何转发，对于长连接可能出现流量不均衡的现象。\n","date":"2024-04-11","id":19,"permalink":"/blog/tomcat-keepalive-load-balancer/","summary":"\u003cp\u003e问题背景，我们有一个 Http 服务在 K8S 内部署了 3 个 Pod，客户端使用 Service NodePort 进行连接，发现流量几乎都集中到了一个 Pod 上，各 Pod 承载流量很不均衡。\u003c/p\u003e\n\u003cp\u003e已知的情况是：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eK8S Service 底层是 ipvs round-robin 负载均衡策略，按道理讲应该是均衡的。\u003c/li\u003e\n\u003cli\u003e客户端和服务端都启用了 Keep-Alive 长连接。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e经过抓包分析，负载较高的 Pod 保持着较多 KeepAlive 长连接。将 kube-proxy 的 ipvs 转发模式设置为 Least-Connection，即倾向转发给连接数少的 Pod，可能会有所缓解，但也不一定，因为 ipvs 的负载均衡状态是分散在各个节点的，并没有收敛到一个地方，也就无法在全局层面感知哪个 Pod 上的连接数少，并不能真正做到 Least-Connection。\u003c/p\u003e\n\u003ch2 id=\"服务端主动要求断开长连接\"\u003e服务端主动要求断开长连接\u003c/h2\u003e\n\u003cp\u003e客户端连接我们可能无法控制，那么如何从服务端主动断开长连接。\u003c/p\u003e\n\u003cp\u003e以 Tomcat 为例，它提供了 maxKeepAliveRequests 参数，到达此参数阈值后，Tomcat 会在 Response Header 中主动加一个 \u003ccode\u003eConnection: close\u003c/code\u003e，正常情况下客户端接收到此响应后会主动断开长连接。\u003c/p\u003e\n\u003cp\u003e对于其他不支持此参数的服务器，可以自定义 Filter 或者自定代码，到达某阈值后在 Response Header 中主动追加 \u003ccode\u003eConnection: close\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e对于 Spring Boot 可通过 properties 配置。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-properties\" data-lang=\"properties\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Spring Boot Tomcat\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eserver.tomcat.max-keep-alive-requests\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e100\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Spring Boot WebFlux\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eserver.netty.max-keep-alive-requests\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e100\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e对于独立部署 Tomcat，可在 server.xml 文件 Connector 中配置 maxKeepAliveRequests，Tomcat xml 可解析启动参数，启动时增加 \u003ccode\u003e-D=server.tomcat.max-keep-alive-requests=200\u003c/code\u003e 来调整默认值大小，另外注意，Tomcat xml 不支持解析 ENV 环境变量，只支持解析 \u003ccode\u003e-D\u003c/code\u003e 启动参数。\u003c/p\u003e","tags":["k8s"],"title":"K8S Service 长连接导致负载不均衡问题分析和解决办法"},{"content":"在 K8S 中使用 Helm 部署了一些有状态应用，并通过 Helm 自动生成了 PV 和 PVC，某天想扩容，竟然报错了。\n以下以 bitnami zookeeper 为例，其他 StatefulSet 同理。\n为了实现磁盘扩容，改大 persistence.size，比如由 8Gi 改为 10Gi，然后执行 helm upgrade，出现错误。\nError: UPGRADE FAILED: cannot patch \u0026#34;zookeeper\u0026#34; with kind StatefulSet: StatefulSet.apps \u0026#34;zookeeper\u0026#34; is invalid: spec: Forbidden: updates to statefulset spec for fields other than \u0026#39;replicas\u0026#39;, \u0026#39;template\u0026#39;, \u0026#39;updateStrategy\u0026#39;, \u0026#39;persistentVolumeClaimRetentionPolicy\u0026#39; and \u0026#39;minReadySeconds\u0026#39; are forbidden 实际上我们想更新的是 StatefulSet 的 spec.volumeClaimTemplates 中的 storage 大小，根据提示信息，StatefulSet 竟然不允许。\nspec: volumeClaimTemplates: - apiVersion: v1 spec: resources: requests: storage: 8Gi\r查看 K8S 官方说明，果然当前版本 (1.29) 还不支持，参考链接如下。\nKEP-0661: StatefulSet volume resize kubernetes/enhancements#3412 https://github.com/kubernetes/enhancements/pull/3412 Support Volume Expansion Through StatefulSets kubernetes/enhancements#661 https://github.com/kubernetes/enhancements/issues/661 注意此时 helm release 的状态是 failed，先把 persistence.size 改为原大小，然后再执行一遍 helm upgrade，先把 release 恢复正常。\n那么如何实现 StatefulSet 磁盘平衡扩容，issues/661 提供了解决方案。\n确保你用的 StorageClass 支持扩容，比如 NFS、rancher/local-path-provisioner 都是不支持扩容的。 删除 StatefulSet，但是保留 Pod，让服务继续运行。删除时增加 --cascade=orphan 参数，执行 kubectl delete statefulset --cascade=orphan zookeeper。 修改 Helm 中声明的 size，继续执行 helm upgrade 更新应用，此时通过 kubectl 可以看到 PV/PVC 大小已经变更，StatefulSet 已经重建，但是 Pod 无任何变化。 重建 Pod，使更新生效：kubectl rollout restart statefulset zookeeper 。 rancher/local-path-provisioner rancher/local-path-provisioner 是 Rancher 提供的一个本地存储卷插件，它主要用于在 Kubernetes 集群中动态创建和管理本地存储卷，让本地存储使用起来更简单。\n有些应用使用了此 local-path 作为存储，但是在更新完 size 后，发现 PV 大小已经变更，PVC 大小仍然是旧值，比如以下 PVC 声明的是 10Gi，但是 status 仍然是 8Gi。\napiVersion: v1 kind: List items: - apiVersion: v1 kind: PersistentVolumeClaim spec: resources: requests: storage: 10Gi storageClassName: local-path status: capacity: storage: 8Gi phase: Bound\r通过 kubectl describe pvc 发现 Events 中有以下 warning。\n# Warning ExternalExpanding 8h volume_expand Ignoring the PVC: didn\u0026#39;t find a plugin capable of expanding the volume; waiting for an external controller to process this PVC. 然而我们的 local-path-provisioner 已经声明了 allowVolumeExpansion: true，通过以下命令查看值也是对的，为啥不行呢，因为当前版本（我使用的是 v0.0.26） 就是不支持。\n$ kubectl get sc NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE local-path cluster.local/local-path-provisioner Retain WaitForFirstConsumer true 2d 使用 local-path-provisioner 注意事项：\nlocal-path-provisioner 使用 hostPath 映射，不支持磁盘扩容，扩容后会出现以上 Warning。 不管是 K8S hostPath、Local volumes 还是 local-path-provisioner，都不支持限制磁盘大小，映射到主机的 hostPath 磁盘有多大，Pod 就能用多大。PV/PVC 声明的大小都只是声明并不起作用，所以也不用给 PV/PVC 尝试做扩容。 目前常用的 NFS 存储和 local-path-provisioner 一样，也不支持扩容和限制磁盘大小。 ","date":"2024-03-31","id":20,"permalink":"/blog/statefulset-resize-pvc/","summary":"\u003cp\u003e在 K8S 中使用 Helm 部署了一些有状态应用，并通过 Helm 自动生成了 PV 和 PVC，某天想扩容，竟然报错了。\u003c/p\u003e\n\u003cp\u003e以下以 bitnami zookeeper 为例，其他 StatefulSet 同理。\u003c/p\u003e\n\u003cp\u003e为了实现磁盘扩容，改大 \u003ccode\u003epersistence.size\u003c/code\u003e，比如由 8Gi 改为 10Gi，然后执行 helm upgrade，出现错误。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003eError: UPGRADE FAILED: cannot patch \u0026#34;zookeeper\u0026#34; with kind StatefulSet: StatefulSet.apps \u0026#34;zookeeper\u0026#34; is invalid: spec: Forbidden: updates to statefulset spec for fields other than \u0026#39;replicas\u0026#39;, \u0026#39;template\u0026#39;, \u0026#39;updateStrategy\u0026#39;, \u0026#39;persistentVolumeClaimRetentionPolicy\u0026#39; and \u0026#39;minReadySeconds\u0026#39; are forbidden\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e实际上我们想更新的是 StatefulSet 的 spec.volumeClaimTemplates 中的 storage 大小，根据提示信息，StatefulSet 竟然不允许。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003evolumeClaimTemplates\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ev1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eresources\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003erequests\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e8Gi\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e查看 K8S 官方说明，果然当前版本 (1.29) 还不支持，参考链接如下。\u003c/p\u003e","tags":[],"title":"K8S StatefulSet 应用 PV/PVC 平滑扩容"},{"content":"作为一个开发者，经常在 MacOS 遇到 Too many open files in system 的报错，尤其是碰到黑洞 node_modules 时，如何持久化配置彻底解决，直接上代码。\n输入 launchctl limit 即可看到当前的限制，我这里 maxfiles 是改过以后的。\n$ launchctl limit cpu unlimited unlimited filesize unlimited unlimited data unlimited unlimited stack 8388608 67104768 core 0 unlimited rss unlimited unlimited memlock unlimited unlimited maxproc 1392 2088 maxfiles 10240 102400 开始创建文件 sudo vi /Library/LaunchDaemons/limit.maxfiles.plist ，内容如下，可根据自己爱好改后面的两个数字值。\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;Label\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;limit.maxfiles\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;ProgramArguments\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;string\u0026gt;launchctl\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;limit\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;maxfiles\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;10240\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;102400\u0026lt;/string\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;key\u0026gt;RunAtLoad\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;ServiceIPC\u0026lt;/key\u0026gt; \u0026lt;false/\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt;\r验证文件格式和内容，并应用生效。\nplutil /Library/LaunchDaemons/limit.maxfiles.plist sudo launchctl load -w /Library/LaunchDaemons/limit.maxfiles.plist 再次输入 launchctl limit 查看是否生效。\n","date":"2024-03-19","id":21,"permalink":"/blog/macos-too-many-open-files/","summary":"\u003cp\u003e作为一个开发者，经常在 MacOS 遇到 Too many open files in system 的报错，尤其是碰到黑洞 node_modules 时，如何持久化配置彻底解决，直接上代码。\u003c/p\u003e\n\u003cp\u003e输入 launchctl limit 即可看到当前的限制，我这里 maxfiles 是改过以后的。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"gp\"\u003e$\u003c/span\u003e launchctl limit\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  cpu         unlimited      unlimited\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  filesize    unlimited      unlimited\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  data        unlimited      unlimited\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  stack       8388608        67104768\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  core        0              unlimited\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  rss         unlimited      unlimited\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  memlock     unlimited      unlimited\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  maxproc     1392           2088\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e  maxfiles    10240         102400\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e开始创建文件 \u003ccode\u003esudo vi /Library/LaunchDaemons/limit.maxfiles.plist\u003c/code\u003e ，内容如下，可根据自己爱好改后面的两个数字值。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e        \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;plist\u003c/span\u003e \u003cspan class=\"na\"\u003eversion=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1.0\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;dict\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;key\u0026gt;\u003c/span\u003eLabel\u003cspan class=\"nt\"\u003e\u0026lt;/key\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003elimit.maxfiles\u003cspan class=\"nt\"\u003e\u0026lt;/string\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;key\u0026gt;\u003c/span\u003eProgramArguments\u003cspan class=\"nt\"\u003e\u0026lt;/key\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;array\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003elaunchctl\u003cspan class=\"nt\"\u003e\u0026lt;/string\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003elimit\u003cspan class=\"nt\"\u003e\u0026lt;/string\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003emaxfiles\u003cspan class=\"nt\"\u003e\u0026lt;/string\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003e10240\u003cspan class=\"nt\"\u003e\u0026lt;/string\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003e102400\u003cspan class=\"nt\"\u003e\u0026lt;/string\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;/array\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;key\u0026gt;\u003c/span\u003eRunAtLoad\u003cspan class=\"nt\"\u003e\u0026lt;/key\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;true/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;key\u0026gt;\u003c/span\u003eServiceIPC\u003cspan class=\"nt\"\u003e\u0026lt;/key\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;false/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/dict\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/plist\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e验证文件格式和内容，并应用生效。\u003c/p\u003e","tags":["Tools"],"title":"MacOS 持久化配置，彻底解决 too many open files in system 的问题"},{"content":"文件压缩解压缩快速参考。\n常用文件格式 .tar：tar 其实打包（或翻译为归档）文件，本身并没有压缩。在 Linux 里 man tar 可以看到它的描述也是“manipulate tape archives”（tar 最初被用来在磁带上创建档案，现在，用户可以在任何设备上创建档案，只是它的描述还没有改）。\n.gz：gzip 是 GNU 组织开发的一个压缩程序，.gz 结尾的文件就是 gzip 压缩的结果。\n.bz2：bzip2 是一个压缩能力更强的压缩程序，.bz2 结尾的文件就是 bzip2 压缩的结果。\n.Z：compress 也是一个压缩程序。.Z 结尾的文件就是 compress 压缩的结果。\n.zip：使用 zip 软件压缩的文件。\n.tar.gz、.tar.bz2、.tar.xz 等可以理解为打包+压缩的效果，用软件解压可以发现比。gz 多了一层包。gzip 和 bzip2，不能同时压缩多个文件，tar 相当于开个挂加上同时压缩的特效，tar 先归档为一个大文件，而归档为大文件的速度是很快的，测试了一下几乎可以忽略不计。\n除了这些格式外，常见的 deb、exe、msi、rpm、dmg、iso 等安装软件，其实都是经过压缩的，一般情况下没有必要再压缩。而 rar 基本认为是 Windows 平台专属的压缩算法了，各个 Linux 发行版都不自带 rar 压缩解压缩软件，所以可以看到很多软件发行的格式都是 .tar.gz 或 .zip。\n解压缩 根据文件名后缀自行选择解压缩命令。\ntar -xf test.tar gzip -d test.gz gunzip test.gz # -C 直接解压到指定目录 tar -xzf test.tar.gz -C /home bzip2 -d test.bz2 bunzip2 test.bz2 tar -xjf test.tar.bz2 tar -xvJf test.tar.xz\r压缩 请根据需要选择压缩算法。\n# 将当前目录下所有 jpg 格式的文件打包为 pictures.tar tar -cf pictures.tar *.jpg # 将 Picture 目录下所有文件打包并用 gzip 压缩为 pictures.tar.gz tar -czf pictures.tar.gz Picture/ # 将 Picture 目录下所有文件打包并用 bzip2 压缩为 pictures.tar.bz2 tar -cjf pictures.tar.bz2 Picture/\r","date":"2024-03-10","id":22,"permalink":"/blog/tar-gz/","summary":"\u003cp\u003e文件压缩解压缩快速参考。\u003c/p\u003e\n\u003ch2 id=\"常用文件格式\"\u003e常用文件格式\u003c/h2\u003e\n\u003cp\u003e.tar：tar 其实打包（或翻译为归档）文件，本身并没有压缩。在 Linux 里 man tar 可以看到它的描述也是“manipulate tape archives”（tar 最初被用来在磁带上创建档案，现在，用户可以在任何设备上创建档案，只是它的描述还没有改）。\u003c/p\u003e\n\u003cp\u003e.gz：gzip 是 GNU 组织开发的一个压缩程序，.gz 结尾的文件就是 gzip 压缩的结果。\u003c/p\u003e\n\u003cp\u003e.bz2：bzip2 是一个压缩能力更强的压缩程序，.bz2 结尾的文件就是 bzip2 压缩的结果。\u003c/p\u003e\n\u003cp\u003e.Z：compress 也是一个压缩程序。.Z 结尾的文件就是 compress 压缩的结果。\u003c/p\u003e\n\u003cp\u003e.zip：使用 zip 软件压缩的文件。\u003c/p\u003e\n\u003cp\u003e.tar.gz、.tar.bz2、.tar.xz 等可以理解为打包+压缩的效果，用软件解压可以发现比。gz 多了一层包。gzip 和 bzip2，不能同时压缩多个文件，tar 相当于开个挂加上同时压缩的特效，tar 先归档为一个大文件，而归档为大文件的速度是很快的，测试了一下几乎可以忽略不计。\u003c/p\u003e\n\u003cp\u003e除了这些格式外，常见的 deb、exe、msi、rpm、dmg、iso 等安装软件，其实都是经过压缩的，一般情况下没有必要再压缩。而 rar 基本认为是 Windows 平台专属的压缩算法了，各个 Linux 发行版都不自带 rar 压缩解压缩软件，所以可以看到很多软件发行的格式都是 .tar.gz 或 .zip。\u003c/p\u003e\n\u003ch2 id=\"解压缩\"\u003e解压缩\u003c/h2\u003e\n\u003cp\u003e根据文件名后缀自行选择解压缩命令。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -xf test.tar\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egzip -d test.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egunzip test.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# -C 直接解压到指定目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -xzf test.tar.gz -C /home\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebzip2 -d test.bz2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebunzip2 test.bz2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -xjf test.tar.bz2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -xvJf test.tar.xz\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003ch2 id=\"压缩\"\u003e压缩\u003c/h2\u003e\n\u003cp\u003e请根据需要选择压缩算法。\u003c/p\u003e","tags":[],"title":"文件压缩解压缩快速参考"},{"content":"项目中需要根据 SQL 文件导入数据，文件大约 20G，正常导入约需要 2 小时，如何提高导入速度。\n经过实验测试，如果一个 SQL 文件只有一个表的数据，可以直接使用 mysql load data infile 语法，速度比较快。\n我们是一个 SQL 文件包含了很多表，mysql load data infile 就不支持了，可考虑在导入过程中设置如下参数，经过测试 20G 大约需要 40 分钟，比之前快了很多。\n# 进入 mysql mysql -u root -p # 创建数据库（如果已经有数据库忽略此步骤） CREATE DATABASE 数据库名； # 设置参数 set sql_log_bin=OFF;//关闭日志 set autocommit=0;//关闭 autocommit 自动提交模式 0 是关闭 1 是开启（默认） set global max_allowed_packet = 20 *1024* 1024 * 1024; # 使用数据库 use 数据库名； # 开启事务 START TRANSACTION; # 导入 SQL 文件并 COMMIT（因为导入比较耗时，导入和 COMMIT 一行命令，这样不用盯着屏幕等提交了） source /xxx.sql；COMMIT;\r","date":"2024-03-10","id":23,"permalink":"/blog/mysql-large-import/","summary":"\u003cp\u003e项目中需要根据 SQL 文件导入数据，文件大约 20G，正常导入约需要 2 小时，如何提高导入速度。\u003c/p\u003e\n\u003cp\u003e经过实验测试，如果一个 SQL 文件只有一个表的数据，可以直接使用 mysql load data infile 语法，速度比较快。\u003c/p\u003e\n\u003cp\u003e我们是一个 SQL 文件包含了很多表，mysql load data infile 就不支持了，可考虑在导入过程中设置如下参数，经过测试 20G 大约需要 40 分钟，比之前快了很多。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 进入 mysql\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysql -u root -p\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 创建数据库（如果已经有数据库忽略此步骤）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCREATE DATABASE 数据库名；\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 设置参数\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e \u003cspan class=\"nv\"\u003esql_log_bin\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eOFF\u003cspan class=\"p\"\u003e;\u003c/span\u003e//关闭日志\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e \u003cspan class=\"nv\"\u003eautocommit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"p\"\u003e;\u003c/span\u003e//关闭 autocommit 自动提交模式 \u003cspan class=\"m\"\u003e0\u003c/span\u003e 是关闭  \u003cspan class=\"m\"\u003e1\u003c/span\u003e 是开启（默认）\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e global \u003cspan class=\"nv\"\u003emax_allowed_packet\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e20\u003c/span\u003e *1024* \u003cspan class=\"m\"\u003e1024\u003c/span\u003e * 1024\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 使用数据库\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euse 数据库名；\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 开启事务\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSTART TRANSACTION\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 导入 SQL 文件并 COMMIT（因为导入比较耗时，导入和 COMMIT 一行命令，这样不用盯着屏幕等提交了）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003esource\u003c/span\u003e /xxx.sql；COMMIT\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e","tags":[],"title":"MySQL 大文件导入优化，提高速度，提升性能"},{"content":"介绍基于 start.spring.io 快速定制自己的 Spring Boot 脚手架，主要应用场景：\n规范公司自己的 parent pom，增加特定的依赖项。 根据公司规范生成统一的包结构，统一命名。 根据需要增加特定代码或文件，比如根据公司要求统一 logback.xml、 application.properties 文件。 提供公司自研的二方 jar 包。 快速开始 基本步骤：\n对于 spring.initializr 我们没有定制的需求，直接引用官方的。 拷贝一份 start.spring.io ，直接基于这个项目开发、部署、运行。以下都是关于如何修改 start.spring.io。 start.spring.io 主要关注两个模块：\nstart-client：前端页面，可以定制些自己的 logo、title 等。 start-site：是一个标准的 spring boot 项目，实际 run 起来的服务，引用了 start-client，直接 run 这个项目的 main 方法就能看到效果。 主要配置文件：start-site/src/main/resources/application.yml，通过修改这个配置文件可以达到的效果如下。\n修改 start 启动时默认 group，把 com.example 改为公司自己的 group。\ninitializr: group-id: value: com.yourgroup\r修改父 pom，使用公司自己的 pom。\ninitializr: env: maven: # use your parent pom parent: groupId: com.yourself artifactId: your-parent version: 1.0.0 # relativePath: ../pom.xml includeSpringBootBom: false\r限定 Java 和 Spring Boot 版：修改 languages 和 bootVersions 即可。\n增加公司自己的 starter，参考文件中例子增加即可。\n核心扩展接口 ProjectContributor: 用于实现文件结构变化，比如加个文件夹，增加配置文件、代码片段等。 BuildCustomizer：动态修改 pom.xml，用于修改 maven/gradle 的 dependencies/repository/plugins 等。 更多自带定制接口参考：MainSourceCodeCustomizer, MainCompilationUnitCustomizer, MainApplicationTypeCustomizer, TestSourceCodeCustomizer, TestApplicationTypeCustomizer. 场景：生成默认的 logback-spring.xml。\nimport io.spring.initializr.generator.project.contributor.SingleResourceProjectContributor; /** * 定制 logback xml 文件，从当前项目的`classpath:configuration`拷贝到指定的 src/main/resources 目录下 */ public class LogbackContributor extends SingleResourceProjectContributor { public LogbackContributor() { this(\u0026#34;classpath:configuration/logback-spring.xml\u0026#34;); } public LogbackContributor(String resourcePattern) { super(\u0026#34;src/main/resources/logback-spring.xml\u0026#34;, resourcePattern); } }\r场景：按照统一规范生成目录结构。\n/** * 按照规范生成默认的 java 目录结构 */ public class DefaultPackageContributor implements ProjectContributor { private final ProjectDescription description; public DefaultPackageContributor(ProjectDescription description) { this.description = description; } @Override public void contribute(Path projectRoot) throws IOException { Language language = description.getLanguage(); // \u0026#34;src/main/java/com.test.demo\u0026#34; Path packageRoot = projectRoot.resolve(\u0026#34;src/main/\u0026#34;) .resolve(language.id()) .resolve(description.getPackageName().replaceAll(\u0026#34;\\\\.\u0026#34;,\u0026#34;/\u0026#34;)); Files.createDirectories(packageRoot.resolve(\u0026#34;config\u0026#34;)); Files.createDirectories(packageRoot.resolve(\u0026#34;dao\u0026#34;)); Files.createDirectories(packageRoot.resolve(\u0026#34;service\u0026#34;)); Files.createDirectories(packageRoot.resolve(\u0026#34;web\u0026#34;)); } }\r场景：在 xxx 条件下做 xxx。比如我们使用 spock 作为测试框架，spock 使用 groovy 语言。如果引入 spock 的时候，默认在 maven plugin 里增加 groovy 插件 gmavenplus-plugin。\nclass SpockMavenBuildCustomizer implements BuildCustomizer\u0026lt;MavenBuild\u0026gt; { @Override public void customize(MavenBuild build) { // add groovy plugin build.plugins() .add(\u0026#34;org.codehaus.gmavenplus\u0026#34;, \u0026#34;gmavenplus-plugin\u0026#34;); } }\r@ProjectGenerationConfiguration public class MyProjectGenerationConfiguration { @Bean @ConditionalOnRequestedDependency(\u0026#34;spock\u0026#34;) public SpockMavenBuildCustomizer spockMavenBuildCustomizer() { return new SpockMavenBuildCustomizer(); } }\r","date":"2024-03-09","id":24,"permalink":"/blog/spring-boot-start-site/","summary":"\u003cp\u003e介绍基于 \u003ccode\u003estart.spring.io\u003c/code\u003e 快速定制自己的 Spring Boot 脚手架，主要应用场景：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e规范公司自己的 parent pom，增加特定的依赖项。\u003c/li\u003e\n\u003cli\u003e根据公司规范生成统一的包结构，统一命名。\u003c/li\u003e\n\u003cli\u003e根据需要增加特定代码或文件，比如根据公司要求统一 logback.xml、 application.properties 文件。\u003c/li\u003e\n\u003cli\u003e提供公司自研的二方 jar 包。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"快速开始\"\u003e快速开始\u003c/h2\u003e\n\u003cp\u003e基本步骤：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e对于 \u003ca href=\"https://github.com/spring-io/initializr\" target=\"_blank\" rel=\"noopener\"\u003espring.initializr\u003c/a\u003e\n 我们没有定制的需求，直接引用官方的。\u003c/li\u003e\n\u003cli\u003e拷贝一份 \u003ca href=\"https://github.com/spring-io/start.spring.io\" target=\"_blank\" rel=\"noopener\"\u003estart.spring.io\u003c/a\u003e\n，直接基于这个项目开发、部署、运行。以下都是关于如何修改 \u003ccode\u003estart.spring.io\u003c/code\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ccode\u003estart.spring.io\u003c/code\u003e 主要关注两个模块：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003estart-client：前端页面，可以定制些自己的 logo、title 等。\u003c/li\u003e\n\u003cli\u003estart-site：是一个标准的 spring boot 项目，实际 run 起来的服务，引用了 start-client，直接 run 这个项目的 main 方法就能看到效果。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e主要配置文件：\u003ccode\u003estart-site/src/main/resources/application.yml\u003c/code\u003e，通过修改这个配置文件可以达到的效果如下。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e修改 start 启动时默认 group，把 \u003ccode\u003ecom.example\u003c/code\u003e 改为公司自己的 group。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003einitializr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003egroup-id\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ecom.yourgroup\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e修改父 pom，使用公司自己的 pom。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003einitializr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003emaven\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"c\"\u003e# use your parent pom\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003egroupId\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ecom.yourself\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eartifactId\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eyour-parent\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eversion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1.0.0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c\"\u003e# relativePath: ../pom.xml\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eincludeSpringBootBom\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e限定 Java 和 Spring Boot 版：修改 languages 和 bootVersions 即可。\u003c/p\u003e","tags":["Spring Boot","Java"],"title":"Spring Boot Start 脚手架定制开发和快速入门"},{"content":"基于 Alibaba Sentinel 实现的分布式限流中间件服务。主要对服务提供者提供限流、系统保护，对服务调用者提供熔断降级、限流排队等待效果。\n实现目标：\n作为服务提供者，保护自己不被打死，服务可以慢不可以挂。 作为客户端及时限速和熔断，防止对服务提供方包含 Http、数据库、MQ 等造成太大压力，防止把糟糕的情况变得更糟。 以用户、租户、对象等更细粒度进行流量精细控制。 服务预热，应用新发布上线，缓存尚未完全建立，防止流量一下子把服务打死。 能够根据 Prometheus、ClickHouse、Elasticsearch 提供的监控指标，动态生成规则，自适应调整规则。 概述 Sentinel 的基础知识请参考官方文档描述，这里单独介绍一些与我们定制相关的内容。\n限流简单来说就三个点：资源、规则、效果。\n资源：就是一个字符串，这个字符串可以自己定义、可以用注解自动生成、可以通过拦截器按规则生成。\n规则：Sentinel 定义的一系列限流保护规则，比如流量控制规则、自适应保护规则。\n效果：实际上“效果”也是“规则”定义的一部分。任何一条请求，命中某些资源规则后产生的效果，比如直接抛出异常、匀速等待。\nSentinel 全局注意事项和使用限制 使用开源默认 Sentinel 组件，有一些坑，或者说需要关注的注意事项：\n单个进程内资源数量阈值是 6000，多出的资源规则将不会生效（因为是懒加载，资源先到先得），也不提示错误而是直接忽略，资源数量太多建议使用热点参数控制。 对于限流的链路模式，context 阈值是 2000，所以默认的 WEB_CONTEXT_UNIFY 为 true，如果需要链路限流需要把这个改为 false。 自定义时，资源名中不要带 | 线， 这个日志中要用，日志以此作为分割符。 Sentinel 支持按来源限流，注意 origin 数量不能太多，否则会导致内存暴涨。 一个资源可以有多个规则，一条请求能否通过，取决于规则里阈值最小的限制条件。 限流的目的是保护系统，计数计量并不准确，所以不要拿限流做计量或配额控制。 增加限流一定程度上通过时间换空间，降低了 CPU、内存负载，对 K8S HPA 策略会有一定影响。后续我们也会考虑根据 Sentinel 限流指标进行扩缩容。 限流中如果有增加等待效果会使接口变慢，各调用链需要关注调用超时和事务配置。 目前 sentinel-web-servlet 和 sentinel-spring-webmvc-adapter 均不支持热点参数限流。为了支持热点参数需要自行扩展。 sentinel-web-servlet 和 sentinel-spring-webmvc-adapter 会将每个到来的不同的 URL 都作为不同的资源处理，因此对于 REST 风格的 API，需要自行实现 UrlCleaner 接口清洗一下资源（比如将满足 /foo/:id 的 URL 都归到 /foo/* 资源下）。否则会导致资源数量过多，超出资源数量阈值（目前是 6000）时多出的资源的规则将不会生效。 Java 中 sentinel-time-tick-thread 线程会额外多占用约 1-2% CPU，详细代码参考 com.alibaba.csp.sentinel.util.TimeUtil。 一些文档中尚未更新但是大家可能关心的内容：\n从 1.8.7 版本开始资源匹配支持正则表达式，使用的是 Java 自带的正则引擎。 从 1.8.7 版本对 QPS 限流做了优化，支持 QPS 大于 1000 了。 热点参数限流已经支持按照线程数限流，文档尚未更新，文档中说只支持 QPS。 接入指导 总体架构图。\n我们所有组件，规则加载都是由 Datasource 组件统一加载，配置是懒加载的，在第一次访问的时候加载，如果需要定义规则请在配置中心定义，这是由 Sentinel 在第一次初始化的时候（参考源码：com.alibaba.csp.sentinel.Env.java）通过 SPI 加载的。\n注意：如果你有自编码使用 Sentinel SDK 自带的 XxxRuleManager.loadRules 加载规则，会被远端配置中心覆盖掉，远端配置变更自动刷新后会以远端配置为准，把 XxxRuleManager.loadRules 加载的规则覆盖掉。\n底层限流策略实现 Sentinel 底层限流策略共有 2 种，另外有 2 个 WARMUP 的变体，总共 4 个。参考源码 com.alibaba.csp.sentinel.slots.block.flow.TrafficShapingController 。\n基于绝对值的 DefaultController，只要总值校验通过即可，比如 QPS 10，1s 内可以前 500ms 通过 10 个，后 500ms 通过 0 个，只要在这 1s 内没超标就行。 基于频率的 ThrottlingController，漏桶算法，比如 QPS 10，要求以每 100ms 一个的固定频率执行。如果前 500ms 有 10 个请求，最多通过 5 个，其他的都要排队。 关于这几种策略支持的范围，有兴趣的可以查看源码 com.alibaba.csp.sentinel.slots.block.flow.FlowRuleUtil#generateRater，核心代码如下。\nprivate static TrafficShapingController generateRater(FlowRule rule) { if (rule.getGrade() == RuleConstant.FLOW_GRADE_QPS) { switch (rule.getControlBehavior()) { case RuleConstant.CONTROL_BEHAVIOR_WARM_UP: return new WarmUpController(rule.getCount(), rule.getWarmUpPeriodSec(), ColdFactorProperty.coldFactor); case RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER: return new ThrottlingController(rule.getMaxQueueingTimeMs(), rule.getCount()); case RuleConstant.CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER: return new WarmUpRateLimiterController(rule.getCount(), rule.getWarmUpPeriodSec(), rule.getMaxQueueingTimeMs(), ColdFactorProperty.coldFactor); case RuleConstant.CONTROL_BEHAVIOR_DEFAULT: default: } } return new DefaultController(rule.getCount(), rule.getGrade()); }\r根据以上代码，可以确定限流各个参数适用的范围，比如 “按照并发线程数限流，实现匀速等待效果” 就做不到了。\n规则参数详解 Sentinel 规则的资源名字匹配支持正则表达式，但是不知道为什么文档里从未提及，可能是考虑到性能。如果要为某个规则启用正则，需主动设置 xxRule.setRegex(true)，另外注意用的是 Java 正则匹配，不要和 Spring Path 的正则匹配混了。比如 Java 里 .* 代表任意匹配，Spring * 表达任意匹配。\n系统自适应保护规则 参数示例：\n{ \u0026#34;avgRt\u0026#34;: 500, \u0026#34;highestSystemLoad\u0026#34;: 100, \u0026#34;highestCpuUsage\u0026#34;: 90.0, \u0026#34;maxThread\u0026#34;: 100, \u0026#34;qps\u0026#34;: 200.0 }\rhighestSystemLoad：当系统 load1 超过阈值，且系统当前的并发线程数超过系统容量时才会触发系统保护。系统容量由系统的 maxQps * minRt 计算得出。设定参考值一般是 CPU cores * 2.5。 highestCpuUsage：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0）。 avgRt ：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。 maxThread：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。 qps：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。 以上参数默认是 -1，代表无限制。\n注意：\n在 K8S 环境下，Sentinel 读取当前指标值时，highestSystemLoad 获取的是宿主机的 load1，不是 Pod 的。参考：https://github.com/alibaba/Sentinel/issues/2260 Sentinel 读取当前指标值时，获取的 CPU 指标取的是 Pod Cpu 和宿主机 CPU 的最大值，也就是说如果 宿主机 CPU 占用太高，Pod CPU 很低，会误伤，会触发限流。 highestSystemLoad 相当于要不要自适应的开关，达到条件后会计算下是否还能承受流量，不行才拒绝。这就是所谓的“自适应”。除 highestSystemLoad 外，其他几个参数是达到阈值就拒绝。 规则中的几个参数，可以在一条规则里全部设置，也可以分多个规则配置不同参数，也可以只设置某个，Sentinel 会自行合并参数计算。 流量控制 参数示例：\n{ \u0026#34;resource\u0026#34;: \u0026#34;spring-cloud-samples:GET:/api-provider/pets/{id}\u0026#34;, \u0026#34;count\u0026#34;: 100.0, \u0026#34;grade\u0026#34;: 1, \u0026#34;controlBehavior\u0026#34;: 0, \u0026#34;warmUpPeriodSec\u0026#34;: 10, \u0026#34;maxQueueingTimeMs\u0026#34;: 5000, \u0026#34;limitApp\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;strategy\u0026#34;: 0 }\rresource：资源名，即限流规则的作用对象 count: 限流阈值 grade: 限流阈值类型，QPS（RuleConstant.FLOW_GRADE_QPS = 1） 或线程数（RuleConstant.FLOW_GRADE_THREAD = 0）。 controlBehavior：限流效果，有直接拒绝（RuleConstant.CONTROL_BEHAVIOR_DEFAULT = 0）、冷启动（RuleConstant.CONTROL_BEHAVIOR_WARM_UP=1）、匀速器（RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER=2）、冷启动-匀速器（RuleConstant.CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER=3）。 warmUpPeriodSec：冷启动时间，单位秒，默认 10s。 maxQueueingTimeMs：最大排队等待时长，默认 500ms。（仅在匀速排队模式 + QPS 下生效） limitApp: 按来源限流，默认 default 表示忽略来源，所有来源都限流。如果 limitApp 为 null，将忽略此条规则，不限流直接放行。 strategy: 根据调用关系选择策略：根据调用方限流（STRATEGY_DIRECT=0），根据调用链路入口限流（STRATEGY_CHAIN=1），具有关系的资源流量控制（STRATEGY_RELATE=2）。 注意：\n匀速器模式的时候根据实际情况设置 maxQueueingTimeMs，处理好排队超时情况，如果太长客户端可能超时，如果太短直接抛出超时异常了，达不到匀速的效果。 热点参数限流 热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。 Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。\n参数示例：\n{ \u0026#34;resource\u0026#34;: \u0026#34;spring-cloud-samples:GET:/api-provider/pets/{id}\u0026#34;, \u0026#34;count\u0026#34;: 100.0, \u0026#34;grade\u0026#34;: 1, \u0026#34;paramIdx\u0026#34;: 0, \u0026#34;controlBehavior\u0026#34;: 0, \u0026#34;warmUpPeriodSec\u0026#34;: 1, \u0026#34;maxQueueingTimeMs\u0026#34;: 5000, \u0026#34;durationInSec\u0026#34;: 1, \u0026#34;burstCount\u0026#34;: 0, \u0026#34;limitApp\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;paramFlowItemList\u0026#34;: [ { \u0026#34;object\u0026#34;: \u0026#34;ea-vip\u0026#34;, \u0026#34;classType\u0026#34;: \u0026#34;String\u0026#34;, \u0026#34;count\u0026#34;: 1000 } ], \u0026#34;strategy\u0026#34;: 0 }\r默认参数参考流量控制规则的解释。 paramIdx：热点参数的索引，必填，对应 SphU.entry(xxx, args) 中的 args 参数索引位置，从 0 开始。 durationInSec：统计窗口时间长度（单位为秒），默认 1s。在此单位时间 durationInSec 内允许 count 值，比如 1s 10 个，10s 100 个。注意这个 durationInSec 不要太长，另外思考一个问题 1s 10 个和 10s 100 个数字上相等效果相等吗，显然不是。 paramFlowItemList：参数例外项，可以针对指定的参数值单独设置限流阈值，不受前面 count 阈值的限制。仅支持基本类型和字符串类型。 burstCount: 为应对突发流量\u0026quot;额外允许\u0026quot;的流量，在原 count 的基础上再额外加上这个值，相当于保底。默认为 0，仅在 快速失败|Warm UP + QPS 下生效。（Java 文档中未提及，代码中支持） 注意：\n可以通过 paramFlowItemList 设置例外项，比如为 VIP 单独设置限流阈值。 每个参数索引 (paramIdx) 对应的不同值最多统计 4000（ParameterMetric.BASE_PARAM_MAX_CAPACITY）个。 在统计窗口时间长度（durationInSec）内最多允许统计 20 万个。可以理解为 LRU 的 Top N。 来源访问控制 参数示例：\n{ \u0026#34;resource\u0026#34;: \u0026#34;spring-cloud-samples:GET:/api-provider/pets/{id}\u0026#34;, \u0026#34;limitApp\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;strategy\u0026#34;: 0 }\rresource：资源名，即限流规则的作用对象 limitApp：对应的黑名单/白名单，不同 origin 用 , 分隔，如 appA,appB strategy：限制模式，AUTHORITY_WHITE=0 为白名单模式，AUTHORITY_BLACK=1 为黑名单模式，默认为白名单模式。 熔断降级 现代微服务架构都是分布式的，由非常多的服务组成。不同服务之间相互调用，组成复杂的调用链路。以上的问题在链路调用中会产生放大的效果。复杂链路上的某一环不稳定，就可能会层层级联，最终导致整个链路都不可用。因此我们需要对不稳定的弱依赖服务调用进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的雪崩。熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置。\nSentinel 提供以下几种熔断策略：\n慢调用比例 (SLOW_REQUEST_RATIO)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。 异常比例 (ERROR_RATIO)：当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。 异常数 (ERROR_COUNT)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。 { \u0026#34;resource\u0026#34;: \u0026#34;spring-cloud-samples:GET:/api-provider/pets/{id}\u0026#34;, \u0026#34;grade\u0026#34;: 0, \u0026#34;count\u0026#34;: 100.0, \u0026#34;timeWindow\u0026#34;: 10, \u0026#34;minRequestAmount\u0026#34;: 5, \u0026#34;statIntervalMs\u0026#34;: 1000, \u0026#34;slowRatioThreshold\u0026#34;: 1 }\rgrade：熔断策略，支持慢调用比例/异常比例/异常数策略。默认慢调用比例。 count：慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例/异常数模式下为对应的阈值。 timeWindow：熔断时长，单位为秒。 minRequestAmount：熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断。默认 5。 statIntervalMs：统计时长（单位为 ms），如 60*1000 代表分钟级。默认 1000ms。 slowRatioThreshold：慢调用比例阈值，仅慢调用比例模式有效。 注意事项：\n熔断降级规则在服务端时，Spring 的全局异常处理器一般会消化掉异常转换成一个合法的 Response，会导致熔断规则中的异常数规则失效，我们在 Server 端并不准备支持，参考 Issue 。 对象类型作为热点参数 在热点参数限流规则说明中，有单独提到一点 “参数只支持基本类型和字符串类型”。\n很多场景下，我们的接口是 POST 类型，请求参数是一个 Request Body，能不能以此作为热点参数呢。\n能。实现方式是对此对象实现 com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowArgument 接口，在接口中通过 paramFlowKey 返回真正作为热点的数据。\nclass User implements ParamFlowArgument { Integer id; String name; String address; public User(Integer id, String name, String address) { this.id = id; this.name = name; this.address = address; } @Override public Object paramFlowKey() { return name; } }\r以上例子将使用 name 作为真正的热点参数。\n当然，若需要配置例外项或者使用集群维度流控，则传入的参数只支持基本类型，要不然例外项的规则里没法配置。\n集群限流 集群限流功能就不复制粘贴了，这里着重提几个注意事项：\n集群 Token Server 不支持高可用，生产环境需自己做高可用改造。 客户端获取 Token 失败会降级到本地限流。 集群限流只是解决限流问题，不解决流量不均衡问题，这是网络层面的问题。常见的如 http 长连接情况下，客户端和服务器连接保持，一个客户端所有请求可能会发给同一个服务器节点，单机限流阈值是 10 QPS，部署了 3 个节点，理论上集群的总 QPS 可以达到 30，但是实际上由于流量不均匀导致集群总 QPS 还没有达到 30 就已经触发限流了。 关联限流 在 Sentinel 限流规则中，有一个大家容易忽略的属性：流控模式之关联模式。可实现类似于进程内的“背压”模型。\n限流规则可以选择三种流控模式：\n直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式。 关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流。 链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流。 典型应用场景：\n数据库读写竞争：比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢，限制某一方。 保证优先级任务：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是有限支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。 阻止请求放大：比如接口 A 本身流量很小，但是一次接口 A 又调用了其他 10 个接口，相当于请求放大了 10 倍，如果任由 A 随意调用，后端服务则无法承担压力，需要对 A 进行限流。 举例：\n比如 http 接口 /create 作为入口流量，调用一次，需要对数据库（我们暂定数据库操作生产资源名是 /database）执行 10 次操作，如果不限制 /create，就会把数据库压崩溃。 那么可以在数据库资源/database 到达阈值 N 时，对/create 进行限流。注意这里：阈值是数据库资源 /database 的阈值，限流的却是资源 /create，数据库资源 /database 并不触发限流。\n注意使用限制：关联限流仅限于“流量控制”规则，不支持热点参数限流规则。\n日志和监控模块 我们自定义了日志模块，在 block 和 metrics 日志中增加 trace id、user id 等更多参数，通过 fluent-bit 收集到 ClickHouse 中。\n可在 Granfana 中以 ClickHouse 作为数据源配置自己需要的视图，并结合告警组件配置告警，比如应用 1 分钟 block 次数超过 10 次触发告警。\n自定义实现 如果各个 adapter 模块不能满足你的要求，可以自己编码实现，一个典型的示例代码如下，按需选择。\npublic void sample() { String resource = anyStringName(); Entry entry = null; try { //支持按照来源设置规则，指定自己的来源，不需要来源的时候不写这行 ContextUtil.enter(SAMPLE_CONTEXT, APP_NAME); // 执行 Sentinel 流程，判断是否放行。最后一个 anyArgsArray 是热点参数，如果不需要热点参数限流就可以不写 entry = SphU.entry(resource, ResourceTypeConstants.COMMON_WEB, EntryType.OUT, anyArgsArray()); //开始执行自己真正的代码逻辑 doJobHere(); } catch (BlockException e) { //根据情况处理异常 handleBlockException(e); } catch (Exception ex) { //如果需要熔断降级规则，需要通过这个 traceEntry 方法把异常数统计上，否则熔断降级里不能按照异常降级 Tracer.traceEntry(ex, entry); throw ex; } finally { if (entry != null) { entry.close(); } ContextUtil.exit(); } }\r实战经验和踩坑记录 LB 或 K8S Service 长连接负载不均衡问题，可能导致误触发限流，本来计算好的一个实例承载 10 QPS，怎么请求全集中在一个实例上，所以最好预留一些余量。为什么会有这个问题以及解决办法参考 此博客 。\n单机限流阈值到底配多少。\n无监控不拍脑袋，可以先配一个很大的阈值，上线 metrics 日志，根据日志指标确定最大值最小值后再评估配置多少合适。\n入口网关已经限流了，应用层或数据库还需要限流吗。\n看具体情况，在以往的教训中我们遇到了一个请求，扩大到 N 多请求的情况，这时仅有网关限流就不够了。\n注意多服务关联限流。\n假设一个服务 A 一次请求需要同时调用服务 B 一次，服务 C 一次。然而服务 B 限流 100，服务 C 限流 200，总有失败的情况，服务 A 就要不停的平衡他们的关系，造成资源浪费甚至数据不一致。\nFAQ Q：Sentinel 资源生成时如何忽略某些资源。\nA：自定义 UrlCleaner，对想忽略的资源返回空字符。\nQ：Sentinel DataSource adapter 和 XxxRuleManager.loadRules 两种加载规则的方式能不能同时使用。\nA：默认不能。比如 Nacos DataSource adapter，远端配置有变更后自动刷新，会以远端配置为准，覆盖掉 XxxRuleManager.loadRules 主动加载的规则。当然一种妥协的处理方式是自定义 DataSource 加载，在加载的时候集成各个 Rule，加一个自定义标记，对此标记的规则不进行覆盖。\nQ：对于限流的冷启动效果，冷启动结束进入稳定状态后，还会不会重新回到冷启动阶段。\nA：会，一段时间流量较小或无流量后会回到冷启动阶段。通俗来讲就是会先判断一下“冷不冷”，很久没有流量或者流量很小，不就很冷。Sentinel 固定速率产生令牌再消费，服务第一次启动时，或者接口很久没有被访问，都会导致当前时间与上次生产令牌的时间相差甚远，所以第一次生产令牌将会生产 maxPermits 个令牌，直接将令牌桶装满。由于令牌桶已满，接下来 N 秒就是冷启动阶段。具体查看参考资料里的冷启动算法详解。\nQ: 很多开发通过错误码来处理流程，而非通过异常。这种写法，导致 Sentinel 不能拦截到异常，无法触发降级。对于这种情况，有没有什么好的处理方法。\nA: 实际上 Sentinel 是通过 Tracer.trace(e) 来统计业务异常的，因此可以收到错误码就调用此函数来统计业务异常。\nQ: 我的服务响应有时快有时慢，为了尽可能保证服务可用，我能不能向未来“借”指标，或者某些接口比较重要能否优先处理。\nA：QPS 模式下能。但是各个 adapter 都不支持，需要自己实现，参考 com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController#canPass(com.alibaba.csp.sentinel.node.Node, int, boolean) 和 com.alibaba.csp.sentinel.SphU#entryWithPriority(java.lang.String, com.alibaba.csp.sentinel.EntryType)，核心在于需要 prioritized 为 true。\n参考资料 令牌桶算法在 Sentinel 中的应用：https://blog.51cto.com/morris131/6506314 Sentinel 中的冷启动限流算法：https://cloud.tencent.com/developer/article/1674916 ","date":"2024-03-07","id":25,"permalink":"/blog/sentinel/","summary":"\u003cp\u003e基于 Alibaba Sentinel 实现的分布式限流中间件服务。主要对服务提供者提供限流、系统保护，对服务调用者提供熔断降级、限流排队等待效果。\u003c/p\u003e\n\u003cp\u003e实现目标：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e作为服务提供者，保护自己不被打死，服务可以慢不可以挂。\u003c/li\u003e\n\u003cli\u003e作为客户端及时限速和熔断，防止对服务提供方包含 Http、数据库、MQ 等造成太大压力，防止把糟糕的情况变得更糟。\u003c/li\u003e\n\u003cli\u003e以用户、租户、对象等更细粒度进行流量精细控制。\u003c/li\u003e\n\u003cli\u003e服务预热，应用新发布上线，缓存尚未完全建立，防止流量一下子把服务打死。\u003c/li\u003e\n\u003cli\u003e能够根据 Prometheus、ClickHouse、Elasticsearch 提供的监控指标，动态生成规则，自适应调整规则。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"概述\"\u003e概述\u003c/h2\u003e\n\u003cp\u003eSentinel 的基础知识请参考官方文档描述，这里单独介绍一些与我们定制相关的内容。\u003c/p\u003e\n\u003cp\u003e限流简单来说就三个点：资源、规则、效果。\u003c/p\u003e\n\u003cp\u003e资源：就是一个字符串，这个字符串可以自己定义、可以用注解自动生成、可以通过拦截器按规则生成。\u003c/p\u003e\n\u003cp\u003e规则：Sentinel 定义的一系列限流保护规则，比如流量控制规则、自适应保护规则。\u003c/p\u003e\n\u003cp\u003e效果：实际上“效果”也是“规则”定义的一部分。任何一条请求，命中某些资源规则后产生的效果，比如直接抛出异常、匀速等待。\u003c/p\u003e\n\u003ch3 id=\"sentinel-全局注意事项和使用限制\"\u003eSentinel 全局注意事项和使用限制\u003c/h3\u003e\n\u003cp\u003e使用开源默认 Sentinel 组件，有一些坑，或者说需要关注的注意事项：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e单个进程内资源数量阈值是 6000，多出的资源规则将不会生效（因为是懒加载，资源先到先得），也不提示错误而是直接忽略，资源数量太多建议使用热点参数控制。\u003c/li\u003e\n\u003cli\u003e对于限流的链路模式，context 阈值是 2000，所以默认的 WEB_CONTEXT_UNIFY 为 true，如果需要链路限流需要把这个改为 false。\u003c/li\u003e\n\u003cli\u003e自定义时，资源名中不要带 \u003ccode\u003e|\u003c/code\u003e 线， 这个日志中要用，日志以此作为分割符。\u003c/li\u003e\n\u003cli\u003eSentinel 支持按来源限流，注意 \u003ccode\u003eorigin\u003c/code\u003e 数量不能太多，否则会导致内存暴涨。\u003c/li\u003e\n\u003cli\u003e一个资源可以有多个规则，一条请求能否通过，取决于规则里阈值最小的限制条件。\u003c/li\u003e\n\u003cli\u003e限流的目的是保护系统，计数计量并不准确，所以不要拿限流做计量或配额控制。\u003c/li\u003e\n\u003cli\u003e增加限流一定程度上通过时间换空间，降低了 CPU、内存负载，对 K8S HPA 策略会有一定影响。后续我们也会考虑根据 Sentinel 限流指标进行扩缩容。\u003c/li\u003e\n\u003cli\u003e限流中如果有增加等待效果会使接口变慢，各调用链需要关注调用超时和事务配置。\u003c/li\u003e\n\u003cli\u003e目前 sentinel-web-servlet 和 sentinel-spring-webmvc-adapter 均不支持热点参数限流。为了支持热点参数需要自行扩展。\u003c/li\u003e\n\u003cli\u003esentinel-web-servlet 和 sentinel-spring-webmvc-adapter 会将每个到来的不同的 URL 都作为不同的资源处理，因此对于 REST 风格的 API，需要自行实现 UrlCleaner 接口清洗一下资源（比如将满足 /foo/:id 的 URL 都归到 /foo/* 资源下）。否则会导致资源数量过多，超出资源数量阈值（目前是 6000）时多出的资源的规则将不会生效。\u003c/li\u003e\n\u003cli\u003eJava 中 \u003ccode\u003esentinel-time-tick-thread\u003c/code\u003e 线程会额外多占用约 1-2% CPU，详细代码参考 \u003ccode\u003ecom.alibaba.csp.sentinel.util.TimeUtil\u003c/code\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e一些文档中尚未更新但是大家可能关心的内容：\u003c/p\u003e","tags":["Java"],"title":"基于 Alibaba Sentinel 实现的分布式限流中间件服务以及遇到的坑和注意事项"},{"content":"背景：公司 Windows 办公机受域控安全策略限制，部分文件无权直接修改，另外开发常用的设置系统环境变量也变灰无法设置。 此问题解决方式如下。\n提升文件权限 点击 Windows + X 快捷键 – 选择「命令提示符（管理员）。\n在 CDM 窗口中执行如下命令。\ntakeown /f C:\\要修复的文件路径\r在拿到文件所有权后，还需要使用如下命令获取文件的完全控制权限。\nicacls C:\\要修复的文件路径 /Grant Administrators:F\r命令行设置环境变量 Windows 下命令行设置环境变量，方式为 setx 变量名 变量值，变量值带空格等特殊符号的，用引号引起来。\n# 通过命令行设置 Java Home setx JAVA_HOME \u0026#34;C:\\Program Files\\Java\\jdk-11.0.2\u0026#34; # 设置 GO Path setx GOPATH \u0026#34;D:\\workspace\\go\u0026#34;\r","date":"2024-02-26","id":26,"permalink":"/blog/windows-takeown/","summary":"\u003cp\u003e背景：公司 Windows 办公机受域控安全策略限制，部分文件无权直接修改，另外开发常用的设置系统环境变量也变灰无法设置。\n此问题解决方式如下。\u003c/p\u003e\n\u003ch2 id=\"提升文件权限\"\u003e提升文件权限\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e点击 Windows + X 快捷键 – 选择「命令提示符（管理员）。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e在 CDM 窗口中执行如下命令。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cmd\" data-lang=\"cmd\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etakeown /f C:\\要修复的文件路径\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e在拿到文件所有权后，还需要使用如下命令获取文件的完全控制权限。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cmd\" data-lang=\"cmd\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eicacls C:\\要修复的文件路径 /Grant Administrators:F\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"命令行设置环境变量\"\u003e命令行设置环境变量\u003c/h2\u003e\n\u003cp\u003eWindows 下命令行设置环境变量，方式为 \u003ccode\u003esetx 变量名 变量值\u003c/code\u003e，变量值带空格等特殊符号的，用引号引起来。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cmd\" data-lang=\"cmd\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e# 通过命令行设置 Java Home\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esetx JAVA_HOME \u003cspan class=\"s2\"\u003e\u0026#34;C:\\Program Files\\Java\\jdk-11.0.2\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e# 设置 GO Path\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esetx GOPATH \u003cspan class=\"s2\"\u003e\u0026#34;D:\\workspace\\go\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e","tags":["Tools"],"title":"Windows 使用脚本提高权限以及设置环境变量"},{"content":"Git 为不同目录配置不同的 config，比如在同一个电脑上区分个人开发账号和公司开发账号，开源项目放一个文件夹，公司项目放一个文件夹，这样在提交代码的时候就不会混乱。\n为账户 B 准备一个单独的配置文件，比如： ~/.gitconfig-b，内容根据需要定义。\n[user] name = userb-name email = userb-email@test.com\r修改 ~/.gitconfig 文件，增加以下配置，引用上面创建的配置文件，注意其中的路径用绝对路径，并且路径以 / 结尾。\n[includeIf \u0026#34;gitdir:/project/path-b/\u0026#34;] path = /Users/xxxx/.gitconfig-b\r保存后，在 /project/path-b/ 下新的仓库都会以 .gitconfig-b 中的用户名和邮箱提交了。\n注意如果使用 ssh key 方式，在生成 key 的时候 ssh-keygen 名字指定文件名，多个 key 不要覆盖了。\n","date":"2024-02-26","id":27,"permalink":"/blog/git-multi-user/","summary":"\u003cp\u003eGit 为不同目录配置不同的 config，比如在同一个电脑上区分个人开发账号和公司开发账号，开源项目放一个文件夹，公司项目放一个文件夹，这样在提交代码的时候就不会混乱。\u003c/p\u003e\n\u003cp\u003e为账户 B 准备一个单独的配置文件，比如： ~/.gitconfig-b，内容根据需要定义。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-txt\" data-lang=\"txt\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e[user]\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name = userb-name\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  email = userb-email@test.com\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e修改 ~/.gitconfig 文件，增加以下配置，引用上面创建的配置文件，注意其中的路径用绝对路径，并且路径以 / 结尾。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-txt\" data-lang=\"txt\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e[includeIf \u0026#34;gitdir:/project/path-b/\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epath = /Users/xxxx/.gitconfig-b\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e保存后，在 /project/path-b/ 下新的仓库都会以 .gitconfig-b 中的用户名和邮箱提交了。\u003c/p\u003e\n\u003cp\u003e注意如果使用 ssh key 方式，在生成 key 的时候 ssh-keygen 名字指定文件名，多个 key 不要覆盖了。\u003c/p\u003e","tags":["Tools"],"title":"Git SSH 客户端同一机器多用户多仓库配置"},{"content":"我有一个 Spring Boot 应用服务，提供了一些简单的查询接口，本身运行很正常，通过 curl 或其他 http 客户端 localhost 请求都没有问题。\n某天通过 Traefik 代理了此服务，经过代理后再访问，某个接口一直都是 500 internal server error，其他接口都没有问题。通过 tcpdump 抓包发现，应用服务并没有返回任何 500 错误，而且响应时间和 Body 体大小都很正常。\n根据网上经验排查了 Traefik SSL 证书问题、路径问题、消息体太大问题、请求 Header 不合规问题，都一一否定。最后无意间看了一眼 Response Header，发现 Spring Boot 应用返回了两个 Transfer-Encoding: chunked Header。\n再根据此 Header 搜索，发现果然有人遇到过类似问题，请参考这几个链接。\nhttps://github.com/traefik/traefik/issues/7741 https://github.com/spring-projects/spring-framework/issues/21523 https://github.com/spring-projects/spring-boot/issues/37646 https://stackoverflow.com/questions/77042701/nginx-upstream-sent-duplicate-header-line-transfer-encoding-chunked-previo 从上面链接描述中可知，不仅 Traefik 会出现此问题，nginx 包含以 nginx 为基础的 ingress 也会出现同样问题，不过 nginx 返回错误信息类似 Nginx: upstream sent duplicate header line: \u0026quot;Transfer-Encoding: chunked\u0026quot;, previous value: \u0026quot;Transfer-Encoding: chunked” ，返回错误码一般是 502 Bad Gateway。\n我所使用的 Traefik(2.10.6) 和 Spring Boot(2.7.17) 都是当前日期最新版本，目前仍然有问题。\n出现此问题的代码类似如下。\nimport org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.client.RestTemplate; @Controller @RequestMapping(\u0026#34;/status\u0026#34;) public class StatusController { @Autowired private RestTemplate restTemplate; @GetMapping(value = \u0026#34;/test\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; getStatus() { return restTemplate.getForEntity(\u0026#34;http://another-service/actuator/health\u0026#34;, String.class); } }\r修改为如下方式即解决问题。\nimport org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.client.RestTemplate; @Controller @RequestMapping(\u0026#34;/status\u0026#34;) public class StatusController { @Autowired private RestTemplate restTemplate; @GetMapping(value = \u0026#34;/test\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; getStatus() { // 不要直接用 RestTemplate 返回值，使用 ResponseEntity 重新包装一次 return ResponseEntity.ok(restTemplate.getForEntity(\u0026#34;http://another-service/actuator/health\u0026#34;, String.class)); } }\r另外根据 GitHub Issue 反馈，不仅 RestTemplate，使用 OpenFeign 也会触发以上问题。\n同理，如果大家遇到服务经过 Nginx、Traefik 代理后出现的疑难问题，可关注下 Response Header 是否有异常。\n","date":"2023-11-26","id":28,"permalink":"/blog/duplicate-transfer-encoding-chunked/","summary":"\u003cp\u003e我有一个 Spring Boot 应用服务，提供了一些简单的查询接口，本身运行很正常，通过 curl 或其他 http 客户端 localhost 请求都没有问题。\u003c/p\u003e\n\u003cp\u003e某天通过 Traefik 代理了此服务，经过代理后再访问，某个接口一直都是 \u003ccode\u003e500 internal server error\u003c/code\u003e，其他接口都没有问题。通过 tcpdump 抓包发现，应用服务并没有返回任何 500 错误，而且响应时间和 Body 体大小都很正常。\u003c/p\u003e\n\u003cp\u003e根据网上经验排查了 Traefik SSL 证书问题、路径问题、消息体太大问题、请求 Header 不合规问题，都一一否定。最后无意间看了一眼 Response Header，发现 Spring Boot 应用返回了两个 \u003ccode\u003eTransfer-Encoding: chunked\u003c/code\u003e Header。\u003c/p\u003e\n\u003cp\u003e再根据此 Header 搜索，发现果然有人遇到过类似问题，请参考这几个链接。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/traefik/traefik/issues/7741\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/traefik/traefik/issues/7741\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/spring-projects/spring-framework/issues/21523\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/spring-projects/spring-framework/issues/21523\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/spring-projects/spring-boot/issues/37646\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/spring-projects/spring-boot/issues/37646\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://stackoverflow.com/questions/77042701/nginx-upstream-sent-duplicate-header-line-transfer-encoding-chunked-previo\" target=\"_blank\" rel=\"noopener\"\u003ehttps://stackoverflow.com/questions/77042701/nginx-upstream-sent-duplicate-header-line-transfer-encoding-chunked-previo\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e从上面链接描述中可知，不仅 Traefik 会出现此问题，nginx 包含以 nginx 为基础的 ingress 也会出现同样问题，不过 nginx 返回错误信息类似 \u003ccode\u003eNginx: upstream sent duplicate header line: \u0026quot;Transfer-Encoding: chunked\u0026quot;, previous value: \u0026quot;Transfer-Encoding: chunked”\u003c/code\u003e ，返回错误码一般是 502 Bad Gateway。\u003c/p\u003e","tags":["Java"],"title":"重复 Transfer-Encoding Response Header 引起的 Traefik 代理服务 500 问题"},{"content":"","date":"2023-09-07","id":29,"permalink":"/blog/","summary":"卫星实验室技术博客，一些关于 AIOps、DataOps、DevOps、GitOps、FinOps 、云原生、平台工程、Java 开发的技术分享，右上角点搜索搜你所想。","tags":[],"title":"Blog"},{"content":"问题描述：\n一个 Java 应用跑在 K8S 容器内，Pod 内只有 Java 这一个进程。应用跑了一段时间后，CPU、内存占用都不高，但是却出现以下 OutOfMemoryError 错误。\nException in thread \u0026#34;slow-fetch-15\u0026#34; java.lang.OutOfMemoryError: unable to create new native thread 428 at java.lang.Thread.start0(Native Method) 429 at java.lang.Thread.start(Thread.java:719) 430 at java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:957) 431 at java.util.concurrent.ThreadPoolExecutor.processWorkerExit(ThreadPoolExecutor.java:1025) 432 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167) 433 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) 进入 Pod 内，尝试执行任何操作，又会出现 unable to start container process 错误。\n一开始怀疑是内存不足，调大了内存，同时也缩小了 Java 的 xss，都不起作用。\n真实原因： K8S 容器限制了 PID 数，无法创建新的线程。关于 K8S PID limit， 可参考此资料：https://kubernetes.io/zh-cn/docs/concepts/policy/pid-limiting/ .\n在 Pod 内查看当前 PID 限制方式：\n# cgroup v1 版本，查看最大值和当前值 cat /sys/fs/cgroup/pids/pids.max cat /sys/fs/cgroup/pids/pids.current # cgroup v2 版本 cat /sys/fs/cgroup/$(cat /proc/self/cgroup | grep -o \u0026#39;[^:]*$\u0026#39;)/pids.max cat /sys/fs/cgroup/$(cat /proc/self/cgroup | grep -o \u0026#39;[^:]*$\u0026#39;)/pids.current\r但是，PID 为什么会超呢，Pod 内只有一个 Java 进程，PID 数不应该是 1 个吗，这个 PID 限制为什么影响了线程。\n简单来讲，在 Linux 中线程其实是通过轻量级进程实现的，也就是 LWP(light weight process)，因此在 Linux 中每个线程都是一个进程，都拥有一个 PID，换句话说，操作系统原理中的线程，对应的其实是 Linux 中的进程（即 LWP），因此 Linux 内核中的 PID 对应的其实是原理中的 TID。\n在 Pod 内通过 top -p pid -H 查看，可以看到第一列每个线程都分配了一个 PID。\nPID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 101 root 20 0 8622220 5.1g 15640 S 0.3 8.1 0:16.29 VM Thread 112 root 20 0 8622220 5.1g 15640 S 0.3 8.1 0:46.13 C2 CompilerThre 113 root 20 0 8622220 5.1g 15640 S 0.3 8.1 0:39.62 C1 CompilerThre 846 root 20 0 8622220 5.1g 15640 S 0.3 8.1 0:00.64 NettyClientSele 850 root 20 0 8622220 5.1g 15640 S 0.3 8.1 0:00.54 NettyClientWork 1 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.27 java 89 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.99 java 90 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:03.29 java 91 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:03.27 java 92 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:03.26 java 93 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:03.30 java 94 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:01.43 java 95 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.11 java 96 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.12 java 97 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.16 java 98 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.31 java 99 root 20 0 8622220 5.1g 15640 S 0.0 8.1 0:00.32 java 为什么要限制 POD PID 数。类似 CPU 和内存，进程 ID（PID）也是节点上的一种基础资源，很容易就会在尚未超出其它资源约束的时候就已经触及任务个数上限，进而导致宿主机不稳定。某日某个不起眼的服务因为无节制创建了 N 多线程，把整个宿主机打挂了，谁痛谁知道啊。\n","date":"2023-09-07","id":30,"permalink":"/blog/k8s-pid-limiting-oom/","summary":"\u003cp\u003e问题描述：\u003c/p\u003e\n\u003cp\u003e一个 Java 应用跑在 K8S 容器内，Pod 内只有 Java 这一个进程。应用跑了一段时间后，CPU、内存占用都不高，但是却出现以下 OutOfMemoryError 错误。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003eException in thread \u0026#34;slow-fetch-15\u0026#34; java.lang.OutOfMemoryError: unable to create new native thread\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e428  at java.lang.Thread.start0(Native Method)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e429  at java.lang.Thread.start(Thread.java:719)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e430  at java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:957)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e431  at java.util.concurrent.ThreadPoolExecutor.processWorkerExit(ThreadPoolExecutor.java:1025)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e432  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e433  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e进入 Pod 内，尝试执行任何操作，又会出现 \u003ccode\u003eunable to start container process\u003c/code\u003e 错误。\u003c/p\u003e\n\u003cp\u003e一开始怀疑是内存不足，调大了内存，同时也缩小了 Java 的 \u003ccode\u003exss\u003c/code\u003e，都不起作用。\u003c/p\u003e\n\u003cp\u003e真实原因： K8S 容器限制了 PID 数，无法创建新的线程。关于 K8S PID limit， 可参考此资料：\u003ca href=\"https://kubernetes.io/zh-cn/docs/concepts/policy/pid-limiting/\" target=\"_blank\" rel=\"noopener\"\u003ehttps://kubernetes.io/zh-cn/docs/concepts/policy/pid-limiting/\u003c/a\u003e\n.\u003c/p\u003e\n\u003cp\u003e在 Pod 内查看当前 PID 限制方式：\u003c/p\u003e","tags":["k8s","Java"],"title":"K8S 容器 PID 限制引起的 Java OutOfMemoryError"},{"content":"故事背景：\n一个 K8S Pod，里面只有一个 Java 进程，K8S request 和 limit memory 都是 2G，Java 进程核心参数包括：-XX:+UseZGC -Xmx1024m -Xms768m。\n服务启动一段时间后，查看 Grafana 监控数据，Pod 内存使用量约 1.5G，JVM 内存使用量约 500M，通过 jvm dump 分析没有任何大对象，运行三五天后出现 K8S Container OOM。\n首先区分下 Container OOM 和 Jvm OOM，Container OOM 是 Pod 内进程申请内存大约 K8S Limit 所致。\n问题来了：\nPod 2G 内存，JVM 设置了 Xmx 1G，已经预留了 1G 内存，为什么还会 Container OOM，这预留的 1G 内存被谁吃了。 正常情况下（无 Container OOM），Grafana 看到的监控数据，Pod 内存使用量 1.5G， JVM 内存使用量 500M，差别为什么这么大。 Pod 内存使用量为什么超过 Xmx 限制。 Grafana 监控图。\n统计指标 Pod 内存使用量统计的指标是 container_memory_working_set_bytes：\ncontainer_memory_usage_bytes = container_memory_rss + container_memory_cache + kernel memory container_memory_working_set_bytes = container_memory_usage_bytes - total_inactive_file（未激活的匿名缓存页） container_memory_working_set_bytes 是容器真实使用的内存量，也是资源限制 limit 时的 OOM 判断依据。\n另外注意 cgroup 版本差异： container_memory_cache reflects cache (cgroup v1) or file (cgroup v2) entry in memory.stat.\nJVM 内存使用量统计的指标是 jvm_memory_bytes_used： heap、non-heap 以及其他 真实用量总和。下面解释其他。\n首先说结论：在 POD 内，通过 top、free 看到的指标都是不准确的，不用看了，如果要看真实的数据以 cgroup 为准。\ncontainer_memory_working_set_bytes 指标来自 cadvisor，cadvisor 数据来源 cgroup，可以查看以下文件获取真实的内存情况。\n# cgroup v2 文件地址 ll /sys/fs/cgroup/memory.* -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.current -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.events -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.events.local -rw-r--r-- 1 root root 0 Jan 7 11:50 /sys/fs/cgroup/memory.high -rw-r--r-- 1 root root 0 Jan 7 11:50 /sys/fs/cgroup/memory.low -rw-r--r-- 1 root root 0 Jan 7 11:50 /sys/fs/cgroup/memory.max -rw-r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.min -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.numa_stat -rw-r--r-- 1 root root 0 Jan 7 11:50 /sys/fs/cgroup/memory.oom.group -rw-r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.pressure -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.stat -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.swap.current -r--r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.swap.events -rw-r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.swap.high -rw-r--r-- 1 root root 0 Jan 6 16:25 /sys/fs/cgroup/memory.swap.max JVM 关于使用量和提交量的解释。\nUsed Size：The used space is the amount of memory that is currently occupied by Java objects. 当前实际真的用着的内存，每个 bit 都对应了有值的。\nCommitted Size：The committed size is the amount of memory guaranteed to be available for use by the Java virtual machine. 操作系统向 JVM 保证可用的内存大小，或者说 JVM 向操作系统已经要的内存。站在操作系统的角度，就是已经分出去（占用）的内存，保证给 JVM 用了，其他进程不能用了。 由于操作系统的内存管理是惰性的，对于已申请的内存虽然会分配地址空间，但并不会直接占用物理内存，真正使用的时候才会映射到实际的物理内存，所以 committed \u0026gt; res 也是很可能的。\nJava 进程内存分析 Pod 的内存使用量 1.5G，都包含哪些。\nkernel memory 为 0，Cache 约 1100M，rss 约 650M，inactive_file 约 200M。可以看到 Cache 比较大，因为这个服务比较特殊有很多文件操作。\n# cgroup v2 变量变了 cat /sys/fs/cgroup/memory.stat anon 846118912 file 2321530880 kernel_stack 10895360 pagetables 15523840 percpu 0 sock 1212416 shmem 1933574144 file_mapped 1870290944 file_dirty 12288 file_writeback 0 swapcached 0 anon_thp 0 file_thp 0 shmem_thp 0 inactive_anon 2602876928 active_anon 176771072 inactive_file 188608512 active_file 199348224 unevictable 0 slab_reclaimable 11839688 slab_unreclaimable 7409400 slab 19249088 workingset_refault_anon 0 workingset_refault_file 318 workingset_activate_anon 0 workingset_activate_file 95 workingset_restore_anon 0 workingset_restore_file 0 workingset_nodereclaim 0 pgfault 2563565 pgmajfault 15 pgrefill 14672 pgscan 25468 pgsteal 25468 pgactivate 106436 pgdeactivate 14672 pglazyfree 0 pglazyfreed 0 thp_fault_alloc 0 thp_collapse_alloc 0 通过 Java 自带的 Native Memory Tracking 看下内存提交量。\n# Java 启动时先打开 NativeMemoryTracking，默认是关闭的。注意不要在生产环境长期开启，有性能损失 java -XX:NativeMemoryTracking=detail -jar # 查看详情 jcmd $(pgrep java) VM.native_memory detail scale=MB # 查看 summary jcmd $(pgrep java) VM.native_memory summary scale=MB # 创建基线，然后分不同时间进行 diff 查看变化 jcmd $(pgrep java) VM.native_memory baseline jcmd $(pgrep java) VM.native_memory detail.diff scale=MB jcmd $(pgrep java) VM.native_memory summary.diff scale=MB\r通过 Native Memory Tracking 追踪到的详情大致如下，关注其中每一项 committed 值。\nNative Memory Tracking: (Omitting categories weighting less than 1MB) Total: reserved=68975MB, committed=1040MB - Java Heap (reserved=58944MB, committed=646MB) (mmap: reserved=58944MB, committed=646MB) - Class (reserved=1027MB, committed=15MB) (classes #19551) #加载类的个数 ( instance classes #18354, array classes #1197) (malloc=3MB #63653) (mmap: reserved=1024MB, committed=12MB) ( Metadata: ) ( reserved=96MB, committed=94MB) ( used=93MB) ( waste=0MB =0.40%) ( Class space:) ( reserved=1024MB, committed=12MB) ( used=11MB) ( waste=1MB =4.63%) - Thread (reserved=337MB, committed=37MB) (thread #335) #线程的个数 (stack: reserved=336MB, committed=36MB) (malloc=1MB #2018) - Code (reserved=248MB, committed=86MB) (malloc=6MB #24750) (mmap: reserved=242MB, committed=80MB) - GC (reserved=8243MB, committed=83MB) (malloc=19MB #45814) (mmap: reserved=8224MB, committed=64MB) - Compiler (reserved=3MB, committed=3MB) (malloc=3MB #2212) - Internal (reserved=7MB, committed=7MB) (malloc=7MB #31683) - Other (reserved=18MB, committed=18MB) (malloc=18MB #663) - Symbol (reserved=19MB, committed=19MB) (malloc=17MB #502325) (arena=2MB #1) - Native Memory Tracking (reserved=12MB, committed=12MB) (malloc=1MB #8073) (tracking overhead=11MB) - Shared class space (reserved=12MB, committed=12MB) (mmap: reserved=12MB, committed=12MB) - Module (reserved=1MB, committed=1MB) (malloc=1MB #4996) - Synchronization (reserved=1MB, committed=1MB) (malloc=1MB #2482) - Metaspace (reserved=97MB, committed=94MB) (malloc=1MB #662) (mmap: reserved=96MB, committed=94MB) - Object Monitors (reserved=8MB, committed=8MB) (malloc=8MB #39137) 先解释下内存参数意义：\nreserved：JVM 向操作系统预约的虚拟内存地址空间，仅是地址空间预留，不消耗物理资源，防止其他进程使用这段地址范围，类似\u0026#34;土地规划许可\u0026#34;，但尚未建房。 committed：JVM 实际分配的物理内存（RAM + Swap），真实消耗系统内存资源。 虚拟地址空间 ┌──────────────────────────────┐ │ reserved=16MB │ ← 整个预约区域 ├───────────────┬──────────────┤ │ committed=13MB│ 未使用 3MB │ ← 实际使用的物理内存 └───────────────┴──────────────┘ Heap Heap 是 Java 进程中使用量最大的一部分内存，是最常遇到内存问题的部分，Java 也提供了很多相关工具来排查堆内存泄露问题，这里不详细展开。Heap 与 RSS 相关的几个重要 JVM 参数如下： Xms：Java Heap 初始内存大小。（目前我们用的百分比控制，MaxRAMPercentage) Xmx：Java Heap 的最大大小。(InitialRAMPercentage) XX:+UseAdaptiveSizePolicy：是否开启自适应大小策略。开启后，JVM 将动态判断是否调整 Heap size，来降低系统负载。\nMetaspace Metaspace 主要包含方法的字节码，Class 对象，常量池。一般来说，记载的类越多，Metaspace 使用的内存越多。与 Metaspace 相关的 JVM 参数有： XX:MaxMetaspaceSize: 最大的 Metaspace 大小限制【默认无限制】 XX:MetaspaceSize=64M: 初始的 Metaspace 大小。如果 Metaspace 空间不足，将会触发 Full GC。 类空间占用评估，给两个数字可供参考：10K 个类约 90M，15K 个类约 100M。 什么时候回收：分配给一个类的空间，是归属于这个类的类加载器的，只有当这个类加载器卸载的时候，这个空间才会被释放。释放 Metaspace 的空间，并不意味着将这部分空间还给系统内存，这部分空间通常会被 JVM 保留下来。 扩展：参考资料中的Java Metaspace 详解，这里完美解释 Metaspace、Compressed Class Space 等。\nThread NMT 中显示的 Thread 部分内存与线程数与 -Xss 参数成正比，一般来说 committed 内存等于 Xss *线程数 。\nCode JIT 动态编译产生的 Code 占用的内存。这部分内存主要由-XX:ReservedCodeCacheSize 参数进行控制。\nInternal Internal 包含命令行解析器使用的内存、JVMTI、PerfData 以及 Unsafe 分配的内存等等。 需要注意的是，Unsafe_AllocateMemory 分配的内存在 JDK11 之前，在 NMT 中都属于 Internal，但是在 JDK11 之后被 NMT 归属到 Other 中。\nSymbol Symbol 为 JVM 中的符号表所使用的内存，HotSpot 中符号表主要有两种：SymbolTable 与 StringTable。 大家都知道 Java 的类在编译之后会生成 Constant pool 常量池，常量池中会有很多的字符串常量，HotSpot 出于节省内存的考虑，往往会将这些字符串常量作为一个 Symbol 对象存入一个 HashTable 的表结构中即 SymbolTable，如果该字符串可以在 SymbolTable 中 lookup（SymbolTable::lookup）到，那么就会重用该字符串，如果找不到才会创建新的 Symbol（SymbolTable::new_symbol）。 当然除了 SymbolTable，还有它的双胞胎兄弟 StringTable（StringTable 结构与 SymbolTable 基本是一致的，都是 HashTable 的结构），即我们常说的字符串常量池。平时做业务开发和 StringTable 打交道会更多一些，HotSpot 也是基于节省内存的考虑为我们提供了 StringTable，我们可以通过 String.intern 的方式将字符串放入 StringTable 中来重用字符串。\nNative Memory Tracking Native Memory Tracking 使用的内存就是 JVM 进程开启 NMT 功能后，NMT 功能自身所申请的内存。\n观察上面几个区域的分配，没有明显的异常。\nNMT 追踪到的 是 Committed，不一定是 Used，NMT 和 cadvisor 没有找到必然的对应的关系。可以参考 RSS，cadvisor 追踪到 RSS 是 650M，JVM Used 是 500M，还有大约 150M 浮动到哪里去了。\n因为 NMT 只能 Track JVM 自身的内存分配情况，比如：Heap 内存分配，direct byte buffer 等。无法追踪的情况主要包括：\n使用 JNI 调用的一些第三方 native code 申请的内存，比如使用 System.Loadlibrary 加载的一些库。 标准的 Java Class Library，典型的，如文件流等相关操作（如：Files.list、ZipInputStream 和 DirectoryStream 等）。主要涉及到的调用是 Unsafe.allocateMemory 和 java.util.zip.Inflater.init(Native Method)。 怎么追踪 NMT 追踪不到的其他内存，目前是安装了 jemalloc 内存分析工具，他能追踪底层内存的分配情况输出报告。\n通过 jemalloc 内存分析工具佐证了上面的结论，Unsafe.allocateMemory 和 java.util.zip.Inflater.init 占了 30%，基本吻合。\n启动 arthas 查看下类调用栈，在 arthas 里执行以下命令：\n# 先设置 unsafe true options unsafe true # 这个没有 stack sun.misc.Unsafe allocateMemory # 这个有 stack jdk.internal.misc.Unsafe allocateMemory stack java.util.zip.Inflater inflate # stack 经常追踪不到，改用 profiler 输出内存分配火焰图 profiler start --event alloc --duration 600 profiler start --event Unsafe_AllocateMemory0 --duration 600\r通过上面的命令，能看到 MongoDB 和 netty 一直在申请使用内存。注意：早期的 mongodb client 确实有无法释放内存的 bug，但是在我们场景，长期观察会发现内存申请了逐渐释放了，没有持续增长。回到开头的 ContainerOOM 问题，可能一个原因是流量突增，MongoDB 申请了更多的内存导致 OOM，而不是因为内存不释放。\nts=2022-12-29 21:20:01;thread_name=ForkJoinPool.commonPool-worker-1;id=22;is_daemon=true;priority=1;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@1d44bcfa @jdk.internal.misc.Unsafe.allocateMemory() at java.nio.DirectByteBuffer.\u0026lt;init\u0026gt;(DirectByteBuffer.java:125) at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:332) at sun.nio.ch.Util.getTemporaryDirectBuffer(Util.java:243) at java.net.Socket$SocketOutputStream.write(Socket.java:1035) at com.mongodb.internal.connection.SocketStream.write(SocketStream.java:99) at com.mongodb.internal.connection.InternalStreamConnection.sendMessage(InternalStreamConnection.java:426) at com.mongodb.internal.connection.UsageTrackingInternalConnection.sendAndReceive(UsageTrackingInternalConnection.java:99) at com.mongodb.internal.connection.DefaultConnectionPool$PooledConnection.sendAndReceive(DefaultConnectionPool.java:444) ……………………………… at com.mongodb.MongoClientExt$1.execute(MongoClientExt.java:42) ……………………………… 另外，arthas 自带的 profiler 有时候经常追踪失败，可以切换到原始的 async-profiler ，用他来追踪“其他”内存分配比较有效。\n总结 Java 进程内存占用：Total=heap + non-heap + 上面说的这个其他。\njemalloc jemalloc 是一个比 glibc malloc 更高效的内存池技术，在 Facebook 公司被大量使用，在 FreeBSD 和 FireFox 项目中使用了 jemalloc 作为默认的内存管理器。使用 jemalloc 可以使程序的内存管理性能提升，减少内存碎片。\n比如 Redis 内存分配默认使用的 jemalloc，早期版本安装 redis 是需要手动安装 jemalloc 的，现在 redis 应该是在编译期内置好了。\n原来使用 jemalloc 是为了分析内存占用，通过 jemalloc 输出当前内存分配情况，或者通过 diff 分析前后内存差，大概能看出内存都分给睡了，占了多少，是否有内存无法释放的情况。\n后来参考了这个文章，把 glibc 换成 jemalloc 带来性能提升，降低内存使用，决定一试。\nhow we’ve reduced memory usage without changing any code：https://blog.malt.engineering/java-in-k8s-how-weve-reduced-memory-usage-without-changing-any-code-cbef5d740ad Decreasing RAM Usage by 40% Using jemalloc with Python \u0026amp; Celery: https://zapier.com/engineering/celery-python-jemalloc/ 一个服务，运行一周，观察效果。\n使用 Jemalloc 之前： 使用 Jemalloc 之后（同时调低了 Pod 内存）： 注：以上结果未经生产长期检验。\n内存交还给操作系统 注意：下面的操作，生产环境不建议这么干。\n默认情况下，OpenJDK 不会主动向操作系统退还未用的内存（不严谨）。看第一张监控的图，会发现运行一段时间后，Pod 的内存使用量一直稳定在 80%\u0026ndash;90%不再波动。\n其实对于 Java 程序，浮动比较大的就是 heap 内存。其他区域 Code、Metaspace 基本稳定\n# 执行命令获取当前 heap 情况 jhsdb jmap --heap --pid $(pgrep java) #以下为输出 Attaching to process ID 7, please wait... Debugger attached successfully. Server compiler detected. JVM version is 17.0.5+8-LTS using thread-local object allocation. ZGC with 4 thread(s) Heap Configuration: MinHeapFreeRatio = 40 MaxHeapFreeRatio = 70 MaxHeapSize = 1287651328 (1228.0MB) NewSize = 1363144 (1.2999954223632812MB) MaxNewSize = 17592186044415 MB OldSize = 5452592 (5.1999969482421875MB) NewRatio = 2 SurvivorRatio = 8 MetaspaceSize = 22020096 (21.0MB) CompressedClassSpaceSize = 1073741824 (1024.0MB) MaxMetaspaceSize = 17592186044415 MB G1HeapRegionSize = 0 (0.0MB) Heap Usage: ZHeap used 310M, capacity 710M, max capacity 1228M Java 内存不交还，几种情况：\nXms 大于实际需要的内存，比如我们服务设置了 Xms768M，但是实际上只需要 256，高峰期也就 512，到不了 Xms 的值也就无所谓归还。 上面 jmap 的结果，可以看到 Java 默认的配置 MaxHeapFreeRatio=70，这个 70% Free 几乎很难达到。（另外注意 Xmx==Xms 的情况下这两个参数无效，因为他怎么扩缩都不会突破 Xms 和 Xmx 的限制）\nMinHeapFreeRatio = 40 空闲堆空间的最小百分比，计算公式为：HeapFreeRatio =(CurrentFreeHeapSize/CurrentTotalHeapSize) * 100，值的区间为 0 到 100，默认值为 40。如果 HeapFreeRatio \u0026lt; MinHeapFreeRatio，则需要进行堆扩容，扩容的时机应该在每次垃圾回收之后。 MaxHeapFreeRatio = 70 空闲堆空间的最大百分比，计算公式为：HeapFreeRatio =(CurrentFreeHeapSize/CurrentTotalHeapSize) * 100，值的区间为 0 到 100，默认值为 70。如果 HeapFreeRatio \u0026gt; MaxHeapFreeRatio，则需要进行堆缩容，缩容的时机应该在每次垃圾回收之后。 对于 ZGC，默认是交还给操作系统的。可通过 -XX:+ZUncommit -XX:ZUncommitDelay=300 这两个参数控制（不再使用的内存最多延迟 300s 归还给 OS，线下环境可以改小点）。\n经过调整后的服务，内存提交在 500\u0026ndash;800M 之间浮动，不再是一条直线。\n内存分析工具速览 使用 Java 自带工具 dump 内存。\njcmd \u0026lt;pid\u0026gt; GC.heap_dump \u0026lt;file-path\u0026gt; # 这个命令执行，JVM 会先触发 gc，然后再统计信息。 jmap -dump:live,format=b,file=/opt/tomcat/logs/dump.hprof \u0026lt;pid\u0026gt; # dump all jmap -dump:format=b,file=/opt/tomcat/logs/dump.hprof \u0026lt;pid\u0026gt;\r使用 jmap 输出内存占用概览。\njmap -histo 1 | head -n 500\r使用 async-profiler 追踪 native 内存分配，输出火焰图。\nasync-profiler/bin/asprof -d 600 -e Unsafe_AllocateMemory0 -f /opt/tomcat/logs/unsafe_allocate.html \u0026lt;pid\u0026gt;\r使用 vmtouch 查看和清理 Linux 系统文件缓存。\n# 查看文件或文件夹占了多少缓存 vmtouch /files vmtouch /dir # 遍历文件夹输出详细占用 vmtouch -v /dir # 清空缓存 vmtouch -e /dir\rpmap 查看内存内容 使用 pmap 查看当前内存分配，如果找到了可疑的内存块，可以通过 gdb 尝试解析出内存块中的内容。\n# pmap 查看内存，先不要排序，便于找出连续的内存块（一般是 2 个一组） # pmap -x \u0026lt;pid\u0026gt; | sort -n -k3 pmap -x $(pgrep java) # 举例说明在上面发现有 7f6737dff000 开头的内存块可能异常，一般都是一个或多个一组，是连续的内存 cat /proc/$(pgrep java)/smaps \u0026gt; logs/smaps.txt gdb attach $(pgrep java) # dump 的起始地址，基于上面 smaps.txt 找到的内容，地址加上 0x 前缀 dump memory /opt/tomcat/logs/gdb-test.dump 0x7f6737dff000 0x7f6737e03000 # 尝试将 dump 文件内容转成可读的 string，其中 -10 是过滤长度大于 10 的，也可以不过滤 strings -10 /opt/tomcat/logs/gdb-test.dump # 如果幸运，能在上面的 strings 中找到你的 Java 类或 Bean 内容，如果不幸都是一堆乱码，可以尝试扩大 dump 内存块，多找几个连续的块试试 # pmap 按大小降序排序并过滤大于 1000 KB 的项 pmap -x $(pgrep java) | awk \u0026#39;NR\u0026gt;2 \u0026amp;\u0026amp; !/total/ {print $2, $0}\u0026#39; | sort -k1,1nr | cut -d\u0026#39; \u0026#39; -f2- | awk \u0026#39;$2 \u0026gt; 1000\u0026#39;\r识别 Linux 节点上的 cgroup 版本 cgroup 版本取决于正在使用的 Linux 发行版和操作系统上配置的默认 cgroup 版本。 要检查你的发行版使用的是哪个 cgroup 版本，请在该节点上运行 stat -fc %T /sys/fs/cgroup/ 命令：\nstat -fc %T /sys/fs/cgroup/\r对于 cgroup v2，输出为 cgroup2fs。\n对于 cgroup v1，输出为 tmpfs。\n问题原因分析和调整 回到开头问题，通过上面分析，2G 内存，RSS 其实占用 600M，为什么最终还是 ContainerOOM 了。\nkernel memory 为 0，排除 kernel 泄漏的原因。下面的参考资料里介绍了 kernel 泄露的两种场景。 Cache 很大，说明文件操作多。搜了一下代码，确实有很多 InputStream 调用没有显式关闭，而且有的 InputSteam Root 引用在 ThreadLocal 里，ThreadLocal 只 init 未 remove。 但是，ThreadLocal 的引用对象是线程池，池不回收，所以这部分可能会无法关闭，但是不会递增，但是 cache 也不能回收。 优化办法：ThreadLocal 中对象是线程安全的，无数据传递，直接干掉 ThreadLocal；显式关闭 InputStream。运行一周发现 cache 大约比优化前低 200\u0026ndash;500M。 ThreadLocal 引起内存泄露是 Java 中很经典的一个场景，一定要特别注意。 一般场景下，Java 程序都是堆内存占用高，但是这个服务堆内存其实在 200-500M 之间浮动，我们给他分了 768M，从来没有到过这个值，所以调低 Xms。留出更多内存给 JNI 使用。 线下环境内存分配切换到 jemalloc，长期观察大部分效果可以，但是对部分应用基本没有效果。 经过上述调整以后，线下环境 Pod 内存使用量由 1G 降到 600M 作用。线上环境内存使用量在 50%\u0026ndash;80%之间根据流量大小浮动，原来是 85% 居高不小。\n不同 JVM 参数内存占用对比 以下为少量应用实例总结出来的结果，应用的模型不同占用情况会有比较大差异，仅供对比参考。\n基础参数 中低流量时内存占用（Xmx 6G） 高流量时内存占用 Java 8 + G1 65% 85% Java 17 + G1 60% 75% Java 17 + ZGC 90% 95% Java 21 + G1 40% 60% Java 21 + ZGC 80% 90% Java 21 + ZGC + UseStringDeduplication 85% 90% Java 21 + ZGC + ZGenerational + UseStringDeduplication 75% 80% 总结：\nG1 比 ZGC 占用内存明显减少。 Java 21 比 Java 8、17 占用内存明显偏少。 Java 21 ZGC 分代后确实能降低内存。 通过 -XX:+UseStringDeduplication 启用 String 去重后，有的应用能降低 10% 内存，有的几乎无变化。 分享我们所使用的 Java 21 生产环境参数配置，仅供参考请根据自己应用情况选择性使用：\n-XX:InitialRAMPercentage=40.0 -XX:MaxRAMPercentage=70.0：按照百分比设置初始化和最大堆内存。内存充足的情况下建议设置为一样大。 -XX:+UseZGC -XX:+ZUncommit -XX:ZUncommitDelay=300 -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=30：促进 Java 内存更快交还给操作系统，但同时 CPU 可能偏高。 -XX:+ZGenerational：启用分代 ZGC，能降低内存占用。 -XX:+UseStringDeduplication：启用 String 去重，可能降低内存占用。 -Xss256k：降低线程内存占用，默认 1Mb，线程比较多的情况下这个占用还是很多的。谨慎设置。 -XX:+ParallelRefProcEnabled：多线程并行处理 Reference，减少 GC 的 Reference 数量，减少 Young GC 时间。 关于 Java 8、17 和 21 不同 GC 更多维度的对比效果可参考： JDK 21: The GCs keep getting better 。\nJava 分析工具 [推荐] 在线 GC 分析工具 GCeasy.io [推荐] 在线 Thread 分析工具 FastThread.io [推荐] 在线 Heap 分析工具 HeapHero.io [推荐] 在线 jstack 分析工具 jstack.review [Beta] 可私有化部署 Online GC、Heap Dump、Thread、JFR 分析工具 eclipse/jifa 参考资料 IOTDB 线上堆外内存泄漏问题排查：https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=195728187 JVM 堆外内存问题定位： https://juejin.cn/post/6844904168549777421 java 堆外内存泄漏排查： https://javakk.com/1158.html ","date":"2023-01-07","id":31,"permalink":"/blog/java-memory/","summary":"\u003cp\u003e故事背景：\u003c/p\u003e\n\u003cp\u003e一个 K8S Pod，里面只有一个 Java 进程，K8S request 和 limit memory 都是 2G，Java 进程核心参数包括：\u003ccode\u003e-XX:+UseZGC -Xmx1024m -Xms768m\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e服务启动一段时间后，查看 Grafana 监控数据，Pod 内存使用量约 1.5G，JVM 内存使用量约 500M，通过 jvm dump 分析没有任何大对象，运行三五天后出现 K8S Container OOM。\u003c/p\u003e\n\u003cp\u003e首先区分下 Container OOM 和 Jvm OOM，Container OOM 是 Pod 内进程申请内存大约 K8S Limit 所致。\u003c/p\u003e\n\u003cp\u003e问题来了：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ePod 2G 内存，JVM 设置了 \u003ccode\u003eXmx 1G\u003c/code\u003e，已经预留了 1G 内存，为什么还会 Container OOM，这预留的 1G 内存被谁吃了。\u003c/li\u003e\n\u003cli\u003e正常情况下（无 Container OOM），Grafana 看到的监控数据，Pod 内存使用量 1.5G， JVM 内存使用量 500M，差别为什么这么大。\u003c/li\u003e\n\u003cli\u003ePod 内存使用量为什么超过 Xmx 限制。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eGrafana 监控图。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"./grafana-pod-jvm.png\"\u003e\r\n\r\n\u003cimg\r\n  src=\"/blog/java-memory/grafana-pod-jvm_hu_f3e003bf88afca3a.webp\"\r\n  width=\"1920\"\r\n  height=\"3600\"\r\n  decoding=\"async\"\r\n  fetchpriority=\"auto\"\r\n  loading=\"lazy\"\r\n  alt=\"Grafana 监控图\"\r\n  id=\"h-rh-i-0\"\r\n\u003e\u003c/a\u003e\n\u003c/p\u003e","tags":["k8s","Java"],"title":"K8S Pod 容器内 Java 进程内存分析，内存虚高以及容器 OOM 或 Jave OOM 问题定位"},{"content":"为 VS Code Web 版 code-server 增加外部认证，并支持多用户，不同用户的 code-server 实例完全隔离。\n主要为了解决问题：\ncode-server 本身只支持配置文件形式的用户名密码认证（截止目前，以后也许会改进）。所以引入了外部认证系统，Google、GitHub、 okta、CAS、Keycloak 等理论上都是支持的。\ncode-server 默认没有数据隔离，所以又加了一层 auth proxy，为每个用户创建一个（或多个）code-server 实例，通过 proxy 代理到各自的实例，以实现用户间的数据隔离。\n使用开源 Auth Proxy，无需自己编码即可实现认证授权流程，比如 code flow with pkce 对大部分人来说读懂这个协议都很困难。\n此文档源码请参考：architecture-diagram 使用组件 keycloak Redhat 开源 IAM 系统，目前也是 CNCF 项目，提供用户、组织服务，提供标准 OIDC。\noauth2-proxy 认证代理，配合 keycloak 提供完整 OAuth2 Code Flow 认证流程。也可以试试 pomerium ，看样子也不错。\n架构图如下。\n核心逻辑 架构图简单解读，所有过程官方文档都有详细说明，都是配置，以官方配置为准。\nkeycloak 创建 client，使用 OIDC 协议，作为 oauth2-proxy 的 provider。\ningress(nginx) 使用 auth_request 指令拦截所有请求，从 oauth2-proxy 进行代理认证，配置可参考 oauth2-proxy auth_request 指导。\nnginx.ingress.kubernetes.io/auth-signin: https://$host/oauth2/start?rd=$escaped_request_uri nginx.ingress.kubernetes.io/auth-url: https://$host/oauth2/auth\r认证通过后，将用户名/ID 作为标识，通过 Http Header （举例如 X-Forwarded-Preferred-Username) 传入 upstream。\ngateway(nginx) 从 Header 中获取用户标识，代理到此用户对应的 code-server 实例。\nlocation / { …… proxy_pass http://code-server-$http_x_forwarded_for_preferred_username; }\rcode-server 各个实例部署时，以免认证方式部署。\n每个 code-server 实例挂载不同的存储，实现完全隔离。\n","date":"2022-09-07","id":32,"permalink":"/blog/code-server/","summary":"\u003cp\u003e为 VS Code Web 版 \u003ca href=\"https://github.com/coder/code-server\" target=\"_blank\" rel=\"noopener\"\u003ecode-server\u003c/a\u003e\n 增加外部认证，并支持多用户，不同用户的 code-server 实例完全隔离。\u003c/p\u003e\n\u003cp\u003e主要为了解决问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003ecode-server 本身只支持配置文件形式的用户名密码认证（截止目前，以后也许会改进）。所以引入了外部认证系统，Google、GitHub、 okta、CAS、Keycloak 等理论上都是支持的。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecode-server 默认没有数据隔离，所以又加了一层 auth proxy，为每个用户创建一个（或多个）code-server 实例，通过 proxy 代理到各自的实例，以实现用户间的数据隔离。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e使用开源 Auth Proxy，无需自己编码即可实现认证授权流程，比如 \u003ccode\u003ecode flow with pkce\u003c/code\u003e 对大部分人来说读懂这个协议都很困难。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e此文档源码请参考：\u003ca href=\"https://github.com/xlabs-club/architecture-diagram\" target=\"_blank\" rel=\"noopener\"\u003earchitecture-diagram\u003c/a\u003e\n\u003c/p\u003e\n\u003ch2 id=\"使用组件\"\u003e使用组件\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/keycloak/keycloak\" target=\"_blank\" rel=\"noopener\"\u003ekeycloak\u003c/a\u003e\n\u003c/p\u003e\n\u003cp\u003eRedhat 开源 IAM 系统，目前也是 CNCF 项目，提供用户、组织服务，提供标准 OIDC。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/oauth2-proxy/oauth2-proxy\" target=\"_blank\" rel=\"noopener\"\u003eoauth2-proxy\u003c/a\u003e\n\u003c/p\u003e\n\u003cp\u003e认证代理，配合 keycloak 提供完整 OAuth2 Code Flow 认证流程。也可以试试 \u003ca href=\"https://github.com/pomerium/pomerium\" target=\"_blank\" rel=\"noopener\"\u003epomerium\u003c/a\u003e\n，看样子也不错。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e架构图如下。\u003c/p\u003e\n\u003cp\u003e\r\n\r\n\u003cimg\r\n  src=\"/blog/code-server/code-server-auth-proxy_hu_9d21f682080840b4.webp\"\r\n  width=\"752\"\r\n  height=\"922\"\r\n  decoding=\"async\"\r\n  fetchpriority=\"auto\"\r\n  loading=\"lazy\"\r\n  alt=\"code-server-auth-proxy\"\r\n  id=\"h-rh-i-0\"\r\n\u003e\u003c/p\u003e\n\u003ch2 id=\"核心逻辑\"\u003e核心逻辑\u003c/h2\u003e\n\u003cp\u003e架构图简单解读，所有过程官方文档都有详细说明，都是配置，以官方配置为准。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003ekeycloak 创建 client，使用 OIDC 协议，作为 oauth2-proxy 的 provider。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eingress(nginx) 使用 auth_request 指令拦截所有请求，从 oauth2-proxy 进行代理认证，配置可参考 \u003ca href=\"https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview/#configuring-for-use-with-the-nginx-auth_request-directive\" target=\"_blank\" rel=\"noopener\"\u003eoauth2-proxy auth_request\u003c/a\u003e\n 指导。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003enginx.ingress.kubernetes.io/auth-signin\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ehttps://$host/oauth2/start?rd=$escaped_request_uri\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003enginx.ingress.kubernetes.io/auth-url\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ehttps://$host/oauth2/auth\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e认证通过后，将用户名/ID 作为标识，通过 Http Header （举例如 X-Forwarded-Preferred-Username) 传入 upstream。\u003c/p\u003e","tags":["devops"],"title":"使用 Visual Studio Code 搭建多用户远程 IDE"},{"content":"备考 CKA （Certified Kubernetes Administrator）过程，心得，遇见问题，CKA 真题。\n一句话总结：按照教程多练习，把控好时间就能通过，期望通过刷题通过考试的年代已经过去了，而且多练习对平时工作真的有用。\n备考环境 备考使用的系统和软件版本如下。\nUbuntu：20.04 Focal Fossa Kubernetes：1.20.7 kubeadm：1.20.7 安装和使用问题记录 kubeadm 安装问题 安装 kubeadm，国内安装使用阿里镜像源。\n$ cat /etc/apt/sources.list.d/kubernetes.list deb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main 踩坑：因为使用的是 ubuntu 20.04，代号 focal，专门去各个代理镜像源找kubernetes-focal都没有找到，后来发现 google 官方根本没发布对应的版本，只有kubernetes-xenial， k8s 官方文档里 ubuntu 也是用的这一个版本。可以用，就用他吧。\nkubeadm init 时指定使用阿里镜像源（解决国内连不上 k8s.gcr.io 的问题）、指定版本号（安装考试对应的版本，不一定是最新版本）。 通过指定--image-repository，不需要手动下载镜像重新打 tag，kubeadm 自动使用指定的 repository。\nkubeadm init --image-repository=registry.aliyuncs.com/google_containers \\ --pod-network-cidr=10.244.0.0/16 \\ --kubernetes-version=v1.20.7\r解决 scheduler Unhealthy，controller-manager Unhealthy 第一次安装完成后通过 kubectl get cs命令，发现 scheduler Unhealthy，controller-manager Unhealthy。\n$ kubectl get cs NAME STATUS MESSAGE scheduler Unhealthy Get \u0026#34;http://127.0.0.1:10251/healthz\u0026#34;: dial tcp 127.0.0.1:10 controller-manager Unhealthy Get \u0026#34;http://127.0.0.1:10252/healthz\u0026#34;: dial tcp 127.0.0.1:10 查看本机端口，10251 和 10252 都没有启动。\n确认 schedule 和 controller-manager 组件配置是否禁用了非安全端口。\n查看配置文件，路径分别为：/etc/kubernetes/manifests/kube-scheduler.yaml 和 /etc/kubernetes/manifests/kube-controller-manager.yaml 将两个配置文件中 --port=0 注释掉（注释掉是否合适待商量）。\nspec: containers: - command: - kube-scheduler - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf - --bind-address=127.0.0.1 # 注释掉 port，其他行原样不要动 - --port=0\r解决 master 无法调度 我的环境是单节点，既当 master 又当 worker，kubeadm 安装完成后默认 master 节点是不参与调度的，pod 会一直 pending。\nkubectl describe node 发现 node 的 Taints 里有 node-role.kubernetes.io/master:NoSchedule。\n设置 k8s master 节点参与 POD 调度。\nkubectl taint nodes your-node-name node-role.kubernetes.io/master-\r考试心得 刷新浏览器会导致考试被终止。\n提前演练敲一遍，时间其实挺紧张。\n官方kubectl Cheat Sheet章节非常有用，必考。\n命令自动补全 source \u0026lt;(kubectl completion bash)。\n尽量使用命令创建 Pod、deployment、service。\nkubectl run podname --image=imagename --restart=Never -n namespace kubectl run \u0026lt;deploymentname\u0026gt; --image=\u0026lt;imagename\u0026gt; -n \u0026lt;namespace\u0026gt; kubectl expose \u0026lt;deploymentname\u0026gt; --port=\u0026lt;portNo.\u0026gt; --name=\u0026lt;svcname\u0026gt; 使用 dry-run。\nkubectl run \u0026lt;podname\u0026gt; --image=\u0026lt;imagename\u0026gt; --restart=Never --dry-run -o yaml \u0026gt; title.yaml 使用 kubectl -h 查看各个命令的帮助，很多都在 Examples 里。比如 kubectl expose -h。\nCKA 真题练习 真题会过时，别指望着刷刷题就通过考试，老老实实学一遍。\n将所有 pv 按照 name/capacity 排序。\n# sort by name kubectl get pv --sort-by=.metadata.name # sort by capacity kubectl get pv --sort-by=.spec.capacity.storage deployment 扩容。\nkubectl scale deployment test --replicas=3 Set the node named ek8s-node-1 as unavaliable and reschedule all the pods running on it.\nkubectl cordon ek8s-node-1 # drain node 的时候可能出错，根据错误提示加参数 kubectl drain ek8s-node-1 --delete-local-data --ignore-daemonsets --force Form the pod label name-cpu-loader,find pods running high CPU workloads and write the name of the pod consuming most CPU to the file /opt/KUTR00401/KURT00401.txt(which alredy exists).\n# 注意题目中并没有提 namespace，可以先看下这个 label 的 pod 在哪个 namespace，确定命令中要不要加 namespace kubectl top pods -l name=name-cpu-loader --sort-by=cpu echo \u0026#39;排名第一的 pod 名称\u0026#39; \u0026gt;\u0026gt;/opt/KUTR00401/KUTR00401.txt ","date":"2022-02-26","id":33,"permalink":"/blog/kubernetes-cka/","summary":"\u003cp\u003e备考 CKA （Certified Kubernetes Administrator）过程，心得，遇见问题，CKA 真题。\u003c/p\u003e\n\u003cp\u003e一句话总结：按照教程多练习，把控好时间就能通过，期望通过刷题通过考试的年代已经过去了，而且多练习对平时工作真的有用。\u003c/p\u003e\n\u003ch2 id=\"备考环境\"\u003e备考环境\u003c/h2\u003e\n\u003cp\u003e备考使用的系统和软件版本如下。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUbuntu：20.04 Focal Fossa\u003c/li\u003e\n\u003cli\u003eKubernetes：1.20.7\u003c/li\u003e\n\u003cli\u003ekubeadm：1.20.7\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"安装和使用问题记录\"\u003e安装和使用问题记录\u003c/h2\u003e\n\u003ch3 id=\"kubeadm-安装问题\"\u003ekubeadm 安装问题\u003c/h3\u003e\n\u003cp\u003e安装 kubeadm，国内安装使用阿里镜像源。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"gp\"\u003e$\u003c/span\u003e cat /etc/apt/sources.list.d/kubernetes.list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003edeb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e踩坑：因为使用的是 ubuntu 20.04，代号 \u003ccode\u003efocal\u003c/code\u003e，专门去各个代理镜像源找\u003ccode\u003ekubernetes-focal\u003c/code\u003e都没有找到，后来发现 google 官方根本没发布对应的版本，只有\u003ccode\u003ekubernetes-xenial\u003c/code\u003e， k8s 官方文档里 ubuntu 也是用的这一个版本。可以用，就用他吧。\u003c/p\u003e\n\u003cp\u003ekubeadm init 时指定使用阿里镜像源（解决国内连不上 k8s.gcr.io 的问题）、指定版本号（安装考试对应的版本，不一定是最新版本）。\n通过指定\u003ccode\u003e--image-repository\u003c/code\u003e，不需要手动下载镜像重新打 tag，kubeadm 自动使用指定的 repository。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubeadm init --image-repository\u003cspan class=\"o\"\u003e=\u003c/span\u003eregistry.aliyuncs.com/google_containers \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --pod-network-cidr\u003cspan class=\"o\"\u003e=\u003c/span\u003e10.244.0.0/16 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --kubernetes-version\u003cspan class=\"o\"\u003e=\u003c/span\u003ev1.20.7\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003ch3 id=\"解决-scheduler-unhealthycontroller-manager-unhealthy\"\u003e解决 scheduler Unhealthy，controller-manager Unhealthy\u003c/h3\u003e\n\u003cp\u003e第一次安装完成后通过 \u003ccode\u003ekubectl get cs\u003c/code\u003e命令，发现 scheduler Unhealthy，controller-manager Unhealthy。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"gp\"\u003e$\u003c/span\u003e kubectl get cs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003eNAME                 STATUS      MESSAGE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003escheduler            Unhealthy   Get \u0026#34;http://127.0.0.1:10251/healthz\u0026#34;: dial tcp 127.0.0.1:10\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003econtroller-manager   Unhealthy   Get \u0026#34;http://127.0.0.1:10252/healthz\u0026#34;: dial tcp 127.0.0.1:10\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e查看本机端口，10251 和 10252 都没有启动。\u003c/p\u003e","tags":[],"title":"备考 CKA 过程，CKA 真题分享"},{"content":"日常开发速查手册，程序员的瑞士军刀，常用优秀命令行工具和编程语句汇总。\n","date":"2023-09-07","id":34,"permalink":"/docs/tldr/","summary":"日常开发速查手册，程序员的瑞士军刀，常用优秀命令行工具","tags":[],"title":"TL;DR"},{"content":"Install KEDA ","date":"2024-06-26","id":35,"permalink":"/docs/cloud/k8s-hpa-with-keda/","summary":"\u003ch2 id=\"install-keda\"\u003eInstall KEDA\u003c/h2\u003e","tags":[],"title":"基于 KEDA 实现高效扩缩容"},{"content":"Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标，主要内容：\nMicrometer 介绍。 业务如何自定义指标，如何接入 Prometheus，实现方式和规范。 Micrometer 介绍 Micrometer 为 Java 平台上的性能数据收集提供了一个通用的 API，应用程序只需要使用 Micrometer 的通用 API 来收集性能指标，Micrometer 会负责完成与不同监控系统的适配工作。\nMicrometer 提供了多种度量指标类型（Timers、Guauges、Counters 等），同时支持接入不同的监控系统，例如 Influxdb、Graphite、Prometheus、OTLP 等。\n从 Spring Boot 2.x 开始使用 Micrometer 作为默认的监控门面接口， Think SLF4J, but for observability 。\nMicrometer 核心概念 Micrometer 中两个最核心的概念：计量器注册表 (MeterRegistry)，计量器 (Meter)。\nMeterRegistry\n内存注册表 (SimpleMeterRegistry): 在内存中保存每一个 Meter（指标）的最新值，并且不会将数据导出到任何地方。 组合注册表 (CompositeMeterRegistry): 可以添加多个注册表，用于将各个注册表组合起来，可以同时将指标发布到多个监控系统。Micrometer 提供了一个全局的 MeterRegistry，io.micrometer.core.instrument.Metrics 中持有一个静态 final 的 CompositeMeterRegistry 实例 globalRegistry。 普罗米修斯注册表 (PrometheusMeterRegistry): 当使用普罗米修斯监控时，引入 micrometer-registry-prometheus 依赖时会提供此种收集器，用于将指标数据转换为普罗米修斯识别的格式和导出数据等功能。 Meter（指标）\n监控数据的整个过程都是围绕着 Meter（指标）, 通过一个一个的 Meter（指标）数据来进行观察应用的状态。常用的指标如：\nCounter（计数器）: 单一计数指标，允许按固定数量递增，用来统计无上限数据。只允许递增。 Gauge（仪表盘）: 表示单个的变化的值，例如温度，气压。用于统计有上限可增可减的数据。在每次取样时，Gauge 会返回当前值。 Timer（计时器）: 通常用来记录事件的持续时间。Timer 会记录两类的数据，事件的数量和总的持续时间。 Tag（标签）\nMircrometer 通过 Tag（标签）实现了多维度的度量数据收集，通过 Tag 的命名可以推断出其指向的数据代表什么维度或是什么类型的度量指标。\n我们的实现方式和要求 总体架构：Spring Boot Actuator + Micrometer + Prometheus + Granfana。\nSpring Boot Micrometer：提供监控门面 Api。 Spring Boot Actuator：提供监控指标采集服务，通过 /actuator/prometheus 获取数据。 Prometheus + Granfana：采集和存储数据，提供图表展示，另外 Granfana 可根据指标配置告警规则发出告警。 总体实现步骤如下：\nSpring Boot Actuator 放开 prometheus http 访问，在配置文件中增加以下配置。\nmanagement.endpoint.prometheus.enabled=true management.endpoints.web.exposure.include=info,health,metrics,prometheus management.metrics.export.prometheus.enabled=true\r创建 Prometheus ServiceMonitor 或 PodMonitor，从 /actuator/prometheus path 采集指标，如果涉及多个 war 合并部署到一个 tomcat 的，从多个 path 采集。\napiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: labels: app.kubernetes.io/component: metrics release: your-prometheus-instance-name name: eye-consumer namespace: test spec: endpoints: - interval: 30s honorLabels: true # /client-biz 是我的服务 ContextPath path: /client-biz/actuator/prometheus port: metrics - interval: 30s honorLabels: true path: /gateway-biz/actuator/prometheus port: metrics jobLabel: eye-consumer selector: matchLabels: app: eye-consumer\r业务可通过 http://localhost:8080/actuator/metrics 查看指标是否已上报，通过 http://localhost:8080/actuator/prometheus 查看指标的当前值。\n自定义 Metrics 指标 在 Spring Boot 中实现自定义指标非常简单，几种方式举例如下。\n像使用 slf4j 一样，使用 io.micrometer.core.instrument.Metrics 静态方式初始化一个指标，然后使用此指标直接操作。 使用 @Timed @Counted 注解。注意注解方式必须等方法调用后才能生成指标。而静态方法形式 io.micrometer.core.instrument.Metrics.counter立即就生成指标只是值为 0。另外注意 Spring 注解不支持 private、default 级别方法。 使用 Autowired MeterRegistry 创建自己的指标类型，适合一些动态 Tag 等高级定制场景。 import io.micrometer.core.annotation.Counted; import io.micrometer.core.instrument.Counter; import io.micrometer.core.instrument.Metrics; import org.springframework.stereotype.Service; @Service public class MicrometerSampleService { /** * 方式 1：像使用 slf4j 一样，使用 `io.micrometer.core.instrument.Metrics`静态方式初始化一个计数器，适用于名字和 Tag 固定的场景 */ private static final Counter failure = Metrics.counter(\u0026#34;fs.sms.send\u0026#34;, \u0026#34;result\u0026#34;, \u0026#34;failure\u0026#34;); @Autowired private MeterRegistry registry; private void sendSms() { try { // do something } catch (Exception e) { failure.increment(); } } /** * 方式 2：使用注解的方式，注意需要引入 spring-boot-starter-aop 依赖 */ @Counted(value = \u0026#34;fs.sms.send\u0026#34;, extraTags = {\u0026#34;provider\u0026#34;, \u0026#34;huawei\u0026#34;}) public void sendByHuawei() { this.sendSms(); } @Counted(value = \u0026#34;fs.sms.send\u0026#34;, extraTags = {\u0026#34;provider\u0026#34;, \u0026#34;ali\u0026#34;}) public void sendByAli() { this.sendSms(); } /** * 方式 3：使用 MeterRegistry，适合一些动态 Tag 等高级定制场景 * * @param result result */ public void countByResult(String result) { registry.counter(\u0026#34;fs.sms.send\u0026#34;, \u0026#34;result\u0026#34;, result).increment(); // or Counter.builder(\u0026#34;fs.sms.send\u0026#34;) .description(\u0026#34;send sms\u0026#34;) .tags(\u0026#34;result\u0026#34;, result) .register(registry) .increment(); } }\rSpring Boot 无法直接使用 @Timed @Counted 注解，需要引入切面支持，需要引入 spring-boot-starter-aop 依赖。\n@Configuration public class MicrometerAspectConfiguration { @Bean public CountedAspect countedAspect(MeterRegistry registry) { return new CountedAspect(registry); } @Bean public TimedAspect timedAspect(MeterRegistry registry) { return new TimedAspect(registry); } }\r另外这里大家可能有个疑惑，我的请求量很大，Metrics.counter 对象是不是每次都 new 出来的，要不要缓存起来，减少获取 counter 对象的压力。\n其实不用，MeterRegistry 已经做了缓存，参考 io.micrometer.core.instrument.MeterRegistry#registerMeterIfNecessary 以下代码片段。\nprivate \u0026lt;M extends Meter\u0026gt; M registerMeterIfNecessary(Class\u0026lt;M\u0026gt; meterClass, Meter.Id id, @Nullable DistributionStatisticConfig config, BiFunction\u0026lt;Meter.Id, DistributionStatisticConfig, M\u0026gt; builder, Function\u0026lt;Meter.Id, M\u0026gt; noopBuilder) { Meter.Id mappedId = this.getMappedId(id); Meter m = this.getOrCreateMeter(config, builder, id, mappedId, noopBuilder); if (!meterClass.isInstance(m)) { throw new IllegalArgumentException(String.format(\u0026#34;There is already a registered meter of a different type (%s vs. %s) with the same name: %s\u0026#34;, m.getClass().getSimpleName(), meterClass.getSimpleName(), id.getName())); } else { return (Meter)meterClass.cast(m); } }\r自定义指标高级配置 Spring 默认注入的 MeterRegistry 是一个 CompositeMeterRegistry，如果想定制可注入自定义 MeterRegistryCustomizer Bean。\n@Configuration public class MicrometerConfiguration { @Bean MeterRegistryCustomizer\u0026lt;MeterRegistry\u0026gt; configurer() { return (registry) -\u0026gt; registry.config() .commonTags(\u0026#34;group\u0026#34;, \u0026#34;sample\u0026#34;) .commonTags(\u0026#34;application\u0026#34;, \u0026#34;sample\u0026#34;); } }\r如果只是想为当前应用增加 Tag，可直接通过配置文件增加，示例如下。\nmanagement.metrics.tags.biz=sample management.metrics.tags.application=${spring.application.name}\r自定义指标规范 指标和 Tag 命名约定使用英语句号分隔，全小写，Tag 可根据实际情况使用缩写。指标名在不同的 MeterRegistry 里会自动转换，比如在 Prometheus 会把 fs.sms.send 转换为 fs_sms_send。\n指标命名建议以 fs.application.action 为模板，避免与开源或其他项目组冲突。\n注意 Tag values 不能为 Null， 且必须是可枚举的某些固定类型便于统计。\n使用注解 @Timed @Counted 会默认增加 method、class、result、exception 这几个 Tag，注意不要与之冲突。\n在 K8S 集群内，公司和开源默认 Tag 如下，这些会被 ServiceMonitor 强制覆盖，业务不要自己定义。\nnamespace、application、service、container、pod、instance、job、endpoint、id 编码中如果需要 MeterRegistry，不允许引用具体实现（比如 Prometheus 的 io.prometheus.client.CollectorRegistry），而是使用 Micrometer 提供的统一接口 MeterRegistry。类比，在打印日志时不允许直接使用 logback 或 log4j api，而是使用 slf4j api.\n不要自己 new MeterRegistry，而是使用自动注入的或静态方法。\n建议为指标加上 description 字段。\n最佳实践 合理规划 Tag，一个 Meter 具体类型需要通过名字和 Tag 作为它的唯一标识，这样做的好处是可以使用名字进行标记，通过不同的 Tag 去区分多种维度进行数据统计。\n反例 1（全部用 name 区分，无 Tag，重复计量，无法多维度分析汇聚）： Metrics.counter(\u0026#34;fs.sms.all\u0026#34;); Metrics.counter(\u0026#34;fs.sms.aliyun\u0026#34;); Metrics.counter(\u0026#34;fs.sms.huaweiyun\u0026#34;); 正例： Metrics.counter(\u0026#34;fs.sms.send\u0026#34;,\u0026#34;provider\u0026#34;,\u0026#34;ali\u0026#34;); Metrics.counter(\u0026#34;fs.sms.send\u0026#34;,\u0026#34;provider\u0026#34;,\u0026#34;huawei\u0026#34;,\u0026#34;result\u0026#34;,\u0026#34;success\u0026#34;); 避免无意义不可枚举的 Tag，混乱的 Tag 比无 Tag 更难管理。\n","date":"2023-08-07","id":36,"permalink":"/blog/spring-boot-micrometer/","summary":"\u003cp\u003eSpring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标，主要内容：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eMicrometer 介绍。\u003c/li\u003e\n\u003cli\u003e业务如何自定义指标，如何接入 Prometheus，实现方式和规范。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"micrometer-介绍\"\u003eMicrometer 介绍\u003c/h2\u003e\n\u003cp\u003eMicrometer 为 Java 平台上的性能数据收集提供了一个通用的 API，应用程序只需要使用 Micrometer 的通用 API 来收集性能指标，Micrometer 会负责完成与不同监控系统的适配工作。\u003c/p\u003e\n\u003cp\u003eMicrometer 提供了多种度量指标类型（Timers、Guauges、Counters 等），同时支持接入不同的监控系统，例如 Influxdb、Graphite、Prometheus、OTLP 等。\u003c/p\u003e\n\u003cp\u003e从 Spring Boot 2.x 开始使用 Micrometer 作为默认的监控门面接口， \u003ccode\u003eThink SLF4J, but for observability\u003c/code\u003e 。\u003c/p\u003e\n\u003ch3 id=\"micrometer-核心概念\"\u003eMicrometer 核心概念\u003c/h3\u003e\n\u003cp\u003eMicrometer 中两个最核心的概念：计量器注册表 (MeterRegistry)，计量器 (Meter)。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eMeterRegistry\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e内存注册表 (SimpleMeterRegistry): 在内存中保存每一个 Meter（指标）的最新值，并且不会将数据导出到任何地方。\u003c/li\u003e\n\u003cli\u003e组合注册表 (CompositeMeterRegistry): 可以添加多个注册表，用于将各个注册表组合起来，可以同时将指标发布到多个监控系统。Micrometer 提供了一个全局的 MeterRegistry，\u003ccode\u003eio.micrometer.core.instrument.Metrics\u003c/code\u003e 中持有一个静态 final 的 CompositeMeterRegistry 实例 globalRegistry。\u003c/li\u003e\n\u003cli\u003e普罗米修斯注册表 (PrometheusMeterRegistry): 当使用普罗米修斯监控时，引入 micrometer-registry-prometheus 依赖时会提供此种收集器，用于将指标数据转换为普罗米修斯识别的格式和导出数据等功能。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMeter（指标）\u003c/p\u003e\n\u003cp\u003e监控数据的整个过程都是围绕着 Meter（指标）, 通过一个一个的 Meter（指标）数据来进行观察应用的状态。常用的指标如：\u003c/p\u003e","tags":["Spring Boot","Java"],"title":"Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标"},{"content":"程序员的瑞士军刀，常用优秀命令行工具，上榜都是有理由的。\nprocs 比 ps 好用的工具，查看路径和端口一步到位，支持过滤。\nripgrep ripgrep 简称 rg，是一个面向行的搜索工具，Rust 编写，全平台支持，也是 VS Code 的默认搜索工具。它的搜索性能极高，在大项目中也有着出色的表现，并且默认可以忽略 .gitignore 文件中的内容，非常实用。\n除了作为一个高效的命令行工具使用外，整个项目的设计也不错，另外还是一个学习 Rust 的好项目。\nrg -h 开启探索之旅吧。\nTL;DR Too Long; Didn’t Read.\ntldr 根据二八原则，简化了烦琐的 man 指令帮助文档，仅列出常用的该指令的使用方法，让人一看就懂，大多数情况下，给出几个指令的使用 demo 可能正是我们想要的。\n举个例子看下实际运行效果，如下（太长，节选）。\n➜ ~ tldr docker List all docker containers (running and stopped): docker ps -a Start a container from an image, with a custom name: docker run --name container_name image Start or stop an existing container: docker start|stop container_name tldr 命令行有多种实现，比如官方推荐的有 npm 和 python。\n个人更喜欢 Rust 版本的实现 tealdeer ，支持各系统包管理器和二进制安装，比如 homebrew。\nbrew install tealdeer\rfd fd ，find 的替代品。\nbottom bottom ，类似 Top 的酷炫系统监控工具，Inspired by gtop, gotop, and htop。\nbat bat ，一只带翅膀的 cat，代替 cat 命令。\n","date":"2024-03-09","id":37,"permalink":"/docs/tldr/knife/","summary":"\u003cp\u003e程序员的瑞士军刀，常用优秀命令行工具，上榜都是有理由的。\u003c/p\u003e\n\u003ch2 id=\"procs\"\u003eprocs\u003c/h2\u003e\n\u003cp\u003e比 ps 好用的工具，查看路径和端口一步到位，支持过滤。\u003c/p\u003e\n\u003ch2 id=\"ripgrep\"\u003eripgrep\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/BurntSushi/ripgrep\" target=\"_blank\" rel=\"noopener\"\u003eripgrep\u003c/a\u003e\n 简称 rg，是一个面向行的搜索工具，Rust 编写，全平台支持，也是 VS Code 的默认搜索工具。它的搜索性能极高，在大项目中也有着出色的表现，并且默认可以忽略 .gitignore 文件中的内容，非常实用。\u003c/p\u003e\n\u003cp\u003e除了作为一个高效的命令行工具使用外，整个项目的设计也不错，另外还是一个学习 Rust 的好项目。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003erg -h\u003c/code\u003e 开启探索之旅吧。\u003c/p\u003e\n\u003ch2 id=\"tldr\"\u003eTL;DR\u003c/h2\u003e\n\u003cp\u003eToo Long; Didn’t Read.\u003c/p\u003e\n\u003cp\u003etldr 根据二八原则，简化了烦琐的 man 指令帮助文档，仅列出常用的该指令的使用方法，让人一看就懂，大多数情况下，给出几个指令的使用 demo 可能正是我们想要的。\u003c/p\u003e\n\u003cp\u003e举个例子看下实际运行效果，如下（太长，节选）。\u003c/p\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e➜  ~ tldr docker\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e  List all docker containers (running and stopped):\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e      docker ps -a\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e  Start a container from an image, with a custom name:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e      docker run --name container_name image\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e  Start or stop an existing container:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"go\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e\u003c/span\u003e\u003cspan class=\"go\"\u003e      docker start|stop container_name\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cp\u003e\u003ca href=\"https://github.com/tldr-pages/tldr\" target=\"_blank\" rel=\"noopener\"\u003etldr\u003c/a\u003e\n 命令行有多种实现，比如官方推荐的有 npm 和 python。\u003c/p\u003e","tags":[],"title":"Knife"},{"content":"Linux Shell 日常编程实用句式速查，注意以下例子如无特殊说明都是 bash 语法。\n选择执行环境。 #!/usr/bin/env bash #!/usr/bin/bash\r指定变量默认值，取环境变量，取不到用默认值。 rep=${ENV_YOUR_KEY:-\u0026#34;my-default-value\u0026#34;}\r获取当前执行脚本的绝对路径，注意直接用 $0 或 pwd 获取的可能都不要你想要的。 current_dir=$(cd `dirname $0`;pwd)\r为当前目录包含子目录下所有 .sh 文件增加可执行权限。 chmod +x `find . -name \u0026#39;*.sh\u0026#39;`\r通过 tee 将提示信息显示到终端，并同时写入到文件。 log_file=/var/log/test.log echo \u0026#34;This line will echo to console and also write to log file.\u0026#34; | tee -a ${log_file}\r类似于 Java properties 中 key=value 形式的字符串，取 key 和 value 的值。 username_line=\u0026#34;username=test\u0026#34; #key is username key=${username_line%=*} #val is test val=${username_line#*=}\r实现 String trim 效果。 #trim string by echo val_trim=$(echo -n ${val})\r声明和循环数组。 apps=(foo bar) for app in ${apps[@]} do echo \u0026#34;$app\u0026#34; done\r文件 ls 转数组 # ls 转数组，根据需要 grep arrs=($(ls helmfiles/apps | grep -v .yaml))\r指定数组分割符，字符串转数组。 # 获取当前 helm list 命令输出结果，通过换行分割成数组 IFS=$\u0026#39;\\n\u0026#39; helm_list=($(helm list --no-headers)) for hm in ${helm_list[@]} do # 对每一行进行解析按 Tab 再分割成数组 IFS=$\u0026#39;\\t\u0026#39; hma=($hm) echo \u0026#34;helm upgrade --install ${hma[0]} ${hma[0]} --version ${hma[6]} --reset-values 2\u0026gt;\u0026amp;1\u0026#34; done\r文件按内容排序。 log=my-log-file # 原地排序覆盖原文件 sort -o ${log} ${log}\r判断字符串是否以某串开头，并去除指定前缀。 img=docker.io/nginx:1.20 repo=docker.io # if 判断字符串是否以 repo 开头 if [[ $img == $repo* ]]; then # 注意这里 +2 suffix=$(echo $img | cut -c$((${#repo}+2))-) # 输出 nginx:1.20 echo \u0026#34;$suffix\u0026#34; fi\r按多个关键词 或 过滤。 echo \u0026#34;nginx\u0026#34; | grep -E \u0026#34;nginx|tomcat\u0026#34; echo \u0026#34;tomcat\u0026#34; | grep -E \u0026#34;nginx|tomcat\u0026#34; echo \u0026#34;envoy\u0026#34; | grep -E \u0026#34;nginx|tomcat\u0026#34;\r获取当前时间，加减时区。 ct=$(TZ=UTC+8 date \u0026#34;+%Y%m%d%H%M\u0026#34;)\r检查是否以 root 用户执行。 # check if run as root user if [[ `id -u` -ne 0 ]]; then echo \u0026#34;You need root privileges to run this script.\u0026#34; fi\r","date":"2024-03-09","id":38,"permalink":"/docs/tldr/shell-coding/","summary":"\u003cp\u003eLinux Shell 日常编程实用句式速查，注意以下例子如无特殊说明都是 bash 语法。\u003c/p\u003e\n\u003chr\u003e\n\u003cul\u003e\n\u003cli\u003e选择执行环境。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/usr/bin/env bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/usr/bin/bash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e指定变量默认值，取环境变量，取不到用默认值。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erep\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eENV_YOUR_KEY\u003c/span\u003e\u003cspan class=\"k\"\u003e:-\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;my-default-value\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e获取当前执行脚本的绝对路径，注意直接用 $0 或 pwd 获取的可能都不要你想要的。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ecurrent_dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003edirname \u003cspan class=\"nv\"\u003e$0\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"nb\"\u003epwd\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e为当前目录包含子目录下所有 .sh 文件增加可执行权限。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod +x \u003cspan class=\"sb\"\u003e`\u003c/span\u003efind . -name \u003cspan class=\"s1\"\u003e\u0026#39;*.sh\u0026#39;\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e通过 tee 将提示信息显示到终端，并同时写入到文件。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elog_file\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/log/test.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;This line will echo to console and also write to log file.\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e tee -a \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003elog_file\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e类似于 Java properties 中 key=value 形式的字符串，取 key 和 value 的值。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eusername_line\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;username=test\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#key is username\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eusername_line\u003c/span\u003e\u003cspan class=\"p\"\u003e%=*\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#val is test\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eval\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eusername_line\u003c/span\u003e\u003cspan class=\"p\"\u003e#*=\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e实现 String trim 效果。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#trim string by echo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eval_trim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e -n \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eval\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e声明和循环数组。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eapps\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003efoo bar\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e app in \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eapps\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$app\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e文件 ls 转数组\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ls 转数组，根据需要 grep\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003earrs\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003els helmfiles/apps \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -v .yaml\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e指定数组分割符，字符串转数组。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 获取当前 helm list 命令输出结果，通过换行分割成数组\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eIFS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e$\u0026#39;\\n\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ehelm_list\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ehelm list --no-headers\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e hm in \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ehelm_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 对每一行进行解析按 Tab 再分割成数组\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eIFS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e$\u0026#39;\\t\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ehma\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hm\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;helm upgrade --install \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ehma\u003c/span\u003e\u003cspan class=\"p\"\u003e[0]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ehma\u003c/span\u003e\u003cspan class=\"p\"\u003e[0]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e --version \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ehma\u003c/span\u003e\u003cspan class=\"p\"\u003e[6]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e --reset-values 2\u0026gt;\u0026amp;1\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e文件按内容排序。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emy-log-file\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 原地排序覆盖原文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esort -o \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003elog\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003elog\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e判断字符串是否以某串开头，并去除指定前缀。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eimg\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003edocker.io/nginx:1.20\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erepo\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003edocker.io\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if 判断字符串是否以 repo 开头\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[[\u003c/span\u003e \u003cspan class=\"nv\"\u003e$img\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nv\"\u003e$repo\u003c/span\u003e* \u003cspan class=\"o\"\u003e]]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# 注意这里 +2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003esuffix\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$img\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e cut -c\u003cspan class=\"k\"\u003e$((\u003c/span\u003e\u003cspan class=\"si\"\u003e${#\u003c/span\u003e\u003cspan class=\"nv\"\u003erepo\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e-\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# 输出  nginx:1.20\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$suffix\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e按多个关键词 \u003ccode\u003e或\u003c/code\u003e 过滤。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;nginx\u0026#34;\u003c/span\u003e  \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -E \u003cspan class=\"s2\"\u003e\u0026#34;nginx|tomcat\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tomcat\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -E \u003cspan class=\"s2\"\u003e\u0026#34;nginx|tomcat\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;envoy\u0026#34;\u003c/span\u003e  \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -E \u003cspan class=\"s2\"\u003e\u0026#34;nginx|tomcat\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e获取当前时间，加减时区。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ect\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nv\"\u003eTZ\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eUTC+8 date \u003cspan class=\"s2\"\u003e\u0026#34;+%Y%m%d%H%M\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e\r\n\u003cul\u003e\n\u003cli\u003e检查是否以 root 用户执行。\u003c/li\u003e\n\u003c/ul\u003e\n\r\n\r\n\r\n\u003cdiv class=\"expressive-code\"\u003e\r\n  \u003cfigure class=\"frame is-terminal not-content\"\u003e\r\n  \u003cfigcaption class=\"header\"\u003e\r\n    \u003cspan class=\"title\"\u003e\u003c/span\u003e\r\n  \u003c/figcaption\u003e\r\n  \u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# check if run as root user\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[[\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003eid -u\u003cspan class=\"sb\"\u003e`\u003c/span\u003e -ne \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e]]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;You need root privileges to run this script.\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\r\n  \u003c/figure\u003e\r\n\u003c/div\u003e","tags":[],"title":"Shell Coding"},{"content":"使用 backstage 创建开发者门户。\nBackstage 插件资源 Backstage 官方插件：https://backstage.io/plugins Backstage 社区插件：https://github.com/backstage/community-plugins Red Hat 贡献的社区插件：https://github.com/janus-idp/backstage-plugins Roadie 贡献的插件：https://github.com/RoadieHQ/roadie-backstage-plugins ","date":"2024-01-27","id":39,"permalink":"/docs/platform/backstage/","summary":"\u003cp\u003e使用 backstage 创建开发者门户。\u003c/p\u003e\n\u003ch2 id=\"backstage-插件资源\"\u003eBackstage 插件资源\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eBackstage 官方插件：\u003ca href=\"https://backstage.io/plugins\" target=\"_blank\" rel=\"noopener\"\u003ehttps://backstage.io/plugins\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eBackstage 社区插件：\u003ca href=\"https://github.com/backstage/community-plugins\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/backstage/community-plugins\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eRed Hat 贡献的社区插件：\u003ca href=\"https://github.com/janus-idp/backstage-plugins\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/janus-idp/backstage-plugins\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://roadie.io/\" target=\"_blank\" rel=\"noopener\"\u003eRoadie\u003c/a\u003e\n 贡献的插件：\u003ca href=\"https://github.com/RoadieHQ/roadie-backstage-plugins\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/RoadieHQ/roadie-backstage-plugins\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e","tags":[],"title":"开发者门户"},{"content":"作为一个以 Java 和 Spring 为主要技术栈的团队，在日常的软件开发中，我们经常会遇到一系列的组件升级和代码重构需求，在此过程我们期望能做到几个效果：\n项目级升级：整个项目（注此项目指 Maven Project）升级，而不是基于某个 Java 类或片段。 不同版本跨度变更：比如从 Spring 项目迁移到 Spring Boot，从 Spring Boot 2.x 升级到 3.x，从 Java 8 升级到 Java 21。 代码安全可靠：变更的代码一定是正确的，至少是逻辑正确的，至少不能像某 AI 助手一样设置一些根本不存在的属性。 经验产品化：最佳实践就是产品，比如我并不（想）了解 Spring Boot 3.2 具体有哪些变更，但希望能一键从 3.0 自动升级到 3.2，直接告诉有哪些变更。 自定义重构：对于某些自研代码，希望能自定义重构逻辑，一键自动重构。 基于以上背景，我们探索了 OpenRewrite 、Spring Boot Migrator 、Redhat Windup 、emt4j 和一众不便具名的 AI 代码助手，本文将分享我们使用 OpenRewrite、Spring Boot Migrator 进行代码重构和升级的一些使用经验和体验。\nOpenRewrite OpenRewrite 是一个开源的代码重写工具，旨在帮助开发人员自动化大规模重构代码。\n它提供了一套强大的 API 和插件系统，可以通过静态分析和代码转换技术来解析、修改和生成代码。OpenRewrite 支持多种编程语言，包括 Java、C#、 TypeScript、Python、Kubernetes 等。通过使用 OpenRewrite，开发人员可以轻松地进行代码重构、性能优化、代码风格调整和代码迁移等操作，从而提高代码质量和可维护性。OpenRewrite 的开源性质使得开发人员可以自由地定制和扩展其功能，以满足特定项目的需求。\n比如 Java 领域一些热门的应用场景：\nJava 版本升级：从 Java 8 到 Java 21，从 Java EE 到 Jakarta EE 。 Spring 框架迁移：从 Spring 5 到 Spring 6，从 Spring Boot 2 到 Spring Boot 3。 测试框架迁移： 从 Junit 4 到 Junit 5。 依赖管理：自动更新 Java 项目的 Maven 或 Gradle 依赖，确保使用最新和最安全的库版本。 代码清理和格式化：自动清理和格式化 Java 代码，确保符合项目或组织的编码标准和风格指南。 修复安全漏洞：自动识别和修复 Java 代码中的已知安全漏洞，如使用了有安全问题的库或方法。 代码异味检测和修复：识别并自动重构 Java 代码中的“代码异味”，以提高代码可维护性。 相比于时下火热的 AI 代码工具，比如 GitHub Copilot、Amazon CodeWhisperer，我认为 OpenRewrite 的优势主要有以下几点：\n可以直接处理大型项目，截止我写此文的今天还没一个成熟的 AI 助手能将整个项目一次性迁移或重构。 准确度较高，它通过预定义的规则来实现代码的精确修改，目前很多 AI 代码助手还在一本正经的瞎扯，尤其是凭空创造让人防不胜防。 可自定义扩展，对于自研代码不可能经过自动学习达到精确的效果，此时可自定义实现。 免费，可离线使用，便于 CI 集成。 值得一提的是，AWS 最近推出了 Amazon Q Code Transformation 专门做代码迁移和重构，需要开通 Amazon CodeWhisperer 企业版才能使用，可惜我没有钱去试用。\n快速入门 OpenRewrite 一个最核心的概念是 Recipe，由于我是国内首个翻译这个单词的人，以下将直译为食谱。一个 Recipe 可以理解为是一套声明好的规则，OpenRewrite 按照固定规则进行重构。\n一个 Recipe 可以包含多个 Recipe，可以层级累加，比如 UpgradeSpringBoot_3_2可能包含对 pom.xml、application.properties、java main source、java test source 的升级改动。\n初次使用 OpenRewrite，可通过官方提供的 热门指导 找到自己感兴趣的按步骤操作。\n另外就是食谱很多，一个一个用很麻烦，可优先考虑 best practices 系列，里面聚合了多个食谱。\n更多功能可通过 食谱分类 搜索，也可通过官网右上方的搜索按钮按照关键字搜索，也可通过 mvn rewrite:discover 列出可用的食谱。\n运行方式 友情提示：运行前请把代码交给 Git 管理，并 checkout 一个全新的分支，便于比对自动修改了哪些代码。\nOpenRewrite 支持使用 maven、gradle 以及使用 SaaS 服务 Moderne cli mod 这三种方法。\n使用 maven、gradle 文件定制比较方便，dependency 管理也比较灵活，另外某些食谱只有 maven、gradle 支持，缺点则是需要修改 pom、gradle 文件。\n使用 maven 命令行直接执行插件任务并指定属性，不用改 pom.xml 更方便，缺点是不方便管理 dependencies。\nmvn -U org.openrewrite.maven:rewrite-maven-plugin:run -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:RELEASE -Drewrite.activeRecipes=org.openrewrite.java.migrate.jakarta.JakartaEE10 -Drewrite.exportDatatables=true\r使用 SaaS 服务提供的 Moderne CLI 最方便，比如 mod run . --recipe JakartaEE10, 需要注册 license。\n最佳实践和定制 OpenRewrite 对不同类型分别内置了一些最佳实践，可通过 best practices 关键字搜索。\n最佳实践包含了哪些规则呢，以 Spring Boot 3.x best practices 为例，在文档中能看到对应的食谱列表如下：\n--- type: specs.openrewrite.org/v1beta/recipe name: org.openrewrite.java.spring.boot3.SpringBoot3BestPractices displayName: Spring Boot 3.x best practices description: Applies best practices to Spring Boot 3 applications. tags: - spring - boot recipeList: - org.openrewrite.java.spring.boot2.SpringBoot2BestPractices - org.openrewrite.java.migrate.UpgradeToJava21 - org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2\r而其中每个食谱又可能包含多个，比如上面的 org.openrewrite.java.spring.boot2.SpringBoot2BestPractices 又包含以下列表：\n--- type: specs.openrewrite.org/v1beta/recipe name: org.openrewrite.java.spring.boot2.SpringBoot2BestPractices displayName: Spring Boot 2.x best practices description: Applies best practices to Spring Boot 2 applications. tags: - spring - boot recipeList: - org.openrewrite.java.spring.NoRequestMappingAnnotation - org.openrewrite.java.spring.ImplicitWebAnnotationNames - org.openrewrite.java.spring.boot2.UnnecessarySpringExtension - org.openrewrite.java.spring.NoAutowiredOnConstructor - org.openrewrite.java.spring.boot2.RestTemplateBuilderRequestFactory - org.openrewrite.java.spring.boot2.ReplaceDeprecatedEnvironmentTestUtils\r如果官方的某个食谱不和你的胃口，比如想在最佳实践中去掉或新增某个自定义食谱怎么办，可以自己定义一个 rewrite.yml 文件，类似上面的 yaml 文件，在文件中自行组合食谱。注意 rewrite.yml 文件要放到 maven 项目的根目录下，更多关于文件的说明参考 Refactoring with declarative YAML recipes 。\nCI 集成 通过 mvn rewrite:run 命令执行后，会直接修改代码。但是大部分 CI 场景下，我们可能只想做分析，不想真正改动代码。那么就可以把命令换成 mvn rewrite:dryRun，dryRun 会在控制台输出 warning 结果，并生成一个 rewrite.patch 文件。\n如果 dryRun 向控制台日志发出任何警告，或者生成了 rewrite.patch 文件，证明此次有需要变更的地方，则可视为 CI 失败。\nSpring Boot Migrator OpenRewrite 功能很强悍，但是仍缺失一项功能：将传统 Spring 项目一键迁移到 Spring Boot。\nSpring Boot Migrator 基于 OpenRewrite，是一个专门用于协助将传统的 Spring 应用迁移到基于 Spring Boot 的工具，同时也提供 Spring Boot 的升级。\nSpring Boot Migrator 程序运行起来后，通过 list 命令可以看到提供的 OpenRewrite recipes，其中主要关注的有：\ninitialize-spring-boot-migration: 将项目初始化为 Spring Boot 应用。 migrate-spring-xml-to-java-config：将 Spring xml 转换为 Java 注解。 spring-context-xml-import：使用 Import xml 文件的形式初始化 Bean。 boot-2.7-3.0-dependency-version-update：Spring Boot 2 升级到 Spring Boot 3。 migrator:\u0026gt; list Found these recipes: 1) remove-redundant-maven-compiler-plugin -\u0026gt; Remove standard maven-compiler plugin for applications with boot parent. 2) initialize-spring-boot-migration -\u0026gt; Initialize an application as Spring Boot application. 3) migrate-jndi-lookup -\u0026gt; Migrate JNDI lookup using InitialContext to Spring Boot 4) migrate-jpa-to-spring-boot -\u0026gt; Migrate JPA to Spring Boot 5) migrate-ejb-jar-deployment-descriptor -\u0026gt; Add or overrides @Stateless annotation as defined in ejb deployment descriptor 6) migrate-weblogic-ejb-deployment-descriptor -\u0026gt; Migrate weblogic-ejb-jar.xml deployment descriptor 7) mark-and-clean-remote-ejbs -\u0026gt; Search @Stateless EJBs implementing a @Remote interface 8) migrate-stateless-ejb -\u0026gt; Migration of stateless EJB to Spring components. 9) migrate-annotated-servlets -\u0026gt; Allow Spring Boot to deploy servlets annotated with @WebServlet 10) migrate-jax-ws -\u0026gt; Migrate Jax Web-Service implementation to Spring Boot bases Web-Service 11) migrate-jax-rs -\u0026gt; Any class has import starting with javax.ws.rs 12) migrate-mule-to-boot -\u0026gt; Migrate Mulesoft 3.9 to Spring Boot. 13) migrate-tx-to-spring-boot -\u0026gt; Migration of @TransactionAttribute to @Transactionsl 14) spring-context-xml-import -\u0026gt; Import Spring Framework xml bean configuration into Java configuration without converting them. 15) migrate-spring-xml-to-java-config -\u0026gt; Migrate Spring Framework xml bean configuration to Java configuration. 16) migrate-jms -\u0026gt; Convert JEE JMS app into Spring Boot JMS app 17) documentation-actions -\u0026gt; Create Documentation for Actions 18) migrate-jsf-2.x-to-spring-boot -\u0026gt; Use joinfaces to integrate JSF 2.x with Spring Boot. 19) cn-spring-cloud-config-server -\u0026gt; Externalize properties to Spring Cloud Config Server 20) boot-2.4-2.5-upgrade-report -\u0026gt; Create Upgrade Report for a Spring Boot 2.4 Application 21) boot-2.7-3.0-dependency-version-update -\u0026gt; Bump spring-boot-starter-parent from 2.7.x to 3.0.0 22) boot-autoconfiguration-update -\u0026gt; Create org.springframework.boot.autoconfigure.AutoConfiguration.imports file for new spring 2.7 23) boot-2.4-2.5-datasource-initializer -\u0026gt; Replace deprecated spring.datasource.* properties 24) boot-2.4-2.5-spring-data-jpa -\u0026gt; Rename JpaRepository methods getId() and calls to getOne() 25) boot-2.4-2.5-dependency-version-update -\u0026gt; Update Spring Boot dependencies from 2.4 to 2.5 26) boot-2.7-3.0-upgrade-report -\u0026gt; Create a report for Spring Boot Upgrade from 2.7.x to 3.0.0-M3 27) boot-2.4-2.5-sql-init-properties -\u0026gt; Replace deprecated spring.datasource.* properties 28) sbu30-report -\u0026gt; Create a report for Spring Boot Upgrade from 2.7.x to 3.0.x 29) sbu30-upgrade-dependencies -\u0026gt; Spring boot 3.0 Upgrade - Upgrade dependencies 30) sbu30-set-java-version -\u0026gt; Spring boot 3.0 Upgrade - Set java version property in build file 31) sbu30-add-milestone-repositories -\u0026gt; Spring boot 3.0 Upgrade - Add milestone repository for dependencies and plugins 32) sbu30-migrate-spring-data-properties -\u0026gt; Spring boot 3.0 Upgrade - Migrate \u0026#39;spring.data\u0026#39; properties to new property names 33) sbu30-remove-construtor-binding -\u0026gt; Spring boot 3.0 Upgrade - Remove redundant @ConstructorBinding annotations 34) sbu30-migrate-to-jakarta-packages -\u0026gt; Spring boot 3.0 Upgrade - Migrate javax packages to new jakarta packages 35) sbu30-johnzon-dependency-update -\u0026gt; Spring boot 3.0 Upgrade - Specify version number for johnzon-core 36) sbu30-225-logging-date-format -\u0026gt; Spring boot 3.0 Upgrade - Logging Date Format 37) sbu30-auto-configuration -\u0026gt; Move EnableAutoConfiguration Property from spring.factories to AutoConfiguration.imports 38) sbu30-upgrade-spring-cloud-dependency -\u0026gt; Upgrade Spring Cloud Dependencies 39) sbu30-upgrade-boot-version -\u0026gt; Spring boot 3.0 Upgrade - Upgrade Spring Boot version 40) sbu30-remove-image-banner -\u0026gt; Spring boot 3.0 Upgrade - Remove the image banner at src/main/resources 41) sbu30-paging-and-sorting-repository -\u0026gt; Spring boot 3.0 Upgrade - Add CrudRepository interface extension additionally to PagingAndSortingRepository 42) migrate-raml-to-spring-mvc -\u0026gt; Create Spring Boot @RestController from .raml files. 43) migrate-boot-2.3-2.4 -\u0026gt; Migrate from Spring Boot 2.3 to 2.4 44) upgrade-boot-1x-to-2x -\u0026gt; Migrate applications built on previous versions of Spring Boot to the latest Spring Boot 2.7 release. OpenRewrite 使用示例 下面使用 maven 方式演示几个例子，注意如果是 maven 多模块项目，请在父模块下执行，否则运行可能出错，参考官方说明：Running Rewrite on a multi-module Maven project 。\n友情提醒：初次使用会下载很多依赖 jar 包，速度可能比较慢，切换到你最快的 maven 仓库。\n升级到 Java 21 从任意版本升级到 Java 21。\nmvn -U org.openrewrite.maven:rewrite-maven-plugin:run -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:RELEASE -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21 # 或者手动指定版本 mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.31.0:run -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.14.0 -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21\rOpenRewrite 会自动替换一些 Java 21 支持的新特性，如：\n大文本块 JEP 378: Text Blocks，自动优化格式化。 模式匹配增强：支持在执行 instanceof 操作时同时定义指定类型的新变量，省却了类型转换的过程。 String 类增加的新格式化方法： formatted(Object…​ args)。 排序性集合：可以直接使用 getFirst() 和 getLast() 来获取第一个和最后一个集合元素了。参考： JEP 431: Sequenced Collections。 Base64 方法替换 Base64 常用的实现有：\nApache Common Codec，依然可用，可以选择是否转换成 java.util.Base64。 sun.misc 包下提供的实现类，从 Java 9 开始，已经不再对外提供，需要替换。 从 Java 1.8 开始提供的标准库 java.util.Base64。 # UseJavaUtilBase64 mvn -U org.openrewrite.maven:rewrite-maven-plugin:run -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:RELEASE -Drewrite.activeRecipes=org.openrewrite.java.migrate.UseJavaUtilBase64 -Drewrite.exportDatatables=true # ApacheBase64ToJavaBase64 mvn -U org.openrewrite.maven:rewrite-maven-plugin:run -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-apache:RELEASE -Drewrite.activeRecipes=org.openrewrite.apache.commons.codec.ApacheBase64ToJavaBase64 -Drewrite.exportDatatables=true\r另外更多关于 Apache 包升级、使用 Java 自带方法代替 Apache Utils 的方法，请参考 OpenRewrite 官网 apache 下的食谱。\n升级到 JakartaEE 从 javax 到 jakarta，在 maven 项目父（根）模块下执行以下命令即可，注意命令可能随着版本变化，请去官网查看最新版本示例。\nmvn -U org.openrewrite.maven:rewrite-maven-plugin:run -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:RELEASE -Drewrite.activeRecipes=org.openrewrite.java.migrate.jakarta.JakartaEE10 -Drewrite.exportDatatables=true\r执行完成后可根据 git diff 查看修改效果。\n代码清理 先试一下 CodeCleanup 效果。\npom.xml 文件中增加以下配置，然后执行 mvn rewrite:run。\n\u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.maven\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.23.1\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;activeRecipes\u0026gt; \u0026lt;recipe\u0026gt;org.openrewrite.staticanalysis.CodeCleanup\u0026lt;/recipe\u0026gt; \u0026lt;/activeRecipes\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.recipe\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-static-analysis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.3.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt;\r我的某个项目执行效果：\n删除了一些多余的空格、空行、多括号。 代码格式化，比如多个参数间缺少空格的加了空格。 颠倒了一个 equals 比较： method.equals(\u0026quot;CONNECT\u0026quot;) -\u0026gt; \u0026quot;CONNECT\u0026quot;.equals(method)。 长代码换行归整，三元运算格式化。 静态分析、查找、重构 支持以下功能，不一一列举，请参考官方文档。\n分析依赖关系。 查找某个方法是否被使用。 将某个方法替换为某个方法。 批量修改方法名字，修改参数类型等。 排序 imports ，删除未使用的 imports。 通用代码格式化 无用空行、空白符、前后空白符、方法参数前后空白符、Tab 转 space 等一些常用格式化方式。\n日志优化 Parameterize logging statements：把字符串拼接自动转为参数类型。 用 logger 代替 System.err、System.out、printStackTrace。 把 JUL、log4j、logback 都转为 slf4j API。 Spring 到 Spring Boot 下面介绍下我们将 Spring 项目迁移到 Spring Boot 的过程，以及中间遇到的一些问题。\n升级项 迁移前 迁移后 Runtime Spring + Tomcat Spring Boot 3.2 Spring Spring 4 Spring 6 Junit Junit 4 Junit 5 okhttp okhttp 3 okhttp 4 Java Java 8 Java 21 Java EE Java EE Jakarta EE 基本步骤：\n使用 Spring Boot Migrator 将 Spring 项目转换成 Spring Boot，使用 Java 17 启动 spring-boot-migrator 程序并根据提示一步一步操作，如果某个步骤出错，根据 stacktrace 命令查看错误信息，修复后继续 apply \u0026lt;recipe-number\u0026gt;。\n# 注意在执行 spring-boot-migrator 前，先在你要升级的项目中执行 mvn clean package install，拉取和安装依赖包，避免下面的 scan 步骤中下载依赖包失败 # 使用 Java 17 启动 spring-boot-migrator 程序 $ java -jar spring-boot-migrator.jar Get Started: ------------ Type \u0026#34;help\u0026#34; - to display a list all of the available commands. \u0026#34;scan \u0026lt;dir\u0026gt;\u0026#34; - to scan an application -------------------------------------------------------------------------------------------------- migrator:\u0026gt; scan my-spring-project-dir [ok] Found pom.xml. [ok] \u0026#39;sbm.gitSupportEnabled\u0026#39; is \u0026#39;true\u0026#39;, changes will be committed to branch [springboot] after each recipe. [ok] Found required source dir \u0026#39;src/main/java\u0026#39;. Maven 100% │██████████████████████████████████│ 2/2 (0:00:00 / 0:00:00) Applicable recipes: 1) remove-redundant-maven-compiler-plugin -\u0026gt; Remove standard maven-compiler plugin for applications with boot parent. 2) initialize-spring-boot-migration -\u0026gt; Initialize an application as Spring Boot application. 3) spring-context-xml-import -\u0026gt; Import Spring Framework xml bean configuration into Java configuration without converting them. 4) migrate-spring-xml-to-java-config -\u0026gt; Migrate Spring Framework xml bean configuration to Java configuration. 5) cn-spring-cloud-config-server -\u0026gt; Externalize properties to Spring Cloud Config Server 6) sbu30-set-java-version -\u0026gt; Spring boot 3.0 Upgrade - Set java version property in build file 7) sbu30-add-milestone-repositories -\u0026gt; Spring boot 3.0 Upgrade - Add milestone repository for dependencies and plugins 8) sbu30-225-logging-date-format -\u0026gt; Spring boot 3.0 Upgrade - Logging Date Format Run command \u0026#39;\u0026gt; apply \u0026lt;recipe-number\u0026gt;\u0026#39; to apply a recipe. ibss-site-dc:\u0026gt; apply remove-redundant-maven-compiler-plugin Applying recipe \u0026#39;remove-redundant-maven-compiler-plugin\u0026#39; [ok] Clean up redundant properties for maven compiler plugin. [ok] Clean up redundant maven compiler plugin. remove-redundant-maven-compiler-plugin successfully applied the following actions: (x) Clean up redundant properties for maven compiler plugin. (x) Clean up redundant maven compiler plugin. Applicable recipes: 1) initialize-spring-boot-migration -\u0026gt; Initialize an application as Spring Boot application. 2) spring-context-xml-import -\u0026gt; Import Spring Framework xml bean configuration into Java configuration without converting them. 3) migrate-spring-xml-to-java-config -\u0026gt; Migrate Spring Framework xml bean configuration to Java configuration. 4) cn-spring-cloud-config-server -\u0026gt; Externalize properties to Spring Cloud Config Server 5) sbu30-set-java-version -\u0026gt; Spring boot 3.0 Upgrade - Set java version property in build file 6) sbu30-add-milestone-repositories -\u0026gt; Spring boot 3.0 Upgrade - Add milestone repository for dependencies and plugins 7) sbu30-225-logging-date-format -\u0026gt; Spring boot 3.0 Upgrade - Logging Date Format Run command \u0026#39;\u0026gt; apply \u0026lt;recipe-number\u0026gt;\u0026#39; to apply a recipe. ibss-site-dc:\u0026gt; apply initialize-spring-boot-migration Applying recipe \u0026#39;initialize-spring-boot-migration\u0026#39; [ok] Add Spring Boot dependency management section to buildfile. [ok] Add Spring Boot starter class. [ok] Add initial unit test class to test Spring Boot Application Context startup. [ok] Set packaging to \u0026#39;jar\u0026#39; type if different initialize-spring-boot-migration successfully applied the following actions: (x) Add Spring Boot dependency management section to buildfile. (x) Add spring dependencies \u0026#39;spring-boot-starter\u0026#39; and \u0026#39;spring-boot-starter-test\u0026#39;. (x) Delete dependencies to artifacts transitively managed by Spring Boot. (x) Add Spring Boot Maven plugin. (x) Add Spring Boot starter class. (x) Add initial unit test class to test Spring Boot Application Context startup. (x) Set packaging to \u0026#39;jar\u0026#39; type if different Applicable recipes: 1) spring-context-xml-import -\u0026gt; Import Spring Framework xml bean configuration into Java configuration without converting them. 2) migrate-spring-xml-to-java-config -\u0026gt; Migrate Spring Framework xml bean configuration to Java configuration. 3) cn-spring-cloud-config-server -\u0026gt; Externalize properties to Spring Cloud Config Server 4) boot-2.7-3.0-dependency-version-update -\u0026gt; Bump spring-boot-starter-parent from 2.7.x to 3.0.0 5) boot-2.7-3.0-upgrade-report -\u0026gt; Create a report for Spring Boot Upgrade from 2.7.x to 3.0.0-M3 6) sbu30-report -\u0026gt; Create a report for Spring Boot Upgrade from 2.7.x to 3.0.x 7) sbu30-upgrade-dependencies -\u0026gt; Spring boot 3.0 Upgrade - Upgrade dependencies 8) sbu30-set-java-version -\u0026gt; Spring boot 3.0 Upgrade - Set java version property in build file 9) sbu30-add-milestone-repositories -\u0026gt; Spring boot 3.0 Upgrade - Add milestone repository for dependencies and plugins 10) sbu30-remove-construtor-binding -\u0026gt; Spring boot 3.0 Upgrade - Remove redundant @ConstructorBinding annotations 11) sbu30-225-logging-date-format -\u0026gt; Spring boot 3.0 Upgrade - Logging Date Format 12) sbu30-upgrade-spring-cloud-dependency -\u0026gt; Upgrade Spring Cloud Dependencies 13) sbu30-upgrade-boot-version -\u0026gt; Spring boot 3.0 Upgrade - Upgrade Spring Boot version Spring Boot Migrator 目前还并不成熟，以上步骤中很多 recipe 可能出错，所以我只用 Spring Boot Migrator 做一些基础初始化，其他任务使用 rewrite-maven-plugin，交给 openrewrite 执行。在 maven pom.xml 中增加以下配置后，执行 mvn rewrite:run。\n\u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.maven\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.19.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;activeRecipes\u0026gt; \u0026lt;recipe\u0026gt;org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7\u0026lt;/recipe\u0026gt; \u0026lt;recipe\u0026gt;org.openrewrite.java.testing.junit5.JUnit4to5Migration\u0026lt;/recipe\u0026gt; \u0026lt;recipe\u0026gt;org.openrewrite.okhttp.UpgradeOkHttp4\u0026lt;/recipe\u0026gt; \u0026lt;recipe\u0026gt;org.openrewrite.okhttp.ReorderRequestBodyCreateArguments\u0026lt;/recipe\u0026gt; \u0026lt;recipe\u0026gt;org.openrewrite.java.migrate.UpgradeToJava17\u0026lt;/recipe\u0026gt; \u0026lt;/activeRecipes\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.recipe\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-spring\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.recipe\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-testing-frameworks\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.recipe\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-okhttp\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.1.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openrewrite.recipe\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rewrite-migrate-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.5.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/plugin\u0026gt;\r[INFO] Using active recipe(s) [org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7, org.openrewrite.java.testing.junit5.JUnit4to5Migration] [INFO] Using active styles(s) [] [INFO] Validating active recipes... [INFO] Project [ibss-site-dc] Resolving Poms... [INFO] Project [ibss-site-dc] Parsing source files [INFO] Running recipe(s)... [WARNING] Changes have been made to pom.xml by: [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_6 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_5 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_4 [WARNING] org.openrewrite.java.spring.boot2.SpringBoot2JUnit4to5Migration [WARNING] org.openrewrite.java.testing.junit5.JUnit4to5Migration [WARNING] org.openrewrite.maven.ExcludeDependency: {groupId=junit, artifactId=junit} [WARNING] org.openrewrite.java.dependencies.UpgradeDependencyVersion: {groupId=org.springframework.boot, artifactId=*, newVersion=2.7.x, overrideManagedVersion=false} [WARNING] Changes have been made to src/main/java/com/fsde/ibss/dc/controller/ClientController.java by: [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_6 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_5 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_4 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_3 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_2 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_1 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_0 [WARNING] org.openrewrite.java.spring.boot2.SpringBoot2BestPractices [WARNING] org.openrewrite.java.spring.NoRequestMappingAnnotation [WARNING] org.openrewrite.java.spring.ImplicitWebAnnotationNames [WARNING] Changes have been made to src/test/java/com/fsde/ibss/dc/service/FileSaveTest.java by: [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_6 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_5 [WARNING] org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_4 [WARNING] org.openrewrite.java.spring.boot2.SpringBoot2JUnit4to5Migration [WARNING] org.openrewrite.java.testing.junit5.JUnit4to5Migration [WARNING] org.openrewrite.java.testing.junit5.UpdateTestAnnotation [WARNING] org.openrewrite.java.spring.boot2.RemoveObsoleteSpringRunners [WARNING] org.openrewrite.java.testing.junit5.JUnit5BestPractices [WARNING] org.openrewrite.java.testing.cleanup.RemoveTestPrefix [WARNING] org.openrewrite.java.testing.cleanup.TestsShouldNotBePublic [WARNING] Please review and commit the results. [INFO] ------------------------------------------------------------------------ [INFO] BUILD SUCCESS [INFO] ------------------------------------------------------------------------ 在上面步骤我是先升级到了 Spring Boot 2，然后再执行升级 Spring Boot 3 和 Jakarta EE。实际上直接升级到 Spring Boot 3 也是可以的。\n执行完成后可从 maven 中删除 rewrite-maven-plugin，也可留着下次做其他变更。\n试用总结 注意事项：\n我们项目配置都是通过远程配置中心管理的，所以升级过程中配置文件无法响应变更，解决办法是将配置从远端拷贝到本地 applicaiton.properties 中，执行完任务后根据变化再更新远程配置中心。 执行过程中可能会报错，比如 maven 插件升级后某些属性可能变更或失效，需要手动解决错误后，再执行 mvn rewrite:run， 可重复执行 mvn rewrite:run 命令，可随时加入新的 recipe 再执行，所以为了观察变更和保证执行成功，可分批次加入 recipe 多次执行。 OpenRewrite 不解析依赖的第三方 jar 包内容，所以第三方 jar 的问题需要自行识别，比如从 Java EE 到 Jakarta EE，只是替换规则中知道的 jar 包版本和当前项目的源代码，不会自动把 jar 包内的 javax. 替换为 jakarta.。 遇见问题和解决办法 ","date":"2024-01-09","id":40,"permalink":"/docs/platform/smart-code/","summary":"\u003cp\u003e作为一个以 Java 和 Spring 为主要技术栈的团队，在日常的软件开发中，我们经常会遇到一系列的组件升级和代码重构需求，在此过程我们期望能做到几个效果：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e项目级升级：整个项目（注此项目指 Maven Project）升级，而不是基于某个 Java 类或片段。\u003c/li\u003e\n\u003cli\u003e不同版本跨度变更：比如从 Spring 项目迁移到 Spring Boot，从 Spring Boot 2.x 升级到 3.x，从 Java 8 升级到 Java 21。\u003c/li\u003e\n\u003cli\u003e代码安全可靠：变更的代码一定是正确的，至少是逻辑正确的，至少不能像某 AI 助手一样设置一些根本不存在的属性。\u003c/li\u003e\n\u003cli\u003e经验产品化：最佳实践就是产品，比如我并不（想）了解 Spring Boot 3.2 具体有哪些变更，但希望能一键从 3.0 自动升级到 3.2，直接告诉有哪些变更。\u003c/li\u003e\n\u003cli\u003e自定义重构：对于某些自研代码，希望能自定义重构逻辑，一键自动重构。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e基于以上背景，我们探索了 \u003ca href=\"https://docs.openrewrite.org/\" target=\"_blank\" rel=\"noopener\"\u003eOpenRewrite\u003c/a\u003e\n、\u003ca href=\"https://github.com/spring-projects-experimental/spring-boot-migrator\" target=\"_blank\" rel=\"noopener\"\u003eSpring Boot Migrator\u003c/a\u003e\n、\u003ca href=\"https://github.com/windup\" target=\"_blank\" rel=\"noopener\"\u003eRedhat Windup\u003c/a\u003e\n、\u003ca href=\"https://github.com/adoptium/emt4j\" target=\"_blank\" rel=\"noopener\"\u003eemt4j\u003c/a\u003e\n 和一众不便具名的 AI 代码助手，本文将分享我们使用 OpenRewrite、Spring Boot Migrator 进行代码重构和升级的一些使用经验和体验。\u003c/p\u003e\n\u003ch2 id=\"openrewrite\"\u003eOpenRewrite\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://docs.openrewrite.org/\" target=\"_blank\" rel=\"noopener\"\u003eOpenRewrite\u003c/a\u003e\n 是一个开源的代码重写工具，旨在帮助开发人员自动化大规模重构代码。\u003c/p\u003e\n\u003cp\u003e它提供了一套强大的 API 和插件系统，可以通过静态分析和代码转换技术来解析、修改和生成代码。OpenRewrite 支持多种编程语言，包括 Java、C#、 TypeScript、Python、Kubernetes 等。通过使用 OpenRewrite，开发人员可以轻松地进行代码重构、性能优化、代码风格调整和代码迁移等操作，从而提高代码质量和可维护性。OpenRewrite 的开源性质使得开发人员可以自由地定制和扩展其功能，以满足特定项目的需求。\u003c/p\u003e\n\u003cp\u003e比如 Java 领域一些热门的应用场景：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eJava 版本升级：从 Java 8 到 Java 21，从 Java EE 到 Jakarta EE 。\u003c/li\u003e\n\u003cli\u003eSpring 框架迁移：从 Spring 5 到 Spring 6，从 Spring Boot 2 到 Spring Boot 3。\u003c/li\u003e\n\u003cli\u003e测试框架迁移： 从 Junit 4 到 Junit 5。\u003c/li\u003e\n\u003cli\u003e依赖管理：自动更新 Java 项目的 Maven 或 Gradle 依赖，确保使用最新和最安全的库版本。\u003c/li\u003e\n\u003cli\u003e代码清理和格式化：自动清理和格式化 Java 代码，确保符合项目或组织的编码标准和风格指南。\u003c/li\u003e\n\u003cli\u003e修复安全漏洞：自动识别和修复 Java 代码中的已知安全漏洞，如使用了有安全问题的库或方法。\u003c/li\u003e\n\u003cli\u003e代码异味检测和修复：识别并自动重构 Java 代码中的“代码异味”，以提高代码可维护性。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e相比于时下火热的 AI 代码工具，比如 GitHub Copilot、Amazon CodeWhisperer，我认为 OpenRewrite 的优势主要有以下几点：\u003c/p\u003e","tags":[],"title":"智能代码重构"},{"content":"","date":"2023-09-07","id":41,"permalink":"/docs/","summary":"","tags":[],"title":"Docs"},{"content":"","date":"2025-09-14","id":42,"permalink":"/categories/","summary":"","tags":[],"title":"Categories"},{"content":"","date":"2025-09-14","id":43,"permalink":"/contributors/","summary":"","tags":[],"title":"Contributors"},{"content":"","date":"2025-09-14","id":44,"permalink":"/categories/java/","summary":"","tags":[],"title":"Java"},{"content":"","date":"2025-09-14","id":45,"permalink":"/tags/java/","summary":"","tags":[],"title":"Java"},{"content":"","date":"2025-09-14","id":46,"permalink":"/contributors/l10178/","summary":"","tags":[],"title":"L10178"},{"content":"","date":"2025-09-14","id":47,"permalink":"/categories/spring-boot/","summary":"","tags":[],"title":"Spring Boot"},{"content":"","date":"2025-09-14","id":48,"permalink":"/tags/spring-boot/","summary":"","tags":[],"title":"Spring Boot"},{"content":"","date":"2025-09-14","id":49,"permalink":"/tags/","summary":"","tags":[],"title":"Tags"},{"content":"","date":"2025-09-09","id":50,"permalink":"/tags/cicd/","summary":"","tags":[],"title":"CICD"},{"content":"","date":"2024-11-24","id":51,"permalink":"/categories/idaas/","summary":"","tags":[],"title":"Idaas"},{"content":"","date":"2024-11-24","id":52,"permalink":"/tags/idaas/","summary":"","tags":[],"title":"Idaas"},{"content":"","date":"2024-11-24","id":53,"permalink":"/tags/keycloak/","summary":"","tags":[],"title":"Keycloak"},{"content":"","date":"2024-11-24","id":54,"permalink":"/tags/oauth2/","summary":"","tags":[],"title":"Oauth2"},{"content":"","date":"2024-11-24","id":55,"permalink":"/categories/spring/","summary":"","tags":[],"title":"Spring"},{"content":"","date":"2024-11-24","id":56,"permalink":"/tags/spring/","summary":"","tags":[],"title":"Spring"},{"content":"","date":"2024-11-16","id":57,"permalink":"/categories/k8s/","summary":"","tags":[],"title":"K8s"},{"content":"","date":"2024-11-16","id":58,"permalink":"/tags/k8s/","summary":"","tags":[],"title":"K8s"},{"content":"卫星实验室，一个专注于技术创新的开源组织，此项目为卫星实验室主页 xlabs.club 的源码，合作交流请到我们的 GitHub 主页。\n卫星实验室账号 GitHub: https://github.com/xlabs-club Medium: https://xlabs-club.medium.com 稀土掘金：https://juejin.cn/user/169800120680251 主页内容 平台工程：我们的平台工程建设之路，关于 DevOps, DataOps, FinOps 以及 AIOps 的工程实践。 云原生：云原生技术探索，如何以云原生技术支撑起不断变化的复杂业务。 技术博客：研发踩坑记录，翻一翻总有惊喜。 awesome-x-ops：一些关于 AIOps、DataOps、DevOps、GitOps、FinOps 的优秀软件、博客、配套工具。 xlabs-ops：一些 IaC 运维脚本和通用模板，如 Argo Workflows 模板仓库，是对官方 Examples 的组合、扩展。 xlabs-developer-platform：一个基于 Backstage 自建的开发者平台。 backstage-plugins：卫星实验室的开源 backstage plugins，欢迎提交 PR。 ","date":"2024-09-28","id":59,"permalink":"/about/","summary":"\u003cp\u003e卫星实验室，一个专注于技术创新的开源组织，此项目为卫星实验室主页 \u003ca href=\"https://www.xlabs.club\" target=\"_blank\" rel=\"noopener\"\u003exlabs.club\u003c/a\u003e\n 的源码，合作交流请到我们的 \u003ca href=\"https://github.com/xlabs-club\" target=\"_blank\" rel=\"noopener\"\u003eGitHub\u003c/a\u003e\n 主页。\u003c/p\u003e\n\u003ch2 id=\"卫星实验室账号\"\u003e卫星实验室账号\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eGitHub: \u003ca href=\"https://github.com/xlabs-club\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/xlabs-club\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eMedium: \u003ca href=\"https://xlabs-club.medium.com\" target=\"_blank\" rel=\"noopener\"\u003ehttps://xlabs-club.medium.com\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e稀土掘金：\u003ca href=\"https://juejin.cn/user/169800120680251\" target=\"_blank\" rel=\"noopener\"\u003ehttps://juejin.cn/user/169800120680251\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"主页内容\"\u003e主页内容\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e平台工程：我们的平台工程建设之路，关于 DevOps, DataOps, FinOps 以及 AIOps 的工程实践。\u003c/li\u003e\n\u003cli\u003e云原生：云原生技术探索，如何以云原生技术支撑起不断变化的复杂业务。\u003c/li\u003e\n\u003cli\u003e技术博客：研发踩坑记录，翻一翻总有惊喜。\u003c/li\u003e\n\u003cli\u003eawesome-x-ops：一些关于 AIOps、DataOps、DevOps、GitOps、FinOps 的优秀软件、博客、配套工具。\u003c/li\u003e\n\u003cli\u003exlabs-ops：一些 IaC 运维脚本和通用模板，如 Argo Workflows 模板仓库，是对官方 Examples 的组合、扩展。\u003c/li\u003e\n\u003cli\u003exlabs-developer-platform：一个基于 Backstage 自建的开发者平台。\u003c/li\u003e\n\u003cli\u003ebackstage-plugins：卫星实验室的开源 backstage plugins，欢迎提交 PR。\u003c/li\u003e\n\u003c/ul\u003e","tags":[],"title":"About"},{"content":"","date":"2024-04-29","id":60,"permalink":"/tags/pulumi/","summary":"","tags":[],"title":"Pulumi"},{"content":"","date":"2024-03-19","id":61,"permalink":"/tags/tools/","summary":"","tags":[],"title":"Tools"},{"content":"","date":"2023-09-07","id":62,"permalink":"/privacy/","summary":"","tags":[],"title":"Privacy Policy"},{"content":"","date":"2023-09-07","id":63,"permalink":"/","summary":"","tags":[],"title":"卫星实验室"},{"content":"","date":"2022-09-07","id":64,"permalink":"/tags/devops/","summary":"","tags":[],"title":"Devops"}]