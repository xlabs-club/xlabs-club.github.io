<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>分布式中间件 on XLabs</title><link>https://www.xlabs.club/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6/</link><description>Recent content in 分布式中间件 on XLabs</description><generator>Hugo</generator><language>zh</language><copyright>Copyright (c) 2020-2025 XLabs Club</copyright><lastBuildDate>Fri, 19 Dec 2025 09:31:00 +0800</lastBuildDate><atom:link href="https://www.xlabs.club/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6/index.xml" rel="self" type="application/rss+xml"/><item><title>基于 Alibaba Sentinel 实现的分布式限流中间件服务以及遇到的坑和注意事项</title><link>https://www.xlabs.club/blog/sentinel/</link><pubDate>Thu, 07 Mar 2024 21:06:10 +0800</pubDate><guid>https://www.xlabs.club/blog/sentinel/</guid><description>&lt;p&gt;基于 Alibaba Sentinel 实现的分布式限流中间件服务。主要对服务提供者提供限流、系统保护，对服务调用者提供熔断降级、限流排队等待效果。&lt;/p&gt;
&lt;p&gt;实现目标：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;作为服务提供者，保护自己不被打死，服务可以慢不可以挂。&lt;/li&gt;
&lt;li&gt;作为客户端及时限速和熔断，防止对服务提供方包含 Http、数据库、MQ 等造成太大压力，防止把糟糕的情况变得更糟。&lt;/li&gt;
&lt;li&gt;以用户、租户、对象等更细粒度进行流量精细控制。&lt;/li&gt;
&lt;li&gt;服务预热，应用新发布上线，缓存尚未完全建立，防止流量一下子把服务打死。&lt;/li&gt;
&lt;li&gt;能够根据 Prometheus、ClickHouse、Elasticsearch 提供的监控指标，动态生成规则，自适应调整规则。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="概述"&gt;概述&lt;/h2&gt;
&lt;p&gt;Sentinel 的基础知识请参考官方文档描述，这里单独介绍一些与我们定制相关的内容。&lt;/p&gt;
&lt;p&gt;限流简单来说就三个点：资源、规则、效果。&lt;/p&gt;
&lt;p&gt;资源：就是一个字符串，这个字符串可以自己定义、可以用注解自动生成、可以通过拦截器按规则生成。&lt;/p&gt;
&lt;p&gt;规则：Sentinel 定义的一系列限流保护规则，比如流量控制规则、自适应保护规则。&lt;/p&gt;
&lt;p&gt;效果：实际上“效果”也是“规则”定义的一部分。任何一条请求，命中某些资源规则后产生的效果，比如直接抛出异常、匀速等待。&lt;/p&gt;
&lt;h3 id="sentinel-全局注意事项和使用限制"&gt;Sentinel 全局注意事项和使用限制&lt;/h3&gt;
&lt;p&gt;使用开源默认 Sentinel 组件，有一些坑，或者说需要关注的注意事项：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;单个进程内资源数量阈值是 6000，多出的资源规则将不会生效（因为是懒加载，资源先到先得），也不提示错误而是直接忽略，资源数量太多建议使用热点参数控制。&lt;/li&gt;
&lt;li&gt;对于限流的链路模式，context 阈值是 2000，所以默认的 WEB_CONTEXT_UNIFY 为 true，如果需要链路限流需要把这个改为 false。&lt;/li&gt;
&lt;li&gt;自定义时，资源名中不要带 &lt;code&gt;|&lt;/code&gt; 线， 这个日志中要用，日志以此作为分割符。&lt;/li&gt;
&lt;li&gt;Sentinel 支持按来源限流，注意 &lt;code&gt;origin&lt;/code&gt; 数量不能太多，否则会导致内存暴涨。&lt;/li&gt;
&lt;li&gt;一个资源可以有多个规则，一条请求能否通过，取决于规则里阈值最小的限制条件。&lt;/li&gt;
&lt;li&gt;限流的目的是保护系统，计数计量并不准确，所以不要拿限流做计量或配额控制。&lt;/li&gt;
&lt;li&gt;增加限流一定程度上通过时间换空间，降低了 CPU、内存负载，对 K8S HPA 策略会有一定影响。后续我们也会考虑根据 Sentinel 限流指标进行扩缩容。&lt;/li&gt;
&lt;li&gt;限流中如果有增加等待效果会使接口变慢，各调用链需要关注调用超时和事务配置。&lt;/li&gt;
&lt;li&gt;目前 sentinel-web-servlet 和 sentinel-spring-webmvc-adapter 均不支持热点参数限流。为了支持热点参数需要自行扩展。&lt;/li&gt;
&lt;li&gt;sentinel-web-servlet 和 sentinel-spring-webmvc-adapter 会将每个到来的不同的 URL 都作为不同的资源处理，因此对于 REST 风格的 API，需要自行实现 UrlCleaner 接口清洗一下资源（比如将满足 /foo/:id 的 URL 都归到 /foo/* 资源下）。否则会导致资源数量过多，超出资源数量阈值（目前是 6000）时多出的资源的规则将不会生效。&lt;/li&gt;
&lt;li&gt;Java 中 &lt;code&gt;sentinel-time-tick-thread&lt;/code&gt; 线程会额外多占用约 1-2% CPU，详细代码参考 &lt;code&gt;com.alibaba.csp.sentinel.util.TimeUtil&lt;/code&gt;。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一些文档中尚未更新但是大家可能关心的内容：&lt;/p&gt;</description></item></channel></rss>