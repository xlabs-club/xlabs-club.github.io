<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.c4fdc4149e5e1c7b1e9f189cefc6eb2be050c2cfb72145725c54e0862ca767949ef61742676a78018768d0816d71f9004da915f293da8a8ba2666dd8b1062094.css" integrity="sha512-xP3EFJ5eHHsenxic78brK+BQws+3IUVyXFTghiynZ5Se9hdCZ2p4AYdo0IFtcfkATakV8pPaiouiZm3YsQYglA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/trust-cert-manager-selfsigned-tls/><link rel=canonical href=https://www.xlabs.club/blog/trust-cert-manager-selfsigned-tls/><title>使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书并信任证书 — XLabs</title>
<meta name=description content="使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书，为应用自动签发 HTTPS 证书，并信任证书"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:url" content="https://www.xlabs.club/blog/trust-cert-manager-selfsigned-tls/"><meta property="og:site_name" content="XLabs"><meta property="og:title" content="使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书并信任证书"><meta property="og:description" content="使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书，为应用自动签发 HTTPS 证书，并信任证书"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-04-29T21:49:22+08:00"><meta property="article:modified_time" content="2025-06-05T20:15:24+08:00"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Pulumi"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书并信任证书"><meta name=twitter:description content="使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书，为应用自动签发 HTTPS 证书，并信任证书"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"使用 Pulumi 部署 Cert Manager 创建 K8 S 自签名证书并信任证书","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书并信任证书","description":"使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书，为应用自动签发 HTTPS 证书，并信任证书","isPartOf":{"@id":"https://www.xlabs.club/blog/trust-cert-manager-selfsigned-tls/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/trust-cert-manager-selfsigned-tls/"},"datePublished":"2024-04-29T21:49:22+08:00","dateModified":"2025-06-05T20:15:24+08:00","author":{"@type":"Organization","name":"XLabs Club 卫星实验室","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club 卫星实验室"}}]}</script><meta http-equiv=content-language content='zh-cn'></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu"><svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close><svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/blog/xlabs-link-exchange>Links</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme"><svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg><svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="container p-0"><article><div class="row justify-content-center"><div class="col-md-12 col-lg-11"><div class=blog-header><h1>使用 Pulumi 部署 cert-manager 创建 K8S 自签名证书并信任证书</h1><p><small>2024年4月29日&nbsp;&nbsp;<a class="stretched-link position-relative" href=/contributors/l10178/>l10178</a><span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>2&nbsp;minutes</span></small></p></div></div><div class="col-md-12 col-lg-11"><p>在搭建本地 Kubernetus 集群后，由于环境在内网，做不了域名验证，无法使用 Let&rsquo;s Encrypt 颁发和自动更新证书，然而很多应用要求必须启用 HTTPS，只能用自签名 CA 证书，并由此 CA 继续颁发其他证书。</p><p>所以我们准备了以下工具，开始搭建。</p><ul><li><a href=https://www.pulumi.com/ target=_blank rel=noopener>Pulumi</a>
: 当前非常流行的 IaC 工具，值得一试。</li><li><a href=https://cert-manager.io/ target=_blank rel=noopener>cert-manager</a>
: 云原生证书管理，用于自动管理和颁发各种发行来源的 TLS 证书。它将确保证书有效并定期更新，并尝试在到期前的适当时间更新证书。</li></ul><p>核心步骤和相关代码如下，更多源码请参考我们的 GitHub 项目 <a href=https://github.com/xlabs-club/xlabs-ops target=_blank rel=noopener>xlabs-ops</a>
。</p><p>使用 Pulumi 安装 cert-manager，生成自签名 CA 证书，根据自签名 CA 证书生成 cert-manager ClusterIssuer，都在如下代码了。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>pulumi</span> <span class=kr>from</span> <span class=s2>&#34;@pulumi/pulumi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>kubernetes</span> <span class=kr>from</span> <span class=s2>&#34;@pulumi/kubernetes&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>tls</span> <span class=kr>from</span> <span class=s2>&#34;@pulumi/tls&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 部署 cert-manager Helm chart
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>certManagerRelease</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>helm</span><span class=p>.</span><span class=nx>v3</span><span class=p>.</span><span class=nx>Release</span><span class=p>(</span><span class=s2>&#34;cert-manager&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;cert-manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>chart</span><span class=o>:</span> <span class=s2>&#34;cert-manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.14.5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>namespace</span><span class=o>:</span> <span class=s2>&#34;cert-manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>createNamespace</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>timeout</span>: <span class=kt>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>repositoryOpts</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>repo</span><span class=o>:</span> <span class=s2>&#34;https://charts.jetstack.io&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>values</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>installCRDs</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 生成一个 CA private key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>caPrivateKey</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>PrivateKey</span><span class=p>(</span><span class=s2>&#34;caPrivateKey&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>algorithm</span><span class=o>:</span> <span class=s2>&#34;RSA&#34;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 生成一个 自签名 CA 证书
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>caCert</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>SelfSignedCert</span><span class=p>(</span><span class=s2>&#34;caCert&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// keyAlgorithm: &#34;RSA&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>privateKeyPem</span>: <span class=kt>caPrivateKey.privateKeyPem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isCaCertificate</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>validityPeriodHours</span>: <span class=kt>87600</span><span class=p>,</span> <span class=c1>// 10 year
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>allowedUses</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;cert_signing&#34;</span><span class=p>,</span> <span class=s2>&#34;crl_signing&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>subject</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>commonName</span><span class=o>:</span> <span class=s2>&#34;your.domain.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>organization</span><span class=o>:</span> <span class=s2>&#34;Xlabs Club&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 生成一个带有 CA crt 和 key 的 Kubernetes Secret
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>caSecret</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>core</span><span class=p>.</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Secret</span><span class=p>(</span><span class=s2>&#34;caSecret&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;selfsigned-cert-manager-ca&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>namespace</span><span class=o>:</span> <span class=s2>&#34;cert-manager&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;Opaque&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>stringData</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tls.crt&#34;</span><span class=o>:</span> <span class=nx>caCert</span><span class=p>.</span><span class=nx>certPem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tls.key&#34;</span><span class=o>:</span> <span class=nx>caPrivateKey</span><span class=p>.</span><span class=nx>privateKeyPem</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建一个自签名的 ClusterIssuer 给 ingress 用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>clusterIssuer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>apiextensions</span><span class=p>.</span><span class=nx>CustomResource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;selfsigned-issuer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>apiVersion</span><span class=o>:</span> <span class=s2>&#34;cert-manager.io/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>kind</span><span class=o>:</span> <span class=s2>&#34;ClusterIssuer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;selfsigned-issuer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 注意 ClusterIssuer 和 caSecret 放在同一个 namespace，不写 namespace 时 ClusterIssuer 找不到 caSecret
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>namespace</span><span class=o>:</span> <span class=s2>&#34;cert-manager&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>spec</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>ca</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>secretName</span>: <span class=kt>caSecret.metadata.name</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=nx>dependsOn</span>: <span class=kt>certManagerRelease</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>certManagerVersion</span> <span class=o>=</span> <span class=nx>certManagerRelease</span><span class=p>.</span><span class=nx>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>clusterIssuerName</span> <span class=o>=</span> <span class=nx>clusterIssuer</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Export CA 证书，便于客户端导入信任证书
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>caCertificatePem</span> <span class=o>=</span> <span class=nx>caCert</span><span class=p>.</span><span class=nx>certPem</span><span class=p>;</span></span></span></code></pre></div></figure></div><p>以上执行 <code>pulumi up</code> 后，我们就得到了一个自签名的 CA 证书、一个可用于为 ingress 自动签发 TLS 的 ClusterIssuer。</p><p>在 K8S ingress 上，增加以下 annotations 即可自动生成 TLS 证书，注意名字 selfsigned-issuer 与上面创建的名字保持一致。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class=l>selfsigned-issuer</span></span></span></code></pre></div></figure></div><p>另外提供一个小插曲，实际上 cert-manager 的 ClusterIssuer 不需要指定 namespace，但是在创建的时候发现不写 namespace，caSecret 创建在 <code>default</code> namespace 后，ClusterIssuer 找不到 caSecret，所以为他们两个都特别指定了 namespace。</p><h2 id=让-edgechrome-信任自签名证书>让 Edge/Chrome 信任自签名证书</h2><p>以上生成的自签名证书在浏览器访问时，会有红色提示不安全，被禁止访问，所以需要将我们的 CA 证书导入本机并选择信任。</p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 导出上面步骤生产的 CA 证书</span>
</span></span><span class=line><span class=cl>pulumi stack output caCertificatePem --show-secrets &gt; ca.crt.pem</span></span></code></pre></div></figure></div><p>Mac 用户，通过以下命令行，或打开 Keychain Access 应用程序手动导入并在 info trust 中选择 always trust。</p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ca.crt.pem</span></span></code></pre></div></figure></div><p>对于 Ubuntu 用户，可通过以下命令导入。某些 Ubuntu Desktop 增加信任证书后，Edge 仍然提示证书无效，在 Edge 地址栏输入 <code>edge://settings/privacy/manageCertificates</code> 重新导入了一次就解决了。</p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mv ca.crt.pem ca.crt
</span></span><span class=line><span class=cl>sudo apt-get install -y ca-certificates
</span></span><span class=line><span class=cl>sudo cp ca.crt /usr/local/share/ca-certificates/my-local-ca.crt
</span></span><span class=line><span class=cl>sudo update-ca-certificates</span></span></code></pre></div></figure></div><p>Windows 用户，双击 ca.crt 安装证书到“受信任的根证书颁发机构”。</p><div class=tag-list-single><a class="btn btn-light" href=/tags/k8s/ role=button>k8s</a>
<a class="btn btn-light" href=/tags/pulumi/ role=button>pulumi</a></div></div></div></article></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.c673c84373e66019f7895efc74b3b3b940071832aaa8a85e73218087d535e71b.js integrity="sha256-xnPIQ3PmYBn3iV78dLOzuUAHGDKqqKhecyGAh9U15xs="></script><script async src=/js/app.d05c432390da35574e3ded866e7272ad59de79e668c4a70834a8dc52167d6982.js integrity="sha256-0FxDI5DaNVdOPe2GbnJyrVneeeZoxKcINKjcUhZ9aYI="></script><script async src=/js/docsearch.c10d12b41b383a226ea1accfc11112a4463d0dc30116d335216301f8049c938c.js integrity="sha256-wQ0StBs4OiJuoazPwRESpEY9DcMBFtM1IWMB+ASck4w="></script></body></html>