<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.dce5fe2fbf2034c13477c81ccddda34c2a0e4f05bd87e5ba97eb8d4bdbf174bca8bb55dcba072e7fb3a2007bc1a66e93305dd7b18e5e215aa8297b598554d17e.css" integrity="sha512-3OX+L78gNME0d8gczd2jTCoOTwW9h+W6l+uNS9vxdLyou1Xcugcuf7OiAHvBpm6TMF3XsY5eIVqoKXtZhVTRfg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/><link rel=canonical href=https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/><title>使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解</title><meta name=description content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:url" content="https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/"><meta property="og:site_name" content="XLabs"><meta property="og:title" content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解"><meta property="og:description" content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-10-10T23:30:40+08:00"><meta property="article:modified_time" content="2025-07-27T12:08:00+08:00"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Idaas"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解"><meta name=twitter:description content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"使用 Oauth2 Proxy 为任意程序增加认证鉴权，结合 K8 S、traefik、keycloak 部署配置详解","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解","description":"使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解","isPartOf":{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/"},"datePublished":"2024-10-10T23:30:40+08:00","dateModified":"2025-07-27T12:08:00+08:00","image":[{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes1.png"},{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes2.png"},{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes3.png"},{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes4.png"},{"@id":"https://www.xlabs.club/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes5.png"}],"author":{"@type":"Organization","name":"XLabs Club 卫星实验室","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club 卫星实验室"}}]}</script><meta http-equiv=content-language content='zh-cn'></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu">
<svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close>
<svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/blog/xlabs-link-exchange>Links</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme">
<svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg>
<svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col container-fw d-lg-flex flex-lg-row justify-content-center mx-auto"><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>目录</h3><nav id=toc><ul><li><a href=#组件介绍>组件介绍</a></li><li><a href=#基本原理和流程>基本原理和流程</a></li><li><a href=#部署配置详解>部署配置详解</a><ul><li><a href=#keycloak-配置>Keycloak 配置</a></li><li><a href=#oauth2-proxy-配置>oauth2-proxy 配置</a></li><li><a href=#traefik-配置>Traefik 配置</a></li></ul></li><li><a href=#k3s-traefik-对接-oauth2-proxy-特别说明>K3S Traefik 对接 oauth2-proxy 特别说明</a></li><li><a href=#keycloak-对接-oauth2-proxy-特别说明>Keycloak 对接 oauth2-proxy 特别说明</a></li><li><a href=#oauth2-proxy-自动重定向到-keycloak-登录>oauth2-proxy 自动重定向到 keycloak 登录</a></li><li><a href=#nginx-使用-auth_request-对接-oauth2-proxy>nginx 使用 auth_request 对接 oauth2-proxy</a></li><li><a href=#遇见问题和解决办法>遇见问题和解决办法</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak 部署配置详解</h1><nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation"><details><summary>目录</summary><div class=page-links><nav id=TableOfContents><ul><li><a href=#组件介绍>组件介绍</a></li><li><a href=#基本原理和流程>基本原理和流程</a></li><li><a href=#部署配置详解>部署配置详解</a><ul><li><a href=#keycloak-配置>Keycloak 配置</a></li><li><a href=#oauth2-proxy-配置>oauth2-proxy 配置</a></li><li><a href=#traefik-配置>Traefik 配置</a></li></ul></li><li><a href=#k3s-traefik-对接-oauth2-proxy-特别说明>K3S Traefik 对接 oauth2-proxy 特别说明</a></li><li><a href=#keycloak-对接-oauth2-proxy-特别说明>Keycloak 对接 oauth2-proxy 特别说明</a></li><li><a href=#oauth2-proxy-自动重定向到-keycloak-登录>oauth2-proxy 自动重定向到 keycloak 登录</a></li><li><a href=#nginx-使用-auth_request-对接-oauth2-proxy>nginx 使用 auth_request 对接 oauth2-proxy</a></li><li><a href=#遇见问题和解决办法>遇见问题和解决办法</a></li></ul></nav></div></details></nav><p>作为一个程序员，在日常开发中永远避免不了认证鉴权，而我们开发的某些应用，并不需要太复杂的鉴权，比如可能只要求必须是登录用户，或者只需要根据角色进行 RBAC 鉴权。有没有方法简化此流程，让应用开发者只关注业务开发，这就是本文档要解决的问题。</p><p>如果你有类似以下的需求，都可以参考此文档，原理是一样的，组件也可复用。</p><ol><li>为原本没有登录验证的服务提供认证服务，比如某些开源组件不支持认证但是又因携带一些危险数据而不想公开访问。</li><li>实现统一的单点登录 SSO、并支持简单的 RBAC、UBAC 鉴权。</li><li>为 Kubernetus Traefik Nginx Ingress 提供统一的认证入口，一键实现所有入口必须登录才可访问。</li><li>配置 Traefik 使用 Forward Auth，Nginx 使用 auth_request 实现认证，也可以一并参考。</li><li>在 K8S 或应用网关，基于用户、角色等不同属性，路由到不同服务。</li><li>如果你凑巧也在用 <a href=https://backstage.io/ target=_blank rel=noopener>Backstage</a>
，请参考 <a href=https://www.xlabs.club/blog/backstage-oauth2-proxy-keycloak/ target=_blank rel=noopener>另一篇博客</a>
。</li></ol><p>写在前面：</p><ol><li>本文档里的示例代码是以 k3s 为基础，使用 traefik 作为 ingress controller，整体完善但略显复杂，如果没有 K3S/K8S，以其他方式部署也是完全可以的，基本原理都是一样的。</li><li>对于某些场景下可选的配置，会单独说明，请注意分别。</li><li>这里提到的每个组件都是可替换的，比如 nginx 代替 traefik，Pomerium 代替 oauth2-proxy，可根据爱好选择，后面也会适当补充几种不同方式的对比和部署差异，更详细内容请参考本站另外一篇文档 <a href=https://www.xlabs.club/docs/platform/iam/ target=_blank rel=noopener>统一身份认证</a>
。</li><li>示例中的代码都是从真实环境拷贝经过检验的，但为了便于理解可能裁剪无关紧要的内容，完整的安装部署源码请参考我们的部署脚本 <a href=https://github.com/xlabs-club/xlabs-ops target=_blank rel=noopener>xlabs-club/xlabs-ops</a>
。</li><li>需要懂一些 K8S、OIDC 基础知识，此处只提供链接不展开说明。</li></ol><h2 id=组件介绍>组件介绍<a href=#组件介绍 class=anchor aria-hidden=true>#</a></h2><ol><li><p>Keycloak</p><p>Keycloak 是一个开源的身份和访问管理解决方案，支持 OAuth 2.0、OpenID Connect、SAML 等协议。它提供用户管理、角色管理、单点登录（SSO）、身份提供服务等功能，在本示例中担任 Auth Provider 角色。关于 Keycloak 的中文介绍，可参考本站单独的博客 <a href=https://idaas.xlabs.club/ target=_blank rel=noopener>IDaaS Book</a>
。</p></li><li><p><a href=https://oauth2-proxy.github.io/oauth2-proxy/ target=_blank rel=noopener>oauth2-proxy</a></p><p>顾名思义它是一个关于 oauth 反向代理，主要用来为后端服务增加身份验证层。它支持多种 OAuth 2.0 提供者（如 Google、OIDC、Keycloak 等），可以保护未提供身份验证的应用。oauth2-proxy 在请求进入后端服务之前，会先进行 OAuth 2.0 登录认证，确保请求者具有访问权限。它承担了登录的合法性校验、重定向、登录成功后的 cookie、response 设置等功能。</p></li><li><p>Application</p><p>应用代号，可以是任何应用，UI 也好，API 也好，都可以，只要想拦截都行。</p></li></ol><p>在开始之前，建议先了解下 oauth2-proxy 的基本功能，并需要特别关注一下他的这几个容易令人疑惑的设置。</p><ol><li>oauth2-proxy 的 set header 和 pass header 的区别， set header 设置的是 response header，这在下面提到的 nginx auth_request 模块和 traefik forwardAuth Middleware 会用到。</li><li>pass header 是认证通过后，将一些基本信息，比如 Access Token、User ID、User Group 通过 Http Request Header 传递到 upstream（代理的目标应用），upstream 可以拿到 Header 信息后做更多的事情。</li><li>目标应用 <code>--upstream</code> 一般就是一个或多个具体的后端服务地址，也可以是静态文件。还有一种特殊的文件 <code>file:///dev/null</code>, 相当于舍弃 upstream，下面我们会用他结合 traefik forwardAuth 使用。</li><li>关注下 oauth2-proxy 的 <a href=https://oauth2-proxy.github.io/oauth2-proxy/features/endpoints target=_blank rel=noopener>Endpoints</a>
，主要使用 start、auth、sign_in、sign_out 等几个，另外 auth endpoint 后面可以追加 query parameters <code>allowed_groups/allowed_emails</code>，这样不就组成了一个简单的基于 Group 的权限认证。</li><li>注意看文档中关于 proxy 的设置，比如 <code>--reverse-proxy</code>，很多错误都是因为认证和配置没问题，但是到了后端 OAuth 本身校验失败，Token 的校验对 scheme、host 都有要求，如果经过了 proxy，要透传 header 中的 scheme、host。</li></ol><h2 id=基本原理和流程>基本原理和流程<a href=#基本原理和流程 class=anchor aria-hidden=true>#</a></h2><p>目前 oauth2-proxy 有几种主流的使用方式。</p><p>第一种，直接使用 oauth2-proxy 对外提供服务，承担认证流程并提供简单的权限校验，认证通过后通过 Header 传递一些用户信息到 upstream application，流量由 oauth2-proxy 分发。</p><p>这种方式网络流量大概类似如下方式。</p><div class="mermaid text-center">sequenceDiagram
participant User
participant oauth2-proxy
participant Application
User->>oauth2-proxy: Access Service
oauth2-proxy->>oauth2-proxy: Authenticate User to Auth Provider (eg. keycloak)
oauth2-proxy->>Application: Forward request to Backend<br>proxy paas headers(user id/name/groups/roles)
Application->>Application: Do more things by header info
Application-->>oauth2-proxy: Response
oauth2-proxy-->>User: Return Response</div><p>第二种，借助 traefik forwardAuth 认证插件 或 nginx auth_request 认证模块，结合 oauth2-proxy 提供的认证相关 Endpoints，承担认证流程，认证通过后流量的分发仍然由 traefik/nginx 执行。此方案的优点很明显，就是 traefik/nginx 的流量分发能力远超过 oauth2-proxy，不破坏 traefik/nginx 本身的功能。</p><p>他的网络流量和流程大概类似如下方式。</p><div class="mermaid text-center">sequenceDiagram
participant User
participant Traefik
participant oauth2-proxy
participant Keycloak
participant Application
User->>Traefik: Access Application URL
Traefik->>oauth2-proxy: Forward request (auth check)
oauth2-proxy->>oauth2-proxy: Check if user is authenticated
oauth2-proxy-->>User: Redirect to Keycloak login
User->>Keycloak: Enter credentials
Keycloak->>Keycloak: Authenticate User
Keycloak-->>User: Return Authorization Code
User->>oauth2-proxy: Send Authorization Code
oauth2-proxy->>Keycloak: Exchange Code for Access Token
Keycloak-->>oauth2-proxy: Return Access Token
oauth2-proxy-->>User: Set authentication cookie
oauth2-proxy->>Traefik: Forward original request, add Response Header
Traefik->>Application: Response Header to Request Header, Forward request to Application
Application-->>Traefik: Return response
Traefik-->>User: Return response</div><p>流程描述：</p><ol><li>用户访问 Application URL，请求被 Traefik 捕获。</li><li>Traefik 将请求转发给 oauth2-proxy，检查用户是否已认证。</li><li>如果用户未认证，oauth2-proxy 会将用户重定向到 Keycloak 登录页面。</li><li>用户在 Keycloak 上输入凭证并进行认证。</li><li>认证成功后，Keycloak 返回鉴权码给用户。</li><li>用户将鉴权码发送给 oauth2-proxy，oauth2-proxy 使用鉴权码向 Keycloak 请求访问令牌。</li><li>Keycloak 返回访问令牌给 oauth2-proxy，oauth2-proxy 设置身份验证 cookie。</li><li>oauth2-proxy 认证通过后，设置 Response Header 给 Traefik，Traefik 将 Response Header 转成 Request Header 传递给 Application。</li><li>Application 返回响应，最终由 Traefik 返回给用户。</li></ol><p>本文档部署示例使用的是第二种方式。</p><h2 id=部署配置详解>部署配置详解<a href=#部署配置详解 class=anchor aria-hidden=true>#</a></h2><p>此处的 Traefik 使用的 K3S Traefik ingress controller，相关的功能通过 ingress annotations 实现，如果你使用其他方式部署，请参考 <a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-ingress/ target=_blank rel=noopener>Traefik 文档</a>
转换为对应的 yaml 配置。</p><h3 id=keycloak-配置>Keycloak 配置<a href=#keycloak-配置 class=anchor aria-hidden=true>#</a></h3><p>首先，我们需要在 Keycloak 中创建一个 client，用于允许 <a href=https://oauth2-proxy.github.io/oauth2-proxy/configuration/providers/keycloak_oidc target=_blank rel=noopener>oauth2-proxy 使用 Keycloak</a>
验证用户身份验证。</p><p>OIDC 客户端必须配置 <code>audience mapper</code>，以将客户端的名称包含在 JWT 令牌的 aud 声明中。
aud 声明指定令牌的预期接收者，oauth2-proxy 期望与 &ndash;client-id 或 &ndash;oidc-extra-audience 的值匹配。
在 Keycloak 中，通过使用 <code>client scopes</code> 或 <code>dedicated</code> 将声明添加到 JWT Token 中。</p><ol><li><p>登录 Keycloak admin 控制台，切换到你自己的 realm。</p></li><li><p>通过 <code>Clients -> Create client</code> （注： -> 连接代表 Keycloak 的菜单和按钮导航）来创建新客户端，核心参数如下，注：app.example.com 为我的应用地址。</p><ul><li>Client type： OpenID Connect</li><li>Client ID：oauth2-proxy</li><li>Client authentication 勾选，打开</li><li>Authentication flow 勾选 Standard flow</li><li>Valid redirect URIs: 设置为你的应用 callback 地址，<code>https://app.example.com/oauth2/callback</code>，可以设置多个，也可以设置正则匹配，如 <code>https://app.example.com/*</code></li><li>Valid post logout redirect URIs：<code>https://app.example.com/oauth2/sign_out</code></li></ul></li><li><p>以上点保存后，从 <code>Clients -> oauth2-proxy -> Credentials</code> 页面，复制客户端密钥，下面会用到。</p></li><li><p>配置一个 <code>audience mapper</code>, 在 <code>Clients -> oauth2-proxy -> Client scopes</code>页签，此时在列表应该看到一个名字叫 <code>oauth2-proxy-dedicated</code>的，点击进去，通过 <code>Configure a new mapper</code> 按钮创建一个新的 mapper。</p><ul><li>类型选择 <code>Audience</code></li><li>名字叫 <code>aud-mapper-oauth2-proxy</code></li><li>Included Client Audience：选择 oauth2-proxy</li><li>勾选 <code>Add to ID token</code>、<code>Add to access token</code>、<code>Add to token introspection</code></li></ul><p><img src=/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes1_hu_728db06a1f97bdf5.webp width=1047 height=663 decoding=async fetchpriority=auto loading=lazy alt=keycloak-client-scopes1 id=h-rh-i-0>
<img src=/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes2_hu_f3592fde5c259c9b.webp width=1009 height=562 decoding=async fetchpriority=auto loading=lazy alt=keycloak-client-scopes2 id=h-rh-i-1>
<img src=/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes3_hu_f6c6dd1b63a892eb.webp width=940 height=537 decoding=async fetchpriority=auto loading=lazy alt=keycloak-client-scopes3 id=h-rh-i-2>
<img src=/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes4_hu_140b3cba7ce7cef4.webp width=1075 height=677 decoding=async fetchpriority=auto loading=lazy alt=keycloak-client-scopes4 id=h-rh-i-3>
<img src=/blog/traefik-oauth2-proxy-keycloak/keycloak-client-scopes5_hu_4e64faf9fc5ae862.webp width=775 height=783 decoding=async fetchpriority=auto loading=lazy alt=keycloak-client-scopes5 id=h-rh-i-4></p></li><li><p>如果想使用 oauth2-proxy 的 <code>--allowed-group</code> 验证，需要在 <code>Client scopes -> Create client scope</code> 创建一个名字叫 <code>groups</code> 的 scope，下面参数是保持 groups 后才能使用，在 groups 的 detail -> mapper 里创建 <code>Group Membership</code> 类型的 mapper。</p><ul><li>name：groups-mapper</li><li>Token Claim Name: groups</li><li>勾选 <code>Add to xxx</code>，全勾上。</li></ul></li><li><p>再回到 <code>Clients -> oauth2-proxy -> Client scopes</code>页签， <code>Add client scope</code>选择我们上一步创建的 <code>groups</code>, Add 类型选择 <code>Optional</code>。这样就能把用户的 group 加到 JWT token 里了。</p></li></ol><h3 id=oauth2-proxy-配置>oauth2-proxy 配置<a href=#oauth2-proxy-配置 class=anchor aria-hidden=true>#</a></h3><p>在开始之前我们先做出两个选择：</p><ol><li>oauth2-proxy 对接 keycloak，可以选择 <code>Keycloak OIDC</code> provider，也可以选择 <code>OpenID Connect</code> provider，这里我们选择 <code>Keycloak OIDC</code>，他比 <code>OpenID Connect</code> 多了按照 role 和 group 授权。</li><li>oauth2-proxy 对接 Traefik，可以使用 <code>errors middlewares</code> 实现，也可以使用 Redirect 实现，这两种方式在 oauth2-proxy 的文档里都有详细的说明，两种方式都能实现根据情况选择一个，配置上稍有差别，返回值对 401 和 403 的处理也不同。</li></ol><p>这里我们使用 bitnami/oauth2-proxy helm chart 部署，values.yaml 主要配置如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># service 默认 port 4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Configuration section</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>configuration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clientID</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clientSecret</span><span class=p>:</span><span class=w> </span><span class=l>&lt;%= 替换成上面创建的 clientSecret %&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># cookieSecret 创建命令： openssl rand -base64 32 | tr -- &#39;+/&#39; &#39;-_&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cookieSecret</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;iSGfyi0EbDrkg6eNJpAXGLmwN1jZDZossmElq5GgXeI=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## content 会映射到 oauth2-proxy.cfg 配置文件里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## 各个参数含义请参考 https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    reverse_proxy = true
</span></span></span><span class=line><span class=cl><span class=sd>    provider = &#34;keycloak-oidc&#34;
</span></span></span><span class=line><span class=cl><span class=sd>    provider_display_name = &#34;Keycloak&#34;
</span></span></span><span class=line><span class=cl><span class=sd>    email_domains = &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=sd>    set_xauthrequest = true
</span></span></span><span class=line><span class=cl><span class=sd>    set_authorization_header = true
</span></span></span><span class=line><span class=cl><span class=sd>    ssl_insecure_skip_verify = true
</span></span></span><span class=line><span class=cl><span class=sd>    insecure_oidc_allow_unverified_email = true
</span></span></span><span class=line><span class=cl><span class=sd>    code_challenge_method = &#34;S256&#34;
</span></span></span><span class=line><span class=cl><span class=sd>    upstreams = &#34;file:///dev/null&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 填你自己的 keycloak 服务地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>oidcIssuerUrl</span><span class=p>:</span><span class=w> </span><span class=l>https://keycloak.example.com/realms/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 不需要填 redirectUrl，由 Traefik 帮我们处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redirectUrl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span></span></span></code></pre></div></figure></div><p>再次强调，因为我们是使用 Traefik 做流量分发，oauth2-proxy 仅提供认证功能，所以这几个参数很重要。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>redirectUrl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  reverse_proxy = true
</span></span></span><span class=line><span class=cl><span class=sd>  upstreams = &#34;file:///dev/null&#34;</span></span></span></code></pre></div></figure></div><p>为了配合下面的 Traefik forwardAuth 实现 <code>authResponseHeaders</code>，还需要开启这两个参数。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  set_xauthrequest = true
</span></span></span><span class=line><span class=cl><span class=sd>  set_authorization_header = true</span></span></span></code></pre></div></figure></div><p>开启后，在 backend 服务里就能通过 Header 获取到当前用户的登录信息，以 keycloak-oidc provider 为例，获取到的 Header 如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>x-auth-request-user</span><span class=p>:</span><span class=w> </span><span class=l>af188bba-0388-2623-8cdb-39422e8be30a</span><span class=w> </span><span class=c># user database id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>x-auth-request-preferred-username</span><span class=p>:</span><span class=w> </span><span class=l>lisan123</span><span class=w> </span><span class=c># user login name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>x-auth-request-groups</span><span class=p>:</span><span class=w> </span><span class=l>admin,test-group</span><span class=w> </span><span class=c># user groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>x-auth-request-access-token</span><span class=p>:</span><span class=w> </span><span class=l>xxx</span><span class=w> </span><span class=c># Access Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>authorization</span><span class=p>:</span><span class=w> </span><span class=l>Bearer token xxx</span><span class=w> </span><span class=c># 注意这个是 ID Token，不是 Access Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cookie</span><span class=p>:</span><span class=w> </span><span class=l>xxx</span></span></span></code></pre></div></figure></div><h3 id=traefik-配置>Traefik 配置<a href=#traefik-配置 class=anchor aria-hidden=true>#</a></h3><p>Traefik 我们需要两个 Middleware：</p><ul><li>errors: 将 http 返回状态码是 401-403 的请求，重定向到 oauth2-proxy <code>/oauth2/sign_in</code> 端点。</li><li>forwardAuth：检查登录状态并设置 cookie 和 Header。</li></ul><p>先创建这两个 Middleware。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>errors-sign-in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>errors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;401-403&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/oauth2/sign_in&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>forward-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwardAuth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># oauth2-proxy k8s service 地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>http://oauth2-proxy.oauth2-proxy.svc:4180/oauth2/auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>trustForwardHeader</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 增加 header，可用 header 参考 oauth2-proxy 文档</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>authResponseHeaders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-Auth-Request-User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-Auth-Request-Preferred-Username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-Auth-Request-Access-Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-Auth-Request-Groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Authorization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Set-Cookie</span></span></span></code></pre></div></figure></div><p>创建完了，在 k8s 里可使用 traefik IngressRoute 对外暴露服务，也可使用标准 traefik ingress，看个人爱好。</p><p>因为 IngressRoute 看起来比较直观，好理解，我们先看下 IngressRoute 配置。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-ingress-route</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># annotations:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   cert-manager.io/issuer: selfsigned-issuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Host(`app.example.com`) &amp;&amp; PathPrefix(`/oauth2`)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>middlewares</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>errors-sign-in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 需要代理的应用对外暴露服务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.example.com`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>middlewares</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>errors-sign-in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>forward-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 后端应用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http-backend</span></span></span></code></pre></div></figure></div><p>使用 k8s ingress 实现，annotations 请参考 <a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-ingress/ target=_blank rel=noopener>traefik.ingress.kubernetes.io</a>
。</p><p>注意这里有两个关键点：</p><ol><li>因为 ingress 没办法像 IngressRoute 那样，为不同 path 设置不同的 middlewares，所以我们拆分成两个 ingress 定义。</li><li>traefik annotations 的 middlewares 名字定义格式为：namespace-middleware@@kubernetescrd，一定要加 namespace 前缀，如果是 default namespace 的话，也要加 <code>default-</code>前缀，否则查看 traefik 日志会看到一些 middlewares 找不到的错误，从而导致服务不生效。</li></ol><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 第一个 ingress，对应 match: &#34;Host(`app.example.com`) &amp;&amp; PathPrefix(`/oauth2`)&#34;，使用 errors-sign-in middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traefik.ingress.kubernetes.io/router.middlewares</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy-errors-sign-in@kubernetescrd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>errors-sign-in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># namespace: oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># traefik 支持泛域名拦截，如果你想给所有的 ingress 都设置 oauth2，此处可以设置为 &#34;*.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;app.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/oauth2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 根据你自己的情况设置 TLS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># tls:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   - hosts:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#       - &#34;app.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#     secretName: &#34;app.example.com-tls&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第二个 ingress，对应 match: &#34;Host(`app.example.com`)，使用 errors-sign-in,oauth2-proxy 两个 middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 这里设置 errors-sign-in,oauth2-proxy 两个 middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traefik.ingress.kubernetes.io/router.middlewares</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy-errors-sign-in@kubernetescrd,oauth2-proxy-forward-auth@kubernetescrd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>errors-sign-in-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># traefik 支持泛域名拦截，如果你想给所有的 ingress 都设置 oauth2，此处可以设置为 &#34;*.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;app.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span></span></span></code></pre></div></figure></div><h2 id=k3s-traefik-对接-oauth2-proxy-特别说明>K3S Traefik 对接 oauth2-proxy 特别说明<a href=#k3s-traefik-对接-oauth2-proxy-特别说明 class=anchor aria-hidden=true>#</a></h2><p>如果以上你的所有应用都部署在 K8S 同一个 namespace 里，就不用关注这个了。</p><p>K3S Traefik 默认未开启 <code>allowCrossNamespace</code>, 不允许跨 namespace 访问，所以如果你给其他 namespace 的应用也加上 auth Middleware，在应用上访问看不到错误就是一直没有 Auth 功能，以为是配置不生效，其实查看 K3S Traefik log 可以看到有关于 Middleware 找不到或 Service 无法访问的错误日志。</p><p>以下解决办法任选其一：</p><ol><li><p>在应用所在的 namespace 都创建 Middleware，创建 K8S ExternalName Service 指定 oauth2-proxy Service，这样 Middleware 和 Service 都在同 namespace 了。</p></li><li><p>为 Traefik 开启 <code>allowCrossNamespace</code> 配置，关于 K3S 如何使用 HelmChartConfig 定制 Traefik 配置，可参考官方文档 <a href=https://docs.k3s.io/helm#customizing-packaged-components-with-helmchartconfig target=_blank rel=noopener>Customizing Packaged Components with HelmChartConfig</a>
。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>#</span> 手动临时改配置，不推荐，可能后续更新丢失
</span></span><span class=line><span class=cl><span class=gp>$</span> kubectl -n kube-system edit deployment traefik
</span></span><span class=line><span class=cl><span class=gp>#</span> 在 args 中增加 --providers.kubernetescrd.allowCrossNamespace<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div></figure></div><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 永久生效配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># vi /var/lib/rancher/k3s/server/manifests/traefik-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>helm.cattle.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HelmChartConfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>valuesContent</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    providers:
</span></span></span><span class=line><span class=cl><span class=sd>      kubernetesCRD:
</span></span></span><span class=line><span class=cl><span class=sd>        enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>        allowCrossNamespace: true</span></span></span></code></pre></div></figure></div></li></ol><h2 id=keycloak-对接-oauth2-proxy-特别说明>Keycloak 对接 oauth2-proxy 特别说明<a href=#keycloak-对接-oauth2-proxy-特别说明 class=anchor aria-hidden=true>#</a></h2><p>Keycloak 需要创建 audience mapper 和 groups scope mapper，这在 <a href=https://oauth2-proxy.github.io/oauth2-proxy/configuration/providers/keycloak_oidc target=_blank rel=noopener>oauth2-proxy 官方文档</a>
中有详细的说明和创建步骤。</p><h2 id=oauth2-proxy-自动重定向到-keycloak-登录>oauth2-proxy 自动重定向到 keycloak 登录<a href=#oauth2-proxy-自动重定向到-keycloak-登录 class=anchor aria-hidden=true>#</a></h2><p>以上使用 traefik errors middlewares 实现的方案，有两个弊端：</p><ol><li>登录成功后的回调，无法回到原始请求页面，会丢失 oauth2-proxy 的 <code>rd</code>，只能回到根目录。</li><li>每次需要登录的时候，先停在 oauth2-proxy 的 sign-in 登录页，等着你点 <code>Sign in with</code>，需要点击一下才会跳转到 keycloak 的登录页。</li></ol><p>为了解决这个问题，我们可以定制 oauth2-proxy 的登录页 <code>sign_in.html</code>，在登录页面直接重定向，<code>sign_in.html</code> 内容如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>{{define &#34;sign_in.html&#34;}}
</span></span><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Redirecting<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nb>window</span><span class=p>.</span><span class=nx>location</span> <span class=o>=</span> <span class=s2>&#34;{{.ProxyPrefix}}/start?rd=&#34;</span> <span class=o>+</span> <span class=nb>encodeURI</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>{{end}}</span></span></code></pre></div></figure></div><p>然后给 oauth2-proxy 增加环境变量 OAUTH2_PROXY_CUSTOM_TEMPLATES_DIR 放置以上登录页面。</p><p>如果在 k8s 里，可以通过重编 oauth2-proxy 镜像，或者通过 initContainers 挂载目录复制以上文件，我已做好了一个这样的镜像，在此 <a href=https://github.com/l10178/x-container target=_blank rel=noopener>GitHub</a>
。</p><p>使用方式类似如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># copy 自定义模板，不需要点击 `Sign in` 按钮，自动重定向到登录页</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-sign-in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 源码： https://github.com/l10178/x-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/nxest/oauth2-proxy-auto-sign-in:v7.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OAUTH2_PROXY_CUSTOM_TEMPLATES_DIR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/bitnami/oauth2-proxy/templates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/bitnami/oauth2-proxy/templates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>templates</span></span></span></code></pre></div></figure></div><h2 id=nginx-使用-auth_request-对接-oauth2-proxy>nginx 使用 auth_request 对接 oauth2-proxy<a href=#nginx-使用-auth_request-对接-oauth2-proxy class=anchor aria-hidden=true>#</a></h2><p>原理同 Traefik，将 /oauth2 相关请求交给 oauth2-proxy 服务，认证通过后 proxy_pass 到后端服务，注意设置 Header 和 Cookie。</p><p>另外注意下这一行 <code>auth_request /oauth2/auth;</code>，前面我们提到 auth endpoint 后面可以追加 query parameters <code>allowed_groups/allowed_emails</code>，在 nginx 里我们可以根据不同 server 或 location 设置不同的 group，类似 <code>auth_request /oauth2/auth?allowed_groups=cms-admin;</code>, 这样不就组成了一个简单的基于 Group 的权限认证。</p><p>如果想根据用户属性代理到不同的服务实例或路径，把 <code>proxy_pass http://backend/;</code> 用 lua if else 包装一下，不就实现了一个简单的路由功能。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=s>/oauth2/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span>       <span class=s>http://oauth2-proxy.svc:4180</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Host</span>                    <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span>               <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Scheme</span>                <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Auth-Request-Redirect</span> <span class=nv>$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># or, if you are handling multiple domains:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=p>=</span> <span class=s>/oauth2/auth</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span>       <span class=s>http://oauth2-proxy.svc:4180</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Host</span>             <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span>        <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Scheme</span>         <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># nginx auth_request includes headers but not body
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>proxy_set_header</span> <span class=s>Content-Length</span>   <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass_request_body</span>           <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>auth_request</span> <span class=s>/oauth2/auth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>error_page</span> <span class=mi>401</span> <span class=p>=</span> <span class=s>/oauth2/sign_in</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># pass information via X-User and X-Email headers to backend,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># requires running with --set-xauthrequest flag
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$user</span>   <span class=nv>$upstream_http_x_auth_request_user</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>auth_request_set</span> <span class=nv>$email</span>  <span class=nv>$upstream_http_x_auth_request_email</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-User</span>  <span class=nv>$user</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Email</span> <span class=nv>$email</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># if you enabled --pass-access-token, this will pass the token to the backend
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$token</span>  <span class=nv>$upstream_http_x_auth_request_access_token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Access-Token</span> <span class=nv>$token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># if you enabled --cookie-refresh, this is needed for it to work with auth_request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$auth_cookie</span> <span class=nv>$upstream_http_set_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>add_header</span> <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># When using the --set-authorization-header flag, some provider&#39;s cookies can exceed the 4kb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># limit and so the OAuth2 Proxy splits these into multiple parts.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># Nginx normally only copies the first `Set-Cookie` header from the auth_request to the response,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># so if your cookies are larger than 4kb, you will need to extract additional cookies manually.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$auth_cookie_name_upstream_1</span> <span class=nv>$upstream_cookie_auth_cookie_name_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Extract the Cookie attributes from the first Set-Cookie header and append them
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># to the second part ($upstream_cookie_* variables only contain the raw cookie content)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$auth_cookie</span> <span class=p>~</span><span class=sr>*</span> <span class=s>&#34;(</span><span class=p>;</span> <span class=kn>.*)&#34;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>set</span> <span class=nv>$auth_cookie_name_0</span> <span class=nv>$auth_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>set</span> <span class=nv>$auth_cookie_name_1</span> <span class=s>&#34;auth_cookie_name_1=</span><span class=nv>$auth_cookie_name_upstream_1$1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Send both Set-Cookie headers now if there was a second part
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$auth_cookie_name_upstream_1</span><span class=s>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie_name_0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie_name_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span> <span class=s>http://backend/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># or &#34;root /path/to/site;&#34; or &#34;fastcgi_pass ...&#34; etc
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>如果是在 K8S 内使用 nginx ingress controller 实现，请参考官方文档将以上配置转换为注解和 lua 片段，类似如下设置。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nginx.ingress.kubernetes.io/auth-signin</span><span class=p>:</span><span class=w> </span><span class=l>https://$host/oauth2/start?rd=$escaped_request_uri</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nginx.ingress.kubernetes.io/auth-url</span><span class=p>:</span><span class=w> </span><span class=l>https://$host/oauth2/auth</span></span></span></code></pre></div></figure></div><h2 id=遇见问题和解决办法>遇见问题和解决办法<a href=#遇见问题和解决办法 class=anchor aria-hidden=true>#</a></h2><p>我们使用过程中遇见的问题和解决办法，记录下来仅供参考。</p><ul><li><p>traefik middleware 配置未生效。</p><p>检查 traefik 日志，看看有没有错误，如果有语法错误或者权限问题，traefik 也能正常启动，只是配置不生效。</p></li><li><p>traefik log 中 middleware 找不到，请参考本文上面说明，将 middlewares 名字改为：namespace-middleware@@kubernetescrd，一定要加 namespace 前缀，如果是 default namespace 的话，也要加 <code>default-</code> 前缀。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>level=error msg=&#34;middleware \&#34;errors-sign-in@kubernetes\&#34; does not exist&#34; entryPointName=web routerName=oauth2-proxy-errors-sign-in-sign-in-example-com-oauth2@kubernetes
</span></span></span></code></pre></div></figure></div></li><li><p>oauth2-proxy 能重定向到登录页面，输入密码登录成功，回调到 callback 时出现下面这个错误，原因是缺少 audience mapper，参考本文上面介绍增加 mapper。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>500 Internal Server Error
</span></span></span><span class=line><span class=cl><span class=go>Oops! Something went wrong. For more information contact your server administrator.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[oauthproxy.go:902] Error creating session during OAuth2 callback: audience from claim aud with value [account] does not match with any of allowed audiences map[oauth2-proxy:{}]
</span></span></span></code></pre></div></figure></div></li></ul><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"><div class=last-modified><a href=https://github.com/xlabs-club/xlabs-club.github.io/commit/daade68fd25a1f0fa01c53a2df9c413e8f7d11f5><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Last updated on 2025年7月27日</a></div><div class=edit-page><a href=https://github.com/xlabs-club/xlabs-club.github.io/blob/main/content//blog/traefik-oauth2-proxy-keycloak/index.md><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
Edit this page on GitHub</a></div></div><div class="page-nav d-flex flex-column flex-sm-row"><div class="card w-100"><div class="card-body d-flex"><div class="d-flex flex-column justify-content-center"><svg class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M5 12l6 6"/><path d="M5 12l6-6"/></svg></div><div class="d-flex flex-column"><div class=text-body-secondary>Prev</div><a href=/blog/backstage-keycloak-oauth2-proxy/ class="stretched-link text-reset text-decoration-none">Backstage 集成 oauth2-proxy 和 Keycloak，实现用户管理、登录认证以及 RBAC、ABAC 授权</a></div></div></div><div class=m-2></div><div class="card text-end w-100"><div class="card-body d-flex justify-content-end"><div class="d-flex flex-column"><div class=text-body-secondary>Next</div><a href=/blog/xlabs-link-exchange/ class="stretched-link text-reset text-decoration-none">卫星实验室友情链接</a></div><div class="d-flex flex-column justify-content-center"><svg class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M13 18l6-6"/><path d="M13 6l6 6"/></svg></div></div></div></div></main></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.8b717d53dae071196d91d0d0c63650fe240e84ffe50a76fdb433a914d6b216ec.js integrity="sha256-i3F9U9rgcRltkdDQxjZQ/iQOhP/lCnb9tDOpFNayFuw="></script><script async src=/js/app.e5f0197b4049f745883cbc7d1b4fc3c4b18b834887097912f5840adf8dea4264.js integrity="sha256-5fAZe0BJ90WIPLx9G0/DxLGLg0iHCXkS9YQK343qQmQ="></script><script async src=/js/docsearch.9b6c50e883968304dd308427d775dc80fb2da495f60d6f657f3e80f4552dd32e.js integrity="sha256-m2xQ6IOWgwTdMIQn13XcgPstpJX2DW9lfz6A9FUt0y4="></script></body></html>