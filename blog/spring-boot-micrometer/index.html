<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.dce5fe2fbf2034c13477c81ccddda34c2a0e4f05bd87e5ba97eb8d4bdbf174bca8bb55dcba072e7fb3a2007bc1a66e93305dd7b18e5e215aa8297b598554d17e.css" integrity="sha512-3OX+L78gNME0d8gczd2jTCoOTwW9h+W6l+uNS9vxdLyou1Xcugcuf7OiAHvBpm6TMF3XsY5eIVqoKXtZhVTRfg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/spring-boot-micrometer/><link rel=canonical href=https://www.xlabs.club/blog/spring-boot-micrometer/><title>Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标 — XLabs</title><meta name=description content="Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:url" content="https://www.xlabs.club/blog/spring-boot-micrometer/"><meta property="og:site_name" content="XLabs"><meta property="og:title" content="Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标"><meta property="og:description" content="Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-08-07T10:54:37+08:00"><meta property="article:modified_time" content="2025-09-04T21:33:38+08:00"><meta property="article:tag" content="Spring Boot"><meta property="article:tag" content="Java"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标"><meta name=twitter:description content="Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标","description":"Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标","isPartOf":{"@id":"https://www.xlabs.club/blog/spring-boot-micrometer/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/spring-boot-micrometer/"},"datePublished":"2023-08-07T10:54:37+08:00","dateModified":"2025-09-04T21:33:38+08:00","author":{"@type":"Organization","name":"XLabs Club 卫星实验室","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club 卫星实验室"}}]}</script><meta http-equiv=content-language content='zh-cn'></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu">
<svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close>
<svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/blog/xlabs-link-exchange>Links</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme">
<svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg>
<svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="container p-0"><article><div class="row justify-content-center"><div class="col-md-12 col-lg-11"><div class=blog-header><h1>Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标</h1><p><small>2023年8月7日&nbsp;&nbsp;<a class="stretched-link position-relative link-muted" href=/categories/spring-boot/>Spring Boot</a>, <a class="stretched-link position-relative link-muted" href=/categories/java/>Java</a>&nbsp;&nbsp;<a class="stretched-link position-relative" href=/contributors/l10178/>l10178</a><span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>3&nbsp;minutes</span></small></p></div></div><div class="col-md-12 col-lg-11"><p>Spring Boot 使用 Micrometer 集成 Prometheus 监控，5 分钟接入自定义监控指标，主要内容：</p><ol><li>Micrometer 介绍。</li><li>业务如何自定义指标，如何接入 Prometheus，实现方式和规范。</li></ol><h2 id=micrometer-介绍>Micrometer 介绍</h2><p>Micrometer 为 Java 平台上的性能数据收集提供了一个通用的 API，应用程序只需要使用 Micrometer 的通用 API 来收集性能指标，Micrometer 会负责完成与不同监控系统的适配工作。</p><p>Micrometer 提供了多种度量指标类型（Timers、Guauges、Counters 等），同时支持接入不同的监控系统，例如 Influxdb、Graphite、Prometheus、OTLP 等。</p><p>从 Spring Boot 2.x 开始使用 Micrometer 作为默认的监控门面接口， <code>Think SLF4J, but for observability</code> 。</p><h3 id=micrometer-核心概念>Micrometer 核心概念</h3><p>Micrometer 中两个最核心的概念：计量器注册表 (MeterRegistry)，计量器 (Meter)。</p><ul><li><p>MeterRegistry</p><ul><li>内存注册表 (SimpleMeterRegistry): 在内存中保存每一个 Meter（指标）的最新值，并且不会将数据导出到任何地方。</li><li>组合注册表 (CompositeMeterRegistry): 可以添加多个注册表，用于将各个注册表组合起来，可以同时将指标发布到多个监控系统。Micrometer 提供了一个全局的 MeterRegistry，<code>io.micrometer.core.instrument.Metrics</code> 中持有一个静态 final 的 CompositeMeterRegistry 实例 globalRegistry。</li><li>普罗米修斯注册表 (PrometheusMeterRegistry): 当使用普罗米修斯监控时，引入 micrometer-registry-prometheus 依赖时会提供此种收集器，用于将指标数据转换为普罗米修斯识别的格式和导出数据等功能。</li></ul></li><li><p>Meter（指标）</p><p>监控数据的整个过程都是围绕着 Meter（指标）, 通过一个一个的 Meter（指标）数据来进行观察应用的状态。常用的指标如：</p><ul><li>Counter（计数器）: 单一计数指标，允许按固定数量递增，用来统计无上限数据。只允许递增。</li><li>Gauge（仪表盘）: 表示单个的变化的值，例如温度，气压。用于统计有上限可增可减的数据。在每次取样时，Gauge 会返回当前值。</li><li>Timer（计时器）: 通常用来记录事件的持续时间。Timer 会记录两类的数据，事件的数量和总的持续时间。</li></ul></li><li><p>Tag（标签）</p><p>Mircrometer 通过 Tag（标签）实现了多维度的度量数据收集，通过 Tag 的命名可以推断出其指向的数据代表什么维度或是什么类型的度量指标。</p></li></ul><h2 id=我们的实现方式和要求>我们的实现方式和要求</h2><p>总体架构：Spring Boot Actuator + Micrometer + Prometheus + Granfana。</p><ul><li>Spring Boot Micrometer：提供监控门面 Api。</li><li>Spring Boot Actuator：提供监控指标采集服务，通过 <code>/actuator/prometheus</code> 获取数据。</li><li>Prometheus + Granfana：采集和存储数据，提供图表展示，另外 Granfana 可根据指标配置告警规则发出告警。</li></ul><p>总体实现步骤如下：</p><ol><li><p>Spring Boot Actuator 放开 <code>prometheus</code> http 访问，在配置文件中增加以下配置。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>management.endpoint.prometheus.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoints.web.exposure.include</span><span class=o>=</span><span class=s>info,health,metrics,prometheus</span>
</span></span><span class=line><span class=cl><span class=na>management.metrics.export.prometheus.enabled</span><span class=o>=</span><span class=s>true</span></span></span></code></pre></div></figure></div></li><li><p>创建 Prometheus ServiceMonitor 或 PodMonitor，从 <code>/actuator/prometheus</code> path 采集指标，如果涉及多个 war 合并部署到一个 tomcat 的，从多个 path 采集。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>your-prometheus-instance-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>eye-consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>honorLabels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># /client-biz 是我的服务 ContextPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/client-biz/actuator/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>honorLabels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/gateway-biz/actuator/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobLabel</span><span class=p>:</span><span class=w> </span><span class=l>eye-consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>eye-consumer</span></span></span></code></pre></div></figure></div></li><li><p>业务可通过 <code>http://localhost:8080/actuator/metrics</code> 查看指标是否已上报，通过 <code>http://localhost:8080/actuator/prometheus</code> 查看指标的当前值。</p></li></ol><h2 id=自定义-metrics-指标>自定义 Metrics 指标</h2><p>在 Spring Boot 中实现自定义指标非常简单，几种方式举例如下。</p><ol><li>像使用 slf4j 一样，使用 <code>io.micrometer.core.instrument.Metrics</code> 静态方式初始化一个指标，然后使用此指标直接操作。</li><li>使用 <code>@Timed @Counted</code> 注解。注意注解方式必须等方法调用后才能生成指标。而静态方法形式 <code>io.micrometer.core.instrument.Metrics.counter</code>立即就生成指标只是值为 0。另外注意 Spring 注解不支持 private、default 级别方法。</li><li>使用 Autowired MeterRegistry 创建自己的指标类型，适合一些动态 Tag 等高级定制场景。</li></ol><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.micrometer.core.annotation.Counted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.micrometer.core.instrument.Counter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.micrometer.core.instrument.Metrics</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Service</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MicrometerSampleService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 方式 1：像使用 slf4j 一样，使用 `io.micrometer.core.instrument.Metrics`静态方式初始化一个计数器，适用于名字和 Tag 固定的场景
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Counter</span><span class=w> </span><span class=n>failure</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Metrics</span><span class=p>.</span><span class=na>counter</span><span class=p>(</span><span class=s>&#34;fs.sms.send&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;result&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;failure&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>MeterRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendSms</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>failure</span><span class=p>.</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 方式 2：使用注解的方式，注意需要引入 spring-boot-starter-aop 依赖
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Counted</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;fs.sms.send&#34;</span><span class=p>,</span><span class=w> </span><span class=n>extraTags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;provider&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;huawei&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendByHuawei</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sendSms</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Counted</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;fs.sms.send&#34;</span><span class=p>,</span><span class=w> </span><span class=n>extraTags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;provider&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ali&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendByAli</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sendSms</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 方式 3：使用 MeterRegistry，适合一些动态 Tag 等高级定制场景
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param result result
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>countByResult</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>.</span><span class=na>counter</span><span class=p>(</span><span class=s>&#34;fs.sms.send&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;result&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>).</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Counter</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=s>&#34;fs.sms.send&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>description</span><span class=p>(</span><span class=s>&#34;send sms&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>tags</span><span class=p>(</span><span class=s>&#34;result&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>registry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>Spring Boot 无法直接使用 <code>@Timed @Counted</code> 注解，需要引入切面支持，需要引入 spring-boot-starter-aop 依赖。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MicrometerAspectConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>CountedAspect</span><span class=w> </span><span class=nf>countedAspect</span><span class=p>(</span><span class=n>MeterRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountedAspect</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>TimedAspect</span><span class=w> </span><span class=nf>timedAspect</span><span class=p>(</span><span class=n>MeterRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TimedAspect</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>另外这里大家可能有个疑惑，我的请求量很大，<code>Metrics.counter</code> 对象是不是每次都 new 出来的，要不要缓存起来，减少获取 counter 对象的压力。</p><p>其实不用，MeterRegistry 已经做了缓存，参考 <code>io.micrometer.core.instrument.MeterRegistry#registerMeterIfNecessary</code> 以下代码片段。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>M</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Meter</span><span class=o>&gt;</span><span class=w> </span><span class=n>M</span><span class=w> </span><span class=nf>registerMeterIfNecessary</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>M</span><span class=o>&gt;</span><span class=w> </span><span class=n>meterClass</span><span class=p>,</span><span class=w> </span><span class=n>Meter</span><span class=p>.</span><span class=na>Id</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>DistributionStatisticConfig</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>BiFunction</span><span class=o>&lt;</span><span class=n>Meter</span><span class=p>.</span><span class=na>Id</span><span class=p>,</span><span class=w> </span><span class=n>DistributionStatisticConfig</span><span class=p>,</span><span class=w> </span><span class=n>M</span><span class=o>&gt;</span><span class=w> </span><span class=n>builder</span><span class=p>,</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;</span><span class=n>Meter</span><span class=p>.</span><span class=na>Id</span><span class=p>,</span><span class=w> </span><span class=n>M</span><span class=o>&gt;</span><span class=w> </span><span class=n>noopBuilder</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Meter</span><span class=p>.</span><span class=na>Id</span><span class=w> </span><span class=n>mappedId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getMappedId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Meter</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getOrCreateMeter</span><span class=p>(</span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>builder</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>mappedId</span><span class=p>,</span><span class=w> </span><span class=n>noopBuilder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>meterClass</span><span class=p>.</span><span class=na>isInstance</span><span class=p>(</span><span class=n>m</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;There is already a registered meter of a different type (%s vs. %s) with the same name: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>(),</span><span class=w> </span><span class=n>meterClass</span><span class=p>.</span><span class=na>getSimpleName</span><span class=p>(),</span><span class=w> </span><span class=n>id</span><span class=p>.</span><span class=na>getName</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Meter</span><span class=p>)</span><span class=n>meterClass</span><span class=p>.</span><span class=na>cast</span><span class=p>(</span><span class=n>m</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=自定义指标高级配置>自定义指标高级配置</h3><p>Spring 默认注入的 MeterRegistry 是一个 CompositeMeterRegistry，如果想定制可注入自定义 MeterRegistryCustomizer Bean。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MicrometerConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MeterRegistryCustomizer</span><span class=o>&lt;</span><span class=n>MeterRegistry</span><span class=o>&gt;</span><span class=w> </span><span class=nf>configurer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>registry</span><span class=p>.</span><span class=na>config</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>commonTags</span><span class=p>(</span><span class=s>&#34;group&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;sample&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>commonTags</span><span class=p>(</span><span class=s>&#34;application&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;sample&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>如果只是想为当前应用增加 Tag，可直接通过配置文件增加，示例如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>management.metrics.tags.biz</span><span class=o>=</span><span class=s>sample</span>
</span></span><span class=line><span class=cl><span class=na>management.metrics.tags.application</span><span class=o>=</span><span class=s>${spring.application.name}</span></span></span></code></pre></div></figure></div><h3 id=自定义指标规范>自定义指标规范</h3><ol><li><p>指标和 Tag 命名约定使用英语句号分隔，全小写，Tag 可根据实际情况使用缩写。指标名在不同的 MeterRegistry 里会自动转换，比如在 Prometheus 会把 <code>fs.sms.send</code> 转换为 <code>fs_sms_send</code>。</p></li><li><p>指标命名建议以 <code>fs.application.action</code> 为模板，避免与开源或其他项目组冲突。</p></li><li><p>注意 Tag values 不能为 Null， 且必须是可枚举的某些固定类型便于统计。</p></li><li><p>使用注解 <code>@Timed @Counted</code> 会默认增加 <code>method、class、result、exception</code> 这几个 Tag，注意不要与之冲突。</p></li><li><p>在 K8S 集群内，公司和开源默认 Tag 如下，这些会被 ServiceMonitor 强制覆盖，业务不要自己定义。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>namespace、application、service、container、pod、instance、job、endpoint、id
</span></span></span></code></pre></div></figure></div></li><li><p>编码中如果需要 MeterRegistry，不允许引用具体实现（比如 Prometheus 的 io.prometheus.client.CollectorRegistry），而是使用 Micrometer 提供的统一接口 <code>MeterRegistry</code>。类比，在打印日志时不允许直接使用 logback 或 log4j api，而是使用 slf4j api.</p></li><li><p>不要自己 new MeterRegistry，而是使用自动注入的或静态方法。</p></li><li><p>建议为指标加上 <code>description</code> 字段。</p></li></ol><h2 id=最佳实践>最佳实践</h2><ol><li><p>合理规划 Tag，一个 Meter 具体类型需要通过名字和 Tag 作为它的唯一标识，这样做的好处是可以使用名字进行标记，通过不同的 Tag 去区分多种维度进行数据统计。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>反例 1（全部用 name 区分，无 Tag，重复计量，无法多维度分析汇聚）：
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.all&#34;);
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.aliyun&#34;);
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.huaweiyun&#34;);
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>正例：
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.send&#34;,&#34;provider&#34;,&#34;ali&#34;);
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.send&#34;,&#34;provider&#34;,&#34;huawei&#34;,&#34;result&#34;,&#34;success&#34;);
</span></span></span></code></pre></div></figure></div></li><li><p>避免无意义不可枚举的 Tag，混乱的 Tag 比无 Tag 更难管理。</p></li></ol><div class=tag-list-single><a class="btn btn-light" href=/tags/spring-boot/ role=button>Spring Boot</a>
<a class="btn btn-light" href=/tags/java/ role=button>Java</a></div></div></div></article></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.8b717d53dae071196d91d0d0c63650fe240e84ffe50a76fdb433a914d6b216ec.js integrity="sha256-i3F9U9rgcRltkdDQxjZQ/iQOhP/lCnb9tDOpFNayFuw="></script><script async src=/js/app.e5f0197b4049f745883cbc7d1b4fc3c4b18b834887097912f5840adf8dea4264.js integrity="sha256-5fAZe0BJ90WIPLx9G0/DxLGLg0iHCXkS9YQK343qQmQ="></script><script async src=/js/docsearch.9b6c50e883968304dd308427d775dc80fb2da495f60d6f657f3e80f4552dd32e.js integrity="sha256-m2xQ6IOWgwTdMIQn13XcgPstpJX2DW9lfz6A9FUt0y4="></script></body></html>