<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.974962bbf902e2bb09d5f947751229907fea343148efc12fbb1ca3b61b799d102d62009b941a5835deabeee0a1d832801e2e7e8ffc5c4f77f2632d7d669f2736.css" integrity="sha512-l0liu/kC4rsJ1flHdRIpkH/qNDFI78Evuxyjtht5nRAtYgCblBpYNd6r7uCh2DKAHi5+j/xcT3fyYy19Zp8nNg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/migration-spring-boot-3-to-4/><link rel=canonical href=https://www.xlabs.club/blog/migration-spring-boot-3-to-4/><title>Spring Boot 4 迁移指南：从 3.x 升级到 4.0 完整教程与踩坑实战</title><meta name=description content="Spring Boot 4.0 迁移实战指南，涵盖新特性解析、废弃 API 处理、Spring Framework 7/Tomcat 11 变更、虚拟线程配置、常见问题与 OpenRewrite 自动化迁移工具"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:url" content="https://www.xlabs.club/blog/migration-spring-boot-3-to-4/"><meta property="og:site_name" content="XLabs"><meta property="og:title" content="Spring Boot 3 到 4 迁移完全指南：新特性、废弃功能与实战踩坑经验"><meta property="og:description" content="深度解析 Spring Boot 4.0 新特性，包含 Spring Framework 7、Tomcat 11、虚拟线程支持、模块化改造等核心变更，提供完整的迁移步骤、常见问题解决方案和自动化迁移工具使用指南"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-11-25T23:20:22+08:00"><meta property="article:modified_time" content="2025-12-13T15:47:38+08:00"><meta property="article:tag" content="Spring Boot"><meta property="article:tag" content="Spring Boot 4"><meta property="article:tag" content="Spring Framework 7"><meta property="article:tag" content="Jakarta EE"><meta property="article:tag" content="Tomcat 11"><meta property="article:tag" content="Virtual Threads"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="Spring Boot 3 到 4 迁移完全指南：新特性、废弃功能与实战踩坑经验"><meta name=twitter:description content="深度解析 Spring Boot 4.0 新特性，包含 Spring Framework 7、Tomcat 11、虚拟线程支持、模块化改造等核心变更，提供完整的迁移步骤、常见问题解决方案和自动化迁移工具使用指南"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"Spring Boot 3 到 4 迁移完全指南：新特性、废弃功能与实战踩坑经验","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"Spring Boot 4 迁移指南：从 3.x 升级到 4.0 完整教程与踩坑实战","description":"Spring Boot 4.0 迁移实战指南，涵盖新特性解析、废弃 API 处理、Spring Framework 7\/Tomcat 11 变更、虚拟线程配置、常见问题与 OpenRewrite 自动化迁移工具","isPartOf":{"@id":"https://www.xlabs.club/blog/migration-spring-boot-3-to-4/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/migration-spring-boot-3-to-4/"},"datePublished":"2025-11-25T23:20:22+08:00","dateModified":"2025-12-13T15:47:38+08:00","author":{"@type":"Organization","name":"XLabs Club 卫星实验室","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club 卫星实验室"}}]}</script><meta http-equiv=content-language content='zh-cn'></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu">
<svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close>
<svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/blog/xlabs-link-exchange>Links</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme">
<svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg>
<svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col container-fw d-lg-flex flex-lg-row justify-content-center mx-auto"><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>目录</h3><nav id=toc><ul><li><a href=#spring-boot-40-核心新特性>Spring Boot 4.0 核心新特性</a><ul><li><a href=#模块化架构>模块化架构</a></li><li><a href=#增强的配置属性元数据>增强的配置属性元数据</a></li><li><a href=#任务调度增强>任务调度增强</a></li><li><a href=#包结构变化>包结构变化</a></li></ul></li><li><a href=#spring-framework-70-带来的增强>Spring Framework 7.0 带来的增强</a><ul><li><a href=#api-版本控制>API 版本控制</a></li><li><a href=#jspecify-空安全注解>JSpecify 空安全注解</a></li><li><a href=#多线程异步启动>多线程异步启动</a></li><li><a href=#http-接口客户端>HTTP 接口客户端</a></li><li><a href=#内置弹性功能resilience>内置弹性功能（Resilience）</a></li><li><a href=#流式-jms-客户端-apijmsclient>流式 JMS 客户端 API（JmsClient）</a></li><li><a href=#统一消息转换unified-message-conversion>统一消息转换（Unified Message Conversion）</a></li><li><a href=#jakarta-ee-11-升级>Jakarta EE 11 升级</a></li><li><a href=#junit-4-和-jackson-2x-弃用>JUnit 4 和 Jackson 2.x 弃用</a></li><li><a href=#测试上下文暂停机制>测试上下文暂停机制</a></li><li><a href=#spel-增强>SpEL 增强</a></li><li><a href=#程序化-bean-注册beanregistrar>程序化 Bean 注册（BeanRegistrar）</a></li></ul></li><li><a href=#tomcat-11-核心变更>Tomcat 11 核心变更</a><ul><li><a href=#虚拟线程支持java-21>虚拟线程支持（Java 21+）</a></li><li><a href=#websocket-22-性能提升>WebSocket 2.2 性能提升</a></li><li><a href=#servlet-61-异步处理改进>Servlet 6.1 异步处理改进</a></li><li><a href=#安全增强>安全增强</a></li><li><a href=#最低-java-版本要求>最低 Java 版本要求</a></li><li><a href=#openssl-支持java-22>OpenSSL 支持（Java 22+）</a></li><li><a href=#javax-到-jakarta-命名空间迁移>javax. <em>到 jakarta.</em> 命名空间迁移</a></li><li><a href=#http-header-大小写处理变化>HTTP Header 大小写处理变化</a></li></ul></li><li><a href=#废弃功能与破坏性变更>废弃功能与破坏性变更</a><ul><li><a href=#移除的废弃-api>移除的废弃 API</a></li><li><a href=#mockitotestexecutionlistener-移除>MockitoTestExecutionListener 移除</a></li><li><a href=#websecurityconfigureradapter-移除>WebSecurityConfigurerAdapter 移除</a></li><li><a href=#undertow-支持移除>Undertow 支持移除</a></li><li><a href=#spring-batch-默认行为变更>Spring Batch 默认行为变更</a></li><li><a href=#reactive-pulsar-支持移除>Reactive Pulsar 支持移除</a></li><li><a href=#embedded-executable-uber-jar-launch-scripts-移除>Embedded Executable Uber Jar Launch Scripts 移除</a></li><li><a href=#spring-session-hazelcastmongodb-移除>Spring Session Hazelcast/MongoDB 移除</a></li></ul></li><li><a href=#常见问题与解决方案>常见问题与解决方案</a><ul><li><a href=#http-header-大小写问题>HTTP Header 大小写问题</a></li><li><a href=#编译时-nullability-错误>编译时 Nullability 错误</a></li><li><a href=#jackson-3x-序列化问题>Jackson 3.x 序列化问题</a></li><li><a href=#第三方库不兼容>第三方库不兼容</a></li><li><a href=#spring-batch-元数据丢失>Spring Batch 元数据丢失</a></li><li><a href=#undertow-无法使用>Undertow 无法使用</a></li><li><a href=#虚拟线程性能未达预期>虚拟线程性能未达预期</a></li><li><a href=#测试上下文缓存问题>测试上下文缓存问题</a></li></ul></li><li><a href=#自动化迁移工具>自动化迁移工具</a><ul><li><a href=#openrewrite>OpenRewrite</a></li><li><a href=#spring-boot-migrator>Spring Boot Migrator</a></li><li><a href=#windup-red-hat>Windup (Red Hat)</a></li><li><a href=#intellij-idea-迁移助手>IntelliJ IDEA 迁移助手</a></li><li><a href=#eclipse-transformer>Eclipse Transformer</a></li></ul></li><li><a href=#参考资料>参考资料</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#技术文章>技术文章</a></li><li><a href=#迁移经验>迁移经验</a></li><li><a href=#虚拟线程>虚拟线程</a></li><li><a href=#迁移工具>迁移工具</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>Spring Boot 3 到 4 迁移完全指南：新特性、废弃功能与实战踩坑经验</h1><nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation"><details><summary>目录</summary><div class=page-links><nav id=TableOfContents><ul><li><a href=#spring-boot-40-核心新特性>Spring Boot 4.0 核心新特性</a><ul><li><a href=#模块化架构>模块化架构</a></li><li><a href=#增强的配置属性元数据>增强的配置属性元数据</a></li><li><a href=#任务调度增强>任务调度增强</a></li><li><a href=#包结构变化>包结构变化</a></li></ul></li><li><a href=#spring-framework-70-带来的增强>Spring Framework 7.0 带来的增强</a><ul><li><a href=#api-版本控制>API 版本控制</a></li><li><a href=#jspecify-空安全注解>JSpecify 空安全注解</a></li><li><a href=#多线程异步启动>多线程异步启动</a></li><li><a href=#http-接口客户端>HTTP 接口客户端</a></li><li><a href=#内置弹性功能resilience>内置弹性功能（Resilience）</a></li><li><a href=#流式-jms-客户端-apijmsclient>流式 JMS 客户端 API（JmsClient）</a></li><li><a href=#统一消息转换unified-message-conversion>统一消息转换（Unified Message Conversion）</a></li><li><a href=#jakarta-ee-11-升级>Jakarta EE 11 升级</a></li><li><a href=#junit-4-和-jackson-2x-弃用>JUnit 4 和 Jackson 2.x 弃用</a></li><li><a href=#测试上下文暂停机制>测试上下文暂停机制</a></li><li><a href=#spel-增强>SpEL 增强</a></li><li><a href=#程序化-bean-注册beanregistrar>程序化 Bean 注册（BeanRegistrar）</a></li></ul></li><li><a href=#tomcat-11-核心变更>Tomcat 11 核心变更</a><ul><li><a href=#虚拟线程支持java-21>虚拟线程支持（Java 21+）</a></li><li><a href=#websocket-22-性能提升>WebSocket 2.2 性能提升</a></li><li><a href=#servlet-61-异步处理改进>Servlet 6.1 异步处理改进</a></li><li><a href=#安全增强>安全增强</a></li><li><a href=#最低-java-版本要求>最低 Java 版本要求</a></li><li><a href=#openssl-支持java-22>OpenSSL 支持（Java 22+）</a></li><li><a href=#javax-到-jakarta-命名空间迁移>javax. <em>到 jakarta.</em> 命名空间迁移</a></li><li><a href=#http-header-大小写处理变化>HTTP Header 大小写处理变化</a></li></ul></li><li><a href=#废弃功能与破坏性变更>废弃功能与破坏性变更</a><ul><li><a href=#移除的废弃-api>移除的废弃 API</a></li><li><a href=#mockitotestexecutionlistener-移除>MockitoTestExecutionListener 移除</a></li><li><a href=#websecurityconfigureradapter-移除>WebSecurityConfigurerAdapter 移除</a></li><li><a href=#undertow-支持移除>Undertow 支持移除</a></li><li><a href=#spring-batch-默认行为变更>Spring Batch 默认行为变更</a></li><li><a href=#reactive-pulsar-支持移除>Reactive Pulsar 支持移除</a></li><li><a href=#embedded-executable-uber-jar-launch-scripts-移除>Embedded Executable Uber Jar Launch Scripts 移除</a></li><li><a href=#spring-session-hazelcastmongodb-移除>Spring Session Hazelcast/MongoDB 移除</a></li></ul></li><li><a href=#常见问题与解决方案>常见问题与解决方案</a><ul><li><a href=#http-header-大小写问题>HTTP Header 大小写问题</a></li><li><a href=#编译时-nullability-错误>编译时 Nullability 错误</a></li><li><a href=#jackson-3x-序列化问题>Jackson 3.x 序列化问题</a></li><li><a href=#第三方库不兼容>第三方库不兼容</a></li><li><a href=#spring-batch-元数据丢失>Spring Batch 元数据丢失</a></li><li><a href=#undertow-无法使用>Undertow 无法使用</a></li><li><a href=#虚拟线程性能未达预期>虚拟线程性能未达预期</a></li><li><a href=#测试上下文缓存问题>测试上下文缓存问题</a></li></ul></li><li><a href=#自动化迁移工具>自动化迁移工具</a><ul><li><a href=#openrewrite>OpenRewrite</a></li><li><a href=#spring-boot-migrator>Spring Boot Migrator</a></li><li><a href=#windup-red-hat>Windup (Red Hat)</a></li><li><a href=#intellij-idea-迁移助手>IntelliJ IDEA 迁移助手</a></li><li><a href=#eclipse-transformer>Eclipse Transformer</a></li></ul></li><li><a href=#参考资料>参考资料</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#技术文章>技术文章</a></li><li><a href=#迁移经验>迁移经验</a></li><li><a href=#虚拟线程>虚拟线程</a></li><li><a href=#迁移工具>迁移工具</a></li></ul></li></ul></nav></div></details></nav><p>2025 年 11 月，Spring Boot 4.0 正式发布，这次升级被业界称为<strong>爆炸性升级</strong>。</p><p>本文基于 Spring Boot 官方文档和实际生产环境迁移经验，为你提供一份<strong>完整、实用、可执行</strong>的 Spring Boot 3 到 4 迁移指南。主要包括：</p><ul><li>✅ <strong>全面的新特性解析</strong>：模块化架构、虚拟线程、Spring Framework 7.0 增强等核心变更深度解读</li><li>✅ <strong>详细的迁移步骤</strong>：从评估到部署的完整流程，包含分阶段迁移策略和检查清单</li><li>✅ <strong>实战踩坑经验</strong>：HTTP Header 大小写、Jackson 序列化、Spring Batch 元数据等常见问题的解决方案</li><li>✅ <strong>自动化工具指南</strong>：OpenRewrite、Spring Boot Migrator 等工具的使用方法和最佳实践</li><li>✅ <strong>性能优化建议</strong>：虚拟线程配置、多线程异步启动、数据库连接池调优等性能提升技巧</li></ul><p>让我们开始这场 Spring Boot 4.0 的迁移之旅！</p><h2 id=spring-boot-40-核心新特性>Spring Boot 4.0 核心新特性<a href=#spring-boot-40-核心新特性 class=anchor aria-hidden=true>#</a></h2><p>作为 Spring Boot 3.x 之后的首个大版本更新，Spring Boot 4.0 基于 Spring Framework 7.0、Jakarta EE 11 和 Java 17+（推荐 Java 21 或 25），带来了模块化架构重构、虚拟线程原生支持、HTTP 服务客户端自动配置等重大变化。</p><p>Spring Boot 4.0 配套使用 <strong>Spring Cloud 2025.1.x</strong>。虽然版本号看起来只是中号版本变更，但实际上这是一次<strong>大版本变更</strong>，包含了大量破坏性变更和重要更新。</p><h3 id=模块化架构>模块化架构<a href=#模块化架构 class=anchor aria-hidden=true>#</a></h3><p>Spring Boot 4 将 <code>spring-boot-autoconfigure</code> 拆分为多个专注的模块，每个技术都有独立的 starter 和对应的测试 starter。</p><p><strong>主要变化：</strong></p><ul><li>模块命名：<code>spring-boot-&lt;technology></code>，包路径：<code>org.springframework.boot.&lt;technology></code></li><li>Starter 命名：<code>spring-boot-starter-&lt;technology></code> 和 <code>spring-boot-starter-&lt;technology>-test</code></li><li>之前没有 starter 的技术（如 Flyway、Liquibase）现在需要显式添加对应的 starter</li></ul><p><strong>模块化的优势：</strong></p><ul><li><strong>减少 IDE 干扰</strong>：IDE 自动完成只显示你实际使用的技术相关的类和配置属性，不再出现无关的代码提示。例如，如果你不使用 GraphQL，IDE 不会提示 GraphQL 相关的配置属性</li><li><strong>更小的运行时占用</strong>：只引入实际使用的模块，减少类路径开销和启动扫描成本。Spring Boot 3.5 的 <code>spring-boot-autoconfigure</code> 是 2 MiB，模块化后只引入需要的模块，显著减少占用</li><li><strong>避免意外自动配置</strong>：模块化后，Spring Boot 能更准确地判断你的意图。例如，如果只使用 <code>WebClient</code>（通过 <code>spring-boot-starter-webclient</code>），不会意外启用 Web 服务器自动配置，不再需要调用 <code>SpringApplication.setWebApplicationType(WebApplicationType.NONE)</code></li><li><strong>启用新用例</strong>：例如，现在可以独立使用 Micrometer 指标（<code>spring-boot-starter-micrometer-metrics</code>），而不需要完整的 Actuator 依赖链</li><li><strong>更好的维护性</strong>：模块边界成为明确的契约，而不是软约定，便于团队协作和代码维护</li></ul><p><strong>测试支持的模块化：</strong></p><p><code>spring-boot-test-autoconfigure</code> 也被模块化了。测试相关的注解现在位于对应的测试模块中。例如，<code>@AutoConfigureDataJdbc</code> 注解现在位于 <code>spring-boot-starter-data-jdbc-test</code> 模块中，与 <code>spring-boot-starter-data-jdbc</code> 对齐。</p><p><strong>测试 Starter 的传递性：</strong></p><p>所有 test starter 都会传递性地引入 <code>spring-boot-starter-test</code>，因此不需要再单独声明 <code>spring-boot-starter-test</code>。只需要列出被测试技术对应的 test starter 即可。</p><p><strong>主要废弃 Starter 和替代方案：</strong></p><table><thead><tr><th>废弃 Starter</th><th>替代</th></tr></thead><tbody><tr><td><code>spring-boot-starter-web</code></td><td><code>spring-boot-starter-webmvc</code></td></tr><tr><td><code>spring-boot-starter-aop</code></td><td><code>spring-boot-starter-aspectj</code></td></tr><tr><td><code>spring-boot-starter-oauth2-authorization-server</code></td><td><code>spring-boot-starter-security-oauth2-authorization-server</code></td></tr><tr><td><code>spring-boot-starter-oauth2-client</code></td><td><code>spring-boot-starter-security-oauth2-client</code></td></tr><tr><td><code>spring-boot-starter-oauth2-resource-server</code></td><td><code>spring-boot-starter-security-oauth2-resource-server</code></td></tr><tr><td><code>spring-boot-starter-web-services</code></td><td><code>spring-boot-starter-webservices</code></td></tr></tbody></table><p><strong>其他迁移要点：</strong></p><ul><li>测试依赖需要添加对应的 <code>-test</code> starter，如 <code>spring-boot-starter-security-test</code></li><li>之前没有 starter 的技术（如 Flyway、Liquibase）现在需要显式添加对应的 starter</li></ul><p><strong>完整的 Starter 列表：</strong></p><p>Spring Boot 4.0 统一了 starter 的使用方式：大多数技术都有专门的 starter，每个 starter 都有对应的 test starter。以下是完整的列表（参考 <a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Migration-Guide#starters target=_blank rel=noopener>官方迁移指南</a>
）：</p><table><thead><tr><th>Technology</th><th>Main Dependency</th><th>Test Dependency</th></tr></thead><tbody><tr><td><strong>Core Starters</strong></td><td></td><td></td></tr><tr><td>AspectJ</td><td><code>spring-boot-starter-aspectj</code></td><td><code>spring-boot-starter-aspectj-test</code></td></tr><tr><td>Cloud Foundry Support</td><td><code>spring-boot-starter-cloudfoundry</code></td><td><code>spring-boot-starter-cloudfoundry-test</code></td></tr><tr><td>Jakarta Validation</td><td><code>spring-boot-starter-validation</code></td><td><code>spring-boot-starter-validation-test</code></td></tr><tr><td>Kotlin Serialization</td><td><code>spring-boot-starter-kotlin-serialization</code></td><td><code>spring-boot-starter-kotlin-serialization-test</code></td></tr><tr><td>Reactor</td><td><code>spring-boot-starter-reactor</code></td><td><code>spring-boot-starter-reactor-test</code></td></tr><tr><td><strong>Web Server Starters</strong></td><td></td><td></td></tr><tr><td>Jetty</td><td><code>spring-boot-starter-jetty</code></td><td><em>none</em></td></tr><tr><td>Reactor Netty</td><td><code>spring-boot-starter-reactor-netty</code></td><td><em>none</em></td></tr><tr><td>Tomcat</td><td><code>spring-boot-starter-tomcat</code></td><td><em>none</em></td></tr><tr><td><strong>Web Client Starters</strong></td><td></td><td></td></tr><tr><td>Spring&rsquo;s Imperative <code>RestClient</code> and <code>RestTemplate</code></td><td><code>spring-boot-starter-restclient</code></td><td><code>spring-boot-starter-restclient-test</code></td></tr><tr><td>Spring&rsquo;s Reactive <code>WebClient</code></td><td><code>spring-boot-starter-webclient</code></td><td><code>spring-boot-starter-webclient-test</code></td></tr><tr><td><strong>Web Starters</strong></td><td></td><td></td></tr><tr><td>Jersey</td><td><code>spring-boot-starter-jersey</code></td><td><code>spring-boot-starter-jersey-test</code></td></tr><tr><td>Spring GraphQL</td><td><code>spring-boot-starter-graphql</code></td><td><code>spring-boot-starter-graphql-test</code></td></tr><tr><td>Spring HATEOAS</td><td><code>spring-boot-starter-hateoas</code></td><td><code>spring-boot-starter-hateoas-test</code></td></tr><tr><td>Spring Session Data Redis</td><td><code>spring-boot-starter-session-data-redis</code></td><td><code>spring-boot-starter-session-data-redis-test</code></td></tr><tr><td>Spring Session JDBC</td><td><code>spring-boot-starter-session-jdbc</code></td><td><code>spring-boot-starter-session-jdbc-test</code></td></tr><tr><td>Spring Web MVC</td><td><code>spring-boot-starter-webmvc</code></td><td><code>spring-boot-starter-webmvc-test</code></td></tr><tr><td>Spring WebFlux</td><td><code>spring-boot-starter-webflux</code></td><td><code>spring-boot-starter-webflux-test</code></td></tr><tr><td>Spring Webservices</td><td><code>spring-boot-starter-webservices</code></td><td><code>spring-boot-starter-webservices-test</code></td></tr><tr><td><strong>Database Starters</strong></td><td></td><td></td></tr><tr><td>Cassandra</td><td><code>spring-boot-starter-cassandra</code></td><td><code>spring-boot-starter-cassandra-test</code></td></tr><tr><td>Couchbase</td><td><code>spring-boot-starter-couchbase</code></td><td><code>spring-boot-starter-couchbase-test</code></td></tr><tr><td>Elasticsearch</td><td><code>spring-boot-starter-elasticsearch</code></td><td><code>spring-boot-starter-elasticsearch-test</code></td></tr><tr><td>Flyway</td><td><code>spring-boot-starter-flyway</code></td><td><code>spring-boot-starter-flyway-test</code></td></tr><tr><td>JDBC</td><td><code>spring-boot-starter-jdbc</code></td><td><code>spring-boot-starter-jdbc-test</code></td></tr><tr><td>jOOQ</td><td><code>spring-boot-starter-jooq</code></td><td><code>spring-boot-starter-jooq-test</code></td></tr><tr><td>Liquibase</td><td><code>spring-boot-starter-liquibase</code></td><td><code>spring-boot-starter-liquibase-test</code></td></tr><tr><td>LDAP</td><td><code>spring-boot-starter-ldap</code></td><td><code>spring-boot-starter-ldap-test</code></td></tr><tr><td>MongoDB</td><td><code>spring-boot-starter-mongodb</code></td><td><code>spring-boot-starter-mongodb-test</code></td></tr><tr><td>Neo4J</td><td><code>spring-boot-starter-neo4j</code></td><td><code>spring-boot-starter-neo4j-test</code></td></tr><tr><td>R2DBC</td><td><code>spring-boot-starter-r2dbc</code></td><td><code>spring-boot-starter-r2dbc-test</code></td></tr><tr><td><strong>Spring Data Starters</strong></td><td></td><td></td></tr><tr><td>Spring Data Cassandra</td><td><code>spring-boot-starter-data-cassandra</code> 或 <code>spring-boot-starter-data-cassandra-reactive</code></td><td><code>spring-boot-starter-data-cassandra-test</code> 或 <code>spring-boot-starter-data-cassandra-reactive-test</code></td></tr><tr><td>Spring Data Couchbase</td><td><code>spring-boot-starter-data-couchbase</code> 或 <code>spring-boot-starter-data-couchbase-reactive</code></td><td><code>spring-boot-starter-data-couchbase-test</code> 或 <code>spring-boot-starter-data-couchbase-reactive-test</code></td></tr><tr><td>Spring Data Elasticsearch</td><td><code>spring-boot-starter-data-elasticsearch</code></td><td><code>spring-boot-starter-data-elasticsearch-test</code></td></tr><tr><td>Spring Data JDBC</td><td><code>spring-boot-starter-data-jdbc</code></td><td><code>spring-boot-starter-data-jdbc-test</code></td></tr><tr><td>Spring Data JPA (using Hibernate)</td><td><code>spring-boot-starter-data-jpa</code></td><td><code>spring-boot-starter-data-jpa-test</code></td></tr><tr><td>Spring Data LDAP</td><td><code>spring-boot-starter-data-ldap</code></td><td><code>spring-boot-starter-data-ldap-test</code></td></tr><tr><td>Spring Data MongoDB</td><td><code>spring-boot-starter-data-mongodb</code> 或 <code>spring-boot-starter-data-mongodb-reactive</code></td><td><code>spring-boot-starter-data-mongodb-test</code> 或 <code>spring-boot-starter-data-mongodb-reactive-test</code></td></tr><tr><td>Spring Data Neo4J</td><td><code>spring-boot-starter-data-neo4j</code></td><td><code>spring-boot-starter-data-neo4j-test</code></td></tr><tr><td>Spring Data R2DBC</td><td><code>spring-boot-starter-data-r2dbc</code></td><td><code>spring-boot-starter-data-r2dbc-test</code></td></tr><tr><td>Spring Data Redis</td><td><code>spring-boot-starter-data-redis</code> 或 <code>spring-boot-starter-data-redis-reactive</code></td><td><code>spring-boot-starter-data-redis-test</code> 或 <code>spring-boot-starter-data-redis-reactive-test</code></td></tr><tr><td>Spring Data REST</td><td><code>spring-boot-starter-data-rest</code></td><td><code>spring-boot-starter-data-rest-test</code></td></tr><tr><td><strong>IO Starters</strong></td><td></td><td></td></tr><tr><td>Hazelcast</td><td><code>spring-boot-starter-hazelcast</code></td><td><code>spring-boot-starter-hazelcast-test</code></td></tr><tr><td>Mail</td><td><code>spring-boot-starter-mail</code></td><td><code>spring-boot-starter-mail-test</code></td></tr><tr><td>Quartz</td><td><code>spring-boot-starter-quartz</code></td><td><code>spring-boot-starter-quartz-test</code></td></tr><tr><td>SendGrid</td><td><code>spring-boot-starter-sendgrid</code></td><td><code>spring-boot-starter-sendgrid-test</code></td></tr><tr><td>Spring Caching Support</td><td><code>spring-boot-starter-cache</code></td><td><code>spring-boot-starter-cache-test</code></td></tr><tr><td>Spring Batch (with JDBC)</td><td><code>spring-boot-starter-batch-jdbc</code></td><td><code>spring-boot-starter-batch-jdbc-test</code></td></tr><tr><td>Spring Batch (without JDBC)</td><td><code>spring-boot-starter-batch</code></td><td><code>spring-boot-starter-batch-test</code></td></tr><tr><td><strong>JSON Starters</strong></td><td></td><td></td></tr><tr><td>GSON</td><td><code>spring-boot-starter-gson</code></td><td><code>spring-boot-starter-gson-test</code></td></tr><tr><td>Jackson</td><td><code>spring-boot-starter-jackson</code></td><td><code>spring-boot-starter-jackson-test</code></td></tr><tr><td>JSONB</td><td><code>spring-boot-starter-jsonb</code></td><td><code>spring-boot-starter-jsonb-test</code></td></tr><tr><td><strong>Messaging Starters</strong></td><td></td><td></td></tr><tr><td>ActiveMQ</td><td><code>spring-boot-starter-activemq</code></td><td><code>spring-boot-starter-activemq-test</code></td></tr><tr><td>Artemis</td><td><code>spring-boot-starter-artemis</code></td><td><code>spring-boot-starter-artemis-test</code></td></tr><tr><td>JMS</td><td><code>spring-boot-starter-jms</code></td><td><code>spring-boot-starter-jms-test</code></td></tr><tr><td>RSocket</td><td><code>spring-boot-starter-rsocket</code></td><td><code>spring-boot-starter-rsocket-test</code></td></tr><tr><td>Spring AMQP</td><td><code>spring-boot-starter-amqp</code></td><td><code>spring-boot-starter-amqp-test</code></td></tr><tr><td>Spring Integration</td><td><code>spring-boot-starter-integration</code></td><td><code>spring-boot-starter-integration-test</code></td></tr><tr><td>Spring for Apache Kafka</td><td><code>spring-boot-starter-kafka</code></td><td><code>spring-boot-starter-kafka-test</code></td></tr><tr><td>Spring for Apache Pulsar</td><td><code>spring-boot-starter-pulsar</code></td><td><code>spring-boot-starter-pulsar-test</code></td></tr><tr><td>Websockets</td><td><code>spring-boot-starter-websocket</code></td><td><code>spring-boot-starter-websocket-test</code></td></tr><tr><td><strong>Security Starters</strong></td><td></td><td></td></tr><tr><td>Spring Security</td><td><code>spring-boot-starter-security</code></td><td><code>spring-boot-starter-security-test</code></td></tr><tr><td>Spring Security OAuth Authorization Server</td><td><code>spring-boot-starter-security-oauth2-authorization-server</code></td><td><code>spring-boot-starter-security-oauth2-authorization-server-test</code></td></tr><tr><td>Spring Security OAuth Client</td><td><code>spring-boot-starter-security-oauth2-client</code></td><td><code>spring-boot-starter-security-oauth2-client-test</code></td></tr><tr><td>Spring Security OAuth Resource Server</td><td><code>spring-boot-starter-security-oauth2-resource-server</code></td><td><code>spring-boot-starter-security-oauth2-resource-server-test</code></td></tr><tr><td>Spring Security SAML</td><td><code>spring-boot-starter-security-saml2</code></td><td><code>spring-boot-starter-security-saml2-test</code></td></tr><tr><td><strong>Templating Starters</strong></td><td></td><td></td></tr><tr><td>Freemarker</td><td><code>spring-boot-starter-freemarker</code></td><td><code>spring-boot-starter-freemarker-test</code></td></tr><tr><td>Groovy Templates</td><td><code>spring-boot-starter-groovy-templates</code></td><td><code>spring-boot-starter-groovy-templates-test</code></td></tr><tr><td>Mustache</td><td><code>spring-boot-starter-mustache</code></td><td><code>spring-boot-starter-mustache-test</code></td></tr><tr><td>Thymeleaf</td><td><code>spring-boot-starter-thymeleaf</code></td><td><code>spring-boot-starter-thymeleaf-test</code></td></tr><tr><td><strong>Production-Ready Starters</strong></td><td></td><td></td></tr><tr><td>Actuator</td><td><code>spring-boot-starter-actuator</code></td><td><code>spring-boot-starter-actuator-test</code></td></tr><tr><td>Micrometer Metrics</td><td><code>spring-boot-starter-micrometer-metrics</code></td><td><code>spring-boot-starter-micrometer-metrics-test</code></td></tr><tr><td>OpenTelemetry</td><td><code>spring-boot-starter-opentelemetry</code></td><td><code>spring-boot-starter-opentelemetry-test</code></td></tr><tr><td>Zipkin</td><td><code>spring-boot-starter-zipkin</code></td><td><code>spring-boot-starter-zipkin-test</code></td></tr></tbody></table><blockquote><p><strong>提示：</strong> 所有 test starter 都会传递性地引入 <code>spring-boot-starter-test</code>，因此不需要再单独声明 <code>spring-boot-starter-test</code>。只需要列出被测试技术对应的 test starter 即可。</p></blockquote><p><strong>Classic Starters（快速迁移方案）：</strong></p><p>如果需要快速迁移，可以使用 Classic Starters，它们提供了类似 Spring Boot 3.x 的 classpath，让你可以快速恢复所有基础设施的可用性：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- 替代 spring-boot-starter --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-classic<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- 替代 spring-boot-starter-test --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-test-classic<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><p><strong>使用 Classic Starters 的好处：</strong></p><ul><li>快速恢复应用功能，无需立即处理所有 starter 替换</li><li>修复导入错误，验证应用能正常工作</li><li>作为过渡方案，降低迁移风险</li></ul><p><strong>迁移建议（官方推荐的两步法）：</strong></p><ol><li><strong>第一步</strong>：使用 Classic Starters 快速迁移，修复编译错误，确保应用运行正常</li><li><strong>第二步</strong>：逐步移除 Classic Starters，根据更新后的导入语句识别缺失的 starter，添加对应的模块化 starter</li></ol><blockquote><p><strong>注意：</strong> 官方建议最终还是要迁移到模块化的 starter，Classic Starters 只是过渡方案。完整的 starter 列表和对应关系请参考 <a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Migration-Guide#starters target=_blank rel=noopener>官方迁移指南</a>
。</p></blockquote><h3 id=增强的配置属性元数据>增强的配置属性元数据<a href=#增强的配置属性元数据 class=anchor aria-hidden=true>#</a></h3><p>Spring Boot 4 引入了新的注解 <strong>@ConfigurationPropertiesSource</strong>，允许 Spring Boot 读取外部模块中定义的 <code>@ConfigurationProperties</code> 类型，这在之前是不可能的。</p><p><strong>使用场景：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ConfigurationPropertiesSource</span><span class=p>(</span><span class=s>&#34;com.example.config&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConfigurationProperties</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;app&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AppProperties</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// getters and setters</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>优势：</strong></p><ul><li>更清晰的模块化设计</li><li>改进工具支持（IDE 自动完成、配置提示等）</li><li>支持跨模块的配置属性定义</li></ul><h3 id=任务调度增强>任务调度增强<a href=#任务调度增强 class=anchor aria-hidden=true>#</a></h3><p>Spring Boot 4 现在支持配置多个 <code>TaskDecorator</code> Bean，允许你组合多个装饰器来增强任务执行行为。</p><p><strong>使用示例：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TaskConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TaskDecorator</span><span class=w> </span><span class=nf>loggingTaskDecorator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>runnable</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Task started: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>runnable</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Task completed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TaskDecorator</span><span class=w> </span><span class=nf>mdcTaskDecorator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>runnable</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>traceId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MDC</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;traceId&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>MDC</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;traceId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>traceId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>runnable</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>MDC</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>多个 <code>TaskDecorator</code> 会按顺序应用，提供更灵活的任务执行增强能力。</p><h3 id=包结构变化>包结构变化<a href=#包结构变化 class=anchor aria-hidden=true>#</a></h3><p>模块化架构对包结构也有影响。每个模块现在都有独立的 <code>org.springframework.boot.&lt;module></code> 包路径。根据模块的职责范围，可能包含 API、自动配置、Actuator 相关支持等。</p><p><strong>示例：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Spring Boot 3.x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Spring Boot 4.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.webmvc.autoconfigure.WebMvcAutoConfiguration</span><span class=p>;</span></span></span></code></pre></div></figure></div><p><strong>主要变化：</strong></p><ul><li>每个技术模块都有独立的包路径：<code>org.springframework.boot.&lt;technology></code></li><li>测试模块包路径：<code>org.springframework.boot.&lt;technology>.test</code></li><li>自动配置类、Actuator 支持等都位于对应的模块包下</li><li><strong>如果你有自定义 starter，大概率都需要适配新的包路径</strong>，尤其是使用 class 字符名字，而不是 class 类的。</li></ul><h2 id=spring-framework-70-带来的增强>Spring Framework 7.0 带来的增强<a href=#spring-framework-70-带来的增强 class=anchor aria-hidden=true>#</a></h2><p>Spring Boot 4 基于 Spring Framework 7.0 构建，继承了以下特性。</p><h3 id=api-版本控制>API 版本控制<a href=#api-版本控制 class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 原生支持 API 版本管理，这是<strong>首次在 Spring 框架中提供官方支持</strong>。之前虽然可以通过 <code>@RequestMapping</code> 实现，但需要大量手动工作。</p><p><strong>配置方式：</strong></p><p><strong>Java 配置：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebConfiguration</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configureApiVersioning</span><span class=p>(</span><span class=n>ApiVersionConfigurer</span><span class=w> </span><span class=n>configurer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>configurer</span><span class=p>.</span><span class=na>useRequestHeader</span><span class=p>(</span><span class=s>&#34;API-Version&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 或使用其他策略：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// configurer.useQueryParameter(&#34;version&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// configurer.usePathPattern(&#34;/api/{version}&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// configurer.useMediaType(&#34;application/vnd.api.v1+json&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>Spring Boot 配置属性：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mvc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiversion</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>use</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>header</span><span class=p>:</span><span class=w> </span><span class=l>API-Version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 或使用：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># query-parameter: version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># path-pattern: /api/{version}</span></span></span></code></pre></div></figure></div><p><strong>使用示例：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/api&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/users&#34;</span><span class=p>,</span><span class=w> </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>UserV1</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUsersV1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>getUsersV1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/users&#34;</span><span class=p>,</span><span class=w> </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>UserV2</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUsersV2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>getUsersV2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>功能式端点支持：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RouterFunction</span><span class=o>&lt;</span><span class=n>ServerResponse</span><span class=o>&gt;</span><span class=w> </span><span class=n>route</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RouterFunctions</span><span class=p>.</span><span class=na>route</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>GET</span><span class=p>(</span><span class=s>&#34;/hello-world&#34;</span><span class=p>,</span><span class=w> </span><span class=n>version</span><span class=p>(</span><span class=s>&#34;1.2&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ServerResponse</span><span class=p>.</span><span class=na>ok</span><span class=p>().</span><span class=na>body</span><span class=p>(</span><span class=s>&#34;Hello World&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>build</span><span class=p>();</span></span></span></code></pre></div></figure></div><p><strong>支持的版本控制策略：</strong></p><ul><li><strong>路径版本控制</strong>：<code>/v1/users</code>、<code>/v2/users</code>（需要在路径中声明 URI 变量）</li><li><strong>请求头版本控制</strong>：<code>X-API-Version: 1</code> 或自定义 header 名称</li><li><strong>查询参数版本控制</strong>：<code>/users?version=1</code></li><li><strong>媒体类型版本控制</strong>：<code>Accept: application/vnd.api.v1+json</code></li></ul><p><strong>版本格式：</strong></p><p>默认使用语义化版本（Semantic Versioning），支持 major.minor.patch 格式。如果未指定 minor 和 patch，默认为 0。版本解析器可以自定义，支持日期格式或其他格式。</p><p><strong>废弃处理：</strong></p><p>API 版本控制支持 RFC 9745 标准的废弃处理，可以在响应中发送废弃提示。</p><h3 id=jspecify-空安全注解>JSpecify 空安全注解<a href=#jspecify-空安全注解 class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 迁移到 JSpecify 注解，这是 Spring 生态系统中<strong>空安全支持的重大里程碑</strong>。JSpecify 是一个由 OpenJDK、Broadcom、Google、JetBrains、Sonar 等组织共同参与的标准项目。</p><p><strong>已支持 JSpecify 的 Spring 项目：</strong></p><ul><li>Spring Boot 4.0</li><li>Spring Framework 7.0</li><li>Spring Data 4.0</li><li>Spring Security 7.0</li><li>Spring Batch 6.0</li><li>Spring Kafka 4.0</li><li>Spring Integration 7.0</li><li>Spring GraphQL 2.0</li><li>Spring Web Services 5.0</li><li>Spring AMQP 4.0</li><li>Spring Shell 4.0</li><li>Spring Plugin 4.0</li><li>Spring HATEOAS 3.0</li><li>Spring Modulith 2.0</li><li>Spring Vault 4.0</li><li>Spring Cloud Commons 5.0</li><li>Spring Cloud Gateway 5.0</li><li>Micrometer 1.16</li><li>Micrometer Tracing 1.6</li><li>Context Propagation 1.2</li><li>Reactor 2025.0</li></ul><p><strong>使用示例：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.jspecify.annotations.Nullable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.jspecify.annotations.NonNull</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>orElseThrow</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserNotFoundException</span><span class=p>(</span><span class=n>userId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>findUser</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>findByEmail</span><span class=p>(</span><span class=n>email</span><span class=p>).</span><span class=na>orElse</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>IDE 支持：</strong></p><ul><li><strong>IntelliJ IDEA 2025.3+</strong>：提供完整的 JSpecify 支持，包括复杂的数据流分析</li><li><strong>Kotlin 2.2</strong>：自动将 JSpecify 注解转换为 Kotlin 空安全类型，告别平台类型（platform types）</li><li><strong>NullAway</strong>：构建时检查工具，需要 JDK 21+（JDK 17 支持可能在后续版本提供）</li></ul><p><strong>Kotlin 项目注意事项：</strong></p><p>JSpecify 注解会明确标记可空性，Kotlin 编译器会自动识别并转换。如果 Java 接口使用 <code>@Nullable</code> 注解，Kotlin 实现必须返回可空类型；如果使用 <code>@NonNull</code>，则必须返回非空类型。IntelliJ IDEA 会提供相应的编译错误提示和修复建议。</p><h3 id=多线程异步启动>多线程异步启动<a href=#多线程异步启动 class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7.0 引入了多线程异步启动机制，可以并行初始化 ApplicationContext，显著加快应用启动速度。</p><p><strong>工作原理：</strong></p><ul><li>ApplicationContext 启动时，可以并行初始化多个 Bean</li><li>利用多核 CPU 资源，将串行的 Bean 初始化改为并行执行</li><li>自动处理 Bean 之间的依赖关系，确保初始化顺序正确</li></ul><p><strong>配置方式：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Application</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SpringApplication</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SpringApplication</span><span class=p>(</span><span class=n>Application</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 启用异步启动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>setApplicationStartup</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>BufferingApplicationStartup</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>或者通过配置属性：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>startup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></figure></div><p><strong>性能提升：</strong></p><ul><li>大型应用启动时间可减少 30-50%</li><li>特别适合 Bean 数量多、初始化耗时的应用</li><li>充分利用多核 CPU，提升资源利用率</li></ul><p><strong>注意事项：</strong></p><ul><li>需要确保 Bean 初始化是线程安全的</li><li>某些单例 Bean 可能仍需要串行初始化</li><li>建议在测试环境先验证，确保无并发问题</li></ul><h3 id=http-接口客户端>HTTP 接口客户端<a href=#http-接口客户端 class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 和 Spring Boot 4 大幅简化了 HTTP 接口客户端的配置。之前需要手动创建 <code>HttpServiceProxyFactory</code> 和配置每个客户端，现在可以通过声明式方式自动注册。</p><p><strong>建议：</strong> 虽然 <code>RestTemplate</code> 仍可使用，但推荐使用 <code>RestClient</code> 或 HTTP 接口客户端（<code>@HttpExchange</code>）作为替代方案。</p><p><strong>旧方式（Spring Framework 6 / Spring Boot 3）：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@HttpExchange</span><span class=p>(</span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/api/users&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserClient</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetExchange</span><span class=p>(</span><span class=s>&#34;/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostExchange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=nf>createUser</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>UserRequest</span><span class=w> </span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 需要手动配置每个客户端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HttpClientConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>UserClient</span><span class=w> </span><span class=nf>userClient</span><span class=p>(</span><span class=n>RestClient</span><span class=p>.</span><span class=na>Builder</span><span class=w> </span><span class=n>builder</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RestClient</span><span class=w> </span><span class=n>restClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>baseUrl</span><span class=p>(</span><span class=s>&#34;https://api.example.com&#34;</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServiceProxyFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HttpServiceProxyFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>builderFor</span><span class=p>(</span><span class=n>RestClientAdapter</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>restClient</span><span class=p>)).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>createClient</span><span class=p>(</span><span class=n>UserClient</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果有多个客户端，需要重复配置。..</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>新方式（Spring Framework 7 / Spring Boot 4）：</strong></p><p>使用 <code>@ImportHttpServices</code> 注解：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@HttpExchange</span><span class=p>(</span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/api/users&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserClient</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetExchange</span><span class=p>(</span><span class=s>&#34;/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostExchange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=nf>createUser</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>UserRequest</span><span class=w> </span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ImportHttpServices</span><span class=p>(</span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;api&#34;</span><span class=p>,</span><span class=w> </span><span class=n>types</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>UserClient</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HttpClientConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>配置 <code>application.yml</code>：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>read-timeout</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>api</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>base-url</span><span class=p>:</span><span class=w> </span><span class=l>https://api.example.com</span></span></span></code></pre></div></figure></div><p>或使用包扫描自动发现：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ImportHttpServices</span><span class=p>(</span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;api&#34;</span><span class=p>,</span><span class=w> </span><span class=n>basePackages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.example.client&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HttpClientConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>多组配置示例：</strong></p><p>如果应用需要集成多个 REST API，可以为每个 API 配置不同的组：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ImportHttpServices</span><span class=p>(</span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;github&#34;</span><span class=p>,</span><span class=w> </span><span class=n>basePackages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.example.client.github&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ImportHttpServices</span><span class=p>(</span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;stackoverflow&#34;</span><span class=p>,</span><span class=w> </span><span class=n>basePackages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.example.client.stackoverflow&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HttpClientConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>对应的配置：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>github</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>base-url</span><span class=p>:</span><span class=w> </span><span class=l>https://api.github.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>read-timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>stackoverflow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>base-url</span><span class=p>:</span><span class=w> </span><span class=l>https://api.stackexchange.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>read-timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span></span></span></code></pre></div></figure></div><p><strong>使用 WebClient（响应式）：</strong></p><p>默认使用 <code>RestClient</code>，如需使用 <code>WebClient</code>，可通过配置切换：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ImportHttpServices</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;api&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>basePackages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.example.client&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>clientType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientType</span><span class=p>.</span><span class=na>WEB_CLIENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HttpClientConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>优势：</strong></p><ul><li><strong>配置简化</strong>：不再需要为每个客户端手动创建 <code>HttpServiceProxyFactory</code> 和 Bean</li><li><strong>自动注册</strong>：所有 HTTP 接口自动注册为 Spring Bean，可直接注入使用</li><li><strong>统一管理</strong>：通过组（group）概念统一管理同一 API 的所有客户端</li><li><strong>灵活配置</strong>：支持为不同组配置不同的超时、重试等策略</li></ul><p>这样 <code>com.example.client</code> 包下所有带 <code>@HttpExchange</code> 的接口都会自动注册为 Spring Bean，可以直接注入使用：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>UserClient</span><span class=w> </span><span class=n>userClient</span><span class=p>;</span><span class=w>  </span><span class=c1>// 直接注入，无需手动配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UserService</span><span class=p>(</span><span class=n>UserClient</span><span class=w> </span><span class=n>userClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>userClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userClient</span><span class=p>.</span><span class=na>getUser</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>  </span><span class=c1>// 直接使用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=内置弹性功能resilience>内置弹性功能（Resilience）<a href=#内置弹性功能resilience class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 引入了强大的弹性工具，直接集成到核心框架中：</p><ul><li><strong>@Retryable</strong>：自动重试失败的方法调用，支持配置最大尝试次数、延迟、抖动和退避策略，也支持响应式返回类型</li><li><strong>@ConcurrencyLimit</strong>：限制并发方法调用数量，保护服务和资源（例如限制为单线程访问）</li></ul><p><strong>配置方式：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableResilientMethods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ApplicationConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PaymentService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Retryable</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>maxAttempts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>backoff</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nd>@Retryable.Backoff</span><span class=p>(</span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2000</span><span class=p>,</span><span class=w> </span><span class=n>multiplier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>.</span><span class=na>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ConcurrencyLimit</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w>  </span><span class=c1>// 只允许 2 个并发调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processPayment</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>paymentId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 处理支付逻辑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>优势：</strong></p><ul><li>无需引入第三方库（如 Resilience4j）</li><li>与 Spring 生态深度集成</li><li>支持响应式编程模型</li><li>配置简单，开箱即用</li></ul><h3 id=流式-jms-客户端-apijmsclient>流式 JMS 客户端 API（JmsClient）<a href=#流式-jms-客户端-apijmsclient class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 引入了 <strong>JmsClient</strong>，类似于 <code>JdbcClient</code> 和 <code>RestClient</code>，提供流畅的构建器风格 API。这是对传统 JMS 模板的更优雅和可读的替代方案。</p><p><strong>使用示例：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MessageService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JmsClient</span><span class=w> </span><span class=n>jmsClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MessageService</span><span class=p>(</span><span class=n>JmsClient</span><span class=w> </span><span class=n>jmsClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>jmsClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jmsClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>destination</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jmsClient</span><span class=p>.</span><span class=na>create</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>queue</span><span class=p>(</span><span class=n>destination</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>send</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>receiveMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>destination</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>jmsClient</span><span class=p>.</span><span class=na>create</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>queue</span><span class=p>(</span><span class=n>destination</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>receive</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>优势：</strong></p><ul><li>流畅的 API 设计，代码更易读</li><li>与 <code>JdbcClient</code>、<code>RestClient</code> 保持一致的风格</li><li>Spring Boot 4 提供自动配置支持</li></ul><h3 id=统一消息转换unified-message-conversion>统一消息转换（Unified Message Conversion）<a href=#统一消息转换unified-message-conversion class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 简化了消息转换，引入了新的 <code>HttpMessageConverters</code> 配置类。这种统一方法借鉴了响应式编解码器的设计，简化了 HTTP 消息的序列化和反序列化。</p><h3 id=jakarta-ee-11-升级>Jakarta EE 11 升级<a href=#jakarta-ee-11-升级 class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 采用 Jakarta EE 11 规范：</p><ul><li><strong>Servlet 6.1</strong></li><li><strong>JPA 3.2</strong></li><li><strong>Bean Validation 3.1</strong></li><li><strong>WebSocket 2.2</strong></li></ul><p><strong>JPA 3.2 重要变化：</strong></p><p>之前，<code>EntityManager</code> 只能通过 <code>@PersistenceContext</code> 注解注入。现在，<code>EntityManagerFactory</code> 和共享的 <code>EntityManager</code> 都可以使用 <code>@Inject</code> 或 <code>@Autowired</code> 注入，并支持使用限定符来选择特定的持久化单元（当配置了多个持久化单元时）。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 旧方式（仍然支持）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@PersistenceContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>EntityManager</span><span class=w> </span><span class=n>entityManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 新方式（Spring Framework 7 / JPA 3.2）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>EntityManager</span><span class=w> </span><span class=n>entityManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 多个持久化单元时使用限定符</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;primaryEntityManager&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>EntityManager</span><span class=w> </span><span class=n>primaryEntityManager</span><span class=p>;</span></span></span></code></pre></div></figure></div><p>这里要提醒一下：<code>javax.*</code> 到 <code>jakarta.*</code> 的迁移应该在 Spring Boot 3.0 的时候就已经完成了。如果你还在用 Spring Boot 2.x，那得先升级到 3.x，然后再考虑 4.0。</p><h3 id=junit-4-和-jackson-2x-弃用>JUnit 4 和 Jackson 2.x 弃用<a href=#junit-4-和-jackson-2x-弃用 class=anchor aria-hidden=true>#</a></h3><ul><li><strong>JUnit 4</strong>：官方推荐迁移到 JUnit 5</li><li><strong>Jackson 2.x</strong>：Spring Boot 4 使用 Jackson 3.x</li></ul><p>Jackson 3.x 的破坏性变更：</p><ul><li>部分注解被移除</li><li>更严格的类型处理</li><li>模块整合</li><li><code>ObjectMapper</code> 行为变更</li></ul><p>迁移示例：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Jackson 2.x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@JsonInclude</span><span class=p>(</span><span class=n>JsonInclude</span><span class=p>.</span><span class=na>Include</span><span class=p>.</span><span class=na>NON_NULL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Jackson 3.x （同样的语法，但内部行为可能不同）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@JsonInclude</span><span class=p>(</span><span class=n>JsonInclude</span><span class=p>.</span><span class=na>Include</span><span class=p>.</span><span class=na>NON_NULL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=测试上下文暂停机制>测试上下文暂停机制<a href=#测试上下文暂停机制 class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 引入了一个挺有意思的测试上下文管理机制：</p><ul><li>测试上下文在不使用的时候会自动暂停（stopped）</li><li>下次用的时候会自动重启</li><li>这样能显著降低测试套件的内存占用</li></ul><p>该机制可显著降低测试套件的内存占用。</p><h3 id=spel-增强>SpEL 增强<a href=#spel-增强 class=anchor aria-hidden=true>#</a></h3><p>支持 <code>Optional</code> 类型和 Elvis 操作符：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;#{userService.findUser(&#39;123&#39;)?.name ?: &#39;Unknown&#39;}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>;</span></span></span></code></pre></div></figure></div><h3 id=程序化-bean-注册beanregistrar>程序化 Bean 注册（BeanRegistrar）<a href=#程序化-bean-注册beanregistrar class=anchor aria-hidden=true>#</a></h3><p>Spring Framework 7 引入了 <code>BeanRegistrar</code> 接口，允许在 <code>@ConditionalOn...</code> 注解族不够用时进行动态 Bean 注册。</p><p><strong>Java 实现：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.bean.BeanRegistrar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.bean.BeanRegistry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>QuoteProviderRegistrar</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>BeanRegistrar</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>register</span><span class=p>(</span><span class=n>BeanRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=n>Environment</span><span class=w> </span><span class=n>env</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBean</span><span class=p>(</span><span class=s>&#34;quoteProviderDb&#34;</span><span class=p>,</span><span class=w> </span><span class=n>QuoteProviderDb</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBean</span><span class=p>(</span><span class=s>&#34;quoteProviderFallback&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>QuoteProviderFallback</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>spec</span><span class=p>.</span><span class=na>fallback</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>spec</span><span class=p>.</span><span class=na>order</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p><strong>Kotlin DSL 实现（更优雅）：</strong></p><p>Kotlin 2.2 提供了 <code>BeanRegistrarDsl</code>，让 Bean 注册更加简洁：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>import</span> <span class=nn>org.springframework.context.bean.BeanRegistrarDsl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QuoteProviderRegistrar</span> <span class=p>:</span> <span class=n>BeanRegistrarDsl</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=n>registerBean</span><span class=p>&lt;</span><span class=n>QuoteProviderDb</span><span class=p>&gt;(</span><span class=s2>&#34;quoteProviderDb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>registerBean</span><span class=p>&lt;</span><span class=n>QuoteProviderFallback</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=p>=</span> <span class=s2>&#34;quoteProviderFallback&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>fallback</span> <span class=p>=</span> <span class=k>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=p>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></figure></div><p><strong>使用场景：</strong></p><ul><li>根据环境变量或配置动态注册 Bean</li><li>实现复杂的条件逻辑，超出 <code>@ConditionalOn...</code> 注解的能力范围</li><li>需要根据运行时信息决定注册哪些 Bean</li></ul><h2 id=tomcat-11-核心变更>Tomcat 11 核心变更<a href=#tomcat-11-核心变更 class=anchor aria-hidden=true>#</a></h2><p>Tomcat 11 是 Apache Tomcat 项目第九个主要版本，标志着从传统 Java EE 向现代 Jakarta EE 框架的重要转变。本次升级支持 Jakarta EE 11，实现了：</p><ul><li><strong>Servlet 6.1</strong> - 改进异步请求处理，提升长运行任务的性能</li><li><strong>JSP 4.0</strong></li><li><strong>EL 6.0</strong></li><li><strong>WebSocket 2.2</strong> - 性能和可扩展性显著提升，特别适合实时双向通信场景（如聊天应用、协作工具）</li><li><strong>Authentication 3.1</strong></li></ul><h3 id=虚拟线程支持java-21>虚拟线程支持（Java 21+）<a href=#虚拟线程支持java-21 class=anchor aria-hidden=true>#</a></h3><p><strong>重要特性：</strong> Tomcat 11 原生支持 Java 21 的 Project Loom 虚拟线程，这是本次升级的<strong>核心亮点之一</strong>。</p><p><strong>性能数据（基于实际测试）：</strong></p><p>根据 Fast Thread 和 Java Code Geeks 的性能基准测试：</p><table><thead><tr><th>场景</th><th>平台线程</th><th>虚拟线程</th><th>性能提升</th></tr></thead><tbody><tr><td><strong>I/O 密集型应用</strong>（数据库查询、HTTP 调用）</td><td>基准</td><td>2-3x 吞吐量</td><td>+100-200%</td></tr><tr><td><strong>高并发 Web 请求</strong>（1000+ 并发）</td><td>基准</td><td>2-3x 吞吐量</td><td>+100-200%</td></tr><tr><td><strong>CPU 密集型应用</strong></td><td>基准</td><td>无明显提升</td><td>0%</td></tr><tr><td><strong>内存占用</strong></td><td>基准</td><td>-30-50%（线程栈）</td><td>-30-50%</td></tr><tr><td><strong>响应时间（P99）</strong></td><td>基准</td><td>-20-40%</td><td>-20-40%</td></tr></tbody></table><p><strong>适用场景：</strong></p><ul><li>✅ <strong>推荐使用</strong>：REST API、数据库查询、HTTP 客户端调用、文件 I/O、消息队列消费</li><li>❌ <strong>不推荐使用</strong>：CPU 密集型计算、图像处理、加密解密、复杂算法</li></ul><p><strong>实际案例：</strong></p><p>一个典型的 Spring Boot Web 应用（处理 REST 请求，调用数据库和外部 API）：</p><ul><li><strong>使用平台线程</strong>：1000 并发请求，吞吐量约 500 req/s，P99 延迟 200ms</li><li><strong>使用虚拟线程</strong>：1000 并发请求，吞吐量约 1200-1500 req/s，P99 延迟 120ms</li><li><strong>性能提升</strong>：吞吐量提升 2-3 倍，延迟降低 40%</li></ul><p><strong>优势：</strong></p><ul><li>轻量级并发模型，简化线程管理</li><li>相比传统线程模型，提供更好的可扩展性</li><li>特别适合 I/O 密集型应用，可以处理大量并发连接</li></ul><p><strong>配置方式：</strong></p><p>在 Spring Boot 4 中，虚拟线程支持通过配置属性启用：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>threads</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>virtual</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></figure></div><p><strong>适用场景：</strong></p><ul><li>Web 请求处理</li><li>WebSocket 连接管理</li><li>高并发 I/O 操作</li></ul><h3 id=websocket-22-性能提升>WebSocket 2.2 性能提升<a href=#websocket-22-性能提升 class=anchor aria-hidden=true>#</a></h3><p><strong>重要变化：</strong> Tomcat 11 升级到 Jakarta WebSocket 2.2，带来显著的性能和可扩展性提升。</p><p><strong>主要改进：</strong></p><ul><li>更高效的实时双向通信处理</li><li>改进的流式数据传输能力</li><li>更好的并发连接管理</li><li>特别适合需要实时更新的应用（如聊天、协作工具、实时数据流）</li></ul><p><strong>与 HTTP/2 和异步处理的协同：</strong></p><p>Tomcat 11 的 WebSocket 改进与 HTTP/2 支持和异步处理能力协同工作，确保更响应式和可扩展的 Web 应用。</p><h3 id=servlet-61-异步处理改进>Servlet 6.1 异步处理改进<a href=#servlet-61-异步处理改进 class=anchor aria-hidden=true>#</a></h3><p><strong>重要变化：</strong> Jakarta Servlet 6.1 改进了 Web 应用处理 HTTP 请求的方式，特别是异步请求处理。</p><p><strong>主要改进：</strong></p><ul><li>更高效的异步请求处理机制</li><li>提升长运行任务的性能</li><li>更好的资源利用率</li></ul><h3 id=安全增强>安全增强<a href=#安全增强 class=anchor aria-hidden=true>#</a></h3><p><strong>重要变化：</strong> Tomcat 11 引入了多项安全增强。</p><p><strong>主要改进：</strong></p><ul><li><strong>更好的 TLS/SSL 默认配置</strong> - 使管理员更容易建立安全的 HTTPS 连接，开箱即用</li><li>改进的安全实践和默认设置</li></ul><h3 id=最低-java-版本要求>最低 Java 版本要求<a href=#最低-java-版本要求 class=anchor aria-hidden=true>#</a></h3><p>Tomcat 11 要求至少 <strong>Java SE 17</strong>，这个和 Spring Boot 4 的要求一致。</p><p><strong>影响：</strong></p><ul><li>确保 Tomcat 能够利用最新的 Java 语言特性和性能改进</li><li>包括增强的内存管理、Records、更高效的 switch 表达式等</li><li>需要从旧版本 Java 升级的应用需要特别注意</li></ul><h3 id=openssl-支持java-22>OpenSSL 支持（Java 22+）<a href=#openssl-支持java-22 class=anchor aria-hidden=true>#</a></h3><p>如果你用的是 Java 22+，Tomcat 11 支持通过 FFM（Foreign Function & Memory API）使用 OpenSSL，性能会更好。</p><h3 id=javax-到-jakarta-命名空间迁移>javax. <em>到 jakarta.</em> 命名空间迁移<a href=#javax-到-jakarta-命名空间迁移 class=anchor aria-hidden=true>#</a></h3><p><strong>重要提醒：</strong> 迁移到 Tomcat 11 的一个挑战性方面是需要重构应用以适应从 <code>javax.*</code> 到 <code>jakarta.*</code> 命名空间的切换。</p><p><strong>影响：</strong></p><ul><li>这是从早期 Tomcat 版本迁移的基础性变更</li><li>特别是使用 Java EE 的应用需要特别注意</li><li>Tomcat 11 提供了 <a href=https://github.com/apache/tomcat-jakartaee-migration/blob/main/README.md target=_blank rel=noopener>迁移工具</a>
来支持这一转换</li><li>需要仔细测试以确保应用在新命名空间下继续正常工作</li></ul><p><strong>注意：</strong> 如果你还在使用 Spring Boot 2.x，需要先升级到 Spring Boot 3.x（已完成 <code>javax.*</code> 到 <code>jakarta.*</code> 迁移），然后再考虑升级到 Spring Boot 4.0。</p><h3 id=http-header-大小写处理变化>HTTP Header 大小写处理变化<a href=#http-header-大小写处理变化 class=anchor aria-hidden=true>#</a></h3><p>Tomcat 11 使用 <strong>header name 的原始大小写</strong>来存储 HTTP/1.1 request headers，而不是强制将其转换为小写。<strong>以前 Tomcat 会自动转小写，现在不会了</strong>。</p><p><strong>主要影响：</strong></p><ul><li>取 Header 时一定要关注大小写</li><li>建议按照 RFC 7230 建议，全链路都统一使用小写</li><li>如果代码中直接比较 header 名称字符串，可能因为大小写不匹配而失败</li><li>Spring Framework 7.0 的 <code>HttpHeaders</code> API 也有相应变化</li></ul><h2 id=废弃功能与破坏性变更>废弃功能与破坏性变更<a href=#废弃功能与破坏性变更 class=anchor aria-hidden=true>#</a></h2><h3 id=移除的废弃-api>移除的废弃 API<a href=#移除的废弃-api class=anchor aria-hidden=true>#</a></h3><p>Spring Boot 4.0 这次移除了 36 个废弃类，大概占了所有废弃 API 的 88%。迁移的时候这些地方需要特别注意：</p><h4 id=mockbean-和-spybean-移除>MockBean 和 SpyBean 移除<a href=#mockbean-和-spybean-移除 class=anchor aria-hidden=true>#</a></h4><p><strong>影响：</strong> 测试代码中广泛使用。旧写法：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Spring Boot 3.x （已废弃，4.0 移除）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UserServiceTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@MockBean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserRepository</span><span class=w> </span><span class=n>userRepository</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>新写法：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Spring Boot 4.0 （使用 Spring 官方支持）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UserServiceTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@MockitoBean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserRepository</span><span class=w> </span><span class=n>userRepository</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=mockitotestexecutionlistener-移除>MockitoTestExecutionListener 移除<a href=#mockitotestexecutionlistener-移除 class=anchor aria-hidden=true>#</a></h3><p>Spring Boot 4.0 移除了该监听器，使用 Spring 的原生 Mockito 支持。</p><h3 id=websecurityconfigureradapter-移除>WebSecurityConfigurerAdapter 移除<a href=#websecurityconfigureradapter-移除 class=anchor aria-hidden=true>#</a></h3><p>该改动在 Spring Boot 3.x 时已废弃，4.0 正式移除。</p><p>旧写法：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Spring Boot 2.x/3.x （已废弃）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableWebSecurity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WebSecurityConfigurerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>authorizeRequests</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=s>&#34;/public/**&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>需要改成新的方式：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Spring Boot 4.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableWebSecurity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>filterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>authorizeHttpRequests</span><span class=p>(</span><span class=n>auth</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/public/**&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>该改动在 Spring Boot 3.x 时已废弃，4.0 正式移除。</p><h3 id=undertow-支持移除>Undertow 支持移除<a href=#undertow-支持移除 class=anchor aria-hidden=true>#</a></h3><p>Undertow 目前不兼容 Servlet 6.1，Spring Boot 4.0 移除了对它的支持：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- Spring Boot 4.0 不再支持 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-undertow<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><p><strong>替代方案：</strong></p><ul><li>切换到 Tomcat 11（推荐）</li><li>使用 Jetty 12.1+</li><li>等待 Undertow 支持 Servlet 6.1</li></ul><h3 id=spring-batch-默认行为变更>Spring Batch 默认行为变更<a href=#spring-batch-默认行为变更 class=anchor aria-hidden=true>#</a></h3><p>Spring Batch 现在默认在内存中存储元数据，不再使用数据库。这可能导致 Job 执行历史丢失：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- 如果需要持久化元数据，显式添加 JDBC 支持 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-batch-jdbc<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><h3 id=reactive-pulsar-支持移除>Reactive Pulsar 支持移除<a href=#reactive-pulsar-支持移除 class=anchor aria-hidden=true>#</a></h3><p>Spring Pulsar 移除了 Reactor 支持，所以 Spring Boot 4.0 也相应移除了响应式 Pulsar 客户端的自动配置。</p><h3 id=embedded-executable-uber-jar-launch-scripts-移除>Embedded Executable Uber Jar Launch Scripts 移除<a href=#embedded-executable-uber-jar-launch-scripts-移除 class=anchor aria-hidden=true>#</a></h3><p>Spring Boot 4.0 移除了用于创建"完全可执行" jar 文件的嵌入式启动脚本支持。该功能仅适用于类 Unix 系统，且与 <a href=https://docs.spring.io/spring-boot/4.0-SNAPSHOT/reference/packaging/efficient.html target=_blank rel=noopener>高效部署建议</a>
冲突。</p><p>如果需要类似功能，可以使用 Gradle 的 application plugin 等替代方案。你仍然可以使用 Spring Boot 的构建插件创建 uber jar，并通过 <code>java -jar</code> 运行。</p><h3 id=spring-session-hazelcastmongodb-移除>Spring Session Hazelcast/MongoDB 移除<a href=#spring-session-hazelcastmongodb-移除 class=anchor aria-hidden=true>#</a></h3><p>Spring Session Hazelcast 和 Spring Session MongoDB 现在分别由 Hazelcast 团队和 MongoDB 团队维护，Spring Boot 4.0 移除了对它们的直接支持。如需使用，请直接使用对应的 starter。</p><h2 id=常见问题与解决方案>常见问题与解决方案<a href=#常见问题与解决方案 class=anchor aria-hidden=true>#</a></h2><h3 id=http-header-大小写问题>HTTP Header 大小写问题<a href=#http-header-大小写问题 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：Header 访问失败或行为不一致</p><p>升级到 Tomcat 11.0.12+ 和 Spring Framework 7.0 后，某些 header 访问可能出现问题。这是 Spring Boot 4 迁移中<strong>必须关注的坑</strong>。</p><p><strong>原因：</strong></p><ul><li><strong>Tomcat 11.0.12+</strong>：HTTP 请求头名称会保留原始大小写，而不是强制转换为小写（<strong>以前 Tomcat 会自动转小写，现在不会了</strong>）</li><li>Spring Framework 7.0：<code>HttpHeaders</code> API 不再继承 <code>MultiValueMap</code></li><li>Header 名称大小写不敏感，但某些代码可能依赖特定的大小写格式或直接比较 header 名称</li></ul><p><strong>建议：</strong> 按照 RFC 7230 建议，全链路都统一使用小写 header 名称。</p><p><strong>解决方案：</strong></p><ul><li>更新 <code>HttpHeaders</code> 的使用方式：</li></ul><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 旧代码（Spring Framework 6.x）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpHeaders</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpHeaders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>headers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>contentType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>headers</span><span class=p>.</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 新代码（Spring Framework 7.0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpHeaders</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpHeaders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>headers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>contentType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>headers</span><span class=p>.</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 仍然可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 或使用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=n>hasContentType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>headers</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>);</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=n>大小写不敏感</span></span></span></code></pre></div></figure></div><ul><li>统一使用标准格式的 header 名称：</li></ul><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 推荐：使用标准格式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>headers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>headers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Bearer token&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>headers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;X-Custom-Header&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span></span></span></code></pre></div></figure></div><ul><li>更新 header 名称比较的代码：</li></ul><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 问题代码：直接字符串比较可能失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Enumeration</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>headerNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaderNames</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>headerNames</span><span class=p>.</span><span class=na>hasMoreElements</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>headerNames</span><span class=p>.</span><span class=na>nextElement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;content-type&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 可能失败，name 可能是 &#34;Content-Type&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 推荐：使用大小写不敏感比较</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=s>&#34;content-type&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><ul><li>更新测试代码：</li></ul><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// MockHttpServletRequest 的行为已更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MockHttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MockHttpServletRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>addHeader</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 以下都能正常工作（大小写不敏感）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>assertThat</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>)).</span><span class=na>isNotNull</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>assertThat</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;content-type&#34;</span><span class=p>)).</span><span class=na>isNotNull</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>assertThat</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;CONTENT-TYPE&#34;</span><span class=p>)).</span><span class=na>isNotNull</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 但遍历时需要注意原始大小写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Enumeration</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>names</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaderNames</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>names</span><span class=p>.</span><span class=na>hasMoreElements</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>names</span><span class=p>.</span><span class=na>nextElement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// name 可能是 &#34;Content-Type&#34; 而不是 &#34;content-type&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 使用原始大小写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=编译时-nullability-错误>编译时 Nullability 错误<a href=#编译时-nullability-错误 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：JSpecify 注解导致 Kotlin 或空值检查工具报错</p><p>Kotlin 项目可能遇到以下错误：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>error: [nullness] incompatible types in return.
</span></span><span class=line><span class=cl>  required: @NonNull String
</span></span><span class=line><span class=cl>  found:    @Nullable String</span></span></code></pre></div></figure></div><p><strong>解决方案</strong>：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// Kotlin 中处理可空类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=py>user</span><span class=p>:</span> <span class=n>User</span><span class=p>?</span> <span class=p>=</span> <span class=n>userService</span><span class=p>.</span><span class=n>findUser</span><span class=p>(</span><span class=s2>&#34;123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>name</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=n>user</span><span class=o>?.</span><span class=n>name</span> <span class=o>?:</span> <span class=s2>&#34;Unknown&#34;</span></span></span></code></pre></div></figure></div><p>或者临时禁用严格空值检查：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;compilerArgs&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;arg&gt;</span>-Xlint:-nullness<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/compilerArgs&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/plugin&gt;</span></span></span></code></pre></div></figure></div><h3 id=jackson-3x-序列化问题>Jackson 3.x 序列化问题<a href=#jackson-3x-序列化问题 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：JSON 序列化/反序列化行为变更</p><p>Jackson 3.x 的行为和 2.x 有些不一样，可能会导致一些序列化问题。</p><p><strong>解决方案</strong>：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JacksonConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ObjectMapper</span><span class=w> </span><span class=nf>objectMapper</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>mapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 恢复 Jackson 2.x 的兼容性行为</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mapper</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>DeserializationFeature</span><span class=p>.</span><span class=na>FAIL_ON_UNKNOWN_PROPERTIES</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mapper</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>SerializationFeature</span><span class=p>.</span><span class=na>WRITE_DATES_AS_TIMESTAMPS</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mapper</span><span class=p>.</span><span class=na>registerModule</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>JavaTimeModule</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=第三方库不兼容>第三方库不兼容<a href=#第三方库不兼容 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：某些库依赖旧版本的 Spring 或 Jakarta API</p><p>部分第三方库可能尚未适配 Spring Boot 4.0。</p><p><strong>解决方案</strong>：</p><ol><li>检查库的最新版本</li><li>使用依赖排除和强制版本：</li></ol><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.example<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>legacy-library<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.0.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;exclusions&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;exclusion&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.springframework<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>*<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/exclusion&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/exclusions&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><ul><li>考虑替换为兼容的库</li></ul><h3 id=spring-batch-元数据丢失>Spring Batch 元数据丢失<a href=#spring-batch-元数据丢失 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：升级后找不到 Job 执行历史</p><p>升级后 Job 执行历史丢失，原因是 Spring Batch 默认行为变更。</p><p><strong>解决方案</strong>：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-batch-jdbc<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jdbc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialize-schema</span><span class=p>:</span><span class=w> </span><span class=l>always</span></span></span></code></pre></div></figure></div><h3 id=undertow-无法使用>Undertow 无法使用<a href=#undertow-无法使用 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：<code>spring-boot-starter-undertow</code> 不再可用</p><p><strong>解决方案</strong>：切换到 Tomcat：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- 默认使用 Tomcat，无需额外配置 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><p>如果需要 Jetty：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;exclusions&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;exclusion&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/exclusion&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/exclusions&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-jetty<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div><h3 id=虚拟线程性能未达预期>虚拟线程性能未达预期<a href=#虚拟线程性能未达预期 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：启用虚拟线程后性能无明显提升</p><p><strong>可能原因：</strong></p><ul><li>应用是 CPU 密集型的（虚拟线程对这种情况没用）</li><li>数据库连接池配置不当</li><li>用了同步的阻塞代码（比如 <code>synchronized</code>）</li></ul><p><strong>解决方案</strong>：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 优化数据库连接池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hikari</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maximum-pool-size</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>  </span><span class=c># 虚拟线程环境可适当增加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>minimum-idle</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 确保启用虚拟线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>threads</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>virtual</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></figure></div><p>使用 JFR (Java Flight Recorder) 分析：</p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -XX:StartFlightRecording<span class=o>=</span><span class=nv>filename</span><span class=o>=</span>recording.jfr -jar app.jar</span></span></code></pre></div></figure></div><h3 id=测试上下文缓存问题>测试上下文缓存问题<a href=#测试上下文缓存问题 class=anchor aria-hidden=true>#</a></h3><p><strong>问题</strong>：测试上下文自动暂停导致测试变慢</p><p>Spring Framework 7 的测试上下文暂停机制可能导致测试变慢。</p><p><strong>解决方案</strong>：</p><p>调整测试上下文缓存配置：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TestPropertySource</span><span class=p>(</span><span class=n>properties</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;spring.test.context.cache.maxSize=10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MyTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h2 id=自动化迁移工具>自动化迁移工具<a href=#自动化迁移工具 class=anchor aria-hidden=true>#</a></h2><h3 id=openrewrite>OpenRewrite<a href=#openrewrite class=anchor aria-hidden=true>#</a></h3><p>OpenRewrite 是开源的自动化代码重构工具，支持 Spring Boot 迁移。</p><p><strong>Maven 集成：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;build&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;plugins&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.openrewrite.maven<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>rewrite-maven-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>5.40.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;activeRecipes&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;recipe&gt;</span>org.openrewrite.java.spring.boot4.UpgradeSpringBoot_4_0<span class=nt>&lt;/recipe&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/activeRecipes&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;groupId&gt;</span>org.openrewrite.recipe<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;artifactId&gt;</span>rewrite-spring<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;version&gt;</span>5.22.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/dependencies&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/plugin&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/plugins&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/build&gt;</span></span></span></code></pre></div></figure></div><p><strong>Gradle 集成：</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>plugins</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span> <span class=s1>&#39;org.openrewrite.rewrite&#39;</span> <span class=n>version</span> <span class=s1>&#39;6.25.0&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rewrite</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>activeRecipe</span><span class=o>(</span><span class=s1>&#39;org.openrewrite.java.spring.boot4.UpgradeSpringBoot_4_0&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rewrite</span> <span class=s1>&#39;org.openrewrite.recipe:rewrite-spring:5.22.0&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div></figure></div><p><strong>运行迁移：</strong></p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Maven: 预览变更</span>
</span></span><span class=line><span class=cl>mvn rewrite:dryRun
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Maven: 应用变更</span>
</span></span><span class=line><span class=cl>mvn rewrite:run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Gradle: 预览变更</span>
</span></span><span class=line><span class=cl>./gradlew rewriteDryRun
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Gradle: 应用变更</span>
</span></span><span class=line><span class=cl>./gradlew rewriteRun</span></span></code></pre></div></figure></div><p><strong>主要功能：</strong></p><ul><li>自动升级 Spring Boot 版本号</li><li>替换废弃的 API（如 <code>@MockBean</code> → <code>@MockitoBean</code>）</li><li>更新 import 语句</li><li>修复依赖冲突</li><li>调整配置文件格式</li><li>重构安全配置（移除 <code>WebSecurityConfigurerAdapter</code>）</li></ul><h4 id=示例迁移安全配置>示例：迁移安全配置<a href=#示例迁移安全配置 class=anchor aria-hidden=true>#</a></h4><p>OpenRewrite 会自动将：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WebSecurityConfigurerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>authorizeRequests</span><span class=p>().</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><p>重构为：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>filterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=p>.</span><span class=na>authorizeHttpRequests</span><span class=p>(</span><span class=n>auth</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>auth</span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=spring-boot-migrator>Spring Boot Migrator<a href=#spring-boot-migrator class=anchor aria-hidden=true>#</a></h3><p><a href=https://github.com/spring-projects-experimental/spring-boot-migrator target=_blank rel=noopener>Spring Boot Migrator</a>
是 Spring 官方的实验性工具，基于 OpenRewrite，专门用于将传统 Spring 应用迁移到 Spring Boot，同时提供 Spring Boot 版本升级。</p><p><strong>主要功能：</strong></p><ul><li>将传统 Spring 项目初始化为 Spring Boot 应用</li><li>将 Spring XML 配置转换为 Java 配置</li><li>Spring Boot 版本升级</li></ul><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装</span>
</span></span><span class=line><span class=cl>git clone https://github.com/spring-projects-experimental/spring-boot-migrator.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> spring-boot-migrator
</span></span><span class=line><span class=cl>./mvnw clean install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 扫描项目</span>
</span></span><span class=line><span class=cl>java -jar applications/cli/target/spring-boot-migrator.jar scan /path/to/project
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用迁移</span>
</span></span><span class=line><span class=cl>java -jar applications/cli/target/spring-boot-migrator.jar migrate /path/to/project</span></span></code></pre></div></figure></div><h3 id=windup-red-hat>Windup (Red Hat)<a href=#windup-red-hat class=anchor aria-hidden=true>#</a></h3><p><a href=https://github.com/windup/windup target=_blank rel=noopener>Windup</a>
是 Red Hat 提供的 Java 应用现代化和迁移工具，支持大规模 Java 应用迁移。</p><p><strong>主要功能：</strong></p><ul><li>代码分析和迁移评估</li><li>支持多种迁移场景（Java 版本升级、框架迁移、云迁移等）</li><li>生成迁移报告和评估工作量</li></ul><p><strong>适用场景：</strong></p><ul><li>大型企业级应用迁移</li><li>多项目批量迁移</li><li>云原生应用迁移</li></ul><h3 id=intellij-idea-迁移助手>IntelliJ IDEA 迁移助手<a href=#intellij-idea-迁移助手 class=anchor aria-hidden=true>#</a></h3><p>IntelliJ IDEA 2025.3+ 内置了 Spring Boot 4 迁移支持：</p><ol><li>打开项目</li><li>右键点击 <code>pom.xml</code> 或 <code>build.gradle</code></li><li>选择 Refactor → Migrate to Spring Boot 4.0</li><li>按照向导完成迁移</li></ol><h3 id=eclipse-transformer>Eclipse Transformer<a href=#eclipse-transformer class=anchor aria-hidden=true>#</a></h3><p>从 Spring Boot 2.x 迁移时，可使用 Eclipse Transformer 批量转换 <code>javax.*</code> 到 <code>jakarta.*</code>：</p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -jar transformer.jar /path/to/project /path/to/output</span></span></code></pre></div></figure></div><h2 id=参考资料>参考资料<a href=#参考资料 class=anchor aria-hidden=true>#</a></h2><h3 id=官方文档>官方文档<a href=#官方文档 class=anchor aria-hidden=true>#</a></h3><ul><li><a href=https://spring.io/blog/2025/11/20/spring-boot-4-0-0-available-now/ target=_blank rel=noopener>Spring Boot 4.0.0 Official Release</a></li><li><a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Release-Notes target=_blank rel=noopener>Spring Boot 4.0 Release Notes</a>
- GitHub Wiki</li><li><a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Migration-Guide target=_blank rel=noopener>Spring Boot 4.0 Migration Guide</a>
- GitHub Wiki，<strong>必读</strong></li><li><a href=https://github.com/spring-projects/spring-framework/wiki/Spring-Framework-7.0-Release-Notes target=_blank rel=noopener>Spring Framework 7.0 Release Notes</a></li><li><a href=https://spring.io/blog/2025/11/13/spring-framework-7-0-general-availability/ target=_blank rel=noopener>Spring Framework 7.0 General Availability</a></li></ul><h3 id=技术文章>技术文章<a href=#技术文章 class=anchor aria-hidden=true>#</a></h3><ul><li><a href=https://spring.io/blog/2025/10/28/modularizing-spring-boot/ target=_blank rel=noopener>Modularizing Spring Boot</a>
- Spring 官方对模块化改造的详细说明</li><li><a href=https://loiane.com/2025/08/spring-boot-4-spring-framework-7-key-features/ target=_blank rel=noopener>Spring Boot 4 and Spring Framework 7: Key Features and Changes</a>
- Loiane Groner 的详细解读</li><li><a href=https://www.baeldung.com/spring-boot-4-spring-framework-7 target=_blank rel=noopener>Spring Boot 4 & Spring Framework 7 – What&rsquo;s New | Baeldung</a>
- Baeldung 权威教程</li><li><a href=https://blog.jetbrains.com/idea/2025/11/spring-boot-4/ target=_blank rel=noopener>Spring Boot 4: Leaner, Safer Apps and a New Kotlin Baseline</a>
- JetBrains 官方对 Spring Boot 4 的分析</li><li><a href=https://www.infoq.com/news/2025/11/spring-7-spring-boot-4/ target=_blank rel=noopener>Spring Framework 7 and Spring Boot 4 Deliver API Versioning, Resilience, and Null-Safe Annotations</a>
- InfoQ 深度报道</li><li><a href=https://foojay.io/today/preparing-for-spring-framework-7-and-spring-boot-4/ target=_blank rel=noopener>Preparing for Spring Framework 7 and Spring Boot 4</a>
- Foojay.io 对 Spring Framework 7 和 Spring Boot 4 新特性的全面介绍</li></ul><h3 id=迁移经验>迁移经验<a href=#迁移经验 class=anchor aria-hidden=true>#</a></h3><ul><li><a href=https://www.moderne.ai/blog/spring-boot-4x-migration-guide target=_blank rel=noopener>Spring Boot 4 Migration Guide: Faster, Safer, at Scale</a>
- Moderne.ai 的企业级迁移指南</li><li><a href=https://medium.com/@kanishks772/the-spring-boot-4-migration-hack-every-developer-needs-to-know-in-2025-7c8ae3529cff target=_blank rel=noopener>The Spring Boot 4 Migration Hack Every Developer Needs to Know in 2025</a>
- 实战技巧分享</li><li><a href=https://medium.com/@javedmj786/migration-to-spring-boot-4-0-a-performance-enhancements-guide-aee2a90c303e target=_blank rel=noopener>Migration to Spring Boot 4.0: A Performance Enhancements Guide</a>
- 性能优化经验</li><li><a href=https://medium.com/@vikrantdheer/migrating-to-spring-boot-3-7-subtle-pitfalls-and-how-to-fix-them-1ac457e6b098 target=_blank rel=noopener>Migrating to Spring Boot 3+: 7 Subtle Pitfalls and How to Fix Them</a>
- 常见问题解决</li><li><a href=https://www.xlabs.club/blog/migrating-java8-to-java25/ target=_blank rel=noopener>Java 25 完整升级指南：从 Java 8 到 Java 25</a>
- Java 版本升级完整指南，包含新特性、性能优化、迁移实战和工具推荐</li></ul><h3 id=虚拟线程>虚拟线程<a href=#虚拟线程 class=anchor aria-hidden=true>#</a></h3><ul><li><a href=https://blog.fastthread.io/virtual-threads-performance-in-spring-boot/ target=_blank rel=noopener>Virtual Threads Performance in Spring Boot</a>
- Fast Thread 的性能基准测试</li><li><a href=https://www.javacodegeeks.com/2025/04/spring-boot-performance-with-java-virtual-threads.html target=_blank rel=noopener>Spring Boot Performance with Java Virtual Threads</a>
- Java Code Geeks 的性能分析</li><li><a href=https://www.baeldung.com/spring-6-virtual-threads target=_blank rel=noopener>Working with Virtual Threads in Spring | Baeldung</a>
- Baeldung 虚拟线程教程</li><li><a href=https://medium.com/@oleksandr.dendeberia/spring-boot-4-and-virtual-threads-a-practical-high-impact-upgrade-for-modern-java-development-10631f4f427b target=_blank rel=noopener>Spring Boot 4 and Virtual Threads: A Practical, High-Impact Upgrade</a>
- 虚拟线程实战</li></ul><h3 id=迁移工具>迁移工具<a href=#迁移工具 class=anchor aria-hidden=true>#</a></h3><ul><li><a href=https://docs.openrewrite.org/recipes/java/spring/boot4/upgradespringboot_4_0-community-edition target=_blank rel=noopener>OpenRewrite: Migrate to Spring Boot 4.0</a>
- OpenRewrite 官方文档</li><li><a href=https://github.com/spring-projects-experimental/spring-boot-migrator target=_blank rel=noopener>Spring Boot Migrator</a>
- Spring 官方迁移工具</li><li><a href=https://windup.github.io/ target=_blank rel=noopener>Windup</a>
- Red Hat 应用现代化工具</li><li><a href=https://github.com/adoptium/emt4j target=_blank rel=noopener>EMT4J</a>
- Eclipse Java 版本迁移工具</li><li><a href=https://www.moderne.ai/ target=_blank rel=noopener>Moderne.ai</a>
- 企业级 OpenRewrite 托管服务</li></ul><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"><div class=last-modified><a href=https://github.com/xlabs-club/xlabs-club.github.io/commit/ec4199e6136929a71d37cdfd3acc4daa6a597421><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Last updated on 2025年12月13日</a></div><div class=edit-page><a href=https://github.com/xlabs-club/xlabs-club.github.io/blob/main/content//blog/migration-spring-boot-3-to-4.md><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
Edit this page on GitHub</a></div></div><div class="page-nav d-flex flex-column flex-sm-row"><div class="card text-end w-100"><div class="card-body d-flex justify-content-end"><div class="d-flex flex-column"><div class=text-body-secondary>Next</div><a href=/blog/javax-jakarta-compatibility/ class="stretched-link text-reset text-decoration-none">Javax 和 Jakarta 过渡期兼容方案</a></div><div class="d-flex flex-column justify-content-center"><svg class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M13 18l6-6"/><path d="M13 6l6 6"/></svg></div></div></div></div></main></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.8b717d53dae071196d91d0d0c63650fe240e84ffe50a76fdb433a914d6b216ec.js integrity="sha256-i3F9U9rgcRltkdDQxjZQ/iQOhP/lCnb9tDOpFNayFuw="></script><script async src=/js/app.592ddd2791734c581ee9465f923ca99817c6bcb2a5c2725df8c34f9def04b128.js integrity="sha256-WS3dJ5FzTFge6UZfkjypmBfGvLKlwnJd+MNPne8EsSg="></script><script async src=/js/docsearch.4c43898496d40210bc7d52e319d675a83a35016293221b53c5c2e544c50ab234.js integrity="sha256-TEOJhJbUAhC8fVLjGdZ1qDo1AWKTIhtTxcLlRMUKsjQ="></script></body></html>